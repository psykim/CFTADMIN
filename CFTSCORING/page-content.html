<!DOCTYPE html><html lang="ko"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ë¬¼ë²”ì£¼í˜•ìœ ì°½ì„±ê²€ì‚¬ ì±„ì ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        /* ì„±ë³„ ë²„íŠ¼ê³¼ ë†’ì´ë¥¼ ë§ì¶˜ ì…ë ¥ í•„ë“œ */
        .aligned-input {
            height: 46px; /* ì„±ë³„ í† ê¸€ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë†’ì´ (padding 10px + font-size 16px + border 2px) */
            padding: 10px;
            box-sizing: border-box;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .time-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .time-section h3 {
            color: #666;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .response-tag {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            position: relative;
        }
        
        .response-tag .remove {
            margin-left: 10px;
            cursor: pointer;
            color: #d32f2f;
            font-weight: bold;
        }
        
        /* ì§ˆë¬¸ íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .question-tag {
            background-color: #ffe4b5;
            border: 1px dashed #ff8c00;
            opacity: 0.8;
        }
        
        .question-tag:hover {
            background-color: #ffd4a3;
        }
        
        .calculate-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background-color: #28a745;
        }
        
        .calculate-btn:hover {
            background-color: #218838;
        }
        
        .db-manage-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background-color: #1976d2;
        }
        
        .db-manage-btn:hover {
            background-color: #1565c0;
        }
        
        .csv-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            background-color: #17a2b8;
        }
        
        .csv-btn:hover {
            background-color: #138496;
        }
        
        /* CSV ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
        .csv-upload-section {
            background-color: #e8f5f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #17a2b8;
            display: none;
        }
        
        .csv-format-example {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .csv-results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .csv-result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .csv-result-table th,
        .csv-result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .csv-result-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .results {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            background-color: white;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border-radius: 20px;
            display: none;
            position: relative;
            overflow: hidden;
        }
        
        .results::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #1565c0 0%, #42a5f5 50%, #1976d2 100%);
        }
        
        /* ì»´íŒ©íŠ¸í•œ í‘œ í˜•ì‹ ìŠ¤íƒ€ì¼ */
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .score-table th,
        .score-table td {
            padding: 8px 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .score-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
            font-size: 13px;
            white-space: nowrap;
            padding: 10px 8px;
        }
        
        /* í—¤ë” í–‰ ìŠ¤íƒ€ì¼ */
        .score-table tr.header-row {
            background-color: #f5f5f5;
        }
        
        .score-table td {
            font-size: 16px;
            font-weight: bold;
            color: #1565c0;
            white-space: nowrap;
            background-color: #fafafa; /* ê¸°ë³¸ ë°°ê²½ìƒ‰ */
        }
        
        /* ë°ì´í„° ì…€ì€ í•­ìƒ í°ìƒ‰ ë°°ê²½ */
        .score-table td.data-cell {
            background-color: white !important;
        }
        
        .score-table td.low-z-score {
            color: #d32f2f;
        }
        
        .score-table thead th {
            vertical-align: middle;
        }
        
        /* ì²« ë²ˆì§¸ tdê°€ data-cell í´ë˜ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ íšŒìƒ‰ ë°°ê²½ */
        .score-table tbody td:first-child:not(.data-cell) {
            font-weight: bold;
            background-color: #f5f5f5;
        }
        
        .score-table .warning {
            color: #d32f2f;
        }
        
        .section-title {
            text-align: center;
            margin: 30px 0 20px 0;
            color: #90a4ae;
            font-size: 24px;
            font-weight: 500;
        }
        
        .score-card {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .score-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-color: #1976d2;
        }
        
        .score-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: normal;
        }
        
        .score-card .score {
            font-size: 42px;
            font-weight: bold;
            color: #1565c0;
            margin-top: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #1565c0, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .analysis-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e3f2fd;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .analysis-section h3 {
            color: #1565c0;
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #1976d2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-section h3::before {
            content: "ğŸ“Š";
            font-size: 24px;
        }
        
        .response-list {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        
        .response-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .response-item:last-child {
            border-bottom: none;
        }
        
        .response-categories {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
        
        .cluster-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .category-tag {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 12px;
            font-size: 12px;
            color: #1565c0;
        }
        
        .category-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .used-categories {
            margin-top: 8px;
        }
        
        .algorithm-info {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .algorithm-info h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .switching-detail {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .switching-item {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
            margin: 2px 0;
        }
        
        .switching-item.has-switch {
            background-color: #ffebee;
            border-left-color: #ff5722;
        }
        
        .switching-arrow {
            color: #ff5722;
            font-weight: bold;
            font-size: 18px;
        }
        
        .no-switch {
            color: #666;
        }
        
        .switch-marker {
            background-color: #ff5722;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .switching-detail h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .animal-number {
            font-weight: bold;
            color: #1976d2;
            min-width: 100px;
        }
        
        .shared-categories {
            margin-left: 40px;
            font-size: 12px;
            color: #4caf50;
            margin-top: 2px;
        }
        
        .no-shared-categories {
            margin-left: 40px;
            font-size: 12px;
            color: #f44336;
            margin-top: 2px;
        }
        
        /* ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
        .database-management {
            background-color: #f0f7ff;
            border: 2px solid #1976d2;
            padding-top: 30px;
        }
        
        .db-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .db-controls input[type="text"] {
            width: 300px;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #1976d2;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background-color: #1565c0;
        }
        
        .btn-success {
            background-color: #4caf50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-success:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #757575;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #616161;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-edit {
            background-color: #ff9800;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .btn-edit:hover {
            background-color: #f57c00;
        }
        
        .animal-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .category-checkboxes {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .category-checkboxes h4 {
            margin: 10px 0 5px 0;
            color: #555;
            font-size: 16px;
        }
        
        .category-checkboxes label {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .category-checkboxes input[type="checkbox"] {
            margin-right: 5px;
        }
        
        .form-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .database-view {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .db-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            align-items: center;
            justify-content: space-between;
        }
        
        .db-stats-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
        }
        
        .db-stats span {
            font-size: 14px;
            color: #666;
        }
        
        .db-stats strong {
            color: #1976d2;
            font-size: 16px;
        }
        
        .animal-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .animal-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .animal-item:hover {
            background-color: #f0f0f0;
        }
        
        .animal-info {
            width: 100%;
        }
        
        .animal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .animal-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        
        .animal-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .category-check {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .category-check.checked {
            background-color: #e3f2fd;
            border-color: #90caf9;
            font-weight: bold;
        }
        
        .category-check input[type="checkbox"] {
            width: auto;
            margin: 0;
            pointer-events: none;
        }
        
        .search-highlight {
            background-color: yellow;
            font-weight: bold;
        }
        
        /* ì„±ë³„ í† ê¸€ ìŠ¤íƒ€ì¼ */
        .gender-toggle {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        
        .gender-toggle input[type="radio"] {
            display: none;
        }
        
        .gender-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: normal;
        }
        
        .gender-toggle input[type="radio"]:checked + .gender-option {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }
        
        .gender-option:hover {
            background-color: #e9ecef;
        }
        
        .gender-toggle input[type="radio"]:checked + .gender-option:hover {
            background-color: #0056b3;
        }
        
        /* ì ìˆ˜ ê³„ì‚° ìƒì„¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .detail-table th,
        .detail-table td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
        }
        
        .detail-table th {
            background-color: #1976d2;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .detail-table tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        .detail-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .detail-table tbody tr {
            transition: background-color 0.2s;
        }
        
        .detail-table td.intrusion {
            color: #f44336;
            font-weight: bold;
        }
        
        .detail-table td.perseveration {
            color: #ff9800;
            font-weight: bold;
        }
        
        .detail-table td.valid {
            color: #4caf50;
        }
        
        .detail-table td.switch {
            color: #2196f3;
            font-weight: bold;
        }
        
        /* ë³€í˜• ëª…ì¹­ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
        .variants-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .variants-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .variant-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .variant-input-group input {
            flex: 1;
        }
        
        .variants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .variant-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 15px;
            font-size: 14px;
            border: 1px solid #90caf9;
        }
        
        .variant-remove {
            cursor: pointer;
            color: #d32f2f;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
        }
        
        .variant-remove:hover {
            background-color: #d32f2f;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <h1>ë™ë¬¼ë²”ì£¼í˜•ìœ ì°½ì„±ê²€ì‚¬ ì±„ì ê¸°</h1>
        
        <div class="section">
            <div class="info-grid">
                <div class="form-group">
                    <label for="subjectId">ID</label>
                    <input type="text" id="subjectId" placeholder="í”¼ê²€ì ID" class="aligned-input" style="">
                </div>
                <div class="form-group">
                    <label for="gender">ì„±ë³„</label>
                    <div class="gender-toggle">
                        <input type="radio" id="gender-male" name="gender" value="male" style="">
                        <label for="gender-male" class="gender-option">ë‚¨ì„±</label>
                        <input type="radio" id="gender-female" name="gender" value="female" style="">
                        <label for="gender-female" class="gender-option">ì—¬ì„±</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="age">ì—°ë ¹</label>
                    <input type="number" id="age" placeholder="ì—°ë ¹" class="aligned-input" style="">
                </div>
                <div class="form-group">
                    <label for="education">í•™ë ¥ (ë…„)</label>
                    <input type="number" id="education" placeholder="êµìœ¡ë…„ìˆ˜ ì…ë ¥" class="aligned-input" style="">
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="time-section">
                <h3>0-15ì´ˆ êµ¬ê°„</h3>
                <div class="input-group">
                    <input type="text" id="input-0-15" placeholder="ë™ë¬¼ ì´ë¦„ ì…ë ¥" onkeypress="handleKeyPress(event, '0-15')" style="">
                    <button onclick="addResponse('0-15')">ì¶”ê°€</button>
                </div>
                <div id="responses-0-15" class="responses"></div>
            </div>
            
            <div class="time-section">
                <h3>15-30ì´ˆ êµ¬ê°„</h3>
                <div class="input-group">
                    <input type="text" id="input-15-30" placeholder="ë™ë¬¼ ì´ë¦„ ì…ë ¥" onkeypress="handleKeyPress(event, '15-30')" style="">
                    <button onclick="addResponse('15-30')">ì¶”ê°€</button>
                </div>
                <div id="responses-15-30" class="responses"></div>
            </div>
            
            <div class="time-section">
                <h3>30-45ì´ˆ êµ¬ê°„</h3>
                <div class="input-group">
                    <input type="text" id="input-30-45" placeholder="ë™ë¬¼ ì´ë¦„ ì…ë ¥" onkeypress="handleKeyPress(event, '30-45')" style="">
                    <button onclick="addResponse('30-45')">ì¶”ê°€</button>
                </div>
                <div id="responses-30-45" class="responses"></div>
            </div>
            
            <div class="time-section">
                <h3>45-60ì´ˆ êµ¬ê°„</h3>
                <div class="input-group">
                    <input type="text" id="input-45-60" placeholder="ë™ë¬¼ ì´ë¦„ ì…ë ¥" onkeypress="handleKeyPress(event, '45-60')" style="">
                    <button onclick="addResponse('45-60')">ì¶”ê°€</button>
                </div>
                <div id="responses-45-60" class="responses"></div>
            </div>
        </div>
        
        <div class="button-group">
            <button class="calculate-btn" onclick="calculateScores()">ì ìˆ˜ ê³„ì‚°í•˜ê¸°</button>
            <button class="db-manage-btn" onclick="showDatabaseManagement()">ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬</button>
            <button class="csv-btn" onclick="showCSVUpload()">CSV ì¼ê´„ ì²˜ë¦¬</button>
        </div>
    </div>
    
    <div id="results" class="results" style="display: none;">
            <h2 style="text-align: center; color: #1565c0; font-size: 32px; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f3f4f6 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">íŒë… ê²°ê³¼</h2>
            
            <!-- ë²„íŠ¼ë“¤ -->
            <div style="text-align: right; margin-bottom: 30px;">
                <button onclick="showAnalysisDetails()" class="btn-primary" style="padding: 10px 25px; font-size: 14px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-right: 10px;">
                    ë¶„ì„ ê³¼ì • ë³´ê¸°
                </button>
                <button onclick="backToInput()" class="btn-primary" style="padding: 10px 25px; font-size: 14px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    ì…ë ¥ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
            
            
            <!-- í†µí•© ê²°ê³¼ í…Œì´ë¸” -->
            <table class="score-table" style="width: 100%; max-width: 1200px; margin: 0 auto; table-layout: fixed;">
                <colgroup>
                    <col style="width: 15%;">
                    <col style="width: 12.14%;">
                    <col style="width: 12.14%;">
                    <col style="width: 12.14%;">
                    <col style="width: 12.14%;">
                    <col style="width: 12.14%;">
                    <col style="width: 12.14%;">
                    <col style="width: 12.14%;">
                </colgroup>
                <tbody>
                    <!-- 60ì´ˆ ë°˜ì‘ ì²«ë²ˆì§¸ í–‰ -->
                    <tr class="header-row">
                        <th rowspan="4" style="vertical-align: middle; font-weight: bold; background-color: #e8f4f8;">60ì´ˆ ë°˜ì‘</th>
                        <th>ì´ì </th>
                        <th>Zì ìˆ˜</th>
                        <th>í¼ì„¼íƒ€ì¼</th>
                        <th>ì „ë°˜ì ìˆ˜</th>
                        <th>í›„ë°˜ì ìˆ˜</th>
                        <th>ë³´ì†ì˜¤ë¥˜</th>
                        <th>ì¹¨íˆ¬ì˜¤ë¥˜</th>
                    </tr>
                    <tr>
                        <td id="totalScore" class="data-cell">0</td>
                        <td id="totalZScore" class="data-cell">-</td>
                        <td id="totalPercentile" class="data-cell">-</td>
                        <td id="firstHalfScore" class="data-cell">0</td>
                        <td id="secondHalfScore" class="data-cell">0</td>
                        <td id="perseverationScore" class="data-cell">0</td>
                        <td id="intrusionScore" class="data-cell">0</td>
                    </tr>
                    
                    <!-- 60ì´ˆ ë°˜ì‘ ë‘ë²ˆì§¸ í–‰ -->
                    <tr class="header-row">
                        <th>ë²”ì£¼ìˆ˜</th>
                        <th>í‰ê· í¬ê¸°</th>
                        <th>ìµœëŒ€í¬ê¸°</th>
                        <th>ì „í™˜</th>
                        <th>ë¹„íš¨ìœ¨ì „í™˜</th>
                        <th colspan="2">-</th>
                    </tr>
                    <tr>
                        <td id="categoryScore" class="data-cell">0</td>
                        <td id="avgClusterSize" class="data-cell">0</td>
                        <td id="maxClusterSize" class="data-cell">0</td>
                        <td id="switchingScore" class="data-cell">0</td>
                        <td id="inefficientSwitchingScore" class="data-cell">0</td>
                        <td colspan="2" class="data-cell">-</td>
                    </tr>
                    
                    <!-- ì „ë°˜ 30ì´ˆ ê²°ê³¼ -->
                    <tr class="header-row" style="border-top: 2px solid #ddd;">
                        <th rowspan="2" style="vertical-align: middle; font-weight: bold; background-color: #e8f4f8;">ì „ë°˜ 30ì´ˆ ë°˜ì‘</th>
                        <th>ë²”ì£¼ìˆ˜</th>
                        <th>í‰ê· í¬ê¸°</th>
                        <th>ìµœëŒ€í¬ê¸°</th>
                        <th>ì „í™˜</th>
                        <th>ë¹„íš¨ìœ¨ì „í™˜</th>
                        <th>ë³´ì†ì˜¤ë¥˜</th>
                        <th>ì¹¨íˆ¬ì˜¤ë¥˜</th>
                    </tr>
                    <tr>
                        <td id="first30SecCategoryScore" class="data-cell">0</td>
                        <td id="first30SecAvgClusterSize" class="data-cell">0</td>
                        <td id="first30SecMaxClusterSize" class="data-cell">0</td>
                        <td id="first30SecSwitchingScore" class="data-cell">0</td>
                        <td id="first30SecInefficient" class="data-cell">0</td>
                        <td id="first30SecPerseverationScore" class="data-cell">0</td>
                        <td id="first30SecIntrusionScore" class="data-cell">0</td>
                    </tr>
                </tbody>
            </table>
            
            <div id="normInfo" style="display: none;"></div>
            
            <div class="analysis-section" id="clusterAnalysisSection" style="display: none;">
                <div id="clusterAnalysis">
                    <p style="color: #666; text-align: center; padding: 20px;">
                        ì ìˆ˜ ê³„ì‚°ì„ ì‹¤í–‰í•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
            
            <!-- ì„ìƒì  í•´ì„ (í‘œ ì•„ë˜ ìœ„ì¹˜) -->
            <div id="patternAnalysis" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #1976d2;">
                <p style="color: #666; text-align: center;">
                    ì ìˆ˜ ê³„ì‚°ì„ ì‹¤í–‰í•˜ë©´ ì„ìƒì  í•´ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
            
            
        </div>
        
        <!-- ë¶„ì„ ê³¼ì • ìƒì„¸ ë³´ê¸° ì„¹ì…˜ -->
        <div id="analysisDetails" class="results" style="display: none;">
            <h2 style="text-align: center; color: #1565c0; font-size: 32px; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f3f4f6 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">ë¶„ì„ ê³¼ì •</h2>
            
            <!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
            <div style="text-align: right; margin-bottom: 30px;">
                <button onclick="backToResults()" class="btn-primary" style="padding: 10px 25px; font-size: 14px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
            
            <!-- ë¶„ì„ ê³¼ì • ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            <div id="analysisContent">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë¶€ë¶„ -->
            </div>
        </div>
        
        <!-- ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section database-management" style="display: block; margin-top: 120px;">
            <div class="db-controls">
                <label style="font-weight: bold; margin-right: 10px;">ê²€ìƒ‰</label>
                <input type="text" id="searchAnimal" placeholder="ë™ë¬¼ ê²€ìƒ‰..." onkeyup="searchAnimals()" style="">
                <button onclick="closeDatabaseManagement()" class="btn-secondary">ë‹«ê¸°</button>
            </div>
            
            <!-- ë™ë¬¼ ì¶”ê°€/ìˆ˜ì • í¼ -->
            <div id="animalForm" style="display: none;" class="animal-form">
                <h3 id="formTitle">ìƒˆ ë™ë¬¼ ì¶”ê°€</h3>
                <div class="form-group">
                    <label>ë™ë¬¼ ì´ë¦„:</label>
                    <input type="text" id="animalName" required="" style="">
                </div>
                
                <div class="category-checkboxes">
                    <h4>ìƒë¬¼í•™ì  ë¶„ë¥˜</h4>
                    <label><input type="checkbox" id="cat_MAMMAL" style=""> í¬ìœ ë¥˜</label>
                    <label><input type="checkbox" id="cat_BIRD" style=""> ì¡°ë¥˜</label>
                    <label><input type="checkbox" id="cat_REPTILE" style=""> íŒŒì¶©ë¥˜</label>
                    <label><input type="checkbox" id="cat_AMPHIBIAN" style=""> ì–‘ì„œë¥˜</label>
                    <label><input type="checkbox" id="cat_FISH" style=""> ì–´ë¥˜</label>
                    <label><input type="checkbox" id="cat_INSECT" style=""> ê³¤ì¶©</label>
                    <label><input type="checkbox" id="cat_MOLLUSK" style=""> ì—°ì²´ë™ë¬¼</label>
                    <label><input type="checkbox" id="cat_CRUSTACEAN" style=""> ê°‘ê°ë¥˜</label>
                    
                    <h4>ì„œì‹ì§€ ë¶„ë¥˜</h4>
                    <label><input type="checkbox" id="cat_MARINE" style=""> í•´ì–‘ìƒë¬¼</label>
                    <label><input type="checkbox" id="cat_FRESHWATER" style=""> ë‹´ìˆ˜ìƒë¬¼</label>
                    
                    <h4>ì¸ê°„ê³¼ì˜ ê´€ê³„</h4>
                    <label><input type="checkbox" id="cat_DOMESTIC" style=""> ê°€ì¶•</label>
                    <label><input type="checkbox" id="cat_PET" style=""> ì• ì™„ë™ë¬¼</label>
                    <label><input type="checkbox" id="cat_WILD" style=""> ì•¼ìƒë™ë¬¼</label>
                    
                    <h4>ë¬¸í™”ì  ë¶„ë¥˜</h4>
                    <label><input type="checkbox" id="cat_ZODIAC" style=""> 12ê°„ì§€</label>
                    <label><input type="checkbox" id="cat_MYTHOLOGY" style=""> ì‹ í™”/ìƒìƒì˜ ë™ë¬¼</label>
                    <label><input type="checkbox" id="cat_PREHISTORIC" style=""> ì„ ì‚¬ì‹œëŒ€ ë™ë¬¼</label>
                </div>
                
                <!-- ë³€í˜• ëª…ì¹­ ê´€ë¦¬ ì„¹ì…˜ -->
                <div class="variants-section">
                    <h4>ë³€í˜• ëª…ì¹­ ê´€ë¦¬</h4>
                    <p class="variants-description">ì´ ë™ë¬¼ì˜ ë‹¤ë¥¸ í‘œí˜„ë“¤ (ì„±ë³„, ì—°ë ¹, ì‚¬íˆ¬ë¦¬, ì™¸ë˜ì–´ í‘œê¸° ë³€í˜• ë“±)ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.<br>
                    ì˜ˆ: ê°œ â†’ ê°•ì•„ì§€, ë©ë©ì´, ì•”ìº, ìˆ˜ìº<br>
                    ì˜ˆ: í•˜ì´ì—ë‚˜ â†’ í•˜ì´ì• ë‚˜ (ì™¸ë˜ì–´ í‘œê¸° ë³€í˜•)</p>
                    
                    <div class="variant-input-group">
                        <input type="text" id="variantInput" placeholder="ë³€í˜• ëª…ì¹­ ì…ë ¥ (ì˜ˆ: ê°•ì•„ì§€, ë©ë©ì´)" style="">
                        <button type="button" onclick="addVariant()" class="btn-secondary">ì¶”ê°€</button>
                    </div>
                    
                    <div id="variantsList" class="variants-list">
                        <!-- ë³€í˜• ëª…ì¹­ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button onclick="saveAnimal()" class="btn-primary">ì €ì¥</button>
                    <button onclick="cancelAnimalForm()" class="btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <!-- ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ -->
            <div id="databaseView" class="database-view">
                <div class="db-stats">
                    <div class="db-stats-info">
                        <span>ì´ ë™ë¬¼ ìˆ˜: <strong id="totalAnimals">0</strong></span>
                        <span>í¬ìœ ë¥˜: <strong id="mammalCount">0</strong></span>
                        <span>ì¡°ë¥˜: <strong id="birdCount">0</strong></span>
                        <span>íŒŒì¶©ë¥˜: <strong id="reptileCount">0</strong></span>
                        <span>ì–‘ì„œë¥˜: <strong id="amphibianCount">0</strong></span>
                        <span>ì–´ë¥˜: <strong id="fishCount">0</strong></span>
                        <span>ê³¤ì¶©: <strong id="insectCount">0</strong></span>
                        <span>ì—°ì²´ë™ë¬¼: <strong id="molluskCount">0</strong></span>
                        <span>ê°‘ê°ë¥˜: <strong id="crustaceanCount">0</strong></span>
                    </div>
                    <button onclick="showAddAnimalForm()" class="btn-success">ìƒˆ ë™ë¬¼ ì¶”ê°€</button>
                    <button onclick="showVariantsManager()" class="btn-primary" style="margin-left: 10px;">ë³€í˜• ëª…ì¹­ ì‚¬ì „ ê´€ë¦¬</button>
                </div>
                
                <div id="animalList" class="animal-list"></div>
            </div>
        </div>
        
        <!-- ë³€í˜• ëª…ì¹­ ì‚¬ì „ ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section variants-management" style="display: none; margin-top: 120px;">
            <div class="db-controls">
                <h2 style="text-align: center; margin-bottom: 20px;">ë™ë¬¼ ë³€í˜• ëª…ì¹­ ì‚¬ì „ ê´€ë¦¬</h2>
                <button onclick="closeVariantsManager()" class="btn-secondary" style="float: right;">ë‹«ê¸°</button>
                <div style="clear: both;"></div>
            </div>
            
            <!-- ì‹ ê·œ ë³€í˜• ëª…ì¹­ ë“±ë¡ -->
            <div class="animal-form" style="background: #e3f2fd; border: 2px solid #1976d2; margin-bottom: 20px;">
                <h3 style="color: #1565c0; margin-bottom: 20px;">ìƒˆ ë™ë¬¼ ë³€í˜• ëª…ì¹­ ë“±ë¡</h3>
                <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰:</label>
                        <input type="text" id="searchAnimalForVariant" placeholder="ë™ë¬¼ ì´ë¦„ ì…ë ¥ (ì˜ˆ: í•˜ì´ì—ë‚˜)" onkeyup="searchAnimalsForVariant()" style="width: 100%;">
                        <div id="animalSearchResults" style="max-height: 200px; overflow-y: auto; background: white; 
                             border: 1px solid #ddd; margin-top: 5px; display: none;">
                            <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">ì„ íƒëœ ë™ë¬¼:</label>
                        <div id="selectedAnimalInfo" style="padding: 10px; background: white; border: 1px solid #ddd; 
                             min-height: 50px; display: flex; align-items: center; justify-content: center; color: #666;">
                            ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”
                        </div>
                    </div>
                </div>
                <button onclick="createNewVariantEntry()" class="btn-success" style="margin-top: 15px;" disabled="" id="createVariantBtn">ìƒˆ ë³€í˜• ëª…ì¹­ ë“±ë¡ ì‹œì‘</button>
            </div>
            
            <!-- ê¸°ì¡´ ë³€í˜• ëª…ì¹­ ëª©ë¡ ë° ê²€ìƒ‰ -->
            <div class="db-controls" style="margin-top: 30px;">
                <label style="font-weight: bold; margin-right: 10px;">ê¸°ì¡´ ë³€í˜• ëª…ì¹­ ê²€ìƒ‰</label>
                <input type="text" id="searchVariant" placeholder="ë™ë¬¼ ëª…ì¹­ ê²€ìƒ‰..." onkeyup="searchVariantAnimals()" style="">
            </div>
            
            <!-- ë³€í˜• ëª…ì¹­ í¸ì§‘ í¼ -->
            <div id="variantEditForm" style="display: none;" class="animal-form">
                <h3 id="variantFormTitle">ë³€í˜• ëª…ì¹­ í¸ì§‘</h3>
                <p class="variants-description">ê¸°ë³¸ ë™ë¬¼: <strong id="variantBaseAnimal"></strong></p>
                
                <div class="variant-input-group">
                    <input type="text" id="newVariantInput" placeholder="ìƒˆ ë³€í˜• ëª…ì¹­ ì…ë ¥ (ì˜ˆ: í•˜ì´ì• ë‚˜, ê°•ì•„ì§€)" style="">
                    <button type="button" onclick="addNewVariant()" class="btn-secondary">ì¶”ê°€</button>
                </div>
                
                <div id="variantEditList" class="variants-list" style="margin: 20px 0; max-height: 300px; overflow-y: auto;">
                    <!-- ë³€í˜• ëª…ì¹­ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="form-buttons">
                    <button onclick="saveVariantChanges()" class="btn-primary">ì €ì¥</button>
                    <button onclick="cancelVariantEdit()" class="btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <!-- ë³€í˜• ëª…ì¹­ ì‚¬ì „ ëª©ë¡ -->
            <div id="variantsView" class="database-view">
                <div class="db-stats">
                    <div class="db-stats-info">
                        <span>ì´ ë™ë¬¼ ìˆ˜: <strong id="totalVariantAnimals">0</strong></span>
                        <span>ì´ ë³€í˜• ëª…ì¹­ ìˆ˜: <strong id="totalVariants">0</strong></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportVariants()" class="btn-primary" title="í˜„ì¬ ë³€í˜• ëª…ì¹­ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤">ë³€í˜• ëª…ì¹­ ë‚´ë³´ë‚´ê¸°</button>
                        <button onclick="importVariants()" class="btn-secondary" title="ì €ì¥ëœ ë³€í˜• ëª…ì¹­ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤">ë³€í˜• ëª…ì¹­ ê°€ì ¸ì˜¤ê¸°</button>
                        <button onclick="showVariantsHelp()" class="btn-secondary" style="background: #9e9e9e;">ì‚¬ìš©ë²•</button>
                    </div>
                </div>
                
                <div id="variantAnimalList" class="animal-list"></div>
            </div>
        </div>
        
        <!-- CSV ì¼ê´„ ì²˜ë¦¬ ì„¹ì…˜ -->
        <div class="csv-upload-section" id="csvUploadSection">
            <h2>CSV ì¼ê´„ ì²˜ë¦¬</h2>
            
            <div class="csv-format-info">
                <h3>CSV íŒŒì¼ í˜•ì‹</h3>
                <p>ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ CSV íŒŒì¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”:</p>
                <div class="csv-format-example">
ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,0-15ì´ˆ,15-30ì´ˆ,30-45ì´ˆ,45-60ì´ˆ
001,ë‚¨ì„±,65,12,ê°œ,ê³ ì–‘ì´,ì†Œ,ë§,ë¼ì§€,ë‹­,í˜¸ë‘ì´,ì‚¬ì,ë±€,ê±°ë¶ì´
002,ì—¬ì„±,72,6,ê°œ,ì†Œ,ë§,ë‹­,ì˜¤ë¦¬,ê°œêµ¬ë¦¬,í† ë¼,ì¥
003,ë‚¨ì„±,58,16,ì‚¬ì,í˜¸ë‘ì´,í‘œë²”,ì¹˜íƒ€,ê³ ì–‘ì´,ê°œ,ëŠ‘ëŒ€,ì—¬ìš°,ë„ˆêµ¬ë¦¬,ê³°,íŒë‹¤
                </div>
                <p><strong>ì£¼ì˜ì‚¬í•­:</strong></p>
                <ul>
                    <li>ì²« ë²ˆì§¸ ì¤„ì€ ë°˜ë“œì‹œ í—¤ë”ë¡œ ìœ„ì™€ ê°™ì´ ì‘ì„±</li>
                    <li>ê° ì‹œê°„ëŒ€ë³„ ë™ë¬¼ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„</li>
                    <li>ì„±ë³„ì€ "ë‚¨ì„±" ë˜ëŠ” "ì—¬ì„±"ìœ¼ë¡œ ì…ë ¥</li>
                    <li>UTF-8 ì¸ì½”ë”©ìœ¼ë¡œ ì €ì¥</li>
                </ul>
            </div>
            
            <div class="csv-upload-area">
                <input type="file" id="csvFile" accept=".csv" style="margin: 20px 0px;">
                <button onclick="processCSV()" class="btn-primary">CSV ì²˜ë¦¬í•˜ê¸°</button>
                <button onclick="downloadCSVTemplate()" class="btn-secondary">í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                <button onclick="hideCSVUpload()" class="btn-secondary">ë‹«ê¸°</button>
            </div>
            
            <div id="csvResults" class="csv-results"></div>
        </div>
    
    
    <!-- ì™¸ë¶€ ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ì°¸ì¡° -->
    <script src="animal-database.js"></script>
    <script src="animal-variants.js"></script>
    <script src="normative_data.js"></script>
    
    <script>
        // Zì ìˆ˜ë¥¼ í¼ì„¼íƒ€ì¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (í‘œì¤€ì •ê·œë¶„í¬ ëˆ„ì ë¶„í¬í•¨ìˆ˜)
        function zScoreToPercentile(zScore) {
            // ê·¼ì‚¬ì‹ì„ ì‚¬ìš©í•œ í‘œì¤€ì •ê·œë¶„í¬ ëˆ„ì ë¶„í¬í•¨ìˆ˜
            const t = 1 / (1 + 0.2316419 * Math.abs(zScore));
            const d = 0.3989423 * Math.exp(-zScore * zScore / 2);
            const probability = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
            
            if (zScore > 0) {
                return (1 - probability) * 100;
            } else {
                return probability * 100;
            }
        }
        
        // ì •ìƒê·œì¤€ì„ ê¸°ë°˜ìœ¼ë¡œ Zì ìˆ˜ì™€ í¼ì„¼íƒ€ì¼ ê³„ì‚°
        function calculateNormativeScores(totalScore, age, education) {
            // getAgeGroupê³¼ getEducationGroup í•¨ìˆ˜ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof getAgeGroup !== 'function' || typeof getEducationGroup !== 'function') {
                console.error('ì •ìƒê·œì¤€ í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return null;
            }
            
            const ageGroup = getAgeGroup(age);
            const eduGroup = getEducationGroup(education);
            
            console.log(`Age: ${age} â†’ Group: ${ageGroup}`);
            console.log(`Education: ${education} â†’ Group: ${eduGroup}`);
            
            // í•´ë‹¹ ê·œì¤€ ë°ì´í„° ì°¾ê¸°
            if (typeof NORMATIVE_DATA === 'undefined') {
                console.error('NORMATIVE_DATAê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return null;
            }
            
            const normData = NORMATIVE_DATA[ageGroup]?.[eduGroup];
            
            if (!normData) {
                console.error('ê·œì¤€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', ageGroup, eduGroup);
                return null;
            }
            
            // Zì ìˆ˜ ê³„ì‚°
            const zScore = (totalScore - normData.mean) / normData.sd;
            
            // í¼ì„¼íƒ€ì¼ ê³„ì‚°
            const percentile = zScoreToPercentile(zScore);
            
            // 5í¼ì„¼íƒ€ì¼ ì´í•˜ ì—¬ë¶€ íŒë‹¨
            const isBelow5Percentile = totalScore <= normData.cutoff_5_percentile;
            
            return {
                mean: normData.mean,
                sd: normData.sd,
                zScore: zScore,
                percentile: percentile,
                cutoff5: normData.cutoff_5_percentile,
                isBelow5Percentile: isBelow5Percentile
            };
        }
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ë°˜ì‘ ì €ì¥
        const responses = {
            '0-15': [],
            '15-30': [],
            '30-45': [],
            '45-60': []
        };
        
        // ë²”ì£¼ ì •ì˜ (ìˆ˜ì •ëœ ë²„ì „)
        const CATEGORIES = {
            // ìƒë¬¼í•™ì  ë¶„ë¥˜
            MAMMAL: 'í¬ìœ ë¥˜',
            BIRD: 'ì¡°ë¥˜',
            REPTILE: 'íŒŒì¶©ë¥˜',
            AMPHIBIAN: 'ì–‘ì„œë¥˜',
            FISH: 'ì–´ë¥˜',
            INSECT: 'ê³¤ì¶©',
            MOLLUSK: 'ì—°ì²´ë™ë¬¼',
            CRUSTACEAN: 'ê°‘ê°ë¥˜',
            
            // ì„œì‹ì§€ë³„ ë¶„ë¥˜
            MARINE: 'í•´ì–‘ë™ë¬¼',
            FRESHWATER: 'ë‹´ìˆ˜ë™ë¬¼',
            
            // ì¸ê°„ê³¼ì˜ ê´€ê³„
            DOMESTIC: 'ê°€ì¶•',
            PET: 'ì• ì™„ë™ë¬¼',
            WILD: 'ì•¼ìƒë™ë¬¼',
            
            // ë¬¸í™”ì  ë¶„ë¥˜
            ZODIAC: '12ê°„ì§€',
            MYTHOLOGY: 'ì‹ í™”/ìƒìƒì˜ ë™ë¬¼',
            PREHISTORIC: 'ì„ ì‚¬ì‹œëŒ€ ë™ë¬¼'
        };
        
        // ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì™¸ë¶€ íŒŒì¼(animal-database.js)ì—ì„œ ë¡œë“œë¨
        // íŠ¹ì • ë™ë¬¼ì˜ ëª¨ë“  ë²”ì£¼ ê°€ì ¸ì˜¤ê¸°
        function getAnimalCategories(animalName) {
            // ë³€í˜• ëª…ì¹­ì„ ê¸°ë³¸ ëª…ì¹­ìœ¼ë¡œ ì •ê·œí™”
            const normalizedName = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(animalName) : animalName;
            const animalData = ANIMAL_CATEGORIES[normalizedName || animalName];
            if (!animalData) return [];
            
            const categories = [];
            for (const [cat, value] of Object.entries(animalData)) {
                if (value === true && CATEGORIES[cat]) {
                    categories.push({
                        code: cat,
                        name: CATEGORIES[cat]
                    });
                }
            }
            return categories;
        }
        
        // íŠ¹ì • ë™ë¬¼ì˜ ì£¼ìš” ìƒë¬¼í•™ì  ë²”ì£¼ ê°€ì ¸ì˜¤ê¸° (í´ëŸ¬ìŠ¤í„° ë¶„ì„ìš©)
        function getPrimaryBiologicalCategory(animalName) {
            // ë³€í˜• ëª…ì¹­ì„ ê¸°ë³¸ ëª…ì¹­ìœ¼ë¡œ ì •ê·œí™”
            const normalizedName = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(animalName) : animalName;
            const animalData = ANIMAL_CATEGORIES[normalizedName || animalName];
            if (!animalData) return 'ê¸°íƒ€';
            
            // ìƒë¬¼í•™ì  ë¶„ë¥˜ ìš°ì„ ìˆœìœ„
            const biologicalCategories = ['MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN'];
            
            for (const bioCategory of biologicalCategories) {
                if (animalData[bioCategory] === true) {
                    return CATEGORIES[bioCategory];
                }
            }
            
            // ì‹ í™”ë™ë¬¼ì¸ ê²½ìš°
            if (animalData['MYTHOLOGY'] === true) {
                return CATEGORIES['MYTHOLOGY'];
            }
            
            return 'ê¸°íƒ€';
        }
        
        // ê³µí†µ ë²”ì£¼ ê¸°ë°˜ ì „í™˜ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ (ì „ë©´ ì¬ì‘ì„±)
        function analyzeTransitionsAndClusters(responses) {
            console.log('=== ì „í™˜ ë¶„ì„ ì‹œì‘ ===');
            console.log('ì…ë ¥ëœ ë™ë¬¼ë“¤:', responses.map(r => r.normalizedResponse));
            
            if (responses.length === 0) return { transitions: [], clusters: [], switchingScore: 0, inefficientSwitchingScore: 0 };
            
            // ì¤‘ë³µ ì œê±°í•˜ì—¬ uniqueí•œ ë™ë¬¼ë§Œ ë‚¨ê¸°ë˜, ìˆœì„œëŠ” ì²« ì¶œí˜„ ìˆœì„œ ìœ ì§€
            const seenAnimals = new Set();
            const uniqueResponses = [];
            
            for (const response of responses) {
                if (!seenAnimals.has(response.normalizedResponse)) {
                    seenAnimals.add(response.normalizedResponse);
                    uniqueResponses.push(response);
                }
            }
            
            console.log('ì¤‘ë³µ ì œê±° í›„ ë™ë¬¼ë“¤:', uniqueResponses.map(r => r.normalizedResponse));
            
            // ê° ë™ë¬¼ì˜ ë²”ì£¼ ì •ë³´ë¥¼ ë¯¸ë¦¬ ì¤€ë¹„
            const animalData = [];
            for (const response of uniqueResponses) {
                const originalAnimal = response.normalizedResponse;
                const normalizedAnimal = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(originalAnimal) : originalAnimal;
                const animal = normalizedAnimal || originalAnimal;
                const categories = [];
                const categoryData = ANIMAL_CATEGORIES[animal] || {};
                
                for (const [cat, value] of Object.entries(categoryData)) {
                    if (value === true) {
                        categories.push(cat);
                    }
                }
                
                animalData.push({
                    name: animal,
                    categories: categories,
                    originalName: originalAnimal
                });
            }
            
            // í´ëŸ¬ìŠ¤í„°ë§ ë° ì „í™˜ ë¶„ì„
            const clusters = [];
            const transitions = [];
            let switchingScore = 0;
            let inefficientSwitchingScore = 0;
            
            let currentClusterStart = 0;
            let currentClusterCategories = [...animalData[0].categories]; // ì²« ë™ë¬¼ì˜ ëª¨ë“  ë²”ì£¼ë¡œ ì‹œì‘
            
            console.log(`\nì²« ë™ë¬¼: ${animalData[0].name}, ë²”ì£¼: ${currentClusterCategories.map(c => CATEGORIES[c] || c)}`);
            
            for (let i = 1; i < animalData.length; i++) {
                const currentAnimal = animalData[i];
                console.log(`\n${i+1}ë²ˆì§¸ ë™ë¬¼: ${currentAnimal.name}`);
                console.log(`  ë²”ì£¼: ${currentAnimal.categories.map(c => CATEGORIES[c] || c)}`);
                
                // í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ ê³µí†µ ë²”ì£¼ì™€ ê²¹ì¹˜ëŠ” ë²”ì£¼ê°€ ìˆëŠ”ì§€ í™•ì¸
                const overlappingCategories = currentAnimal.categories.filter(cat => 
                    currentClusterCategories.includes(cat)
                );
                
                console.log(`  í˜„ì¬ í´ëŸ¬ìŠ¤í„° ê³µí†µë²”ì£¼: ${currentClusterCategories.map(c => CATEGORIES[c] || c)}`);
                console.log(`  ê²¹ì¹˜ëŠ” ë²”ì£¼: ${overlappingCategories.map(c => CATEGORIES[c] || c)}`);
                
                if (overlappingCategories.length > 0) {
                    // ê²¹ì¹˜ëŠ” ë²”ì£¼ê°€ ìˆìœ¼ë©´ ê°™ì€ í´ëŸ¬ìŠ¤í„°ì— ì†í•¨
                    // ê³µí†µ ë²”ì£¼ë¥¼ ê²¹ì¹˜ëŠ” ë²”ì£¼ë¡œ ì—…ë°ì´íŠ¸
                    currentClusterCategories = overlappingCategories;
                    console.log(`  â†’ ê°™ì€ í´ëŸ¬ìŠ¤í„° ìœ ì§€, ê³µí†µë²”ì£¼ ì—…ë°ì´íŠ¸: ${currentClusterCategories.map(c => CATEGORIES[c] || c)}`);
                } else {
                    // ê²¹ì¹˜ëŠ” ë²”ì£¼ê°€ ì—†ìœ¼ë©´ ì „í™˜ ë°œìƒ
                    console.log(`  â†’ ì „í™˜ ë°œìƒ!`);
                    
                    // ì´ì „ í´ëŸ¬ìŠ¤í„° ì €ì¥
                    const clusterSize = i - currentClusterStart;
                    const clusterAnimals = animalData.slice(currentClusterStart, i).map(a => a.name);
                    
                    // í´ëŸ¬ìŠ¤í„°ì˜ ìµœì¢… ê³µí†µ ë²”ì£¼ ê²°ì • (ìµœëŒ€ í¬ê¸°ë¥¼ ë§Œë“œëŠ” ë²”ì£¼)
                    const bestCategory = findBestCategoryForCluster(animalData.slice(currentClusterStart, i));
                    
                    clusters.push({
                        animals: clusterAnimals,
                        size: clusterSize,
                        commonCategories: bestCategory.categories,
                        startIndex: currentClusterStart,
                        endIndex: i - 1
                    });
                    
                    console.log(`  ì´ì „ í´ëŸ¬ìŠ¤í„°: ${clusterAnimals.join(', ')} (í¬ê¸°: ${clusterSize}, ë²”ì£¼: ${bestCategory.categories.map(c => CATEGORIES[c] || c)})`);
                    
                    // ì „í™˜ ì •ë³´ ì¶”ê°€
                    transitions.push({
                        index: i,
                        from: animalData[i-1].name,
                        to: currentAnimal.name,
                        fromCategories: animalData[i-1].categories,
                        toCategories: currentAnimal.categories
                    });
                    switchingScore++;
                    
                    // í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì „í™˜ì´ë©´ ë¹„íš¨ìœ¨ ì „í™˜
                    if (clusterSize === 1) {
                        inefficientSwitchingScore++;
                        console.log(`  â†’ ë¹„íš¨ìœ¨ ì „í™˜! (í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì „í™˜)`);
                    }
                    
                    // ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„° ì‹œì‘
                    currentClusterStart = i;
                    currentClusterCategories = [...currentAnimal.categories];
                }
            }
            
            // ë§ˆì§€ë§‰ í´ëŸ¬ìŠ¤í„° ì €ì¥
            if (animalData.length > 0) {
                const lastClusterSize = animalData.length - currentClusterStart;
                const lastClusterAnimals = animalData.slice(currentClusterStart).map(a => a.name);
                const bestLastCategory = findBestCategoryForCluster(animalData.slice(currentClusterStart));
                
                clusters.push({
                    animals: lastClusterAnimals,
                    size: lastClusterSize,
                    commonCategories: bestLastCategory.categories,
                    startIndex: currentClusterStart,
                    endIndex: animalData.length - 1
                });
                
                console.log(`\në§ˆì§€ë§‰ í´ëŸ¬ìŠ¤í„°: ${lastClusterAnimals.join(', ')} (í¬ê¸°: ${lastClusterSize}, ë²”ì£¼: ${bestLastCategory.categories.map(c => CATEGORIES[c] || c)})`);
            }
            
            console.log('\n=== ì „í™˜ ë¶„ì„ ê²°ê³¼ ===');
            console.log(`ì´ ì „í™˜ íšŸìˆ˜: ${switchingScore}`);
            console.log(`ë¹„íš¨ìœ¨ì „í™˜ íšŸìˆ˜: ${inefficientSwitchingScore}`);
            console.log(`í´ëŸ¬ìŠ¤í„° ìˆ˜: ${clusters.length}`);
            console.log('í´ëŸ¬ìŠ¤í„° êµ¬ì„±:');
            clusters.forEach((cluster, idx) => {
                const categoryNames = cluster.commonCategories.map(cat => CATEGORIES[cat] || cat).join(', ');
                console.log(`  í´ëŸ¬ìŠ¤í„° ${idx + 1}: ${cluster.animals.join(', ')} (í¬ê¸°: ${cluster.size}, ê³µí†µë²”ì£¼: ${categoryNames})`);
            });
            
            return { transitions, clusters, switchingScore, inefficientSwitchingScore };
        }
        
        // í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•´ ìµœì ì˜ ê³µí†µ ë²”ì£¼ë¥¼ ì°¾ëŠ” í•¨ìˆ˜
        function findBestCategoryForCluster(animals) {
            if (animals.length === 0) return { categories: [], count: 0 };
            if (animals.length === 1) return { categories: animals[0].categories, count: 1 };
            
            // ëª¨ë“  ê°€ëŠ¥í•œ ë²”ì£¼ ì¡°í•©ì„ ì°¾ì•„ì„œ ê°€ì¥ ë§ì€ ë™ë¬¼ì„ í¬í•¨í•˜ëŠ” ë²”ì£¼ ì„ íƒ
            const allCategories = new Set();
            animals.forEach(animal => {
                animal.categories.forEach(cat => allCategories.add(cat));
            });
            
            let bestCategories = [];
            let bestCount = 0;
            
            // ê° ë²”ì£¼ë³„ë¡œ ëª‡ ê°œì˜ ë™ë¬¼ì´ ì†í•˜ëŠ”ì§€ í™•ì¸
            for (const category of allCategories) {
                const count = animals.filter(animal => 
                    animal.categories.includes(category)
                ).length;
                
                if (count > bestCount) {
                    bestCount = count;
                    bestCategories = [category];
                }
            }
            
            // ì—¬ëŸ¬ ë²”ì£¼ì˜ êµì§‘í•©ë„ í™•ì¸ (2ê°œ ë²”ì£¼ì˜ êµì§‘í•©ë§Œ)
            const categoriesArray = Array.from(allCategories);
            for (let i = 0; i < categoriesArray.length; i++) {
                for (let j = i + 1; j < categoriesArray.length; j++) {
                    const cat1 = categoriesArray[i];
                    const cat2 = categoriesArray[j];
                    
                    const count = animals.filter(animal => 
                        animal.categories.includes(cat1) && animal.categories.includes(cat2)
                    ).length;
                    
                    if (count > bestCount) {
                        bestCount = count;
                        bestCategories = [cat1, cat2];
                    }
                }
            }
            
            return { categories: bestCategories, count: bestCount };
        }
        
        // ë™ë¬¼ë“¤ì˜ ìµœì  ê³µí†µ ë²”ì£¼ ì°¾ê¸° (ê°€ì¥ ë§ì€ ë™ë¬¼ì„ í¬í•¨í•˜ëŠ” ë²”ì£¼ ì¡°í•©)
        function findOptimalCommonCategories(animals) {
            if (animals.length <= 1) return animals[0]?.categories || [];
            
            // ëª¨ë“  ë²”ì£¼ ìˆ˜ì§‘
            const allCategories = new Set();
            animals.forEach(animal => {
                animal.categories.forEach(cat => allCategories.add(cat));
            });
            
            // ê° ë²”ì£¼ë³„ë¡œ ëª‡ ê°œì˜ ë™ë¬¼ì´ ì†í•˜ëŠ”ì§€ ê³„ì‚°
            const categoryAnimalCount = {};
            allCategories.forEach(cat => {
                categoryAnimalCount[cat] = animals.filter(
                    animal => animal.categories.includes(cat)
                ).length;
            });
            
            // ëª¨ë“  ë™ë¬¼ì´ ê³µìœ í•˜ëŠ” ë²”ì£¼ë“¤ ì°¾ê¸°
            const sharedByAll = [];
            for (const cat of allCategories) {
                if (categoryAnimalCount[cat] === animals.length) {
                    sharedByAll.push(cat);
                }
            }
            
            // ëª¨ë“  ë™ë¬¼ì´ ê³µìœ í•˜ëŠ” ë²”ì£¼ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ë°˜í™˜
            if (sharedByAll.length > 0) {
                return sharedByAll;
            }
            
            // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ê°€ì¥ ë§ì€ ë™ë¬¼ì´ ê³µìœ í•˜ëŠ” ë²”ì£¼ë“¤ ë°˜í™˜
            const maxCount = Math.max(...Object.values(categoryAnimalCount));
            const optimalCategories = [];
            for (const [cat, count] of Object.entries(categoryAnimalCount)) {
                if (count === maxCount && count > 1) {
                    optimalCategories.push(cat);
                }
            }
            
            return optimalCategories;
        }
        
        function handleKeyPress(event, timeRange) {
            if (event.key === 'Enter') {
                addResponse(timeRange);
            }
        }
        
        function addResponse(timeRange) {
            const input = document.getElementById(`input-${timeRange}`);
            const value = input.value.trim();
            
            if (value) {
                // ì§ˆë¬¸ íŒ¨í„´ ê°ì§€ (ë¬¼ìŒí‘œê°€ ìˆê±°ë‚˜ "~ë„ ë˜ìš”?", "~ë„ ë¼ìš”?" ë“±ì˜ íŒ¨í„´)
                const isQuestion = value.includes('?') || 
                                 /ë„\s*(ë˜ìš”|ë¼ìš”|ë˜ë‚˜ìš”|ë˜ë‚˜|ë©ë‹ˆê¹Œ|ë˜ë‹ˆ|ë˜ëƒ)/i.test(value) ||
                                 /ë§ì•„ìš”|ë§ë‚˜ìš”|ë§ì£ |ë§ìŠµë‹ˆê¹Œ/i.test(value) ||
                                 /í• \s*ìˆ˜\s*ìˆ(ì–´ìš”|ë‚˜ìš”|ìŠµë‹ˆê¹Œ)/i.test(value) ||
                                 /ê°€ëŠ¥í•œê°€ìš”|ê°€ëŠ¥í•´ìš”|ê°€ëŠ¥í•©ë‹ˆê¹Œ/i.test(value);
                
                if (isQuestion) {
                    // ì§ˆë¬¸ì—ì„œ ë™ë¬¼ ì´ë¦„ ì¶”ì¶œ ì‹œë„
                    let extractedAnimal = value.replace(/[?ï¼Ÿ]/g, '') // ë¬¼ìŒí‘œ ì œê±°
                        .replace(/ë„\s*(ë˜ìš”|ë¼ìš”|ë˜ë‚˜ìš”|ë˜ë‚˜|ë©ë‹ˆê¹Œ|ë˜ë‹ˆ|ë˜ëƒ).*/i, '') // ì§ˆë¬¸ ë¶€ë¶„ ì œê±°
                        .replace(/.*?(ë§ì•„ìš”|ë§ë‚˜ìš”|ë§ì£ |ë§ìŠµë‹ˆê¹Œ).*/i, '')
                        .replace(/.*?í• \s*ìˆ˜\s*ìˆ(ì–´ìš”|ë‚˜ìš”|ìŠµë‹ˆê¹Œ).*/i, '')
                        .replace(/.*?(ê°€ëŠ¥í•œê°€ìš”|ê°€ëŠ¥í•´ìš”|ê°€ëŠ¥í•©ë‹ˆê¹Œ).*/i, '')
                        .trim();
                    
                    // ì§ˆë¬¸ í‘œì‹œë¥¼ ìœ„í•œ íŠ¹ë³„í•œ ë§ˆì»¤ ì¶”ê°€
                    responses[timeRange].push(`[ì§ˆë¬¸] ${value}`);
                    console.log(`ì§ˆë¬¸ ê°ì§€ë¨: "${value}" (ë™ë¬¼: "${extractedAnimal}"ëŠ” ì •ë°˜ì‘ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ)`);
                } else {
                    // ì¼ë°˜ ë°˜ì‘
                    responses[timeRange].push(value);
                }
                
                input.value = '';
                displayResponses(timeRange);
            }
        }
        
        function removeResponse(timeRange, index) {
            responses[timeRange].splice(index, 1);
            displayResponses(timeRange);
        }
        
        function displayResponses(timeRange) {
            const container = document.getElementById(`responses-${timeRange}`);
            container.innerHTML = responses[timeRange]
                .map((response, index) => {
                    const isQuestion = response.startsWith('[ì§ˆë¬¸]');
                    const displayText = isQuestion ? response.substring(5) : response;
                    const className = isQuestion ? 'response-tag question-tag' : 'response-tag';
                    
                    return `<span class="${className}" title="${isQuestion ? 'ì§ˆë¬¸ì€ ì •ë°˜ì‘ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤' : ''}">
                        ${displayText}${isQuestion ? ' â“' : ''}
                        <span class="remove" onclick="removeResponse('${timeRange}', ${index})">Ã—</span>
                    </span>`;
                }).join('');
        }
        
        function calculateScores() {
            console.log('calculateScores í•¨ìˆ˜ ì‹œì‘');
            
            try {
                // ì •ìƒê·œì¤€ ì ìˆ˜ë¥¼ ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
                let normScores = null;
                
                // ëª¨ë“  ë°˜ì‘ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬
                const allResponses = [];
                let order = 1;
            
            ['0-15', '15-30', '30-45', '45-60'].forEach(range => {
                console.log(`Processing range ${range}:`, responses[range]);
                responses[range].forEach(response => {
                    // ì§ˆë¬¸ìœ¼ë¡œ í‘œì‹œëœ í•­ëª©ì€ ê±´ë„ˆë›°ê¸°
                    if (response.startsWith('[ì§ˆë¬¸]')) {
                        console.log(`ì§ˆë¬¸ í•­ëª© ì œì™¸: ${response}`);
                        return;
                    }
                    
                    // ë³€í˜• ëª…ì¹­ì„ ê¸°ë³¸ ëª…ì¹­ìœ¼ë¡œ ì •ê·œí™”
                    const trimmed = response.trim();
                    const normalized = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(trimmed) : null;
                    
                    // normalizedê°€ nullì´ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—†ëŠ” ë‹¨ì–´
                    // ANIMAL_CATEGORIESì—ì„œ ì§ì ‘ í™•ì¸
                    const finalNormalized = normalized || (ANIMAL_CATEGORIES[trimmed] ? trimmed : null);
                    
                    allResponses.push({
                        response: response,
                        normalizedResponse: finalNormalized,
                        originalResponse: trimmed,
                        order,
                        timeRange: range
                    });
                    order++;
                });
            });
            
            if (allResponses.length === 0) {
                alert('ë°˜ì‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // 1. Total Score (ì¤‘ë³µ ì œì™¸, ì¹¨íˆ¬ ë°˜ì‘ ì œì™¸)
            const validResponses = allResponses.filter(r => r.normalizedResponse !== null);
            const uniqueResponses = [...new Set(validResponses.map(r => r.normalizedResponse))];
            const totalScore = uniqueResponses.length;
            
            // 2. First Half Score (ì¹¨íˆ¬ ì œì™¸, ì¤‘ë³µ ì œì™¸)
            const firstHalfResponses = allResponses.filter(r => 
                (r.timeRange === '0-15' || r.timeRange === '15-30') && r.normalizedResponse !== null
            );
            const firstHalfScore = new Set(firstHalfResponses.map(r => r.normalizedResponse)).size;
            
            // 3. Second Half Score (ì¹¨íˆ¬ ì œì™¸, ì¤‘ë³µ ì œì™¸)
            const secondHalfResponses = allResponses.filter(r => 
                (r.timeRange === '30-45' || r.timeRange === '45-60') && r.normalizedResponse !== null
            );
            const secondHalfScore = new Set(secondHalfResponses.map(r => r.normalizedResponse)).size;
            
            // 4. Perseveration Score (ì¹¨íˆ¬ ë°˜ì‘ ì œì™¸)
            const responseCount = {};
            validResponses.forEach(r => {
                responseCount[r.normalizedResponse] = (responseCount[r.normalizedResponse] || 0) + 1;
            });
            const perseverationScore = Object.values(responseCount)
                .filter(count => count > 1)
                .reduce((sum, count) => sum + (count - 1), 0);
            
            // 5. Intrusion Score (ë°ì´í„°ë² ì´ìŠ¤ì— ì—†ëŠ” ë™ë¬¼)
            let intrusionScore = 0;
            const intrusions = [];
            allResponses.forEach(response => {
                if (response.normalizedResponse === null) {
                    intrusionScore++;
                    if (!intrusions.includes(response.response)) {
                        intrusions.push(response.response);
                    }
                }
            });
            
            // 6. ê³µí†µ ë²”ì£¼ ê¸°ë°˜ ì „í™˜ ë¶„ì„ (ì¹¨íˆ¬ ë°˜ì‘ ì œì™¸)
            console.log('analyzeTransitionsAndClusters í˜¸ì¶œ ì „, validResponses:', validResponses);
            const { transitions, clusters, switchingScore, inefficientSwitchingScore } = analyzeTransitionsAndClusters(validResponses);
            console.log('analyzeTransitionsAndClusters ê²°ê³¼:', { transitions, clusters, switchingScore, inefficientSwitchingScore });
            
            // 7. ë²”ì£¼ì ìˆ˜ (ê° í´ëŸ¬ìŠ¤í„°ë§ˆë‹¤ 1ê°œì˜ ëŒ€í‘œ ë²”ì£¼ë§Œ ì¹´ìš´íŠ¸, ì¤‘ë³µ ì œì™¸)
            console.log('\n=== ë²”ì£¼ ì ìˆ˜ ê³„ì‚° ===');
            const usedCategories = new Set();
            clusters.forEach((cluster, idx) => {
                console.log(`\ní´ëŸ¬ìŠ¤í„° ${idx + 1} (${cluster.animals.join(', ')}):`);
                console.log('  ê³µí†µ ë²”ì£¼:', cluster.commonCategories.map(cat => CATEGORIES[cat] || cat));
                
                // ê° í´ëŸ¬ìŠ¤í„°ì˜ ëŒ€í‘œ ë²”ì£¼ ê²°ì • (ê°€ì¥ ë§ì´ ê³µìœ ëœ ë²”ì£¼ ì„ íƒ)
                if (cluster.commonCategories.length > 0) {
                    // ê³µí†µ ë²”ì£¼ ì¤‘ ì²« ë²ˆì§¸ë¥¼ ëŒ€í‘œë¡œ ì„ íƒ
                    const representativeCategory = cluster.commonCategories[0];
                    console.log(`  â†’ ëŒ€í‘œ ë²”ì£¼ë¡œ '${CATEGORIES[representativeCategory]}' ì„ íƒ`);
                    usedCategories.add(representativeCategory);
                } else {
                    // ê³µí†µ ë²”ì£¼ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë™ë¬¼ì˜ ì£¼ìš” ë²”ì£¼ ì„ íƒ
                    const firstAnimalCategories = [];
                    const firstAnimalData = ANIMAL_CATEGORIES[cluster.animals[0]] || {};
                    
                    // ìƒë¬¼í•™ì  ë¶„ë¥˜ ìš°ì„ 
                    const biologicalCategories = ['MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN'];
                    for (const bioCategory of biologicalCategories) {
                        if (firstAnimalData[bioCategory] === true) {
                            console.log(`  â†’ ëŒ€í‘œ ë²”ì£¼ë¡œ '${CATEGORIES[bioCategory]}' ì„ íƒ (ì²« ë™ë¬¼ì˜ ìƒë¬¼í•™ì  ë¶„ë¥˜)`);
                            usedCategories.add(bioCategory);
                            break;
                        }
                    }
                }
            });
            const categoryScore = usedCategories.size;
            console.log('\nì‚¬ìš©ëœ ë²”ì£¼ë“¤:', Array.from(usedCategories).map(cat => CATEGORIES[cat] || cat));
            console.log(`ì´ ë²”ì£¼ ì ìˆ˜: ${categoryScore}`);
            
            // 8. í´ëŸ¬ìŠ¤í„° ë¶„ì„
            const clusterSizes = clusters.map(c => c.size);
            const avgClusterSize = clusterSizes.length > 0 
                ? clusterSizes.reduce((sum, size) => sum + size, 0) / clusterSizes.length
                : 0;
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            // 9. ë¹„íš¨ìœ¨ì „í™˜ì ìˆ˜ëŠ” ì´ë¯¸ analyzeTransitionsAndClustersì—ì„œ ê³„ì‚°ë¨
            // (í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì „í™˜ì´ ë°œìƒí•œ íšŸìˆ˜)
            
            // 10. 30ì´ˆ ë°˜ì‘ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚°
            const first30SecResponses = allResponses.filter(r => 
                (r.timeRange === '0-15' || r.timeRange === '15-30')
            );
            
            // 30ì´ˆ ë°˜ì‘ ì¤‘ ì •ë°˜ì‘ë§Œ í•„í„°
            const first30SecValidResponses = first30SecResponses.filter(r => r.normalizedResponse !== null);
            
            // 30ì´ˆ ë³´ì† ì ìˆ˜
            const first30SecResponseCount = {};
            first30SecValidResponses.forEach(r => {
                first30SecResponseCount[r.normalizedResponse] = (first30SecResponseCount[r.normalizedResponse] || 0) + 1;
            });
            const first30SecPerseverationScore = Object.values(first30SecResponseCount)
                .filter(count => count > 1)
                .reduce((sum, count) => sum + (count - 1), 0);
            
            // 30ì´ˆ ì¹¨íˆ¬ ì ìˆ˜
            const first30SecIntrusionScore = first30SecResponses.filter(r => r.normalizedResponse === null).length;
            
            // 30ì´ˆ ì „í™˜ ë¶„ì„
            const { transitions: first30SecTransitions, clusters: first30SecClusters, switchingScore: first30SecSwitchingScore, inefficientSwitchingScore: first30SecInefficient } = 
                analyzeTransitionsAndClusters(first30SecValidResponses);
            
            // 30ì´ˆ ë²”ì£¼ ì ìˆ˜
            const first30SecUsedCategories = new Set();
            first30SecClusters.forEach(cluster => {
                if (cluster.commonCategories.length > 0) {
                    first30SecUsedCategories.add(cluster.commonCategories[0]);
                }
            });
            const first30SecCategoryScore = first30SecUsedCategories.size;
            
            // 30ì´ˆ ë¹„íš¨ìœ¨ì „í™˜ ì ìˆ˜ëŠ” ì´ë¯¸ analyzeTransitionsAndClustersì—ì„œ ê³„ì‚°ë¨
            
            // 30ì´ˆ í‰ê·  ë²”ì£¼í¬ê¸°ì™€ ìµœëŒ€ë²”ì£¼í¬ê¸° ê³„ì‚°
            const first30SecClusterSizes = first30SecClusters.map(c => c.size);
            const first30SecAvgClusterSize = first30SecClusterSizes.length > 0 
                ? first30SecClusterSizes.reduce((sum, size) => sum + size, 0) / first30SecClusterSizes.length
                : 0;
            const first30SecMaxClusterSize = Math.max(...first30SecClusterSizes, 0);
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('firstHalfScore').textContent = firstHalfScore;
            document.getElementById('secondHalfScore').textContent = secondHalfScore;
            
            // ì •ìƒê·œì¤€ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚° ë° í‘œì‹œ
            try {
                const age = parseInt(document.getElementById('age').value);
                const education = parseInt(document.getElementById('education').value);
                
                if (age && education !== null && education !== undefined && !isNaN(education)) {
                    console.log('ì •ìƒê·œì¤€ ê³„ì‚° ì‹œì‘ - ë‚˜ì´:', age, 'êµìœ¡ë…„ìˆ˜:', education);
                    normScores = calculateNormativeScores(totalScore, age, education);
                    
                    if (normScores) {
                        // ë³„ë„ ì¹´ë“œì— Zì ìˆ˜ì™€ í¼ì„¼íƒ€ì¼ í‘œì‹œ
                        const zScoreElement = document.getElementById('totalZScore');
                        const percentileElement = document.getElementById('totalPercentile');
                        const normInfoElement = document.getElementById('normInfo');
                        
                        if (zScoreElement && percentileElement) {
                            const zScoreText = normScores.zScore.toFixed(2);
                            const percentileText = normScores.percentile.toFixed(1);
                            
                            zScoreElement.textContent = zScoreText;
                            // Zì ìˆ˜ê°€ -1.5 ì´í•˜ì¼ ë•Œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                            if (normScores.zScore <= -1.5) {
                                zScoreElement.classList.add('low-z-score');
                            } else {
                                zScoreElement.classList.remove('low-z-score');
                            }
                            // ë¶€ë“±í˜¸ í‘œì‹œì™€ ì‹¤ì œ í¼ì„¼íƒ€ì¼ ê°’
                            const percentileCategory = normScores.isBelow5Percentile ? '<5' : 'â‰¥5';
                            percentileElement.textContent = `${percentileCategory} (${Math.round(normScores.percentile)})`;
                            
                            // 5í¼ì„¼íƒ€ì¼ ì´í•˜ì¸ ê²½ìš° ë¹¨ê°„ìƒ‰ í‘œì‹œ
                            if (normScores.isBelow5Percentile) {
                                percentileElement.style.color = '#d32f2f';
                            } else {
                                percentileElement.style.color = '';
                            }
                        }
                        
                        // normInfoëŠ” ì´ì œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìˆ¨ê¹€
                        if (normInfoElement) {
                            normInfoElement.style.display = 'none';
                        }
                    }
                } else {
                    console.log('ë‚˜ì´ ë˜ëŠ” êµìœ¡ë…„ìˆ˜ê°€ ì…ë ¥ë˜ì§€ ì•Šì•„ ì •ìƒê·œì¤€ ê³„ì‚°ì„ ê±´ë„ˆëœë‹ˆë‹¤');
                    // ì •ìƒê·œì¤€ ì •ë³´ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’ í‘œì‹œ
                    const zScoreElement = document.getElementById('totalZScore');
                    const percentileElement = document.getElementById('totalPercentile');
                    if (zScoreElement) {
                        zScoreElement.textContent = '-';
                        zScoreElement.classList.remove('low-z-score');
                    }
                    if (percentileElement) {
                        percentileElement.textContent = '-';
                        percentileElement.style.color = '';
                    }
                }
            } catch (normError) {
                console.error('ì •ìƒê·œì¤€ ê³„ì‚° ì¤‘ ì˜¤ë¥˜:', normError);
                // ì •ìƒê·œì¤€ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë‚˜ë¨¸ì§€ ì ìˆ˜ëŠ” í‘œì‹œë˜ë„ë¡ ê³„ì† ì§„í–‰
            }
            document.getElementById('perseverationScore').textContent = perseverationScore;
            document.getElementById('intrusionScore').textContent = intrusionScore;
            document.getElementById('switchingScore').textContent = switchingScore;
            document.getElementById('inefficientSwitchingScore').textContent = inefficientSwitchingScore;
            document.getElementById('categoryScore').textContent = categoryScore;
            document.getElementById('avgClusterSize').textContent = avgClusterSize.toFixed(1);
            document.getElementById('maxClusterSize').textContent = maxClusterSize;
            
            // 30ì´ˆ ê¸°ë°˜ ì ìˆ˜ í‘œì‹œ
            document.getElementById('first30SecPerseverationScore').textContent = first30SecPerseverationScore;
            document.getElementById('first30SecIntrusionScore').textContent = first30SecIntrusionScore;
            document.getElementById('first30SecSwitchingScore').textContent = first30SecSwitchingScore;
            document.getElementById('first30SecCategoryScore').textContent = first30SecCategoryScore;
            document.getElementById('first30SecInefficient').textContent = first30SecInefficient;
            const first30SecAvgElement = document.getElementById('first30SecAvgClusterSize');
            if (first30SecAvgElement) {
                first30SecAvgElement.textContent = first30SecAvgClusterSize.toFixed(1);
            }
            const first30SecMaxElement = document.getElementById('first30SecMaxClusterSize');
            if (first30SecMaxElement) {
                first30SecMaxElement.textContent = first30SecMaxClusterSize;
            }
            
            // ì ìˆ˜ ê³„ì‚° ìƒì„¸ ê³¼ì • í‘œ í‘œì‹œ - ì œê±°ë¨ (í´ëŸ¬ìŠ¤í„° ë¶„ì„ í‘œì— í†µí•©)
            /*
            const detailTableHtml = `
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>ì‹œê°„ëŒ€</th>
                            <th>ë°˜ì‘ ë‹¨ì–´</th>
                            <th>ë°˜ì‘ ìœ í˜•</th>
                            <th>ì „í™˜ ì—¬ë¶€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateDetailTableRows()}
                    </tbody>
                </table>
            `;
            */
            
            // ìƒì„¸ í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
            function generateDetailTableRows() {
                const timeRanges = ['0-15', '15-30', '30-45', '45-60'];
                let rows = '';
                let transitionIndex = 0;
                
                // ë³´ì† ë°˜ì‘ ì¶”ì ì„ ìœ„í•œ ë§µ
                const seenAnimals = new Map();
                allResponses.forEach((response, idx) => {
                    if (response.normalizedResponse !== null) {
                        if (!seenAnimals.has(response.normalizedResponse)) {
                            seenAnimals.set(response.normalizedResponse, []);
                        }
                        seenAnimals.get(response.normalizedResponse).push(idx);
                    }
                });
                
                timeRanges.forEach(range => {
                    const rangeResponses = allResponses.filter(r => r.timeRange === range);
                    if (rangeResponses.length === 0) return;
                    
                    rangeResponses.forEach((response, idx) => {
                        const isFirstInRange = idx === 0;
                        const globalIndex = allResponses.findIndex(r => r === response);
                        
                        // ë°˜ì‘ ìœ í˜• ê²°ì •
                        let responseType = 'ì •ë°˜ì‘';
                        if (response.normalizedResponse === null) {
                            responseType = 'ì¹¨íˆ¬';
                        } else if (seenAnimals.get(response.normalizedResponse) && 
                                 seenAnimals.get(response.normalizedResponse).indexOf(globalIndex) > 0) {
                            responseType = 'ë³´ì†';
                        }
                        
                        // ì „í™˜ ì—¬ë¶€ í™•ì¸
                        let transitionInfo = '';
                        let categoryInfo = '';
                        
                        // ì¹¨íˆ¬ ë°˜ì‘ì€ ì „í™˜ ë¶„ì„ì—ì„œ ì œì™¸ë¨
                        if (responseType === 'ì¹¨íˆ¬') {
                            transitionInfo = 'ë™ë¬¼ì— í•´ë‹¹í•˜ì§€ ì•ŠìŒ';
                        } else if (transitionIndex < transitions.length && 
                            transitions[transitionIndex].animal === response.response) {
                            const trans = transitions[transitionIndex];
                            
                            // í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ ê³µìœ  ë²”ì£¼ ì°¾ê¸°
                            const currentCluster = clusters.find(c => 
                                c.animals.some(a => a.animal === response.response)
                            );
                            
                            if (trans.isSwitch) {
                                transitionInfo = `ì „í™˜ #${trans.switchNumber}`;
                                // ì „í™˜ ì‹œ ì „í™˜ëœ ì²« ë‹¨ì–´ê°€ ì†í•œ ëª¨ë“  ë²”ì£¼ í‘œì‹œ
                                const animalData = ANIMAL_CATEGORIES[response.normalizedResponse];
                                if (animalData) {
                                    const allCategories = [];
                                    for (const [cat, value] of Object.entries(animalData)) {
                                        if (value === true) {
                                            allCategories.push(CATEGORIES[cat]);
                                        }
                                    }
                                    if (allCategories.length > 0) {
                                        categoryInfo = ` (${allCategories.join(', ')})`;
                                    }
                                }
                            } else if (trans.index === 1) {
                                transitionInfo = 'ì‹œì‘';
                                // ì‹œì‘ ì‹œ í•´ë‹¹ ë™ë¬¼ì˜ ëª¨ë“  ë²”ì£¼ í‘œì‹œ
                                const animalData = ANIMAL_CATEGORIES[response.normalizedResponse];
                                if (animalData) {
                                    const allCategories = [];
                                    for (const [cat, value] of Object.entries(animalData)) {
                                        if (value === true) {
                                            allCategories.push(CATEGORIES[cat]);
                                        }
                                    }
                                    if (allCategories.length > 0) {
                                        categoryInfo = ` (${allCategories.join(', ')})`;
                                    }
                                }
                            } else {
                                transitionInfo = 'ìœ ì§€';
                                if (trans.sharedWithPrev && trans.sharedWithPrev.length > 0) {
                                    categoryInfo = ` (${trans.sharedWithPrev.map(cat => CATEGORIES[cat]).join(', ')})`;
                                }
                            }
                            transitionIndex++;
                        }
                        
                        rows += `
                            <tr>
                                ${isFirstInRange ? `<td rowspan="${rangeResponses.length}">${range}ì´ˆ</td>` : ''}
                                <td>${response.order}. ${response.response}</td>
                                <td class="${responseType === 'ì¹¨íˆ¬' ? 'intrusion' : responseType === 'ë³´ì†' ? 'perseveration' : 'valid'}">${responseType}</td>
                                <td class="${transitionInfo.includes('ì „í™˜') ? 'switch' : ''}">${transitionInfo}${categoryInfo}</td>
                            </tr>
                        `;
                    });
                });
                
                return rows;
            }
            
            // switchingAnalysis ì œê±° - í´ëŸ¬ìŠ¤í„° ë¶„ì„ í‘œì— í†µí•©ë¨
            // const switchingAnalysisHtml = detailTableHtml;
            // document.getElementById('switchingAnalysis').innerHTML = switchingAnalysisHtml;
            // console.log('switchingAnalysis í‘œì‹œ ì™„ë£Œ');
            
            // í´ëŸ¬ìŠ¤í„° ë° ë²”ì£¼ ë¶„ì„ í‘œ í‘œì‹œ
            // ë²”ì£¼ íŒì • ê³¼ì • ìƒì„¸ í‘œì‹œ
            console.log('ë²”ì£¼ íŒì • ê³¼ì • í‘œì‹œ ì‹œì‘...');
            const categoryProcessHtml = `
                <div>
                    <h4 style="text-align: center; color: #616161; margin-bottom: 20px; font-size: 20px;">
                        ë¶„ì„ ê³¼ì •
                    </h4>
                    ${generateCategoryProcessDetail()}
                </div>
            `;
            console.log('categoryProcessHtml ìƒì„± ì™„ë£Œ');
            
            const clusterTableHtml = ``;
            
            // í´ëŸ¬ìŠ¤í„° í…Œì´ë¸” í–‰ ìƒì„± í•¨ìˆ˜
            function generateClusterTableRows() {
                let rows = '';
                
                clusters.forEach((cluster, idx) => {
                    // ê³µí†µ ë²”ì£¼ í‘œì‹œ
                    const commonCategoriesStr = cluster.commonCategories.map(cat => CATEGORIES[cat]).join(', ') || 'ì—†ìŒ';
                    
                    // ëŒ€í‘œ ë²”ì£¼ ê²°ì •
                    let representativeCategory = '';
                    if (cluster.commonCategories.length > 0) {
                        representativeCategory = CATEGORIES[cluster.commonCategories[0]];
                    } else if (cluster.animals.length > 0) {
                        const firstAnimalData = ANIMAL_CATEGORIES[cluster.animals[0]] || {};
                        const biologicalCategories = ['MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN'];
                        for (const bioCategory of biologicalCategories) {
                            if (firstAnimalData[bioCategory] === true) {
                                representativeCategory = CATEGORIES[bioCategory];
                                break;
                            }
                        }
                    }
                    
                    const animalsList = cluster.animals.join(', ');
                    
                    rows += `
                        <tr>
                            <td style="text-align: center; font-weight: bold;">í´ëŸ¬ìŠ¤í„° ${idx + 1}<br>(í¬ê¸°: ${cluster.size})</td>
                            <td>${animalsList}</td>
                            <td style="color: #666;">${commonCategoriesStr}</td>
                            <td style="color: #2196f3; font-weight: bold;">${representativeCategory || '-'}</td>
                        </tr>
                    `;
                });
                
                return rows;
            }
            
            // ë²”ì£¼ íŒì • ê³¼ì • ìƒì„¸ í‘œì‹œ í•¨ìˆ˜
            function generateCategoryProcessDetail() {
                console.log('generateCategoryProcessDetail í˜¸ì¶œë¨');
                console.log('allResponses:', allResponses);
                console.log('clusters:', clusters);
                
                let html = '<div style="font-size: 14px; line-height: 1.8;">';
                
                // ë‹¨ì–´ë³„ ë²”ì£¼ íŒì • ê³¼ì • í…Œì´ë¸”
                html += `<table class="detail-table" style="margin-bottom: 20px; width: 100%; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr>
                            <th>ìˆœì„œ</th>
                            <th>ì‹œê°„ëŒ€</th>
                            <th>ë‹¨ì–´</th>
                            <th>ë°˜ì‘ìœ í˜•</th>
                            <th>ë³´ìœ  ë²”ì£¼</th>
                            <th>í´ëŸ¬ìŠ¤í„° ê³µí†µë²”ì£¼</th>
                            <th>ê²¹ì¹˜ëŠ” ë²”ì£¼</th>
                            <th>íŒì •</th>
                            <th>í´ëŸ¬ìŠ¤í„°</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                // ëª¨ë“  ë°˜ì‘ì— ëŒ€í•œ ìƒì„¸ ë¶„ì„ ì •ë³´ ìƒì„±
                let currentClusterIdx = 0;
                let processedAnimals = 0;
                const seenAnimals = {};
                
                if (!allResponses || allResponses.length === 0) {
                    html += '<tr><td colspan="9" style="text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    allResponses.forEach((response, idx) => {
                    const animal = response.normalizedResponse;
                    const originalAnimal = response.originalResponse || response.response;
                    
                    // ì‹œê°„ëŒ€ ë§¤í•‘
                    const timeRange = response.timeRange || '';
                    const timeRangeDisplay = timeRange === '0-15' ? '0-15ì´ˆ' :
                                           timeRange === '15-30' ? '15-30ì´ˆ' :
                                           timeRange === '30-45' ? '30-45ì´ˆ' :
                                           timeRange === '45-60' ? '45-60ì´ˆ' : '';
                    
                    // ë°˜ì‘ìœ í˜• íŒì •
                    let responseType = '';
                    let rowColor = '#f0f0f0';
                    
                    if (animal === null) {
                        // ì¹¨íˆ¬ë°˜ì‘
                        responseType = '<span style="color: #f44336; font-weight: bold;">ì¹¨íˆ¬</span>';
                        rowColor = '#ffebee';
                        
                        html += `<tr style="background-color: ${rowColor};">
                            <td style="text-align: center;">${idx + 1}</td>
                            <td style="text-align: center;">${timeRangeDisplay}</td>
                            <td><strong>${originalAnimal}</strong></td>
                            <td style="text-align: center;">${responseType}</td>
                            <td colspan="5" style="text-align: center; color: #999;">ë™ë¬¼ì´ ì•„ë‹˜</td>
                        </tr>`;
                        return;
                    }
                    
                    // ë³´ì†ë°˜ì‘ ì²´í¬
                    seenAnimals[animal] = (seenAnimals[animal] || 0) + 1;
                    if (seenAnimals[animal] > 1) {
                        responseType = '<span style="color: #ff9800; font-weight: bold;">ë³´ì†</span>';
                        rowColor = '#fff3e0';
                        
                        html += `<tr style="background-color: ${rowColor};">
                            <td style="text-align: center;">${idx + 1}</td>
                            <td style="text-align: center;">${timeRangeDisplay}</td>
                            <td><strong>${animal}</strong></td>
                            <td style="text-align: center;">${responseType}</td>
                            <td colspan="5" style="text-align: center; color: #999;">ì¤‘ë³µ ë°˜ì‘ (${seenAnimals[animal]}ë²ˆì§¸)</td>
                        </tr>`;
                        return;
                    }
                    
                    // ì •ë°˜ì‘ ì²˜ë¦¬
                    responseType = '<span style="color: #4caf50;">ì •ë°˜ì‘</span>';
                    rowColor = '#f0f0f0';
                    processedAnimals++;
                    
                    const animalData = ANIMAL_CATEGORIES[animal] || {};
                    const categories = [];
                    for (const [cat, value] of Object.entries(animalData)) {
                        if (value === true) categories.push(cat);
                    }
                    
                    // í˜„ì¬ ë™ë¬¼ì´ ì†í•œ í´ëŸ¬ìŠ¤í„° ì°¾ê¸°
                    let belongsToCluster = null;
                    let clusterCommonCategories = [];
                    let overlappingCategories = [];
                    let decision = '';
                    
                    // ì²˜ë¦¬ëœ ì •ë°˜ì‘ ì¸ë±ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ì°¾ê¸°
                    let validAnimalIdx = processedAnimals - 1;
                    
                    for (let i = 0; i < clusters.length; i++) {
                        const cluster = clusters[i];
                        if (cluster.animals.includes(animal)) {
                            belongsToCluster = i + 1;
                            clusterCommonCategories = cluster.commonCategories;
                            
                            // ì´ì „ ì •ë°˜ì‘ ë™ë¬¼ê³¼ì˜ ê´€ê³„ í™•ì¸
                            if (validAnimalIdx > 0 && i === currentClusterIdx) {
                                // ê°™ì€ í´ëŸ¬ìŠ¤í„° ìœ ì§€
                                overlappingCategories = categories.filter(cat => 
                                    clusterCommonCategories.includes(cat)
                                );
                                decision = 'ìœ ì§€';
                            } else if (validAnimalIdx > 0 && i !== currentClusterIdx) {
                                // ì „í™˜ ë°œìƒ
                                decision = 'ì „í™˜';
                                currentClusterIdx = i;
                            } else if (validAnimalIdx === 0) {
                                // ì²« ì •ë°˜ì‘ ë™ë¬¼
                                decision = 'ì‹œì‘';
                                currentClusterIdx = i;
                                overlappingCategories = categories;
                            }
                            break;
                        }
                    }
                    
                    // ì „í™˜ íŒì •ì— ë”°ë¥¸ í–‰ ìƒ‰ìƒ
                    if (decision === 'ì „í™˜') {
                        rowColor = '#ffe0e0';
                    } else if (decision === 'ì‹œì‘') {
                        rowColor = '#e0ffe0';
                    }
                    
                    html += `<tr style="background-color: ${rowColor};">
                        <td style="text-align: center;">${idx + 1}</td>
                        <td style="text-align: center;">${timeRangeDisplay}</td>
                        <td><strong>${animal}</strong></td>
                        <td style="text-align: center;">${responseType}</td>
                        <td>${categories.map(c => CATEGORIES[c]).join(', ')}</td>
                        <td>${clusterCommonCategories.map(c => CATEGORIES[c]).join(', ') || '-'}</td>
                        <td>${overlappingCategories.map(c => CATEGORIES[c]).join(', ') || 'ì—†ìŒ'}</td>
                        <td style="text-align: center; font-weight: bold; color: ${decision === 'ì „í™˜' ? '#d32f2f' : decision === 'ì‹œì‘' ? '#4caf50' : '#2196f3'};">
                            ${decision}
                            ${decision === 'ì „í™˜' && clusters[currentClusterIdx-1]?.size === 1 ? 
                              '<span style="background: #ffeb3b; padding: 2px 6px; border-radius: 3px; color: #333; font-size: 11px; margin-left: 5px;">ë¹„íš¨ìœ¨</span>' : ''}
                        </td>
                        <td style="text-align: center;">í´ëŸ¬ìŠ¤í„° ${belongsToCluster}</td>
                    </tr>`;
                    });
                }
                
                html += '</tbody></table>';
                
                html += '</div>';
                return html;
            }
            
            console.log('clusterAnalysisì— ë‚´ìš© ì„¤ì • ì‹œì‘...');
            const clusterAnalysisElement = document.getElementById('clusterAnalysis');
            if (clusterAnalysisElement) {
                clusterAnalysisElement.innerHTML = categoryProcessHtml;
                console.log('clusterAnalysis ë‚´ìš© ì„¤ì • ì™„ë£Œ');
            } else {
                console.error('clusterAnalysis ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            // íŒ¨í„´ ë¶„ì„ ë° í•´ì„ í‘œì‹œ
            console.log('íŒ¨í„´ ë¶„ì„ ì‹œì‘...');
            const patternAnalysisResult = analyzePerformancePattern({
                totalScore,
                firstHalfScore,
                secondHalfScore,
                perseverationScore,
                intrusionScore,
                numberOfClusters: clusters.length,
                meanClusterSize: avgClusterSize,
                switching: switchingScore,
                hardSwitching: inefficientSwitchingScore,
                normScores: normScores
            });
            
            const patternAnalysisElement = document.getElementById('patternAnalysis');
            if (patternAnalysisElement) {
                patternAnalysisElement.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <span style="font-weight: bold; color: #1565c0;">íŒì • íŒ¨í„´:</span>
                        <span style="font-size: 18px; font-weight: bold; color: #d32f2f; margin-left: 10px;">
                            ${patternAnalysisResult.pattern}
                        </span>
                    </div>
                    <div style="line-height: 1.8; color: #333;">
                        ${patternAnalysisResult.interpretation}
                    </div>
                `;
                console.log('íŒ¨í„´ ë¶„ì„ ë‚´ìš© ì„¤ì • ì™„ë£Œ');
            }
            
            
            
            // ì…ë ¥ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelector('.container').style.display = 'none';
            
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            const resultsElement = document.getElementById('results');
            resultsElement.style.display = 'block';
            resultsElement.style.visibility = 'visible';
            resultsElement.style.opacity = '1';
            
            // ê°•ì œë¡œ ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
            resultsElement.offsetHeight;
            
            // ê²°ê³¼ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
            
            console.log('calculateScores í•¨ìˆ˜ ì™„ë£Œ');
            
            } catch (error) {
                console.error('calculateScores ì—ëŸ¬:', error);
                alert('ì ìˆ˜ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // íŒ¨í„´ ë¶„ì„ ë° í•´ì„ ìƒì„±
        function analyzePerformancePattern(scores) {
            const { 
                totalScore, 
                firstHalfScore, 
                secondHalfScore, 
                perseverationScore, 
                intrusionScore,
                numberOfClusters,
                meanClusterSize,
                switching,
                hardSwitching
            } = scores;
            
            // normScoresëŠ” scores ê°ì²´ì—ì„œ ë³„ë„ë¡œ ê°€ì ¸ì˜¤ê¸°
            const normScores = scores.normScores || null;
            
            // ì •ìƒ ë²”ìœ„ ê¸°ì¤€ (ì˜ˆì‹œê°’ - ì‹¤ì œ ì—°êµ¬ ê¸°ì¤€ì— ë”°ë¼ ì¡°ì • í•„ìš”)
            const norms = {
                totalScore: { low: 12, borderline: 15, normal: 18 },
                firstHalfScore: { low: 7, normal: 10 },
                secondHalfScore: { low: 5, normal: 8 },
                perseverationScore: { normal: 2, high: 4 },
                intrusionScore: { normal: 1, high: 2 },
                numberOfClusters: { low: 3, normal: 5 },
                meanClusterSize: { low: 2.5, normal: 3.5 },
                switching: { low: 4, normal: 6 },
                hardSwitching: { normal: 2, high: 4 }
            };
            
            // íŒ¨í„´ íŒì •
            let pattern = '';
            let interpretation = '';
            
            // 1. ì •ìƒ ìˆ˜í–‰ íŒ¨í„´
            if (totalScore >= norms.totalScore.normal && 
                perseverationScore <= norms.perseverationScore.normal && 
                intrusionScore <= norms.intrusionScore.normal &&
                numberOfClusters >= norms.numberOfClusters.normal) {
                pattern = 'ì •ìƒ ìˆ˜í–‰ íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œì˜ ë™ë¬¼ì„ ì‚°ì¶œí•˜ì—¬ ì •ìƒ ë²”ìœ„ì˜ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì „ë°˜ 30ì´ˆì™€ í›„ë°˜ 30ì´ˆ ëª¨ë‘ ì ì ˆí•œ ì‚°ì¶œì„ ë³´ì˜€ìœ¼ë©°, ì˜¤ë¥˜ëŠ” ê´€ì°°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì˜ë¯¸ ë²”ì£¼í™”ì™€ ì „í™˜ ëŠ¥ë ¥ì´ ëª¨ë‘ ì–‘í˜¸í•˜ì—¬ ì •ìƒì ì¸ ì–¸ì–´ìœ ì°½ì„±ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.`;
            }
            // 2. ì „í˜•ì  ì¹˜ë§¤ íŒ¨í„´
            else if (totalScore < norms.totalScore.low && 
                     firstHalfScore < norms.firstHalfScore.low && 
                     secondHalfScore < norms.secondHalfScore.low &&
                     perseverationScore > norms.perseverationScore.high &&
                     numberOfClusters < norms.numberOfClusters.low) {
                pattern = 'ì „í˜•ì  ì¹˜ë§¤ íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œë§Œì„ ì‚°ì¶œí•˜ì—¬ í˜„ì €íˆ ì €í•˜ëœ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì „ë°˜ë¶€ì™€ í›„ë°˜ë¶€ ëª¨ë‘ì—ì„œ ì‚°ì¶œì´ ì œí•œì ì´ì—ˆìœ¼ë©°, ë™ì¼í•œ ë™ë¬¼ì„ ë°˜ë³µí•´ì„œ ë§í•˜ëŠ” ë³´ì†ì˜¤ë¥˜ê°€ ë‹¤ìˆ˜ ê´€ì°°ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ë¯¸ ë²”ì£¼ í˜•ì„±ì´ ì œí•œì ì´ê³  ë²”ì£¼ ê°„ ì „í™˜ì´ ì–´ë ¤ì›Œ ì˜ë¯¸ê¸°ì–µ ì €ì¥ì†Œ ì ‘ê·¼ì˜ ì–´ë ¤ì›€ ë˜ëŠ” ì „ë‘ì—½ ê¸°ëŠ¥ ì €í•˜ê°€ ì‹œì‚¬ë©ë‹ˆë‹¤.`;
            }
            // 3. ì „ë‘ì—½ ê¸°ëŠ¥ì¥ì•  íŒ¨í„´
            else if (totalScore < norms.totalScore.normal && 
                     firstHalfScore >= norms.firstHalfScore.normal && 
                     secondHalfScore < norms.secondHalfScore.low &&
                     numberOfClusters < norms.numberOfClusters.low &&
                     switching < norms.switching.low) {
                pattern = 'ì „ë‘ì—½ ê¸°ëŠ¥ì¥ì•  íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œë¥¼ ì‚°ì¶œí•˜ì—¬ ì €í•˜ëœ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ˆë°˜ì—ëŠ” ë¹„êµì  ì ì ˆí•œ ì‚°ì¶œì„ ë³´ì˜€ìœ¼ë‚˜ ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ í˜„ì €íˆ ê°ì†Œí•˜ëŠ” ì–‘ìƒì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì˜ë¯¸ ë²”ì£¼ ìˆ˜ì™€ ì „í™˜ íšŸìˆ˜ê°€ ì œí•œì ì´ì–´ì„œ ì¸ì§€ì  ìœ ì—°ì„± ì €í•˜ì™€ ì§€ì†ì ì¸ íƒìƒ‰ ì „ëµ ìœ ì§€ì˜ ì–´ë ¤ì›€ì´ ì‹œì‚¬ë©ë‹ˆë‹¤.`;
            }
            // 4. í”¼ì§ˆí•˜ íŒ¨í„´
            else if (totalScore < norms.totalScore.normal && 
                     intrusionScore > norms.intrusionScore.high &&
                     meanClusterSize < norms.meanClusterSize.low &&
                     hardSwitching > norms.hardSwitching.high) {
                pattern = 'í”¼ì§ˆí•˜ íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œë¥¼ ì‚°ì¶œí•˜ì—¬ ì €í•˜ëœ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ë™ë¬¼ì´ ì•„ë‹Œ ë‹¨ì–´ë“¤ì´ ì¹¨íˆ¬í•˜ëŠ” ì˜¤ë¥˜ê°€ ë‹¤ìˆ˜ ê´€ì°°ë˜ì—ˆìœ¼ë©°, ê° ë²”ì£¼ ë‚´ ì‚°ì¶œì´ ì œí•œì ì´ê³  ë¹„íš¨ìœ¨ì ì¸ ì „í™˜ì´ ë§ì•„ ì£¼ì˜ë ¥ ì¡°ì ˆê³¼ ì–µì œ ê¸°ëŠ¥ì˜ ì–´ë ¤ì›€ì´ ì‹œì‚¬ë©ë‹ˆë‹¤.`;
            }
            // 5. ê²½ë„ì¸ì§€ì¥ì•  íŒ¨í„´
            else if (totalScore >= norms.totalScore.borderline && 
                     totalScore < norms.totalScore.normal &&
                     secondHalfScore < norms.secondHalfScore.normal &&
                     perseverationScore <= norms.perseverationScore.normal &&
                     numberOfClusters >= norms.numberOfClusters.normal &&
                     meanClusterSize < norms.meanClusterSize.normal) {
                pattern = 'ê²½ë„ì¸ì§€ì¥ì•  íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œë¥¼ ì‚°ì¶œí•˜ì—¬ ê²½ê³„ì„  ìˆ˜ì¤€ì˜ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ˆë°˜ì—ëŠ” ì ì ˆí•œ ì‚°ì¶œì„ ë³´ì˜€ìœ¼ë‚˜ í›„ë°˜ë¶€ì— ê°ì†Œí•˜ëŠ” ì–‘ìƒì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ë²”ì£¼ ìˆ˜ëŠ” ìœ ì§€ë˜ë‚˜ ê° ë²”ì£¼ ë‚´ ì‚°ì¶œì´ ë‹¤ì†Œ ì œí•œì ì´ì–´ì„œ ì˜ë¯¸ê¸°ì–µ ì €ì¥ì†Œì˜ ê²½ë¯¸í•œ ì†ìƒ ê°€ëŠ¥ì„±ì´ ì‹œì‚¬ë©ë‹ˆë‹¤.`;
            }
            // 6. ìš°ìš¸ì¦ ê´€ë ¨ íŒ¨í„´
            else if (totalScore < norms.totalScore.normal && 
                     firstHalfScore < norms.firstHalfScore.normal &&
                     perseverationScore === 0 && 
                     intrusionScore === 0 &&
                     numberOfClusters >= norms.numberOfClusters.normal &&
                     switching < norms.switching.normal) {
                pattern = 'ìš°ìš¸ì¦ ê´€ë ¨ íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œë¥¼ ì‚°ì¶œí•˜ì—¬ ì €í•˜ëœ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ì˜¤ë¥˜ëŠ” ì—†ì—ˆìœ¼ë‚˜ ì „ë°˜ì ìœ¼ë¡œ ì‚°ì¶œì´ ëŠë¦¬ê³  ë²”ì£¼ ê°„ ì „í™˜ì´ ì œí•œì ì´ì–´ì„œ ì •ì‹ ìš´ë™ì†ë„ ì €í•˜ì™€ ì¸ì§€ì  ì£¼ë„ì„± ê°ì†Œê°€ ì‹œì‚¬ë©ë‹ˆë‹¤.`;
            }
            // ê¸°íƒ€ íŒ¨í„´
            else {
                pattern = 'ë¹„íŠ¹ì´ì  íŒ¨í„´';
                interpretation = `ë™ë¬¼ ì´ë¦„ëŒ€ê¸° ê³¼ì œì—ì„œ ì´ ${totalScore}ê°œë¥¼ ì‚°ì¶œí•˜ì˜€ìŠµë‹ˆë‹¤. ìˆ˜í–‰ íŒ¨í„´ì´ íŠ¹ì • ì§„ë‹¨êµ°ì˜ ì „í˜•ì ì¸ ì–‘ìƒê³¼ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì¢…í•©ì ì¸ ì„ìƒ í‰ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.`;
            }
            
            // ì •ìƒê·œì¤€ ì •ë³´ ì¶”ê°€
            if (normScores) {
                const zScoreText = normScores.zScore.toFixed(2);
                const percentileText = normScores.percentile.toFixed(1);
                const normInterpretation = normScores.isBelow5Percentile 
                    ? `ì •ìƒê·œì¤€(í‰ê· : ${normScores.mean.toFixed(1)}, í‘œì¤€í¸ì°¨: ${normScores.sd.toFixed(1)})ê³¼ ë¹„êµ ì‹œ Zì ìˆ˜ ${zScoreText}, ë°±ë¶„ìœ„ ${percentileText}%ileë¡œ 5í¼ì„¼íƒ€ì¼ ì´í•˜ì— í•´ë‹¹í•˜ì—¬ ìœ ì˜ë¯¸í•œ ì €í•˜ë¥¼ ì‹œì‚¬í•©ë‹ˆë‹¤.`
                    : `ì •ìƒê·œì¤€(í‰ê· : ${normScores.mean.toFixed(1)}, í‘œì¤€í¸ì°¨: ${normScores.sd.toFixed(1)})ê³¼ ë¹„êµ ì‹œ Zì ìˆ˜ ${zScoreText}, ë°±ë¶„ìœ„ ${percentileText}%ileì— í•´ë‹¹í•©ë‹ˆë‹¤.`;
                
                interpretation += ` ${normInterpretation}`;
            }
            
            return {
                pattern: pattern,
                interpretation: interpretation
            };
        }
        
        // ì…ë ¥ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function backToInput() {
            // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('results').style.display = 'none';
            document.getElementById('analysisDetails').style.display = 'none';
            
            // ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
            document.querySelector('.container').style.display = 'block';
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        }
        
        // ë¶„ì„ ê³¼ì • ë³´ê¸°
        function showAnalysisDetails() {
            // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('results').style.display = 'none';
            
            // ë¶„ì„ ê³¼ì • ì„¹ì…˜ í‘œì‹œ
            document.getElementById('analysisDetails').style.display = 'block';
            
            // ë¶„ì„ ê³¼ì • ë‚´ìš© ë³µì‚¬
            const clusterContent = document.getElementById('clusterAnalysis').innerHTML;
            document.getElementById('analysisContent').innerHTML = clusterContent;
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        }
        
        // ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°
        function backToResults() {
            // ë¶„ì„ ê³¼ì • ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('analysisDetails').style.display = 'none';
            
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('results').style.display = 'block';
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        }
        
        // =====================================================
        // ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // =====================================================
        
        let editingAnimal = null;
        let currentVariants = []; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë™ë¬¼ì˜ ë³€í˜• ëª…ì¹­ë“¤
        
        // ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ í™”ë©´ í‘œì‹œ
        function showDatabaseManagement() {
            const dbSection = document.querySelector('.database-management');
            const resultsSection = document.getElementById('results');
            const containerSection = document.querySelector('.container');
            
            // ë‹¤ë¥¸ ì„¹ì…˜ë“¤ ìˆ¨ê¸°ê¸°
            resultsSection.style.display = 'none';
            containerSection.style.display = 'none';
            
            // ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì„¹ì…˜ í‘œì‹œ
            dbSection.style.display = 'block';
            updateDatabaseStats();
            displayAllAnimals();
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ í™”ë©´ ë‹«ê¸°
        function closeDatabaseManagement() {
            const dbSection = document.querySelector('.database-management');
            const containerSection = document.querySelector('.container');
            
            // ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            dbSection.style.display = 'none';
            
            // ì…ë ¥ í™”ë©´ í‘œì‹œ
            containerSection.style.display = 'block';
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        }
        
        // ë™ë¬¼ ì¶”ê°€ í¼ í‘œì‹œ
        function showAddAnimalForm() {
            editingAnimal = null;
            currentVariants = [];
            document.getElementById('formTitle').textContent = 'ìƒˆ ë™ë¬¼ ì¶”ê°€';
            document.getElementById('animalName').value = '';
            clearAllCheckboxes();
            displayVariants();
            document.getElementById('animalForm').style.display = 'block';
        }
        
        // ë™ë¬¼ ìˆ˜ì • í¼ í‘œì‹œ
        function showEditAnimalForm(animalName) {
            editingAnimal = animalName;
            const animalData = ANIMAL_CATEGORIES[animalName];
            
            document.getElementById('formTitle').textContent = `'${animalName}' ìˆ˜ì •`;
            document.getElementById('animalName').value = animalName;
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì„¤ì •
            clearAllCheckboxes();
            for (const [category, value] of Object.entries(animalData)) {
                const checkbox = document.getElementById(`cat_${category}`);
                if (checkbox) {
                    checkbox.checked = value;
                }
            }
            
            // í˜„ì¬ ë™ë¬¼ì˜ ë³€í˜• ëª…ì¹­ë“¤ ë¡œë“œ
            loadAnimalVariants(animalName);
            
            document.getElementById('animalForm').style.display = 'block';
        }
        
        // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
        function clearAllCheckboxes() {
            const checkboxes = document.querySelectorAll('.category-checkboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // ë™ë¬¼ ì €ì¥
        function saveAnimal() {
            const animalName = document.getElementById('animalName').value.trim();
            if (!animalName) {
                alert('ë™ë¬¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¤‘ë³µ ì²´í¬ (ìˆ˜ì •ì´ ì•„ë‹Œ ê²½ìš°)
            if (!editingAnimal && ANIMAL_CATEGORIES[animalName]) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë™ë¬¼ì…ë‹ˆë‹¤.');
                return;
            }
            
            // ì¹´í…Œê³ ë¦¬ ë°ì´í„° ìˆ˜ì§‘
            const categories = [
                'MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN',
                'MARINE', 'FRESHWATER',
                'DOMESTIC', 'PET', 'WILD',
                'ZODIAC', 'MYTHOLOGY', 'PREHISTORIC'
            ];
            
            const animalData = {};
            categories.forEach(cat => {
                const checkbox = document.getElementById(`cat_${cat}`);
                animalData[cat] = checkbox ? checkbox.checked : false;
            });
            
            // ìˆ˜ì •ì¸ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
            if (editingAnimal && editingAnimal !== animalName) {
                delete ANIMAL_CATEGORIES[editingAnimal];
            }
            
            // ë°ì´í„° ì €ì¥
            ANIMAL_CATEGORIES[animalName] = animalData;
            
            // ë³€í˜• ëª…ì¹­ ì €ì¥ (animal-variants.jsê°€ ë¡œë“œë˜ì–´ ìˆê³  í•¨ìˆ˜ê°€ ìˆëŠ” ê²½ìš°)
            if (typeof animalVariants !== 'undefined' && typeof variantToBase !== 'undefined') {
                // ê¸°ì¡´ ë³€í˜• ëª…ì¹­ë“¤ ì œê±° (ì—­ë°©í–¥ ë§¤í•‘ì—ì„œ)
                if (editingAnimal && editingAnimal !== animalName) {
                    // ë™ë¬¼ ì´ë¦„ì´ ë³€ê²½ëœ ê²½ìš° ê¸°ì¡´ ë³€í˜•ë“¤ ì •ë¦¬
                    const oldVariants = getAnimalVariants ? getAnimalVariants(editingAnimal) : [];
                    if (oldVariants) {
                        oldVariants.forEach(variant => {
                            delete variantToBase[variant];
                        });
                    }
                    delete animalVariants[editingAnimal];
                }
                
                // ìƒˆë¡œìš´ ë³€í˜• ëª…ì¹­ë“¤ ì €ì¥
                if (currentVariants.length > 0) {
                    animalVariants[animalName] = {
                        base: animalName,
                        variants: [...currentVariants]
                    };
                    
                    // ì—­ë°©í–¥ ë§¤í•‘ ì—…ë°ì´íŠ¸
                    currentVariants.forEach(variant => {
                        variantToBase[variant] = animalName;
                    });
                } else {
                    // ë³€í˜• ëª…ì¹­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì—”íŠ¸ë¦¬ë§Œ ìœ ì§€
                    animalVariants[animalName] = {
                        base: animalName,
                        variants: []
                    };
                }
                
                // ê¸°ë³¸ ë™ë¬¼ëª…ë„ ìê¸° ìì‹ ì„ ê°€ë¦¬í‚¤ë„ë¡ ì„¤ì •
                variantToBase[animalName] = animalName;
            }
            
            // ì €ì¥ ì•Œë¦¼
            alert(editingAnimal ? 'ë™ë¬¼ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ ë™ë¬¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // í¼ ë‹«ê¸° ë° ëª©ë¡ ì—…ë°ì´íŠ¸
            cancelAnimalForm();
            updateDatabaseStats();
            displayAllAnimals();
        }
        
        // ë™ë¬¼ ì‚­ì œ
        function deleteAnimal(animalName) {
            if (confirm(`'${animalName}'ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // ë™ë¬¼ ì¹´í…Œê³ ë¦¬ì—ì„œ ì‚­ì œ
                delete ANIMAL_CATEGORIES[animalName];
                
                // ë³€í˜• ëª…ì¹­ë“¤ë„ í•¨ê»˜ ì‚­ì œ
                if (typeof animalVariants !== 'undefined' && typeof variantToBase !== 'undefined') {
                    const variants = getAnimalVariants ? getAnimalVariants(animalName) : [];
                    if (variants) {
                        variants.forEach(variant => {
                            delete variantToBase[variant];
                        });
                    }
                    delete animalVariants[animalName];
                    delete variantToBase[animalName];
                }
                
                alert('ë™ë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateDatabaseStats();
                displayAllAnimals();
            }
        }
        
        // í¼ ì·¨ì†Œ
        function cancelAnimalForm() {
            document.getElementById('animalForm').style.display = 'none';
            editingAnimal = null;
            currentVariants = [];
        }
        
        // =====================================================
        // ë³€í˜• ëª…ì¹­ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // =====================================================
        
        // í˜„ì¬ ë™ë¬¼ì˜ ë³€í˜• ëª…ì¹­ë“¤ ë¡œë“œ
        function loadAnimalVariants(animalName) {
            if (typeof getAnimalVariants === 'function') {
                const variants = getAnimalVariants(animalName);
                currentVariants = variants ? [...variants] : [];
            } else {
                currentVariants = [];
            }
            displayVariants();
        }
        
        // ë³€í˜• ëª…ì¹­ ì¶”ê°€
        function addVariant() {
            const variantInput = document.getElementById('variantInput');
            const variant = variantInput.value.trim();
            
            if (!variant) {
                alert('ë³€í˜• ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (currentVariants.includes(variant)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë³€í˜• ëª…ì¹­ì…ë‹ˆë‹¤.');
                return;
            }
            
            currentVariants.push(variant);
            variantInput.value = '';
            displayVariants();
        }
        
        // ë³€í˜• ëª…ì¹­ ì œê±°
        function removeVariant(variant) {
            const index = currentVariants.indexOf(variant);
            if (index > -1) {
                currentVariants.splice(index, 1);
                displayVariants();
            }
        }
        
        // ë³€í˜• ëª…ì¹­ë“¤ í‘œì‹œ
        function displayVariants() {
            const variantsList = document.getElementById('variantsList');
            
            if (currentVariants.length === 0) {
                variantsList.innerHTML = '<div style="color: #999; font-style: italic;">ë³€í˜• ëª…ì¹­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const variantsHtml = currentVariants.map(variant => `
                <div class="variant-tag">
                    <span>${variant}</span>
                    <span class="variant-remove" onclick="removeVariant('${variant}')" title="ì œê±°">Ã—</span>
                </div>
            `).join('');
            
            variantsList.innerHTML = variantsHtml;
        }
        
        // ë³€í˜• ëª…ì¹­ ì…ë ¥ ì‹œ ì—”í„°í‚¤ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            const variantInput = document.getElementById('variantInput');
            if (variantInput) {
                variantInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        addVariant();
                    }
                });
            }
        });
        
        // ë°ì´í„°ë² ì´ìŠ¤ í†µê³„ ì—…ë°ì´íŠ¸
        function updateDatabaseStats() {
            const stats = {
                total: 0,
                MAMMAL: 0,
                BIRD: 0,
                REPTILE: 0,
                AMPHIBIAN: 0,
                FISH: 0,
                INSECT: 0,
                MOLLUSK: 0,
                CRUSTACEAN: 0
            };
            
            for (const [animalName, animalData] of Object.entries(ANIMAL_CATEGORIES)) {
                stats.total++;
                if (animalData.MAMMAL) stats.MAMMAL++;
                if (animalData.BIRD) stats.BIRD++;
                if (animalData.REPTILE) stats.REPTILE++;
                if (animalData.AMPHIBIAN) stats.AMPHIBIAN++;
                if (animalData.FISH) stats.FISH++;
                if (animalData.INSECT) stats.INSECT++;
                if (animalData.MOLLUSK) stats.MOLLUSK++;
                if (animalData.CRUSTACEAN) stats.CRUSTACEAN++;
            }
            
            document.getElementById('totalAnimals').textContent = stats.total;
            document.getElementById('mammalCount').textContent = stats.MAMMAL;
            document.getElementById('birdCount').textContent = stats.BIRD;
            document.getElementById('reptileCount').textContent = stats.REPTILE;
            document.getElementById('amphibianCount').textContent = stats.AMPHIBIAN;
            document.getElementById('fishCount').textContent = stats.FISH;
            document.getElementById('insectCount').textContent = stats.INSECT;
            document.getElementById('molluskCount').textContent = stats.MOLLUSK;
            document.getElementById('crustaceanCount').textContent = stats.CRUSTACEAN;
        }
        
        // ëª¨ë“  ë™ë¬¼ í‘œì‹œ
        function displayAllAnimals() {
            const searchTerm = document.getElementById('searchAnimal').value.toLowerCase();
            const animalList = document.getElementById('animalList');
            animalList.innerHTML = '';
            
            const sortedAnimals = Object.keys(ANIMAL_CATEGORIES).sort((a, b) => a.localeCompare(b, 'ko'));
            
            sortedAnimals.forEach(animalName => {
                // ê¸°ë³¸ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
                let shouldShow = false;
                
                if (!searchTerm) {
                    shouldShow = true;
                } else if (animalName.toLowerCase().includes(searchTerm)) {
                    shouldShow = true;
                } else if (typeof getAnimalVariants === 'function') {
                    // ë³€í˜• ëª…ì¹­ìœ¼ë¡œë„ ê²€ìƒ‰
                    const variants = getAnimalVariants(animalName);
                    if (variants && variants.some(variant => variant.toLowerCase().includes(searchTerm))) {
                        shouldShow = true;
                    }
                }
                
                if (!shouldShow) {
                    return;
                }
                
                const animalData = ANIMAL_CATEGORIES[animalName];
                const animalItem = createAnimalItem(animalName, animalData, searchTerm);
                animalList.appendChild(animalItem);
            });
        }
        
        // ë™ë¬¼ í•­ëª© ìƒì„±
        function createAnimalItem(animalName, animalData, searchTerm) {
            const div = document.createElement('div');
            div.className = 'animal-item';
            
            // ë™ë¬¼ ì •ë³´
            const infoDiv = document.createElement('div');
            infoDiv.className = 'animal-info';
            
            // í—¤ë” (ì´ë¦„ + ë²„íŠ¼)
            const headerDiv = document.createElement('div');
            headerDiv.className = 'animal-header';
            
            // ë™ë¬¼ ì´ë¦„ (ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸)
            const nameDiv = document.createElement('div');
            nameDiv.className = 'animal-name';
            if (searchTerm) {
                nameDiv.innerHTML = animalName.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="search-highlight">${match}</span>`
                );
            } else {
                nameDiv.textContent = animalName;
            }
            headerDiv.appendChild(nameDiv);
            
            // ì•¡ì…˜ ë²„íŠ¼ë“¤
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-edit';
            editBtn.textContent = 'ìˆ˜ì •';
            editBtn.onclick = () => showEditAnimalForm(animalName);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-danger';
            deleteBtn.textContent = 'ì‚­ì œ';
            deleteBtn.onclick = () => deleteAnimal(animalName);
            
            headerDiv.appendChild(editBtn);
            headerDiv.appendChild(deleteBtn);
            
            infoDiv.appendChild(headerDiv);
            
            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ì²´í¬ë°•ìŠ¤ í˜•íƒœë¡œ í‘œì‹œ
            const categoriesDiv = document.createElement('div');
            categoriesDiv.className = 'animal-categories';
            
            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
            const categoryOrder = [
                'MAMMAL', 'BIRD', 'REPTILE', 'AMPHIBIAN', 'FISH', 'INSECT', 'MOLLUSK', 'CRUSTACEAN',
                'MARINE', 'FRESHWATER',
                'DOMESTIC', 'PET', 'WILD',
                'ZODIAC', 'MYTHOLOGY', 'PREHISTORIC'
            ];
            
            categoryOrder.forEach(category => {
                if (CATEGORIES[category]) {
                    const checkDiv = document.createElement('div');
                    checkDiv.className = 'category-check' + (animalData[category] ? ' checked' : '');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = animalData[category] || false;
                    checkbox.disabled = true;
                    
                    const label = document.createElement('span');
                    label.textContent = CATEGORIES[category];
                    
                    checkDiv.appendChild(checkbox);
                    checkDiv.appendChild(label);
                    categoriesDiv.appendChild(checkDiv);
                }
            });
            
            infoDiv.appendChild(categoriesDiv);
            
            div.appendChild(infoDiv);
            
            return div;
        }
        
        // ë™ë¬¼ ê²€ìƒ‰
        function searchAnimals() {
            displayAllAnimals();
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ë‚´ë³´ë‚´ê¸° (ì¶”ê°€ ê¸°ëŠ¥)
        function exportDatabase() {
            const dataStr = JSON.stringify(ANIMAL_CATEGORIES, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'animal-database.json';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // ë°ì´í„°ë² ì´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ì¶”ê°€ ê¸°ëŠ¥)
        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm('ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                Object.assign(ANIMAL_CATEGORIES, data);
                                updateDatabaseStats();
                                displayAllAnimals();
                                alert('ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                            }
                        } catch (error) {
                            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // =====================================================
        // CSV ì¼ê´„ ì²˜ë¦¬ ê¸°ëŠ¥
        // =====================================================
        
        // CSV ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
        function showCSVUpload() {
            document.getElementById('csvUploadSection').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.querySelector('.database-management').style.display = 'none';
            document.querySelector('.variants-management').style.display = 'none';
        }
        
        // ë³€í˜• ëª…ì¹­ ê´€ë¦¬ì í‘œì‹œ
        function showVariantsManager() {
            const variantsSection = document.querySelector('.variants-management');
            const resultsSection = document.getElementById('results');
            const containerSection = document.querySelector('.container');
            const dbSection = document.querySelector('.database-management');
            
            // ë‹¤ë¥¸ ì„¹ì…˜ë“¤ ìˆ¨ê¸°ê¸°
            resultsSection.style.display = 'none';
            containerSection.style.display = 'none';
            dbSection.style.display = 'none';
            
            // ë³€í˜• ëª…ì¹­ ê´€ë¦¬ ì„¹ì…˜ í‘œì‹œ
            variantsSection.style.display = 'block';
            displayAllVariants();
            updateVariantsStats();
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        }
        
        // ë³€í˜• ëª…ì¹­ ê´€ë¦¬ì ë‹«ê¸°
        function closeVariantsManager() {
            const variantsSection = document.querySelector('.variants-management');
            const dbSection = document.querySelector('.database-management');
            
            // ë³€í˜• ëª…ì¹­ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            variantsSection.style.display = 'none';
            
            // ê²€ìƒ‰ ì´ˆê¸°í™”
            document.getElementById('searchAnimalForVariant').value = '';
            document.getElementById('animalSearchResults').style.display = 'none';
            document.getElementById('selectedAnimalInfo').innerHTML = 'ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            document.getElementById('createVariantBtn').disabled = true;
            selectedAnimalForVariant = null;
            
            // ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            dbSection.style.display = 'block';
        }
        
        // ë³€í˜• ëª…ì¹­ ë“±ë¡ì„ ìœ„í•œ ë™ë¬¼ ê²€ìƒ‰
        let selectedAnimalForVariant = null;
        
        function searchAnimalsForVariant() {
            const searchTerm = document.getElementById('searchAnimalForVariant').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('animalSearchResults');
            
            if (!searchTerm) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // ANIMAL_CATEGORIESì—ì„œ ê²€ìƒ‰
            const matchingAnimals = Object.keys(ANIMAL_CATEGORIES).filter(animal => 
                animal.toLowerCase().includes(searchTerm)
            ).sort();
            
            if (matchingAnimals.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            resultsDiv.innerHTML = matchingAnimals.slice(0, 10).map(animal => {
                const hasVariants = animalVariants && animalVariants[animal];
                const variantCount = hasVariants ? animalVariants[animal].variants.length : 0;
                const statusText = hasVariants ? `(ë³€í˜• ${variantCount}ê°œ ë“±ë¡ë¨)` : '(ë³€í˜• ë¯¸ë“±ë¡)';
                const statusColor = hasVariants ? '#4caf50' : '#ff9800';
                
                return `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between;"
                         onmouseover="this.style.backgroundColor='#f5f5f5'" 
                         onmouseout="this.style.backgroundColor='white'"
                         onclick="selectAnimalForVariant('${animal}')">
                        <span>${animal}</span>
                        <span style="font-size: 12px; color: ${statusColor};">${statusText}</span>
                    </div>
                `;
            }).join('');
            
            if (matchingAnimals.length > 10) {
                resultsDiv.innerHTML += '<div style="padding: 10px; color: #666; text-align: center;">... ì™¸ ' + 
                    (matchingAnimals.length - 10) + 'ê°œ ë” ìˆìŒ</div>';
            }
            
            resultsDiv.style.display = 'block';
        }
        
        // ë™ë¬¼ ì„ íƒ
        function selectAnimalForVariant(animalName) {
            selectedAnimalForVariant = animalName;
            
            // ì„ íƒëœ ë™ë¬¼ ì •ë³´ í‘œì‹œ
            const infoDiv = document.getElementById('selectedAnimalInfo');
            const hasVariants = animalVariants && animalVariants[animalName];
            
            // ë™ë¬¼ì˜ ë²”ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const categories = getAnimalCategories(animalName);
            const categoryNames = categories.map(cat => cat.name).join(', ');
            
            infoDiv.innerHTML = `
                <div style="width: 100%;">
                    <div style="font-size: 18px; font-weight: bold; color: #1976d2; margin-bottom: 5px;">${animalName}</div>
                    <div style="font-size: 12px; color: #666;">ë²”ì£¼: ${categoryNames || 'ì—†ìŒ'}</div>
                    ${hasVariants ? 
                        `<div style="font-size: 12px; color: #4caf50; margin-top: 5px;">
                            ê¸°ì¡´ ë³€í˜•: ${animalVariants[animalName].variants.join(', ')}
                        </div>` : 
                        '<div style="font-size: 12px; color: #ff9800; margin-top: 5px;">ë“±ë¡ëœ ë³€í˜• ì—†ìŒ</div>'
                    }
                </div>
            `;
            
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('animalSearchResults').style.display = 'none';
            
            // ë²„íŠ¼ í™œì„±í™”
            document.getElementById('createVariantBtn').disabled = false;
        }
        
        // ìƒˆ ë³€í˜• ëª…ì¹­ ë“±ë¡ ì‹œì‘
        function createNewVariantEntry() {
            if (!selectedAnimalForVariant) {
                alert('ë™ë¬¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í¸ì§‘ í¼ìœ¼ë¡œ ì´ë™
            editVariants(selectedAnimalForVariant);
            
            // ì„ íƒ ì´ˆê¸°í™”
            document.getElementById('searchAnimalForVariant').value = '';
            document.getElementById('selectedAnimalInfo').innerHTML = 'ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            document.getElementById('createVariantBtn').disabled = true;
            selectedAnimalForVariant = null;
        }
        
        // ëª¨ë“  ë³€í˜• ëª…ì¹­ í‘œì‹œ
        function displayAllVariants() {
            const variantList = document.getElementById('variantAnimalList');
            if (!variantList) return;
            
            variantList.innerHTML = '';
            
            // animalVariantsê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (typeof animalVariants === 'undefined') {
                variantList.innerHTML = '<p style="padding: 20px; text-align: center;">ë³€í˜• ëª…ì¹­ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ëª¨ë“  ë™ë¬¼ê³¼ ë³€í˜• ëª…ì¹­ í‘œì‹œ
            const sortedAnimals = Object.keys(animalVariants).sort();
            
            sortedAnimals.forEach(animal => {
                const data = animalVariants[animal];
                const variantCount = data.variants ? data.variants.length : 0;
                
                const animalDiv = document.createElement('div');
                animalDiv.className = 'animal-item';
                animalDiv.innerHTML = `
                    <div class="animal-info">
                        <span class="animal-name">${animal}</span>
                        <span class="animal-variants">ë³€í˜• ëª…ì¹­: ${variantCount}ê°œ</span>
                    </div>
                    <div class="animal-actions">
                        <button onclick="editVariants('${animal}')" class="btn-edit">í¸ì§‘</button>
                    </div>
                `;
                
                variantList.appendChild(animalDiv);
            });
        }
        
        // ë³€í˜• ëª…ì¹­ í†µê³„ ì—…ë°ì´íŠ¸
        function updateVariantsStats() {
            if (typeof animalVariants === 'undefined') return;
            
            const totalAnimals = Object.keys(animalVariants).length;
            let totalVariants = 0;
            
            Object.values(animalVariants).forEach(data => {
                if (data.variants) {
                    totalVariants += data.variants.length;
                }
            });
            
            document.getElementById('totalVariantAnimals').textContent = totalAnimals;
            document.getElementById('totalVariants').textContent = totalVariants;
        }
        
        // ë³€í˜• ëª…ì¹­ ê²€ìƒ‰
        function searchVariantAnimals() {
            const searchTerm = document.getElementById('searchVariant').value.toLowerCase();
            const variantList = document.getElementById('variantAnimalList');
            const items = variantList.getElementsByClassName('animal-item');
            
            Array.from(items).forEach(item => {
                const animalName = item.querySelector('.animal-name').textContent.toLowerCase();
                const shouldShow = animalName.includes(searchTerm);
                item.style.display = shouldShow ? 'flex' : 'none';
            });
        }
        
        // ë³€í˜• ëª…ì¹­ í¸ì§‘
        let editingVariantAnimal = null;
        let currentEditingVariants = [];
        
        function editVariants(animalName) {
            editingVariantAnimal = animalName;
            
            // animalVariantsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const data = animalVariants[animalName];
            currentEditingVariants = data && data.variants ? [...data.variants] : [];
            
            // í¼ í‘œì‹œ
            document.getElementById('variantFormTitle').textContent = `'${animalName}' ë³€í˜• ëª…ì¹­ í¸ì§‘`;
            document.getElementById('variantBaseAnimal').textContent = animalName;
            document.getElementById('variantEditForm').style.display = 'block';
            
            // ë³€í˜• ëª…ì¹­ ëª©ë¡ í‘œì‹œ
            displayEditingVariants();
        }
        
        // í¸ì§‘ ì¤‘ì¸ ë³€í˜• ëª…ì¹­ í‘œì‹œ
        function displayEditingVariants() {
            const listContainer = document.getElementById('variantEditList');
            listContainer.innerHTML = '';
            
            if (currentEditingVariants.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">ë“±ë¡ëœ ë³€í˜• ëª…ì¹­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            currentEditingVariants.forEach((variant, index) => {
                const variantDiv = document.createElement('div');
                variantDiv.className = 'variant-item';
                variantDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 5px;';
                variantDiv.innerHTML = `
                    <span>${variant}</span>
                    <button onclick="removeEditingVariant(${index})" class="btn-danger">ì‚­ì œ</button>
                `;
                listContainer.appendChild(variantDiv);
            });
        }
        
        // ìƒˆ ë³€í˜• ëª…ì¹­ ì¶”ê°€
        function addNewVariant() {
            const input = document.getElementById('newVariantInput');
            const variant = input.value.trim();
            
            if (!variant) {
                alert('ë³€í˜• ëª…ì¹­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (currentEditingVariants.includes(variant)) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ë³€í˜• ëª…ì¹­ì…ë‹ˆë‹¤.');
                return;
            }
            
            currentEditingVariants.push(variant);
            input.value = '';
            displayEditingVariants();
        }
        
        // í¸ì§‘ ì¤‘ì¸ ë³€í˜• ëª…ì¹­ ì œê±°
        function removeEditingVariant(index) {
            currentEditingVariants.splice(index, 1);
            displayEditingVariants();
        }
        
        // ë³€í˜• ëª…ì¹­ ë³€ê²½ì‚¬í•­ ì €ì¥
        function saveVariantChanges() {
            if (!editingVariantAnimal) return;
            
            // animalVariants ì—…ë°ì´íŠ¸
            if (!animalVariants[editingVariantAnimal]) {
                animalVariants[editingVariantAnimal] = {
                    base: editingVariantAnimal,
                    variants: []
                };
            }
            
            animalVariants[editingVariantAnimal].variants = [...currentEditingVariants];
            
            // variantToBase ì¬êµ¬ì„±
            regenerateVariantToBase();
            
            alert('ë³€í˜• ëª…ì¹­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì£¼ì˜: ë³€ê²½ì‚¬í•­ì€ í˜„ì¬ ì„¸ì…˜ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.\nì˜êµ¬ ì €ì¥ì„ ìœ„í•´ì„œëŠ” ê°œë°œìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
            
            // í¼ ë‹«ê¸°
            cancelVariantEdit();
            
            // ëª©ë¡ ê°±ì‹ 
            displayAllVariants();
            updateVariantsStats();
        }
        
        // variantToBase ì¬ìƒì„±
        function regenerateVariantToBase() {
            // ê¸°ì¡´ variantToBase ì´ˆê¸°í™”
            if (typeof variantToBase !== 'undefined') {
                // ëª¨ë“  ì†ì„± ì œê±°
                Object.keys(variantToBase).forEach(key => delete variantToBase[key]);
                
                // animalVariantsë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¬êµ¬ì„±
                Object.entries(animalVariants).forEach(([base, data]) => {
                    if (data.variants) {
                        data.variants.forEach(variant => {
                            variantToBase[variant] = base;
                        });
                    }
                });
            }
        }
        
        // ë³€í˜• ëª…ì¹­ í¸ì§‘ ì·¨ì†Œ
        function cancelVariantEdit() {
            editingVariantAnimal = null;
            currentEditingVariants = [];
            document.getElementById('variantEditForm').style.display = 'none';
            document.getElementById('newVariantInput').value = '';
        }
        
        // ë³€í˜• ëª…ì¹­ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportVariants() {
            if (typeof animalVariants === 'undefined') {
                alert('ë³€í˜• ëª…ì¹­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const dataStr = `const animalVariants = ${JSON.stringify(animalVariants, null, 2)};
            
// Reverse mapping for quick lookup
const variantToBase = ${JSON.stringify(variantToBase || {}, null, 2)};`;
            
            const blob = new Blob([dataStr], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'animal-variants.js';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // ë³€í˜• ëª…ì¹­ ì‚¬ìš©ë²• í‘œì‹œ
        function showVariantsHelp() {
            alert(`ë³€í˜• ëª…ì¹­ ê´€ë¦¬ ì‚¬ìš©ë²•:

1. ìƒˆ ë³€í˜• ëª…ì¹­ ë“±ë¡:
   - ìƒë‹¨ íŒŒë€ìƒ‰ ë°•ìŠ¤ì—ì„œ ë™ë¬¼ ì´ë¦„ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤
   - ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì›í•˜ëŠ” ë™ë¬¼ì„ í´ë¦­í•©ë‹ˆë‹¤
   - "ìƒˆ ë³€í˜• ëª…ì¹­ ë“±ë¡ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤
   - ë³€í˜• ëª…ì¹­ì„ ì¶”ê°€í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤

2. ê¸°ì¡´ ë³€í˜• ëª…ì¹­ í¸ì§‘:
   - í•˜ë‹¨ ëª©ë¡ì—ì„œ í¸ì§‘í•  ë™ë¬¼ì˜ "í¸ì§‘" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤
   - ë³€í˜• ëª…ì¹­ì„ ì¶”ê°€/ì‚­ì œí•˜ê³  ì €ì¥í•©ë‹ˆë‹¤

3. ë°ì´í„° ê´€ë¦¬:
   - ë‚´ë³´ë‚´ê¸°: í˜„ì¬ ë³€í˜• ëª…ì¹­ ë°ì´í„°ë¥¼ .js íŒŒì¼ë¡œ ì €ì¥
   - ê°€ì ¸ì˜¤ê¸°: ì €ì¥ëœ .js íŒŒì¼ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
   
ì˜ˆì‹œ:
   í•˜ì´ì—ë‚˜ â†’ í•˜ì´ì• ë‚˜ (ì™¸ë˜ì–´ í‘œê¸° ë³€í˜•)
   ê°œ â†’ ê°•ì•„ì§€, ë©ë©ì´ (ì—°ë ¹/ì• ì¹­ ë³€í˜•)

ì£¼ì˜: ë³€ê²½ì‚¬í•­ì€ í˜„ì¬ ì„¸ì…˜ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.
ì˜êµ¬ ì €ì¥ì„ ìœ„í•´ì„œëŠ” "ë‚´ë³´ë‚´ê¸°" ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.`);
        }
        
        // ë³€í˜• ëª…ì¹­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importVariants() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.js,.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            // JavaScript íŒŒì¼ í˜•ì‹ ì²˜ë¦¬
                            if (file.name.endsWith('.js')) {
                                // ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜ ë°±ì—…
                                const backupAnimalVariants = animalVariants;
                                const backupVariantToBase = variantToBase;
                                
                                try {
                                    // evalì„ ì‚¬ìš©í•˜ì—¬ JavaScript ì‹¤í–‰
                                    eval(e.target.result);
                                    alert('ë³€í˜• ëª…ì¹­ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                                    displayAllVariants();
                                    updateVariantsStats();
                                } catch (evalError) {
                                    // ë³µì›
                                    window.animalVariants = backupAnimalVariants;
                                    window.variantToBase = backupVariantToBase;
                                    throw evalError;
                                }
                            } 
                            // JSON íŒŒì¼ í˜•ì‹ ì²˜ë¦¬
                            else if (file.name.endsWith('.json')) {
                                const data = JSON.parse(e.target.result);
                                window.animalVariants = data.animalVariants || data;
                                regenerateVariantToBase();
                                alert('ë³€í˜• ëª…ì¹­ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                                displayAllVariants();
                                updateVariantsStats();
                            } else {
                                alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .js ë˜ëŠ” .json íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // CSV ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        function hideCSVUpload() {
            document.getElementById('csvUploadSection').style.display = 'none';
        }
        
        // CSV í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadCSVTemplate() {
            const template = 'ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,0-15ì´ˆ,15-30ì´ˆ,30-45ì´ˆ,45-60ì´ˆ\n' +
                           '001,ë‚¨ì„±,65,12,"ê°œ,ê³ ì–‘ì´,ì†Œ,ë§,ë¼ì§€","ë‹­,í˜¸ë‘ì´,ì‚¬ì,ë±€,ê±°ë¶ì´","í† ë¼,ì¥,ì›ìˆ­ì´,ì–‘,ì—¼ì†Œ","ì˜¤ë¦¬,ê±°ìœ„,ë¹„ë‘˜ê¸°,ì°¸ìƒˆ,ë…ìˆ˜ë¦¬"\n' +
                           '002,ì—¬ì„±,72,6,"ê°œ,ì†Œ,ë§,ë‹­,ì˜¤ë¦¬","ê°œêµ¬ë¦¬,í† ë¼,ì¥,ê³ ì–‘ì´,ë¼ì§€","ì‚¬ì,í˜¸ë‘ì´,ê³°,ì—¬ìš°,ëŠ‘ëŒ€","ë±€,ê±°ë¶ì´,ì•…ì–´,ë„ë§ˆë±€,ê°œêµ¬ë¦¬"\n' +
                           'ìƒ˜í”Œ,ë‚¨ì„±,55,16,"ê°œ,ê³ ì–‘ì´,ì†Œ,ë§,ë¼ì§€","ë‹­,ì˜¤ë¦¬,ê±°ìœ„,ë¹„ë‘˜ê¸°,ì°¸ìƒˆ","í˜¸ë‘ì´,ì‚¬ì,ê³°,ëŠ‘ëŒ€,ì—¬ìš°","ë±€,ê±°ë¶ì´,ì•…ì–´,ë„ë§ˆë±€,ê°œêµ¬ë¦¬"';
            
            const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ë™ë¬¼ìœ ì°½ì„±ê²€ì‚¬_í…œí”Œë¦¿.csv';
            link.click();
        }
        
        // CSV íŒŒì¼ ì²˜ë¦¬
        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const rows = parseCSV(csv);
                    
                    if (rows.length < 2) {
                        alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // í—¤ë” í™•ì¸
                    const header = rows[0];
                    if (!validateHeader(header)) {
                        alert('CSV í—¤ë” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ê° í–‰ ì²˜ë¦¬
                    const results = [];
                    for (let i = 1; i < rows.length; i++) {
                        if (rows[i].length >= 8) {
                            const result = processRow(rows[i], i);
                            results.push(result);
                        }
                    }
                    
                    // ê²°ê³¼ í‘œì‹œ
                    displayCSVResults(results);
                    
                } catch (error) {
                    console.error('CSV ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('CSV íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // CSV íŒŒì‹± - ë”°ì˜´í‘œë¡œ ë¬¶ì¸ ì…€ì„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const rows = [];
            
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let cell = '';
                    let insideQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            row.push(cell.trim());
                            cell = '';
                        } else {
                            cell += char;
                        }
                    }
                    
                    // ë§ˆì§€ë§‰ ì…€ ì¶”ê°€
                    row.push(cell.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // í—¤ë” ê²€ì¦
        function validateHeader(header) {
            const expected = ['ID', 'ì„±ë³„', 'ì—°ë ¹', 'í•™ë ¥', '0-15ì´ˆ', '15-30ì´ˆ', '30-45ì´ˆ', '45-60ì´ˆ'];
            return header.length >= 8 && 
                   header[0] === expected[0] &&
                   header[1] === expected[1] &&
                   header[2] === expected[2] &&
                   header[3] === expected[3];
        }
        
        // ê°œë³„ í–‰ ì²˜ë¦¬
        function processRow(row, rowIndex) {
            const id = row[0];
            const gender = row[1];
            const age = parseInt(row[2]) || 0;
            const education = parseInt(row[3]) || 0;
            
            // ê° ì‹œê°„ëŒ€ë³„ ë°˜ì‘ íŒŒì‹±
            const responses = {
                '0-15': parseAnimals(row[4]),
                '15-30': parseAnimals(row[5]),
                '30-45': parseAnimals(row[6]),
                '45-60': parseAnimals(row[7])
            };
            
            // ì ìˆ˜ ê³„ì‚° (ê¸°ì¡´ calculateScores ë¡œì§ í™œìš©)
            const scores = calculateScoresForCSV({
                id: id,
                gender: gender,
                age: age,
                education: education,
                responses: responses
            });
            
            return {
                row: rowIndex + 1,
                id: id,
                gender: gender,
                age: age,
                education: education,
                ...scores
            };
        }
        
        // ë™ë¬¼ ì´ë¦„ íŒŒì‹±
        function parseAnimals(animalsStr) {
            if (!animalsStr) return [];
            return animalsStr.split(',').map(a => a.trim()).filter(a => a);
        }
        
        // CSVìš© ì ìˆ˜ ê³„ì‚°
        function calculateScoresForCSV(data) {
            // ì „ì—­ responses ê°ì²´ ì„ì‹œ ë°±ì—…
            const backup = JSON.parse(JSON.stringify(responses));
            
            // CSV ë°ì´í„°ë¡œ responses ì„¤ì •
            responses['0-15'] = data.responses['0-15'];
            responses['15-30'] = data.responses['15-30'];
            responses['30-45'] = data.responses['30-45'];
            responses['45-60'] = data.responses['45-60'];
            
            // ëª¨ë“  ë°˜ì‘ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬
            const allResponses = [];
            let order = 1;
            
            ['0-15', '15-30', '30-45', '45-60'].forEach(range => {
                data.responses[range].forEach(response => {
                    const trimmed = response.trim();
                    
                    // ì§ˆë¬¸ íŒ¨í„´ ê°ì§€ (CSVì—ì„œë„ ë™ì¼í•œ ë¡œì§ ì ìš©)
                    const isQuestion = trimmed.includes('?') || 
                                     /ë„\s*(ë˜ìš”|ë¼ìš”|ë˜ë‚˜ìš”|ë˜ë‚˜|ë©ë‹ˆê¹Œ|ë˜ë‹ˆ|ë˜ëƒ)/i.test(trimmed) ||
                                     /ë§ì•„ìš”|ë§ë‚˜ìš”|ë§ì£ |ë§ìŠµë‹ˆê¹Œ/i.test(trimmed) ||
                                     /í• \s*ìˆ˜\s*ìˆ(ì–´ìš”|ë‚˜ìš”|ìŠµë‹ˆê¹Œ)/i.test(trimmed) ||
                                     /ê°€ëŠ¥í•œê°€ìš”|ê°€ëŠ¥í•´ìš”|ê°€ëŠ¥í•©ë‹ˆê¹Œ/i.test(trimmed);
                    
                    if (isQuestion) {
                        console.log(`CSVì—ì„œ ì§ˆë¬¸ í•­ëª© ì œì™¸: ${trimmed}`);
                        return; // ì§ˆë¬¸ì€ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                    }
                    
                    const normalized = (typeof normalizeAnimalName === 'function') ? normalizeAnimalName(trimmed) : null;
                    const finalNormalized = normalized || (ANIMAL_CATEGORIES[trimmed] ? trimmed : null);
                    
                    allResponses.push({
                        response: response,
                        normalizedResponse: finalNormalized,
                        originalResponse: trimmed,
                        order,
                        timeRange: range
                    });
                    order++;
                });
            });
            
            // ì ìˆ˜ ê³„ì‚° ë¡œì§ (ê¸°ì¡´ calculateScores í•¨ìˆ˜ì˜ ë¡œì§ ì¬ì‚¬ìš©)
            const validResponses = allResponses.filter(r => r.normalizedResponse !== null);
            const uniqueResponses = [...new Set(validResponses.map(r => r.normalizedResponse))];
            const totalScore = uniqueResponses.length;
            
            const firstHalfResponses = allResponses.filter(r => 
                (r.timeRange === '0-15' || r.timeRange === '15-30') && r.normalizedResponse !== null
            );
            const firstHalfScore = new Set(firstHalfResponses.map(r => r.normalizedResponse)).size;
            
            const secondHalfResponses = allResponses.filter(r => 
                (r.timeRange === '30-45' || r.timeRange === '45-60') && r.normalizedResponse !== null
            );
            const secondHalfScore = new Set(secondHalfResponses.map(r => r.normalizedResponse)).size;
            
            const responseCount = {};
            validResponses.forEach(r => {
                responseCount[r.normalizedResponse] = (responseCount[r.normalizedResponse] || 0) + 1;
            });
            const perseverationScore = Object.values(responseCount)
                .filter(count => count > 1)
                .reduce((sum, count) => sum + (count - 1), 0);
            
            let intrusionScore = 0;
            allResponses.forEach(response => {
                if (response.normalizedResponse === null) {
                    intrusionScore++;
                }
            });
            
            const { transitions, clusters, switchingScore, inefficientSwitchingScore } = analyzeTransitionsAndClusters(validResponses);
            
            const usedCategories = new Set();
            clusters.forEach(cluster => {
                if (cluster.commonCategories.length > 0) {
                    usedCategories.add(cluster.commonCategories[0]);
                }
            });
            const categoryScore = usedCategories.size;
            
            const clusterSizes = clusters.map(c => c.size);
            const avgClusterSize = clusterSizes.length > 0 
                ? clusterSizes.reduce((sum, size) => sum + size, 0) / clusterSizes.length
                : 0;
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            // inefficientSwitchingScoreëŠ” ì´ë¯¸ analyzeTransitionsAndClustersì—ì„œ ê³„ì‚°ë¨
            
            // ì „ì—­ responses ë³µì›
            Object.assign(responses, backup);
            
            return {
                totalScore,
                firstHalfScore,
                secondHalfScore,
                perseverationScore,
                intrusionScore,
                switchingScore,
                inefficientSwitchingScore,
                categoryScore,
                avgClusterSize: avgClusterSize.toFixed(1),
                maxClusterSize
            };
        }
        
        // CSV ê²°ê³¼ í‘œì‹œ
        function displayCSVResults(results) {
            let html = '<h3>ì²˜ë¦¬ ê²°ê³¼</h3>';
            html += '<table class="csv-result-table">';
            html += '<thead><tr>';
            html += '<th>ë²ˆí˜¸</th><th>ID</th><th>ì„±ë³„</th><th>ì—°ë ¹</th><th>í•™ë ¥</th>';
            html += '<th>ì´ì </th><th>ì „ë°˜</th><th>í›„ë°˜</th><th>ë³´ì†</th><th>ì¹¨íˆ¬</th>';
            html += '<th>ì „í™˜</th><th>ë¹„íš¨ìœ¨</th><th>ë²”ì£¼ìˆ˜</th><th>í‰ê· í¬ê¸°</th><th>ìµœëŒ€í¬ê¸°</th>';
            html += '</tr></thead><tbody>';
            
            results.forEach(r => {
                html += '<tr>';
                html += `<td>${r.row}</td>`;
                html += `<td>${r.id}</td>`;
                html += `<td>${r.gender}</td>`;
                html += `<td>${r.age}</td>`;
                html += `<td>${r.education}</td>`;
                html += `<td>${r.totalScore}</td>`;
                html += `<td>${r.firstHalfScore}</td>`;
                html += `<td>${r.secondHalfScore}</td>`;
                html += `<td>${r.perseverationScore}</td>`;
                html += `<td>${r.intrusionScore}</td>`;
                html += `<td>${r.switchingScore}</td>`;
                html += `<td>${r.inefficientSwitchingScore}</td>`;
                html += `<td>${r.categoryScore}</td>`;
                html += `<td>${r.avgClusterSize}</td>`;
                html += `<td>${r.maxClusterSize}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
            html += '<div style="margin-top: 20px;">';
            html += '<button onclick="downloadCSVResults(' + JSON.stringify(results).replace(/"/g, '&quot;') + ')" class="btn-primary">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>';
            html += '</div>';
            
            document.getElementById('csvResults').innerHTML = html;
        }
        
        // CSV ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        function downloadCSVResults(results) {
            let csv = 'ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,ì´ì ,ì „ë°˜ì ìˆ˜,í›„ë°˜ì ìˆ˜,ë³´ì†,ì¹¨íˆ¬,ì „í™˜,ë¹„íš¨ìœ¨ì „í™˜,ë²”ì£¼ìˆ˜,í‰ê· ë²”ì£¼í¬ê¸°,ìµœëŒ€ë²”ì£¼í¬ê¸°\n';
            
            results.forEach(r => {
                csv += `${r.id},${r.gender},${r.age},${r.education},`;
                csv += `${r.totalScore},${r.firstHalfScore},${r.secondHalfScore},`;
                csv += `${r.perseverationScore},${r.intrusionScore},${r.switchingScore},`;
                csv += `${r.inefficientSwitchingScore},${r.categoryScore},`;
                csv += `${r.avgClusterSize},${r.maxClusterSize}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ë™ë¬¼ìœ ì°½ì„±ê²€ì‚¬_ê²°ê³¼_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
        }
        // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ì‹œí–‰ í”„ë¡œê·¸ë¨ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°)
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const responsesParam = urlParams.get('responses');
            const autoAnalyze = urlParams.get('autoAnalyze');
            
            if (responsesParam) {
                try {
                    const responsesData = JSON.parse(responsesParam);
                    
                    // ê° êµ¬ê°„ë³„ë¡œ ë°ì´í„° ì…ë ¥
                    for (const [timeRange, animalsStr] of Object.entries(responsesData)) {
                        if (animalsStr) {
                            const animals = animalsStr.split(',').map(a => a.trim()).filter(a => a);
                            
                            // responses ê°ì²´ì— ì§ì ‘ ì¶”ê°€
                            responses[timeRange] = animals;
                            
                            // UI ì—…ë°ì´íŠ¸
                            displayResponses(timeRange);
                        }
                    }
                    
                    // ìë™ ë¶„ì„ ì‹¤í–‰
                    if (autoAnalyze === 'true') {
                        setTimeout(() => {
                            calculateScores();
                        }, 500);
                    }
                } catch (error) {
                    console.error('URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            }
        });
    </script>

</body></html>