<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ë¬¼ ë²”ì£¼ ì–¸ì–´ìœ ì°½ì„±ê²€ì‚¬ v7</title>
    <!-- Version 6.0 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .instructions-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .instruction-card {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .instruction-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-content {
            background: transparent;
            padding: 30px;
            border-radius: 8px;
            display: block !important;
        }
        .timer-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .btn {
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .input-section {
            margin: 20px 0;
            text-align: center;
        }
        #manualInput {
            padding: 10px;
            font-size: 18px;
            width: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .animal-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 50px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .animal-item {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
        }
        .animal-item.duplicate {
            background: #e74c3c;
        }
        .stats {
            margin-top: 30px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .stat-value {
            font-weight: bold;
            color: #2c3e50;
        }
        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            color: #e74c3c;
            font-weight: bold;
        }
        .recording-indicator.active {
            display: flex;
        }
        .rec-dot {
            width: 12px;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .prev-btn {
            background-color: #95a5a6;
            color: white;
        }
        .prev-btn:hover {
            background-color: #7f8c8d;
        }
        .next-btn {
            background-color: #2ecc71;
            color: white;
        }
        .next-btn:hover {
            background-color: #27ae60;
        }
        .voice-guide-btn {
            background-color: #f39c12;
            color: white;
        }
        .voice-guide-btn:hover {
            background-color: #e67e22;
        }
        .download-btn {
            background-color: #9b59b6;
            color: white;
            margin-top: 20px;
        }
        .download-btn:hover {
            background-color: #8e44ad;
        }
        .ready-box {
            text-align: center;
            color: white;
            position: relative;
            z-index: 9999;
            display: block !important;
        }
        .ready-check {
            font-size: 18px;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        .ready-check p {
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
        }
        .start-button {
            background: 
                radial-gradient(ellipse at center, #16a34a 0%, #22c55e 40%, #4ade80 100%);
            color: white;
            border: none;
            width: 160px;
            height: 160px;
            font-size: 26px;
            font-weight: 700;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(34, 197, 94, 0.1),
                inset 0 -8px 16px rgba(255, 255, 255, 0.2),
                inset 0 8px 16px rgba(0, 0, 0, 0.3),
                inset 0 0 40px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 0;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.5),
                0 -1px 0 rgba(255, 255, 255, 0.1);
            z-index: 10000;
        }
        .start-button::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            bottom: 10%;
            border-radius: 50%;
            background: 
                radial-gradient(ellipse at center bottom, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
            opacity: 0.8;
        }
        .start-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            border-radius: 50%;
            box-shadow: 
                inset 0 -3px 8px rgba(255, 255, 255, 0.3),
                inset 0 3px 8px rgba(0, 0, 0, 0.3);
            opacity: 0.5;
        }
        .start-button span {
            position: relative;
            z-index: 1;
        }
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 0 10px rgba(34, 197, 94, 0.15),
                inset 0 -8px 16px rgba(255, 255, 255, 0.25),
                inset 0 8px 16px rgba(0, 0, 0, 0.25),
                inset 0 0 40px rgba(0, 0, 0, 0.15);
            background: 
                radial-gradient(ellipse at center, #1fb85a 0%, #2ed068 40%, #52e88e 100%);
        }
        .start-button:active {
            transform: translateY(2px);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(34, 197, 94, 0.1),
                inset 0 -4px 8px rgba(255, 255, 255, 0.15),
                inset 0 10px 20px rgba(0, 0, 0, 0.4),
                inset 0 0 50px rgba(0, 0, 0, 0.3);
            background: 
                radial-gradient(ellipse at center, #148f42 0%, #1fb34e 40%, #3ec670 100%);
        }
        .voice-guide-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 300px;
            transform: translateY(100px);
            transition: transform 0.3s;
            z-index: 1000;
            opacity: 0;
        }
        .voice-guide-box.active {
            transform: translateY(0);
            opacity: 1;
        }
        .no-setup-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .interval-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .interval-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .interval-stat h5 {
            margin: 0 0 5px 0;
            color: #666;
            font-size: 14px;
        }
        .interval-stat .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        /* ê²€ì‚¬ ì‹œì‘ í™”ë©´ íš¨ê³¼ */
        .test-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }
        .test-start-overlay.active {
            display: flex;
        }
        .mic-icon {
            width: 120px;
            height: 120px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 1.5s infinite;
        }
        .mic-icon svg {
            width: 60px;
            height: 60px;
            fill: white;
        }
        .test-start-text {
            font-size: 48px;
            color: white;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            animation-delay: 0.3s;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* í…ŒìŠ¤íŠ¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .test-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        .test-screen.active {
            display: flex;
        }
        .test-mic-container {
            margin-bottom: 40px;
            text-align: center;
        }
        .test-mic-icon {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px;
            transition: all 0.3s ease;
            box-shadow: 
                0 8px 30px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.1),
                inset 0 -4px 8px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .test-mic-icon::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
            border-radius: 50%;
            opacity: 0.8;
        }
        .test-mic-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: transparent;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1);
        }
        .test-mic-icon.active {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 
                0 0 50px rgba(239, 68, 68, 0.6),
                0 8px 30px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -4px 8px rgba(0,0,0,0.3);
        }
        .test-mic-icon.active::before {
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { opacity: 0.8; transform: translateX(0) translateY(0); }
            50% { opacity: 1; transform: translateX(10px) translateY(10px); }
        }
        .test-mic-icon svg {
            width: 70px;
            height: 70px;
            fill: white;
            z-index: 1;
            position: relative;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .test-mic-icon.active svg {
            animation: mic-pulse 1.5s ease-in-out infinite;
        }
        @keyframes mic-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .response-display {
            width: 90%;
            max-width: 600px;
            height: 200px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .response-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .response-item {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            animation: fadeIn 0.3s ease-in;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
    </style>
</head>
<body>
    <!-- ì˜¤ë²„ë ˆì´ ìš”ì†Œë“¤ -->
    <div id="analyzing-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 24px; margin-bottom: 20px;">ë¶„ì„ ì¤‘...</div>
            <div style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    </div>

    <div id="setupWarning" class="no-setup-warning" style="display: none;">
        <h3>âš ï¸ í•˜ë“œì›¨ì–´ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p>ìŒì„± ê¸°ë°˜ ê²€ì‚¬ë¥¼ ìœ„í•´ ë¨¼ì € í•˜ë“œì›¨ì–´ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
        <button class="btn btn-primary" onclick="goToSetup()">í•˜ë“œì›¨ì–´ ì„¤ì •í•˜ê¸°</button>
    </div>

    <div id="browserWarning" class="no-setup-warning" style="display: none; background: #ffebee; border-color: #ef5350;">
        <h3>âš ï¸ ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì•ˆë‚´</h3>
        <p>ì´ ê²€ì‚¬ëŠ” <strong>Chrome ë¸Œë¼ìš°ì €</strong>ì—ì„œ ê°€ì¥ ì˜ ì‘ë™í•©ë‹ˆë‹¤.</p>
        <p style="margin-top: 10px; font-size: 14px;">
            í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„±ì¸ì‹ì´ ì œí•œì ì´ê±°ë‚˜ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ì´ ë°˜ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            <strong>Chrome ë¸Œë¼ìš°ì €</strong>ë¥¼ ì‚¬ìš©í•˜ì‹œë©´ ë” ì›í™œí•œ ê²€ì‚¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>
        <div style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="continueDespiteBrowser()">ê·¸ë˜ë„ ê³„ì†í•˜ê¸°</button>
            <a href="https://www.google.com/chrome/" target="_blank" class="btn btn-success" style="margin-left: 10px;">Chrome ë‹¤ìš´ë¡œë“œ</a>
        </div>
    </div>

    <div class="container">
        <!-- ì œëª© ì œê±° -->

        <!-- Instructions Page -->
        <div class="page" id="instructionsPage">
            <div class="instructions-content">
                <h2>ê²€ì‚¬ ì•ˆë‚´</h2>
                
                <div class="instruction-card">
                    <h4>ğŸ• ê²€ì‚¬ ì‹œê°„</h4>
                    <p><strong>1ë¶„ (60ì´ˆ)</strong> ë™ì•ˆ ì§„í–‰ë©ë‹ˆë‹¤.</p>
                    <p>ì‹œê°„ì´ ì¢…ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ê²€ì‚¬ê°€ ëë‚©ë‹ˆë‹¤.</p>
                </div>

                <div class="instruction-card">
                    <h4>ğŸ“‹ ê²€ì‚¬ ë°©ë²•</h4>
                    <p>ì œê°€ "ì‹œì‘"ì´ë¼ê³  ë§ì”€ë“œë¦¬ë©´, <strong>ìƒê°ë‚˜ëŠ” ë™ë¬¼ ì´ë¦„ì„ ìµœëŒ€í•œ ë§ì´</strong> ë§ì”€í•´ ì£¼ì„¸ìš”.</p>
                    <p>ìŒì„±ì¸ì‹ ë˜ëŠ” í‚¤ë³´ë“œ ì…ë ¥ ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="instruction-card">
                    <h4>âœ… í¬í•¨ ê°€ëŠ¥í•œ ë™ë¬¼</h4>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>í¬ìœ ë¥˜ (ì˜ˆ: ê°œ, ê³ ì–‘ì´, ì‚¬ì, ì½”ë¼ë¦¬)</li>
                        <li>ì¡°ë¥˜ (ì˜ˆ: ì°¸ìƒˆ, ë…ìˆ˜ë¦¬, í­ê·„)</li>
                        <li>ì–´ë¥˜ (ì˜ˆ: ê¸ˆë¶•ì–´, ìƒì–´, ê³ ë“±ì–´)</li>
                        <li>íŒŒì¶©ë¥˜ (ì˜ˆ: ë±€, ê±°ë¶ì´, ì•…ì–´)</li>
                        <li>ì–‘ì„œë¥˜ (ì˜ˆ: ê°œêµ¬ë¦¬, ë„ë¡±ë‡½)</li>
                        <li>ê³¤ì¶© (ì˜ˆ: ë‚˜ë¹„, ê°œë¯¸, ë²Œ)</li>
                        <li>ë©¸ì¢… ë™ë¬¼ (ì˜ˆ: ê³µë£¡, ë§¤ë¨¸ë“œ)</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <h4>âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li><strong>ê°™ì€ ë™ë¬¼ì„ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”</strong> (ì¤‘ë³µì€ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤)</li>
                        <li><strong>ì• ì™„ë™ë¬¼ ì´ë¦„ì€ ì œì™¸</strong> (ì˜ˆ: ë°”ë‘‘ì´, ë‚˜ë¹„ âœ—)</li>
                        <li><strong>ê°€ìƒì˜ ë™ë¬¼ì€ ì œì™¸</strong> (ì˜ˆ: ìš©, ìœ ë‹ˆì½˜, í¬ì¼“ëª¬ âœ—)</li>
                        <li><strong>ë™ë¬¼ ì¢…ë¥˜ë§Œ ë§ì”€í•˜ì„¸ìš”</strong> (ì˜ˆ: "í° ì‚¬ì" âœ— â†’ "ì‚¬ì" âœ“)</li>
                    </ul>
                </div>

                <div class="navigation">
                    <button class="btn voice-guide-btn" id="instructionsVoiceGuideBtn">ğŸ”Š ìŒì„± ì•ˆë‚´ ë“£ê¸°</button>
                    <button class="btn next-btn" id="instructionsNextBtn">ë‹¤ìŒ ë‹¨ê³„</button>
                </div>
            </div>
        </div>

        <!-- Test Page -->
        <div class="page active" id="testPage">
            <div class="test-content">
                <!-- ê²€ì‚¬ ì§„í–‰ í…ìŠ¤íŠ¸ì™€ íƒ€ì´ë¨¸ ìˆ«ì ì œê±° -->
                
                <div class="timer-display" id="timer" style="display: none;">60</div>
                
                <div class="ready-box" id="readyBox">
                    <button class="start-button" id="manualStartBtn" style="display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 99999 !important;"><span>ì‹œì‘í•˜ê¸°</span></button>
                    <div class="ready-check" id="readyCheckMessage">
                        <p>ì¡°ìš©í•œ ì¥ì†Œì—ì„œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                    </div>
                    <div id="audioPermissionNotice" style="display: none; margin-top: 30px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <p style="margin: 0; color: white; opacity: 0.8; font-size: 16px;">ğŸ”Š ìŒì„± ì•ˆë‚´ë¥¼ ì‹œì‘í•˜ë ¤ë©´ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-success" id="startBtn" style="display: none;">ì‹œì‘</button>
                    <button class="btn btn-danger" id="stopBtn" style="display: none;">ì¤‘ì§€</button>
                    <button class="btn btn-primary" id="resetBtn" style="display: none;">ë‹¤ì‹œ ì‹œì‘</button>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <div class="rec-dot"></div>
                    <span>ìŒì„± ì¸ì‹ ì¤‘...</span>
                </div>

                <!-- í‚¤ë³´ë“œ ì…ë ¥ ì„¹ì…˜ ì œê±° -->
                <!--
                <div class="input-section">
                    <input type="text" id="manualInput" placeholder="í‚¤ë³´ë“œë¡œ ì…ë ¥ (Enterë¡œ ì¶”ê°€)" disabled>
                    <button class="btn btn-primary" id="addBtn" disabled>ì¶”ê°€</button>
                </div>
                -->
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ì€ ê²€ì‚¬ ì‹œì‘ í›„ì—ë§Œ í‘œì‹œ -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <h3>ì…ë ¥ëœ ë™ë¬¼ ëª©ë¡</h3>
                <div class="animal-list" id="animalList"></div>
                
                <div class="stats" id="stats" style="display: none;">
                    <h3>ê²€ì‚¬ ê²°ê³¼</h3>
                    
                    <div class="interval-stats" id="intervalStats"></div>
                    
                    <div class="stat-item">
                        <span class="stat-label">ì´ ì‘ë‹µ ìˆ˜:</span>
                        <span class="stat-value" id="totalCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìœ íš¨ ì‘ë‹µ ìˆ˜ (ì¤‘ë³µ ì œì™¸):</span>
                        <span class="stat-value" id="uniqueCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì¤‘ë³µ ì‘ë‹µ ìˆ˜:</span>
                        <span class="stat-value" id="duplicateCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì†Œìš” ì‹œê°„:</span>
                        <span class="stat-value" id="elapsedTime">0ì´ˆ</span>
                    </div>
                    <button class="btn download-btn" id="downloadBtn">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>

            <!-- ì´ì „ ë‹¨ê³„ ë²„íŠ¼ ì œê±° - ì²« í˜ì´ì§€ê°€ ì—†ìœ¼ë¯€ë¡œ í•„ìš” ì—†ìŒ -->
            <!-- <div class="navigation">
                <button class="btn prev-btn" id="testPrevBtn">ì´ì „ ë‹¨ê³„</button>
                <div></div>
            </div> -->
        </div>
    </div>

    <div class="voice-guide-box" id="voiceGuideBox">
        <div id="voiceGuideText"></div>
    </div>

    <!-- ê²€ì‚¬ ì‹œì‘ ì˜¤ë²„ë ˆì´ -->
    <div class="test-start-overlay" id="testStartOverlay">
        <div class="mic-icon">
            <svg viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
            </svg>
        </div>
        <div class="test-start-text">ê²€ì‚¬ ì‹œì‘</div>
    </div>

    <!-- í…ŒìŠ¤íŠ¸ í™”ë©´ -->
    <div class="test-screen" id="testScreen">
        <div class="test-mic-container">
            <div class="test-mic-icon" id="testMicIcon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                </svg>
            </div>
        </div>
        <div class="response-display" id="responseDisplay">
            <div class="response-list" id="responseList"></div>
        </div>
    </div>

    <script>
        // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testClick() {
            console.log('ë²„íŠ¼ í´ë¦­ í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
            alert('ë²„íŠ¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ì½˜ì†”ì— ë©”ì‹œì§€ ì¶œë ¥
        console.log('V6 í˜ì´ì§€ ë¡œë“œë¨ - ì‹œê°„:', new Date().toLocaleTimeString());
        console.log('testClick í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:', typeof testClick);
        
        // ë””ë²„ê¹…: ìš”ì†Œ ìƒíƒœ í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            const readyBox = document.getElementById('readyBox');
            const testContent = document.querySelector('.test-content');
            const testPage = document.getElementById('testPage');
            const manualStartBtn = document.getElementById('manualStartBtn');
            
            console.log('=== ì‹œì‘ ë²„íŠ¼ ë””ë²„ê¹… ===');
            console.log('readyBox:', readyBox);
            console.log('readyBox display:', readyBox ? window.getComputedStyle(readyBox).display : 'null');
            console.log('testContent:', testContent);
            console.log('testContent display:', testContent ? window.getComputedStyle(testContent).display : 'null');
            console.log('testPage:', testPage);
            console.log('testPage display:', testPage ? window.getComputedStyle(testPage).display : 'null');
            console.log('manualStartBtn:', manualStartBtn);
            console.log('manualStartBtn display:', manualStartBtn ? window.getComputedStyle(manualStartBtn).display : 'null');
            console.log('======================');
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ì‹¤í–‰ - ë””ë²„ê¹… ì™„ë£Œë¨
        
        // ì „ì—­ ë³€ìˆ˜
        let animals = [];
        let uniqueAnimals = new Set();
        let startTime = null;
        let endTime = null;
        let timerInterval = null;
        let timeRemaining = 60;
        let recognition = null;
        let isRecognizing = false;
        let currentStep = 1;
        let hardwareSettings = null;
        let instructionsVoiceGuideActive = false;
        let microphonePermissionGranted = false;
        let practiceItems = [];
        let isPracticePhase = false;
        let practiceRetryCount = 0; // ì—°ìŠµ ì¬ì‹œë„ íšŸìˆ˜ ì¶”ê°€
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let mediaStream = null; // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ìœ ì§€

        // ElevenLabs ê´€ë ¨ ë³€ìˆ˜
        let elevenLabsApiKey = null; // ê¸°ë³¸ê°’ ì œê±° (í•˜ë“œì›¨ì–´ ì„¤ì •ì—ì„œë§Œ ë¡œë“œ)
        let elevenLabsVoiceId = null; // ê¸°ë³¸ê°’ ì œê±°
        let elevenLabsConnected = false; // ê¸°ë³¸ê°’ falseë¡œ ë³€ê²½
        let audioQueue = [];
        let isPlaying = false;

        // ì‹œì‘ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        let isStartClicked = false;
        
        window.handleStartClick = function() {
            if (isStartClicked) {
                console.log('ì´ë¯¸ ì‹œì‘ë¨ - ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€');
                return;
            }
            isStartClicked = true;
            
            console.log('handleStartClick í˜¸ì¶œë¨');
            console.log('DOM ìš”ì†Œ ìƒíƒœ:', {
                voiceGuideBox: voiceGuideBox,
                voiceGuideText: voiceGuideText,
                readyBox: readyBox
            });
            
            // DOM ìš”ì†Œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´ˆê¸°í™”
            if (!voiceGuideBox || !voiceGuideText) {
                console.log('DOM ìš”ì†Œê°€ nullì…ë‹ˆë‹¤. ì´ˆê¸°í™” ì‹œë„...');
                initializeDOMElements();
            }
            
            const manualStartBtn = document.getElementById('manualStartBtn');
            const audioPermissionNotice = document.getElementById('audioPermissionNotice');
            const readyBoxElement = document.getElementById('readyBox');
            
            // ì‹œì‘ ë²„íŠ¼ê³¼ readyBoxë¥¼ ì¦‰ì‹œ ìˆ¨ê¹€
            if (manualStartBtn) {
                manualStartBtn.style.display = 'none';
                console.log('ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€');
            }
            
            if (readyBoxElement) {
                readyBoxElement.style.display = 'none';
                console.log('readyBox ìˆ¨ê¹€');
            }
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheckMessage = document.getElementById('readyCheckMessage');
            if (readyCheckMessage) {
                readyCheckMessage.style.display = 'none';
                console.log('readyCheckMessage ìˆ¨ê¹€');
            }
            
            // testScreen í‘œì‹œ (ë¹„í™œì„±í™”ëœ ë§ˆì´í¬ ì•„ì´ì½˜ í¬í•¨)
            if (testScreen) {
                testScreen.classList.add('active');
                testScreen.style.display = 'flex';
                console.log('testScreen í‘œì‹œë¨');
            }
            
            // ë§ˆì´í¬ ì•„ì´ì½˜ì€ ë¹„í™œì„± ìƒíƒœë¡œ í‘œì‹œ
            if (testMicIcon) {
                testMicIcon.classList.remove('active');
                console.log('ë§ˆì´í¬ ì•„ì´ì½˜ ë¹„í™œì„± ìƒíƒœ');
            }
            
            try {
                // ìŒì„± ì•ˆë‚´ ì‹œì‘
                startInstructions();
            } catch (error) {
                console.error('startInstructions ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        let isInstructionsStarted = false;
        
        // ìŒì„± ì•ˆë‚´ ì‹œì‘ í•¨ìˆ˜
        function startInstructions() {
            if (isInstructionsStarted) {
                console.log('startInstructions ì´ë¯¸ ì‹œì‘ë¨ - ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€');
                return;
            }
            isInstructionsStarted = true;
            
            console.log('startInstructions í˜¸ì¶œë¨');
            
            // ì‹œì‘ ë²„íŠ¼ê³¼ ready box ìˆ¨ê¸°ê¸°
            if (readyBox) readyBox.style.display = 'none';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheck = document.getElementById('readyCheckMessage');
            if (readyCheck) readyCheck.style.display = 'none';
            
            // ì²« ë²ˆì§¸ ë‹¨ê³„: ì—°ìŠµ ì•ˆë‚´
            speak("ì§€ê¸ˆë¶€í„°, ê°„ë‹¨í•œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                setTimeout(() => {
                    speak("ë¨¼ì €, ì—°ìŠµë¶€í„° í•´ë³´ê² ìŠµë‹ˆë‹¤.", () => {
                        setTimeout(() => {
                            speak("ì œê°€ 'ì˜·' ì¢…ë¥˜ë¼ê³  í•˜ë©´, ì˜·ì— ì†í•˜ëŠ” ê²ƒë“¤ì˜ ì´ë¦„ì„ ë§ì”€í•´ ë³´ì‹­ì‹œì˜¤.", () => {
                                setTimeout(() => {
                                    speak("ì˜ˆë¥¼ ë“¤ì–´, ì…”ì¸ , ë°”ì§€, ëª¨ì, ê·¸ ì™¸ ë¬´ì—‡ì´ë“ ì§€ ìƒê´€ì—†ìŠµë‹ˆë‹¤.", () => {
                                        setTimeout(() => {
                                            speak("ì˜· ì¢…ë¥˜ì— ì†í•˜ëŠ” ê²ƒ ì¤‘ì—, ë˜ ë‹¤ë¥¸ ê²ƒë“¤ë„ ìˆì£ .", () => {
                                                speak("ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¤ë©´, ì˜·ì¢…ë¥˜ì— ì†í•˜ëŠ” ë‹¤ë¥¸ ê²ƒë“¤ì„ ì œê°€ ê·¸ë§Œí•  ë•Œê¹Œì§€ ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ë³´ì„¸ìš”.", () => {
                                                    console.log('ì—°ìŠµ ì•ˆë‚´ ì™„ë£Œ - ì‚ ì†Œë¦¬ ì¤€ë¹„');
                                                    setTimeout(() => {
                                                        console.log('ì—°ìŠµ ëª¨ë“œ ì‹œì‘');
                                                        isPracticePhase = true;
                                                        practiceItems = [];
                                                        practiceRetryCount = 0; // ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
                                                        if (responseList) responseList.innerHTML = '';
                                                        
                                                        // 1ì´ˆ ì‚ ì†Œë¦¬
                                                        playBeep(880, 1000).then(() => {
                                                            console.log('ì‚ ì†Œë¦¬ ì™„ë£Œ - ë§ˆì´í¬ í™œì„±í™”');
                                                            
                                                            // ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”
                                                            if (testMicIcon) {
                                                                testMicIcon.classList.add('active');
                                                            }
                                                            
                                                            // testScreen í‘œì‹œ
                                                            if (testScreen) {
                                                                testScreen.classList.add('active');
                                                                testScreen.style.display = 'flex';
                                                            }
                                                            
                                                            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘
                                                            startAudioVisualization();
                                                            
                                                            // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° ìŒì„±ì¸ì‹ ì‹œì‘
                                                            setTimeout(() => {
                                                                // ìŒì„±ì¸ì‹ ì´ˆê¸°í™” í™•ì¸
                                                                if (!recognition) {
                                                                    console.log('ì—°ìŠµ ì‹œì‘ ì „ ìŒì„±ì¸ì‹ ì´ˆê¸°í™”');
                                                                    initializeSpeechRecognition();
                                                                }
                                                                
                                                                // ìŒì„±ì¸ì‹ ì‹œì‘
                                                                console.log('ì—°ìŠµ ëª¨ë“œì—ì„œ ìŒì„±ì¸ì‹ ì‹œì‘ ì¤€ë¹„');
                                                                isPracticePhase = true;  // ì—°ìŠµ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
                                                                startSpeechRecognition();
                                                                console.log('ì—°ìŠµ ìŒì„±ì¸ì‹ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œë¨');
                                                            }, 500)  // 0.5ì´ˆ ëŒ€ê¸°
                                                            
                                                            // 10ì´ˆ ì—°ìŠµ ì‹œê°„
                                                            setTimeout(() => {
                                                                console.log('10ì´ˆ ì—°ìŠµ ì‹œê°„ ì¢…ë£Œ');
                                                                console.log('ì—°ìŠµ í•­ëª© ê°œìˆ˜:', practiceItems.length);
                                                                console.log('ì—°ìŠµ í•­ëª©:', practiceItems);
                                                                
                                                                // ì—°ìŠµ ëª¨ë“œ ì¢…ë£Œ
                                                                isPracticePhase = false;
                                                                // ìŒì„±ì¸ì‹ì€ ê³„ì† ìœ ì§€í•˜ë˜ ì¸ì‹ í”Œë˜ê·¸ë§Œ falseë¡œ
                                                                isRecognizing = false;
                                                                
                                                                // ë§ˆì´í¬ ì•„ì´ì½˜ ë¹„í™œì„±í™”
                                                                if (testMicIcon) {
                                                                    testMicIcon.classList.remove('active');
                                                                }
                                                                
                                                                // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
                                                                stopAudioVisualization();
                                                                
                                                                // ì‘ë‹µì´ ìˆì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ë³¸ ê²€ì‚¬ë¡œ ì§„í–‰
                                                                if (practiceItems.length === 0 && practiceRetryCount < 1) {
                                                                    console.log('ì—°ìŠµ ì‘ë‹µ ì—†ìŒ - ì¬ì‹œë„ ì•ˆë‚´');
                                                                    practiceRetryCount++; // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€
                                                                    speak("ì•„ë¬´ ë§ì”€ë„ ë“¤ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ ì—°ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.", () => {
                                                                        setTimeout(() => {
                                                                            speak("ì œê°€ ì˜· ì¢…ë¥˜ë¼ê³  ë§í•˜ë©´, ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¬ ë•Œ ì˜·ì— ì†í•˜ëŠ” ê²ƒë“¤ì„ ë§ì”€í•´ì£¼ì„¸ìš”.", () => {
                                                                                setTimeout(() => {
                                                                                    // ì—°ìŠµ ì¬ì‹œì‘
                                                                                    practiceItems = [];
                                                                                    if (responseList) responseList.innerHTML = '';
                                                                                    
                                                                                    // 1ì´ˆ ì‚ ì†Œë¦¬
                                                                                    playBeep(880, 1000).then(() => {
                                                                                        // ë§ˆì´í¬ í™œì„±í™” í‘œì‹œ
                                                                                        if (testMicIcon) testMicIcon.classList.add('active');
                                                                                        
                                                                                        // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘
                                                                                        startAudioVisualization();
                                                                                        
                                                                                        console.log('ì—°ìŠµ ì¬ì‹œë„ ì‹œì‘ - 10ì´ˆ ëŒ€ê¸°');
                                                                                        setTimeout(() => {
                                                                                            console.log('ì—°ìŠµ ì¬ì‹œë„ ì¢…ë£Œ');
                                                                                            isPracticePhase = false;
                                                                                            
                                                                                            // ë§ˆì´í¬ ë¹„í™œì„±í™”
                                                                                            if (testMicIcon) testMicIcon.classList.remove('active');
                                                                                            
                                                                                            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
                                                                                            stopAudioVisualization();
                                                                                            
                                                                                            // ë‘ ë²ˆì§¸ ì—°ìŠµì—ì„œë„ ì‘ë‹µì´ ì—†ìœ¼ë©´ ë³¸ê²€ì‚¬ë¡œ ì§„í–‰
                                                                                            if (practiceItems.length === 0) {
                                                                                                console.log('ì—°ìŠµ ì¬ì‹œë„ì—ë„ ì‘ë‹µ ì—†ìŒ - ë³¸ê²€ì‚¬ë¡œ ì§„í–‰');
                                                                                                speak("ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                                                                    proceedToMainTest();
                                                                                                });
                                                                                            } else {
                                                                                                speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                                                                    proceedToMainTest();
                                                                                                });
                                                                                            }
                                                                                        }, 10000); // 10ì´ˆ
                                                                                    });
                                                                                }, 1000);
                                                                            });
                                                                        }, 800);
                                                                    });
                                                                } else if (practiceItems.length === 0 && practiceRetryCount >= 1) {
                                                                    // ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ë°”ë¡œ ë³¸ê²€ì‚¬ë¡œ ì§„í–‰
                                                                    console.log('ì—°ìŠµ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ - ë³¸ê²€ì‚¬ë¡œ ì§„í–‰');
                                                                    speak("ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                                        proceedToMainTest();
                                                                    });
                                                                } else {
                                                                    speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                                        proceedToMainTest();
                                                                    });
                                                                }
                                                            }, 10000); // 10ì´ˆ
                                                        });
                                                    }, 1500);
                                                });
                                            });
                                        }, 800);
                                    });
                                }, 800);
                            });
                        }, 800);
                    });
                }, 800);
            });
        }

        // DOM ìš”ì†Œ (ì´ˆê¸°ì—ëŠ” nullë¡œ ì„¤ì •)
        let pages = null;
        let instructionsNextBtn = null;
        let instructionsVoiceGuideBtn = null;
        let timer = null;
        let startBtn = null;
        let stopBtn = null;
        let resetBtn = null;
        let animalList = null;
        let stats = null;
        let recordingIndicator = null;
        let downloadBtn = null;
        let voiceGuideBox = null;
        let voiceGuideText = null;
        let readyBox = null;
        let setupWarning = null;
        let testStartOverlay = null;
        let testScreen = null;
        let responseList = null;
        let resultsSection = null;
        let testMicIcon = null;
        
        // DOM ìš”ì†Œ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeDOMElements() {
            pages = {
                instructions: document.getElementById('instructionsPage'),
                test: document.getElementById('testPage')
            };
            instructionsNextBtn = document.getElementById('instructionsNextBtn');
            instructionsVoiceGuideBtn = document.getElementById('instructionsVoiceGuideBtn');
            timer = document.getElementById('timer');
            startBtn = document.getElementById('startBtn');
            stopBtn = document.getElementById('stopBtn');
            resetBtn = document.getElementById('resetBtn');
            animalList = document.getElementById('animalList');
            stats = document.getElementById('stats');
            recordingIndicator = document.getElementById('recordingIndicator');
            downloadBtn = document.getElementById('downloadBtn');
            voiceGuideBox = document.getElementById('voiceGuideBox');
            voiceGuideText = document.getElementById('voiceGuideText');
            readyBox = document.getElementById('readyBox');
            setupWarning = document.getElementById('setupWarning');
            testStartOverlay = document.getElementById('testStartOverlay');
            testScreen = document.getElementById('testScreen');
            responseList = document.getElementById('responseList');
            resultsSection = document.getElementById('resultsSection');
            testMicIcon = document.getElementById('testMicIcon');
            
            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸
            console.log('DOM ìš”ì†Œ ì´ˆê¸°í™” ê²°ê³¼:', {
                timer: timer ? 'OK' : 'NULL',
                startBtn: startBtn ? 'OK' : 'NULL',
                stopBtn: stopBtn ? 'OK' : 'NULL',
                testScreen: testScreen ? 'OK' : 'NULL'
            });
        }

        // í•˜ë“œì›¨ì–´ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
        function goToSetup() {
            window.location.href = 'hardware-setup.html?next=animal-fluency-test-v2.html';
        }
        
        // ë¸Œë¼ìš°ì € ê²½ê³  ë¬´ì‹œí•˜ê³  ê³„ì†
        function continueDespiteBrowser() {
            document.getElementById('browserWarning').style.display = 'none';
            tryAutoVoiceStart();
        }
        
        
        
        // ìŒì„± í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testVoice() {
            console.log('=== ìŒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            console.log('ElevenLabs ì„¤ì •:', {
                apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                voiceId: elevenLabsVoiceId,
                connected: elevenLabsConnected
            });
            console.log('í•˜ë“œì›¨ì–´ ì„¤ì •:', hardwareSettings);
            
            // 1. ë¸Œë¼ìš°ì € ê¸°ë³¸ TTS í…ŒìŠ¤íŠ¸
            const utterance = new SpeechSynthesisUtterance("ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.");
            utterance.lang = 'ko-KR';
            utterance.onend = () => console.log('ë¸Œë¼ìš°ì € TTS ì™„ë£Œ');
            utterance.onerror = (e) => console.error('ë¸Œë¼ìš°ì € TTS ì˜¤ë¥˜:', e);
            window.speechSynthesis.speak(utterance);
            
            // 2. speak í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
            setTimeout(() => {
                speak("ì´ê²ƒì€ í†µí•© ìŒì„± í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.", () => {
                    console.log('speak í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                });
            }, 2000);
        }
        
        // ìŒì„± ì•ˆë‚´ ì‹œì‘ ì—¬ë¶€ ì¶”ì 
        let voiceIntroStarted = false;
        
        // ìŒì„± ì•ˆë‚´ ì‹œì‘ í•¨ìˆ˜
        function startVoiceIntroduction() {
            
            // ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (voiceIntroStarted) {
                console.log('ìŒì„± ì•ˆë‚´ê°€ ì´ë¯¸ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            voiceIntroStarted = true;
            console.log('ìŒì„± ì•ˆë‚´ ì‹œì‘...');
            
            // ë¸Œë¼ìš°ì € ì²´í¬ ë° ì•ˆë‚´
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome) {
                console.log('Chromeì´ ì•„ë‹Œ ë¸Œë¼ìš°ì € ê°ì§€:', navigator.userAgent);
            }
            
            // ì¦‰ì‹œ ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê³  í…ŒìŠ¤íŠ¸ í™”ë©´ í‘œì‹œ
            if (readyBox) readyBox.style.display = 'none';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheckMsg = document.getElementById('readyCheckMessage');
            if (readyCheckMsg) readyCheckMsg.style.display = 'none';
            
            // startInstructions í•¨ìˆ˜ í˜¸ì¶œë¡œ ì—°ê²° - ì œê±° (ì¤‘ë³µ ë°©ì§€)
            // startInstructions();
            
            // ë§ˆì´í¬ ì•„ì´ì½˜ì€ ë¹„í™œì„± ìƒíƒœë¡œ í‘œì‹œ
            const localTestMicIcon = document.getElementById('testMicIcon');
            if (localTestMicIcon) localTestMicIcon.classList.remove('active');
            
            // ë°”ë¡œ ìŒì„± ì•ˆë‚´ ì‹œì‘ (ë¬´ìŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì—†ì´)
            speak("ì´ì œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                console.log('ì²« ë²ˆì§¸ ì•ˆë‚´ ì™„ë£Œ');
                
                setTimeout(() => {
                    speak("ì œê°€, ì–´ë–¤ ì¢…ë¥˜ë¥¼ ë§ì”€ë“œë¦¬ë©´, ë˜ë„ë¡, ë¹¨ë¦¬, ê·¸ ì¢…ë¥˜ì— ì†í•˜ëŠ” ì‚¬ë¬¼ë“¤ì˜ ì´ë¦„ì„, ëª¨ë‘ ë§ì”€í•´ì£¼ì„¸ìš”.", () => {
                        speak("ì˜ˆë¥¼ ë“¤ì–´, ì œê°€, 'ì˜· ì¢…ë¥˜'ë¼ê³  ë§í•˜ë©´, ì…”ì¸ , ë„¥íƒ€ì´, ëª¨ì ë“±ì˜ ì´ë¦„ì„, ë§ì”€í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                            speak("ì˜· ì¢…ë¥˜ì— ì†í•˜ëŠ” ê²ƒ ì¤‘ì—, ë˜ ë‹¤ë¥¸ ê²ƒë“¤ë„ ìˆì£ .", () => {
                                speak("ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¤ë©´, ì˜·ì¢…ë¥˜ì— ì†í•˜ëŠ” ë‹¤ë¥¸ ê²ƒë“¤ì„ ì œê°€ ê·¸ë§Œí•  ë•Œê¹Œì§€ ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ë³´ì„¸ìš”.", () => {
                                    console.log('ì—°ìŠµ ì•ˆë‚´ ì™„ë£Œ - ì‚ ì†Œë¦¬ ì¤€ë¹„');
                                    setTimeout(() => {
                                        console.log('ì—°ìŠµ ëª¨ë“œ ì‹œì‘');
                                        isPracticePhase = true;
                                        practiceItems = [];
                                        practiceRetryCount = 0; // ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
                                        if (responseList) responseList.innerHTML = '';
                                        
                                        // 1ì´ˆ ì‚ ì†Œë¦¬
                                        playBeep(880, 1000).then(async () => {
                                            // ë§ˆì´í¬ í™œì„±í™” í‘œì‹œ
                                            if (testMicIcon) testMicIcon.classList.add('active');
                                            
                                            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘ (ì´ë¯¸ ê¶Œí•œì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
                                            startAudioVisualization();
                                            
                                            // ì‚ ì†Œë¦¬ í›„ ì§§ì€ ëŒ€ê¸° ì‹œê°„ì„ ë‘ê³  ìŒì„±ì¸ì‹ ì‹œì‘
                                            setTimeout(() => {
                                                // ìŒì„±ì¸ì‹ ì‹œì‘ (ì—°ìŠµìš©)
                                                if (!recognition) {
                                                    console.log('ì—°ìŠµìš© ìŒì„±ì¸ì‹ ì´ˆê¸°í™”');
                                                    initializeSpeechRecognition();
                                                }
                                                
                                                if (recognition) {
                                                    isPracticePhase = true;  // ì—°ìŠµ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
                                                    startSpeechRecognition();
                                                    console.log('ì—°ìŠµìš© ìŒì„±ì¸ì‹ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ');
                                                } else {
                                                    console.error('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì‹¤íŒ¨');
                                                }
                                            }, 500)  // 0.5ì´ˆ ëŒ€ê¸°
                                            
                                            // 10ì´ˆ ì—°ìŠµ ì‹œê°„
                                            setTimeout(() => {
                                                console.log('10ì´ˆ ì—°ìŠµ ì‹œê°„ ì¢…ë£Œ');
                                                console.log('ì—°ìŠµ í•­ëª© ê°œìˆ˜:', practiceItems.length);
                                                console.log('ì—°ìŠµ í•­ëª©:', practiceItems);
                                                
                                                // ì—°ìŠµ ëª¨ë“œ ì¢…ë£Œ
                                                isPracticePhase = false;
                                                // ìŒì„±ì¸ì‹ ë¹„í™œì„±í™” (ì•ˆë‚´ ìŒì„±ì´ ì¸ì‹ë˜ì§€ ì•Šë„ë¡)
                                                isRecognizing = false;
                                                console.log('ì—°ìŠµ ì¢…ë£Œ - ìŒì„±ì¸ì‹ ì¼ì‹œ ë¹„í™œì„±í™”');
                                                
                                                // ë§ˆì´í¬ ë¹„í™œì„±í™” í‘œì‹œ
                                                if (testMicIcon) testMicIcon.classList.remove('active');
                                                
                                                // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
                                                stopAudioVisualization();
                                                
                                                // ì‘ë‹µì´ ìˆì—ˆëŠ”ì§€ í™•ì¸
                                                if (practiceItems.length === 0 && practiceRetryCount < 1) {
                                                    console.log('ì—°ìŠµ ì‘ë‹µ ì—†ìŒ - ì¬ì‹œë„ ì•ˆë‚´');
                                                    practiceRetryCount++; // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€
                                                    speak("ì•„ë¬´ ë§ì”€ë„ ë“¤ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ ì—°ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.", () => {
                                                        setTimeout(() => {
                                                            speak("ì œê°€ ì˜· ì¢…ë¥˜ë¼ê³  ë§í•˜ë©´, ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¬ ë•Œ ì˜·ì— ì†í•˜ëŠ” ê²ƒë“¤ì„ ë§ì”€í•´ì£¼ì„¸ìš”.", () => {
                                                                setTimeout(() => {
                                                                    // ì—°ìŠµ ì¬ì‹œì‘
                                                                    isPracticePhase = true;
                                                                    practiceItems = [];
                                                                    responseList.innerHTML = '';
                                                                    
                                                                    playBeep(880, 1000).then(() => {
                                                                        if (testMicIcon) testMicIcon.classList.add('active');
                                                                        startAudioVisualization();
                                                                        
                                                                        setTimeout(() => {
                                                                            if (recognition && !isRecognizing) {
                                                                                try {
                                                                                    recognition.start();
                                                                                    isRecognizing = true;
                                                                                    console.log('ì—°ìŠµ ì¬ì‹œë„ - ìŒì„±ì¸ì‹ ì‹œì‘');
                                                                                } catch (e) {
                                                                                    console.log('ìŒì„±ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', e);
                                                                                }
                                                                            }
                                                                        }, 500);
                                                                        
                                                                        // 10ì´ˆ í›„ ë‹¤ì‹œ ì²´í¬
                                                                        setTimeout(() => {
                                                                            isPracticePhase = false;
                                                                            isRecognizing = false;
                                                                            if (testMicIcon) testMicIcon.classList.remove('active');
                                                                            stopAudioVisualization();
                                                                            
                                                                            // ë‘ ë²ˆì§¸ ì‹œë„ì—ì„œë„ ì‘ë‹µì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì§„í–‰
                                                                            if (practiceItems.length === 0) {
                                                                                speak("ì˜·ì˜ ì¢…ë¥˜ë¥¼ ë§ì”€í•˜ì…”ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì…”ì¸ , ë°”ì§€, ëª¨ì ê°™ì€ ê²ƒë“¤ì…ë‹ˆë‹¤. ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                                                    proceedToMainTest();
                                                                                });
                                                                            } else {
                                                                                speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                                                    proceedToMainTest();
                                                                                });
                                                                            }
                                                                        }, 10000);
                                                                    });
                                                                }, 1000);
                                                            });
                                                        }, 800);
                                                    });
                                                } else if (practiceItems.length === 0 && practiceRetryCount >= 1) {
                                                    // ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ë°”ë¡œ ë³¸ê²€ì‚¬ë¡œ ì§„í–‰
                                                    console.log('ì—°ìŠµ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ - ë³¸ê²€ì‚¬ë¡œ ì§„í–‰');
                                                    speak("ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                        proceedToMainTest();
                                                    });
                                                } else {
                                                    speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                        proceedToMainTest();
                                                    });
                                                }
                                            }, 10000); // 10ì´ˆ ëŒ€ê¸°
                                        });
                                    }, 1000);
                                });
                            });
                        });
                    });
                }, 1000);
            });
        }
        
        // ë³¸ ê²€ì‚¬ ì§„í–‰ í•¨ìˆ˜
        function proceedToMainTest() {
            console.log('proceedToMainTest í•¨ìˆ˜ í˜¸ì¶œë¨');
            setTimeout(() => {
                console.log('ë³¸ì‹œí–‰ ì•ˆë‚´ ì‹œì‘');
                speak("ì§€ê¸ˆë¶€í„°ëŠ”, ë‹¤ë¥¸ ì¢…ë¥˜, ì¦‰ 'ë™ë¬¼' ì¢…ë¥˜ì— ì†í•˜ëŠ” ê²ƒë“¤ì˜ ì´ë¦„ì„, ëª¨ë‘ ë§ì”€í•´ë³´ì‹­ì‹œì˜¤.", () => {
                    setTimeout(() => {
                        speak("1ë¶„ì˜ ì‹œê°„ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. 1ë¶„ ë™ì•ˆ, ìƒê°ë‚˜ëŠ” ë™ë¬¼ì˜ ì´ë¦„ì„, ë§ˆì´í¬ê°€ êº¼ì§ˆ ë•Œê¹Œì§€ í¬ê¸°í•˜ì§€ ë§ˆì‹œê³ , ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ë³´ì„¸ìš”.", () => {
                            setTimeout(() => {
                                speak("ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ? ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¤ë©´, ë°”ë¡œ ì‹œì‘í•´ ì£¼ì„¸ìš”.", () => {
                                    console.log('ëª¨ë“  ì•ˆë‚´ ì™„ë£Œ - í˜„ì¬ ì‹œê°:', new Date().toLocaleTimeString());
                                    
                                    // ì•ˆë‚´ ì¢…ë£Œ í›„ 1ì´ˆ ëŒ€ê¸°
                                    console.log('1ì´ˆ ëŒ€ê¸° ì‹œì‘');
                                    setTimeout(() => {
                                        console.log('1ì´ˆ ëŒ€ê¸° ì™„ë£Œ - ë³¸ì‹œí–‰ ì‹œì‘:', new Date().toLocaleTimeString());
                                        startTest(); // ì‹œì‘ í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ
                                    }, 1000);
                                });
                            }, 800);
                        });
                    }, 800);
                });
            }, 800);
        }

        // í•˜ë“œì›¨ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadHardwareSettings() {
            const settingsStr = localStorage.getItem('hardwareSettings');
            if (settingsStr) {
                try {
                    hardwareSettings = JSON.parse(settingsStr);
                    console.log('í•˜ë“œì›¨ì–´ ì„¤ì • ë¡œë“œ:', hardwareSettings);
                    
                    // ElevenLabs ì„¤ì • ì ìš© (ì„¤ì •ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°)
                    if (hardwareSettings.elevenLabsApiKey) {
                        elevenLabsApiKey = hardwareSettings.elevenLabsApiKey;
                    }
                    if (hardwareSettings.elevenLabsVoiceId) {
                        elevenLabsVoiceId = hardwareSettings.elevenLabsVoiceId;
                    }
                    if (hardwareSettings.elevenLabsConnected !== undefined) {
                        elevenLabsConnected = hardwareSettings.elevenLabsConnected;
                    }
                    
                    console.log('ElevenLabs ì„¤ì •:', {
                        apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                        voiceId: elevenLabsVoiceId,
                        connected: elevenLabsConnected
                    });
                    
                    // ìŒì„± ì„¤ì •ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if (!hardwareSettings.voiceEnabled) {
                        console.log('ìŒì„± ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('í•˜ë“œì›¨ì–´ ì„¤ì • íŒŒì‹± ì˜¤ë¥˜:', error);
                    return false;
                }
            }
            console.log('í•˜ë“œì›¨ì–´ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }

        // í˜ì´ì§€ ì „í™˜
        function showPage(pageId) {
            console.log('showPage í˜¸ì¶œ:', pageId);
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
                console.log('í˜ì´ì§€ í‘œì‹œ ì™„ë£Œ:', pageId);
            } else {
                console.error('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', pageId);
            }
        }

        // ìŒì„± ì•ˆë‚´ í‘œì‹œ
        function showVoiceGuide(text) {
            console.log('showVoiceGuide í˜¸ì¶œ:', {
                text: text,
                voiceGuideBox: voiceGuideBox,
                voiceGuideText: voiceGuideText
            });
            
            if (!voiceGuideBox || !voiceGuideText) {
                console.error('voiceGuideBox ë˜ëŠ” voiceGuideTextê°€ nullì…ë‹ˆë‹¤');
                return;
            }
            
            voiceGuideText.textContent = text;
            voiceGuideBox.classList.add('active');
        }

        function hideVoiceGuide() {
            voiceGuideBox.classList.remove('active');
        }

        // ElevenLabs TTS
        async function elevenLabsTTS(text, callback) {
            console.log('elevenLabsTTS í˜¸ì¶œ:', {
                apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                voiceId: elevenLabsVoiceId,
                text: text
            });
            
            if (!elevenLabsApiKey || !elevenLabsVoiceId) {
                console.error('ElevenLabs ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤');
                // ElevenLabs ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ TTSë¡œ í´ë°±
                defaultTTS(text, callback);
                return;
            }

            audioQueue.push({ text, callback });
            if (!isPlaying) {
                playNextInQueue();
            }
        }

        async function playNextInQueue() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const { text, callback } = audioQueue.shift();

            try {
                console.log('ElevenLabs API í˜¸ì¶œ ì‹œì‘:', {
                    url: `https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}/stream`,
                    text: text
                });
                
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}/stream`, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': elevenLabsApiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: hardwareSettings?.voiceSettings || {
                            stability: 0.85,  // ë” ì•ˆì •ì ì¸ ë°œìŒì„ ìœ„í•´ ì¦ê°€
                            similarity_boost: 0.75,
                            style: 0.3,  // ë” ëª…í™•í•œ ë°œìŒì„ ìœ„í•´ ê°ì†Œ
                            use_speaker_boost: true
                        }
                    })
                });

                console.log('ElevenLabs API ì‘ë‹µ:', {
                    status: response.status,
                    ok: response.ok
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        hideVoiceGuide();
                        
                        // ìŒì„± ì•ˆë‚´ê°€ ëë‚œ í›„ì—ë„ ìŒì„±ì¸ì‹ì„ ìë™ìœ¼ë¡œ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ
                        // ì‚ ì†Œë¦¬ í›„ì—ë§Œ ì‹œì‘í•˜ë„ë¡ í•¨
                        
                        if (callback) callback();
                        playNextInQueue();
                    };

                    audio.onerror = () => {
                        console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜');
                        hideVoiceGuide();
                        if (callback) callback();
                        playNextInQueue();
                    };

                    audio.play();
                } else {
                    // API ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë‚´ìš© í™•ì¸
                    const errorText = await response.text();
                    console.error('ElevenLabs API ì—ëŸ¬:', {
                        status: response.status,
                        error: errorText
                    });
                    // ê¸°ë³¸ TTSë¡œ í´ë°±
                    hideVoiceGuide();
                    defaultTTS(text, callback);
                    playNextInQueue();
                }
            } catch (error) {
                console.error('ElevenLabs TTS ì˜¤ë¥˜:', error);
                hideVoiceGuide();
                // ê¸°ë³¸ TTSë¡œ í´ë°±
                defaultTTS(text, callback);
                playNextInQueue();
            }
        }

        // ê¸°ë³¸ ë¸Œë¼ìš°ì € TTS
        function defaultTTS(text, callback) {
            console.log('defaultTTS í˜¸ì¶œ:', text);
            
            if (!window.speechSynthesis) {
                console.error('ë¸Œë¼ìš°ì €ê°€ ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                if (callback) callback();
                return;
            }

            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = hardwareSettings?.voiceSpeed || 1;
            utterance.pitch = 1;
            utterance.volume = 1;

            const voices = window.speechSynthesis.getVoices();
            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:', voices.length);
            
            const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
                utterance.voice = koreanVoice;
                console.log('í•œêµ­ì–´ ìŒì„± ì„ íƒ:', koreanVoice.name);
            } else {
                console.log('í•œêµ­ì–´ ìŒì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            utterance.onstart = () => {
                console.log('ìŒì„± ì¶œë ¥ ì‹œì‘');
            };
            
            utterance.onend = () => {
                console.log('ìŒì„± ì¶œë ¥ ì™„ë£Œ');
                hideVoiceGuide();
                
                // ìŒì„± ì•ˆë‚´ê°€ ëë‚œ í›„ì—ë„ ìŒì„±ì¸ì‹ì„ ìë™ìœ¼ë¡œ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ
                // ì‚ ì†Œë¦¬ í›„ì—ë§Œ ì‹œì‘í•˜ë„ë¡ í•¨
                
                if (callback) callback();
            };
            
            utterance.onerror = (event) => {
                console.error('ìŒì„± ì¶œë ¥ ì˜¤ë¥˜:', event);
                hideVoiceGuide();
                if (callback) callback();
            };

            window.speechSynthesis.speak(utterance);
            console.log('ìŒì„± í•©ì„± ìš”ì²­ë¨');
        }

        // ìŒì„± í•©ì„± (í†µí•© í•¨ìˆ˜)
        function speak(text, callback) {
            // ì´ë¯¸ ê°™ì€ í…ìŠ¤íŠ¸ê°€ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                console.log('ìŒì„±ì´ ì´ë¯¸ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€:', text);
                return;
            }
            
            console.log('speak í•¨ìˆ˜ í˜¸ì¶œ:', {
                text: text,
                hardwareSettings: hardwareSettings,
                voiceEnabled: hardwareSettings?.voiceEnabled !== false, // undefinedì¼ ë•Œë„ true
                elevenLabsConnected: elevenLabsConnected,
                elevenLabsApiKey: elevenLabsApiKey ? 'Set' : 'Not set'
            });
            
            // ìŒì„± ê¸°ëŠ¥ì´ ëª…ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ìŠ¤í‚µ
            if (hardwareSettings && hardwareSettings.voiceEnabled === false) {
                console.log('ìŒì„± ê¸°ëŠ¥ì´ ëª…ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                if (callback) callback();
                return;
            }
            
            // ìŒì„± ì•ˆë‚´ ì¤‘ì—ëŠ” ìŒì„±ì¸ì‹ ì¼ì‹œ ì¤‘ì§€
            if (recognition && isRecognizing) {
                console.log('ìŒì„± ì•ˆë‚´ ì¤‘ ìŒì„±ì¸ì‹ ì¼ì‹œ ì¤‘ì§€');
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('ìŒì„±ì¸ì‹ ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜:', e);
                }
                isRecognizing = false;
            }

            showVoiceGuide(text);

            if (elevenLabsConnected && elevenLabsApiKey && elevenLabsVoiceId) {
                console.log('ElevenLabs TTS ì‚¬ìš©');
                elevenLabsTTS(text, callback);
            } else {
                console.log('ê¸°ë³¸ ë¸Œë¼ìš°ì € TTS ì‚¬ìš©');
                defaultTTS(text, callback);
            }
        }

        // ê²€ì‚¬ ì•ˆë‚´ ìŒì„± ê°€ì´ë“œ
        function instructionsVoiceGuide() {
            const guides = [
                "ê²€ì‚¬ ì•ˆë‚´ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.",
                "ì´ ê²€ì‚¬ëŠ” 1ë¶„ ë™ì•ˆ ì§„í–‰ë©ë‹ˆë‹¤.",
                "ì‹œì‘ ì‹ í˜¸ê°€ ë‚˜ë©´ ìƒê°ë‚˜ëŠ” ë™ë¬¼ ì´ë¦„ì„ ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ì£¼ì„¸ìš”.",
                "í¬ìœ ë¥˜, ì¡°ë¥˜, ì–´ë¥˜, íŒŒì¶©ë¥˜, ì–‘ì„œë¥˜, ê³¤ì¶© ë“± ëª¨ë“  ì¢…ë¥˜ì˜ ë™ë¬¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
                "ë©¸ì¢…ëœ ë™ë¬¼ë„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "ë‹¨, ì• ì™„ë™ë¬¼ì˜ ì´ë¦„ì´ë‚˜ ê°€ìƒì˜ ë™ë¬¼ì€ ì œì™¸ë©ë‹ˆë‹¤.",
                "ê°™ì€ ë™ë¬¼ì„ ë°˜ë³µí•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ ì£¼ì„¸ìš”.",
                "ìŒì„±ì¸ì‹ì´ ì–´ë ¤ìš´ ê²½ìš° í‚¤ë³´ë“œë¡œ ì…ë ¥í•˜ì‹¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.",
                "ì¤€ë¹„ê°€ ë˜ì…¨ìœ¼ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”."
            ];

            let index = 0;
            function speakNext() {
                if (index < guides.length) {
                    speak(guides[index], () => {
                        index++;
                        if (index < guides.length) {
                            setTimeout(speakNext, 800);
                        }
                    });
                }
            }
            speakNext();
        }

        // ìŒì„±ì¸ì‹ ì´ˆê¸°í™”
        function initializeSpeechRecognition() {
            // ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„± ì²´í¬
            const SpeechRecognition = window.SpeechRecognition || 
                                    window.webkitSpeechRecognition || 
                                    window.mozSpeechRecognition || 
                                    window.msSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                alert('ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nChrome ë¸Œë¼ìš°ì € ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.');
                return false;
            }
            
            try {
                // ì´ë¯¸ recognition ê°ì²´ê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'ko-KR';
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.maxAlternatives = 1;
                    
                    recognition.onstart = () => {
                        console.log('ìŒì„±ì¸ì‹ ì‹œì‘ë¨');
                        isRecognizing = true;
                        
                        // ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”
                        const testMicIcon = document.querySelector('.test-mic-icon');
                        if (testMicIcon) {
                            testMicIcon.classList.add('active');
                            console.log('ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”ë¨');
                        }
                    };

                    // ê° ìŒì„± ì„¸ê·¸ë¨¼íŠ¸ì˜ ì‹œì‘ ì‹œê°„ì„ ì €ì¥í•˜ëŠ” ë§µ
                    const speechStartTimes = new Map();
                    
                    recognition.onresult = (event) => {
                        // ì—°ìŠµ ëª¨ë“œì´ê±°ë‚˜ ë³¸ ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ ì²˜ë¦¬
                        if (!isPracticePhase && !isRecognizing) {
                            console.log('ìŒì„±ì¸ì‹ ê²°ê³¼ ë¬´ì‹œ - ì—°ìŠµ/ë³¸ì‹œí–‰ ì¤‘ì´ ì•„ë‹˜');
                            return;
                        }
                        if (!isPracticePhase && timeRemaining <= 0) {
                            console.log('ìŒì„±ì¸ì‹ ê²°ê³¼ ë¬´ì‹œ - ì‹œê°„ ì¢…ë£Œ');
                            return;
                        }
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const result = event.results[i];
                            
                            // ì´ ê²°ê³¼ì— ëŒ€í•œ ì‹œì‘ ì‹œê°„ì´ ì•„ì§ ê¸°ë¡ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ë¡
                            if (!speechStartTimes.has(i)) {
                                const speechStartTime = Date.now() - startTime;
                                speechStartTimes.set(i, speechStartTime);
                                console.log(`ìŒì„± ì„¸ê·¸ë¨¼íŠ¸ ${i} ì‹œì‘ ì‹œê°„: ${speechStartTime}ms (${Math.floor(speechStartTime/1000)}ì´ˆ)`);
                            }
                            
                            if (result.isFinal) {
                                const transcript = result[0].transcript.trim();
                                const speechStartTime = speechStartTimes.get(i);
                                console.log('ì¸ì‹ëœ í…ìŠ¤íŠ¸:', transcript, 'ì—°ìŠµëª¨ë“œ:', isPracticePhase);
                                console.log('ìŒì„± ì…ë ¥ ì‹œì‘ ì‹œê°„:', speechStartTime, 'ms');
                                
                                const words = transcript.split(/[\s,ï¼Œã€]+/).filter(word => word.length > 0);
                                words.forEach((word, index) => {
                                    if (word.length > 0) {
                                        if (isPracticePhase) {
                                            // ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ëª¨ë“  ë‹¨ì–´ í—ˆìš© (ì˜· ì¢…ë¥˜)
                                            console.log('ì—°ìŠµ í•­ëª© ì¶”ê°€:', word);
                                            addPracticeItem(word);
                                        } else {
                                            // ë³¸ ê²€ì‚¬ì—ì„œëŠ” ëª¨ë“  ëª…ì‚¬ ì¸ì‹ (V15 ìˆ˜ì •)
                                            // ì—¬ëŸ¬ ë‹¨ì–´ê°€ í•œ ë²ˆì— ì¸ì‹ëœ ê²½ìš°, ê° ë‹¨ì–´ì— ì•½ê°„ì˜ ì‹œê°„ ê°„ê²© ì¶”ê°€
                                            const adjustedTime = speechStartTime + (index * 500);
                                            console.log('ë‹¨ì–´ ì¶”ê°€:', word, 'ì¡°ì •ëœ ì‹œê°„:', adjustedTime);
                                            // ìŒì„± ì…ë ¥ ì‹œì‘ ì‹œê°„ì„ í•¨ê»˜ ì „ë‹¬
                                            addAnimal(word, adjustedTime);
                                        }
                                    }
                                });
                                
                                // ì²˜ë¦¬ ì™„ë£Œëœ ê²°ê³¼ì˜ ì‹œì‘ ì‹œê°„ ì‚­ì œ
                                speechStartTimes.delete(i);
                            }
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error('ìŒì„±ì¸ì‹ ì˜¤ë¥˜:', event.error);
                        if (event.error === 'no-speech' && isRecognizing) {
                            // no-speech ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
                            console.log('no-speech ì˜¤ë¥˜ ë¬´ì‹œ');
                        } else if (event.error === 'not-allowed') {
                            console.error('ë§ˆì´í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            alert('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                        }
                    };

                    recognition.onend = () => {
                        console.log('ìŒì„±ì¸ì‹ ì¢…ë£Œë¨');
                        // ì—°ìŠµ ëª¨ë“œì´ê±°ë‚˜ ë³¸ ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì¼ ë•Œ ì¬ì‹œì‘
                        if ((isPracticePhase || isRecognizing) && timeRemaining > 0) {
                            setTimeout(() => {
                                try {
                                    recognition.start();
                                    console.log('ìŒì„±ì¸ì‹ ì¬ì‹œì‘ë¨');
                                } catch (e) {
                                    console.error('ìŒì„±ì¸ì‹ ì¬ì‹œì‘ ì˜¤ë¥˜:', e);
                                }
                            }, 100);
                        }
                    };
                }
                
                return true;
            } catch (error) {
                console.error('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
                return false;
            }
        }

        // ì‹ í˜¸ìŒ ì¬ìƒ í•¨ìˆ˜
        function playBeep(frequency = 880, duration = 200) {
            return new Promise((resolve) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
                
                setTimeout(resolve, duration);
            });
        }


        // ì˜¤ë””ì˜¤ ë¶„ì„ ì‹œì‘
        async function startAudioVisualization() {
            try {
                // ì´ë¯¸ ìŠ¤íŠ¸ë¦¼ì´ ìˆê³  í™œì„± ìƒíƒœì¸ì§€ í™•ì¸
                if (!mediaStream || mediaStream.getTracks().every(track => track.readyState !== 'live')) {
                    console.log('ìƒˆë¡œìš´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ìš”ì²­');
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphonePermissionGranted = true;
                    console.log('ë§ˆì´í¬ ê¶Œí•œ íšë“ ì™„ë£Œ');
                } else {
                    console.log('ê¸°ì¡´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ì¬ì‚¬ìš©');
                }
                
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (!analyser) {
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                }
                
                if (!microphone) {
                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    microphone.connect(analyser);
                }
            } catch (error) {
                console.error('ì˜¤ë””ì˜¤ ì‹œê°í™” ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }


        // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
        function stopAudioVisualization() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // ë§ˆì´í¬ì™€ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ëŠ” ìœ ì§€í•˜ê³  ì‹œê°í™”ë§Œ ì¤‘ì§€
            // ì´ë ‡ê²Œ í•˜ë©´ ë§ˆì´í¬ ê¶Œí•œì„ ê³„ì† ìœ ì§€í•  ìˆ˜ ìˆìŒ
        }

        // ê²€ì‚¬ ì‹œì‘ ì‹œê°ì  íš¨ê³¼ì™€ ì‹ í˜¸ìŒ
        function startTestCountdown(callback) {
            console.log('startTestCountdown ì‹œì‘');
            
            // ë§ˆì´í¬ ê¶Œí•œ ë° ìŒì„±ì¸ì‹ ì¤€ë¹„ (ì´ë¯¸ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!audioContext || !recognition) {
                console.log('ë§ˆì´í¬/ìŒì„±ì¸ì‹ ì¤€ë¹„ í•„ìš”');
                prepareMicrophoneAndRecognition();
            }
            
            // í…ŒìŠ¤íŠ¸ í™”ë©´ í‘œì‹œ
            const testContent = document.querySelector('.test-content');
            console.log('í…ŒìŠ¤íŠ¸ ì½˜í…ì¸  ìš”ì†Œ:', testContent);
            // testContentë¥¼ ìˆ¨ê¸°ì§€ ì•ŠìŒ - ì‹œì‘ ë²„íŠ¼ì´ í‘œì‹œë˜ì–´ì•¼ í•¨
            
            console.log('testScreen ìš”ì†Œ:', testScreen);
            if (testScreen) {
                testScreen.classList.add('active');
            } else {
                console.error('testScreen ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            if (responseList) {
                responseList.innerHTML = '';
            }
            isPracticePhase = false;
            
            // 1ì´ˆì˜ ê¸´ ì‹ í˜¸ìŒ
            console.log('ì‹ í˜¸ìŒ ì¬ìƒ ì‹œì‘');
            playBeep(1000, 1000);
            console.log('ì‹ í˜¸ìŒ ì¬ìƒ ì™„ë£Œ');
            
            // ë§ˆì´í¬ í™œì„±í™” í‘œì‹œ
            if (testMicIcon) {
                testMicIcon.classList.add('active');
                console.log('ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”');
            } else {
                console.error('testMicIcon ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘
            console.log('ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘');
            startAudioVisualization();
            
            // ì½œë°± ì‹¤í–‰
            if (callback) {
                console.log('ì½œë°± í•¨ìˆ˜ ì‹¤í–‰');
                callback();
            }
        }

        // ì—°ìŠµ í•­ëª© ì¶”ê°€
        function addPracticeItem(item) {
            if (!item || item.trim() === '') return;
            
            const trimmedItem = item.trim();
            practiceItems.push(trimmedItem);
            
            // ì‘ë‹µ í‘œì‹œì— ì¶”ê°€
            const itemElement = document.createElement('div');
            itemElement.className = 'response-item';
            itemElement.textContent = trimmedItem;
            responseList.appendChild(itemElement);
        }

        // ë™ë¬¼ ì¶”ê°€
        function addAnimal(animal, speechTimestamp) {
            if (!animal || animal.trim() === '') return;
            
            const trimmedAnimal = animal.trim();
            // speechTimestampê°€ ì „ë‹¬ë˜ë©´ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ ì‚¬ìš©
            const timestamp = speechTimestamp !== undefined ? speechTimestamp : (Date.now() - startTime);
            
            console.log(`ë™ë¬¼ ì¶”ê°€: ${trimmedAnimal}, ì‹œê°„: ${timestamp}ms (${Math.floor(timestamp/1000)}ì´ˆ)`);
            
            animals.push({
                name: trimmedAnimal,
                timestamp: timestamp,
                isDuplicate: uniqueAnimals.has(trimmedAnimal.toLowerCase())
            });
            
            uniqueAnimals.add(trimmedAnimal.toLowerCase());
            updateAnimalList();
            
            // í…ŒìŠ¤íŠ¸ í™”ë©´ì—ë„ ì¶”ê°€
            const itemElement = document.createElement('div');
            itemElement.className = 'response-item';
            itemElement.textContent = trimmedAnimal;
            responseList.appendChild(itemElement);
        }

        // ë™ë¬¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAnimalList() {
            animalList.innerHTML = '';
            animals.forEach(animal => {
                const item = document.createElement('div');
                item.className = 'animal-item' + (animal.isDuplicate ? ' duplicate' : '');
                item.textContent = animal.name;
                animalList.appendChild(item);
            });
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            console.log('startTimer í˜¸ì¶œë¨');
            if (!timer) {
                console.error('timer ìš”ì†Œê°€ nullì…ë‹ˆë‹¤');
                return;
            }
            
            // íƒ€ì´ë¨¸ í‘œì‹œ
            console.log('íƒ€ì´ë¨¸ í‘œì‹œ ì „ display:', timer.style.display);
            timer.style.display = 'block';
            console.log('íƒ€ì´ë¨¸ í‘œì‹œ í›„ display:', timer.style.display);
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                timer.textContent = timeRemaining;
                
                if (timeRemaining <= 0) {
                    stopTest();
                }
            }, 1000);
            
            console.log('íƒ€ì´ë¨¸ ì‹œì‘ë¨');
        }

        // ìŒì„±ì¸ì‹ ì‹œì‘ (ê¶Œí•œì€ ì´ë¯¸ hardware-setupì—ì„œ íšë“)
        function startSpeechRecognition() {
            console.log('startSpeechRecognition í˜¸ì¶œë¨');
            
            if (!recognition) {
                console.log('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì‹œë„');
                initializeSpeechRecognition();
            }
            
            if (!recognition) {
                console.error('ìŒì„±ì¸ì‹ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ìŒì„±ì¸ì‹ì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ ì‹œì‘
            try {
                console.log('ìŒì„±ì¸ì‹ ìƒíƒœ:', { isRecognizing });
                if (!isRecognizing) {
                    recognition.start();
                    console.log('recognition.start() í˜¸ì¶œë¨');
                } else {
                    console.log('ìŒì„±ì¸ì‹ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘');
                }
                isRecognizing = true;
                if (recordingIndicator) {
                    recordingIndicator.classList.add('active');
                }
                
                // ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”
                if (testMicIcon) {
                    testMicIcon.classList.add('active');
                }
            } catch (e) {
                console.error('ìŒì„±ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜:', e);
                // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°ì—ë„ í”Œë˜ê·¸ ì„¤ì •
                isRecognizing = true;
                recordingIndicator.classList.add('active');
                if (testMicIcon) {
                    testMicIcon.classList.add('active');
                }
            }
        }

        // ê²€ì‚¬ ì‹œì‘
        function startTest() {
            console.log('startTest í•¨ìˆ˜ í˜¸ì¶œë¨');
            if (readyBox) readyBox.style.display = 'none';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheckElement = document.getElementById('readyCheckMessage');
            if (readyCheckElement) readyCheckElement.style.display = 'none';
            animals = [];
            uniqueAnimals.clear();
            startTime = Date.now();
            timeRemaining = 60;
            if (timer) {
                timer.textContent = timeRemaining;
                timer.style.display = 'block'; // ê²€ì‚¬ ì‹œì‘ ì‹œ íƒ€ì´ë¨¸ í‘œì‹œ
            } else {
                console.error('timer ìš”ì†Œê°€ nullì…ë‹ˆë‹¤');
            }
            
            if (startBtn) {
                startBtn.style.display = 'none';
                console.log('ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€');
            } else {
                console.error('startBtnì´ nullì…ë‹ˆë‹¤');
            }
            
            if (stopBtn) {
                stopBtn.style.display = 'inline-block';
                console.log('ì¤‘ì§€ ë²„íŠ¼ í‘œì‹œ');
            } else {
                console.error('stopBtnì´ nullì…ë‹ˆë‹¤');
            }
            
            if (resetBtn) {
                resetBtn.style.display = 'none';
                console.log('ë¦¬ì…‹ ë²„íŠ¼ ìˆ¨ê¹€');
            } else {
                console.error('resetBtnì´ nullì…ë‹ˆë‹¤');
            }
            if (stats) stats.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'block'; // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            
            updateAnimalList();
            
            console.log('startTestCountdown í˜¸ì¶œ ì „');
            // ì‹ í˜¸ìŒê³¼ ì‹œê°ì  íš¨ê³¼ë¡œ ì¹´ìš´íŠ¸ë‹¤ìš´
            startTestCountdown(() => {
                console.log('startTestCountdown ì½œë°± ì‹¤í–‰');
                startTimer();
                // ì‚ ì†Œë¦¬ í›„ ìŒì„±ì¸ì‹ ì‹œì‘ì„ ìœ„í•´ ì•½ê°„ì˜ ëŒ€ê¸° ì‹œê°„ ì¶”ê°€
                setTimeout(() => {
                    console.log('ë³¸ ê²€ì‚¬ ìŒì„±ì¸ì‹ ì‹œì‘ ì¤€ë¹„');
                    if (!recognition) {
                        console.log('recognition ê°ì²´ê°€ ì—†ì–´ì„œ ì´ˆê¸°í™”');
                        initializeSpeechRecognition();
                    }
                    console.log('ìŒì„±ì¸ì‹ ì‹œì‘ ì‹œë„');
                    startSpeechRecognition();
                }, 500);  // 0.5ì´ˆ ëŒ€ê¸°
            });
            console.log('startTestCountdown ì™„ë£Œ');
        }

        // ê²€ì‚¬ ì¤‘ì§€
        function stopTest() {
            endTime = Date.now();
            clearInterval(timerInterval);
            
            if (isRecognizing) {
                isRecognizing = false;
                recordingIndicator.classList.remove('active');
                // ìŒì„±ì¸ì‹ì€ ê³„ì† ì‹¤í–‰ ì¤‘ìœ¼ë¡œ ìœ ì§€
                console.log('ê²€ì‚¬ ì¢…ë£Œ - ìŒì„±ì¸ì‹ì€ ê³„ì† ìœ ì§€');
            }
            
            // í…ŒìŠ¤íŠ¸ í™”ë©´ ìˆ¨ê¸°ê¸°
            testScreen.classList.remove('active');
            document.querySelector('.test-content').style.display = 'block';
            
            // ë§ˆì´í¬ ë¹„í™œì„±í™”
            testMicIcon.classList.remove('active');
            
            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
            stopAudioVisualization();
            
            if (startBtn) startBtn.style.display = 'none';
            if (stopBtn) stopBtn.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'inline-block';
            
            showResults();
            
            speak("ê²€ì‚¬ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.", () => {
                // ìë™ìœ¼ë¡œ CFTSCORING ë¶„ì„ ì‹œì‘
                setTimeout(() => {
                    analyzeWithCFTSCORING();
                }, 1000);
            });
        }

        // ê²€ì‚¬ ë¦¬ì…‹
        function resetTest() {
            readyBox.style.display = 'block';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ë‹¤ì‹œ í‘œì‹œ
            const readyCheckReset = document.getElementById('readyCheckMessage');
            if (readyCheckReset) readyCheckReset.style.display = 'block';
            animals = [];
            uniqueAnimals.clear();
            timeRemaining = 60;
            timer.textContent = timeRemaining;
            timer.style.display = 'none'; // ë¦¬ì…‹ ì‹œ íƒ€ì´ë¨¸ ìˆ¨ê¸°ê¸°
            resultsSection.style.display = 'none'; // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            
            if (startBtn) startBtn.style.display = 'inline-block';
            if (stopBtn) stopBtn.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'none';
            stats.style.display = 'none';
            
            updateAnimalList();
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResults() {
            const totalCount = animals.length;
            const uniqueCount = uniqueAnimals.size;
            const duplicateCount = totalCount - uniqueCount;
            const elapsedTime = Math.round((endTime - startTime) / 1000);
            
            // 15ì´ˆ ê°„ê²© í†µê³„ ê³„ì‚°
            const intervals = [
                { start: 0, end: 15, count: 0 },
                { start: 15, end: 30, count: 0 },
                { start: 30, end: 45, count: 0 },
                { start: 45, end: 60, count: 0 }
            ];
            
            animals.forEach(animal => {
                const seconds = animal.timestamp / 1000;
                for (let interval of intervals) {
                    if (seconds >= interval.start && seconds < interval.end) {
                        interval.count++;
                        break;
                    }
                }
            });
            
            // ê°„ê²©ë³„ í†µê³„ í‘œì‹œ
            const intervalStats = document.getElementById('intervalStats');
            intervalStats.innerHTML = '';
            intervals.forEach((interval, index) => {
                const div = document.createElement('div');
                div.className = 'interval-stat';
                div.innerHTML = `
                    <h5>${interval.start}-${interval.end}ì´ˆ</h5>
                    <div class="count">${interval.count}</div>
                `;
                intervalStats.appendChild(div);
            });
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('uniqueCount').textContent = uniqueCount;
            document.getElementById('duplicateCount').textContent = duplicateCount;
            document.getElementById('elapsedTime').textContent = elapsedTime + 'ì´ˆ';
            
            stats.style.display = 'block';
        }

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (CSV í˜•ì‹)
        function downloadResults() {
            const testDate = new Date();
            const intervalStats = calculateIntervalStats();
            
            // CSV BOM ì¶”ê°€ (í•œê¸€ ì—‘ì…€ í˜¸í™˜)
            let csvContent = '\ufeff';
            
            // CSV í—¤ë”
            csvContent += 'ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,0-15ì´ˆ,15-30ì´ˆ,30-45ì´ˆ,45-60ì´ˆ\n';
            
            // ë°ì´í„° í–‰ ì¶”ê°€
            const id = testDate.toISOString().slice(0,10).replace(/-/g,'') + '_' + testDate.getHours().toString().padStart(2,'0') + testDate.getMinutes().toString().padStart(2,'0');
            const gender = 'ë¯¸ì…ë ¥';
            const age = 'ë¯¸ì…ë ¥';
            const education = 'ë¯¸ì…ë ¥';
            
            // ê° êµ¬ê°„ë³„ ë™ë¬¼ ëª©ë¡
            const intervals = [
                intervalStats['0-15ì´ˆ'] || [],
                intervalStats['15-30ì´ˆ'] || [],
                intervalStats['30-45ì´ˆ'] || [],
                intervalStats['45-60ì´ˆ'] || []
            ];
            
            // CSV í–‰ ìƒì„±
            csvContent += `${id},${gender},${age},${education},`;
            csvContent += intervals.map(interval => `"${interval.join(',')}"`).join(',');
            csvContent += '\n';
            
            // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ë™ë¬¼ìœ ì°½ì„±ê²€ì‚¬_${testDate.toISOString().slice(0,10).replace(/-/g,'')}_${testDate.getHours().toString().padStart(2,'0')}${testDate.getMinutes().toString().padStart(2,'0')}${testDate.getSeconds().toString().padStart(2,'0')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ë™ë¬¼ ì´ë¦„ í•„í„°ë§ í•¨ìˆ˜
        function isAnimalName(text) {
            // ê¸°ë³¸ì ì¸ í•œêµ­ì–´ ë™ë¬¼ ì´ë¦„ íŒ¨í„´
            const animalPatterns = [
                // ì¼ë°˜ì ì¸ ë™ë¬¼ ì´ë¦„ë“¤
                'ê°œ', 'ê³ ì–‘ì´', 'ì†Œ', 'ë§', 'ë¼ì§€', 'ë‹­', 'ì˜¤ë¦¬', 'ì—¼ì†Œ', 'ì–‘', 'í† ë¼',
                'ì‚¬ì', 'í˜¸ë‘ì´', 'ê³°', 'ëŠ‘ëŒ€', 'ì—¬ìš°', 'ì‚¬ìŠ´', 'ë…¸ë£¨', 'ë©§ë¼ì§€', 'ì½”ë¼ë¦¬', 'ê¸°ë¦°',
                'ì›ìˆ­ì´', 'ê³ ë¦´ë¼', 'ì¹¨íŒ¬ì§€', 'ì˜¤ë‘ìš°íƒ„', 'ê°œë¯¸', 'ë²Œ', 'ë‚˜ë¹„', 'ì ìë¦¬', 'ë©”ëšœê¸°',
                'ë±€', 'ë„ë§ˆë±€', 'ì•…ì–´', 'ê±°ë¶ì´', 'ê°œêµ¬ë¦¬', 'ë‘êº¼ë¹„', 'ì´êµ¬ì•„ë‚˜', 'ì¹´ë©œë ˆì˜¨',
                'ë…ìˆ˜ë¦¬', 'ë§¤', 'ê¹Œë§ˆê·€', 'ê¹Œì¹˜', 'ì°¸ìƒˆ', 'ë¹„ë‘˜ê¸°', 'ì œë¹„', 'ë‘ë£¨ë¯¸', 'ë°±ë¡œ', 'ì˜¬ë¹¼ë¯¸',
                'ê³ ë˜', 'ëŒê³ ë˜', 'ìƒì–´', 'ë¬¼ê°œ', 'ë°”ë‹¤ì‚¬ì', 'í­ê·„', 'í•´ë§ˆ', 'ì˜¤ì§•ì–´', 'ë¬¸ì–´',
                'ì¥', 'ë‹¤ëŒì¥', 'ì²­ì„¤ëª¨', 'í–„ìŠ¤í„°', 'ê¸°ë‹ˆí”¼ê·¸', 'ì¹œì¹ ë¼', 'ê³ ìŠ´ë„ì¹˜', 'ë‘ë”ì§€',
                'í‘œë²”', 'ì¬ê·œì–´', 'ì¹˜íƒ€', 'í•˜ì´ì—ë‚˜', 'ë¯¸ì–´ìº£', 'ìˆ˜ë‹¬', 'ë„ˆêµ¬ë¦¬', 'ì˜¤ì†Œë¦¬',
                'ìº¥ê±°ë£¨', 'ì½”ì•Œë¼', 'ì›œë±ƒ', 'íƒ€ì¡°', 'ì—ë®¤', 'í”Œë¼ë°ê³ ', 'ì•µë¬´ìƒˆ', 'ê³µì‘'
            ];
            
            // í…ìŠ¤íŠ¸ ì •ë¦¬
            const cleaned = text.trim().toLowerCase();
            
            // ë„ˆë¬´ ê¸´ í…ìŠ¤íŠ¸ëŠ” ì œì™¸ (ë³´í†µ ë™ë¬¼ ì´ë¦„ì€ 5ê¸€ì ì´í•˜)
            if (cleaned.length > 5) return false;
            
            // ì¡°ì‚¬ë‚˜ ë¬¸ì¥ ë¶€í˜¸ê°€ í¬í•¨ëœ ê²½ìš° ì œì™¸
            if (/[.,!?~]/.test(cleaned)) return false;
            
            // ë™ë¬¼ ì´ë¦„ íŒ¨í„´ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
            return animalPatterns.some(animal => 
                cleaned === animal || 
                cleaned.includes(animal) || 
                animal.includes(cleaned)
            );
        }
        
        // í´ëŸ¬ìŠ¤í„° ë¶„ì„ í•¨ìˆ˜ (ì˜ë¯¸ ë²”ì£¼ ë¶„ì„)
        function analyzeClusters(animalList) {
            const categories = {
                'ì• ì™„ë™ë¬¼': ['ê°œ', 'ê°•ì•„ì§€', 'ê³ ì–‘ì´', 'í–„ìŠ¤í„°', 'í† ë¼', 'ì•µë¬´ìƒˆ', 'ê¸ˆë¶•ì–´'],
                'ë†ì¥ë™ë¬¼': ['ì†Œ', 'ë¼ì§€', 'ë‹­', 'ì˜¤ë¦¬', 'ì—¼ì†Œ', 'ì–‘', 'ë§', 'ë‹¹ë‚˜ê·€'],
                'ì•¼ìƒë™ë¬¼': ['ì‚¬ì', 'í˜¸ë‘ì´', 'ê³°', 'ëŠ‘ëŒ€', 'ì—¬ìš°', 'ì‚¬ìŠ´', 'ë…¸ë£¨', 'ë©§ë¼ì§€'],
                'ì¡°ë¥˜': ['ì°¸ìƒˆ', 'ë¹„ë‘˜ê¸°', 'ê¹Œì¹˜', 'ë…ìˆ˜ë¦¬', 'ë§¤', 'ì˜¬ë¹¼ë¯¸', 'ë‘ë£¨ë¯¸', 'ë°±ë¡œ'],
                'í•´ì–‘ë™ë¬¼': ['ê³ ë˜', 'ëŒê³ ë˜', 'ìƒì–´', 'ë¬¼ê°œ', 'ë°”ë‹¤ì‚¬ì', 'í­ê·„', 'í•´ë§ˆ', 'ì˜¤ì§•ì–´'],
                'íŒŒì¶©ë¥˜': ['ë±€', 'ë„ë§ˆë±€', 'ì•…ì–´', 'ê±°ë¶ì´', 'ì´êµ¬ì•„ë‚˜', 'ì¹´ë©œë ˆì˜¨'],
                'ê³¤ì¶©ë¥˜': ['ê°œë¯¸', 'ë²Œ', 'ë‚˜ë¹„', 'ì ìë¦¬', 'ë©”ëšœê¸°', 'ê·€ëšœë¼ë¯¸'],
                'ì˜ì¥ë¥˜': ['ì›ìˆ­ì´', 'ê³ ë¦´ë¼', 'ì¹¨íŒ¬ì§€', 'ì˜¤ë‘ìš°íƒ„', 'ê°œì½”ì›ìˆ­ì´']
            };
            
            const clusters = [];
            
            Object.entries(categories).forEach(([category, categoryAnimals]) => {
                const found = animalList.filter(animal => 
                    categoryAnimals.some(cat => animal.includes(cat) || cat.includes(animal))
                );
                if (found.length >= 2) {
                    clusters.push({
                        category: category,
                        items: found,
                        count: found.length
                    });
                }
            });
            
            return clusters;
        }
        
        function calculateIntervalStats() {
            const intervals = {
                '0-15ì´ˆ': [],
                '15-30ì´ˆ': [],
                '30-45ì´ˆ': [],
                '45-60ì´ˆ': []
            };
            
            animals.forEach(animal => {
                const seconds = animal.timestamp / 1000;
                if (seconds < 15) {
                    intervals['0-15ì´ˆ'].push(animal.name);
                } else if (seconds < 30) {
                    intervals['15-30ì´ˆ'].push(animal.name);
                } else if (seconds < 45) {
                    intervals['30-45ì´ˆ'].push(animal.name);
                } else {
                    intervals['45-60ì´ˆ'].push(animal.name);
                }
            });
            
            return intervals;
        }
        
        // CSV ë°ì´í„° ìƒì„±
        function generateCSVData() {
            // 15ì´ˆ ê°„ê²©ìœ¼ë¡œ ë™ë¬¼ ë¶„ë¥˜
            const intervals = {
                '0-15ì´ˆ': [],
                '15-30ì´ˆ': [],
                '30-45ì´ˆ': [],
                '45-60ì´ˆ': []
            };
            
            animals.forEach(animal => {
                const seconds = animal.elapsedTime / 1000;
                if (seconds <= 15) {
                    intervals['0-15ì´ˆ'].push(animal.name);
                } else if (seconds <= 30) {
                    intervals['15-30ì´ˆ'].push(animal.name);
                } else if (seconds <= 45) {
                    intervals['30-45ì´ˆ'].push(animal.name);
                } else {
                    intervals['45-60ì´ˆ'].push(animal.name);
                }
            });
            
            // CSV í—¤ë”ì™€ ë°ì´í„° ìƒì„± - BOM ì¶”ê°€ë¡œ í•œê¸€ ì¸ì½”ë”© ë¬¸ì œ í•´ê²°
            let csv = '\ufeff';  // UTF-8 BOM ì¶”ê°€
            csv += 'ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,0-15ì´ˆ,15-30ì´ˆ,30-45ì´ˆ,45-60ì´ˆ\n';
            
            // ì‚¬ìš©ì ì •ë³´ëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • (ì‹¤ì œ êµ¬í˜„ì‹œ ì…ë ¥ë°›ì•„ì•¼ í•¨)
            const id = 'TEST001';
            const gender = 'ë¯¸ì…ë ¥';
            const age = 'ë¯¸ì…ë ¥';
            const education = 'ë¯¸ì…ë ¥';
            
            // ê° êµ¬ê°„ì˜ ë™ë¬¼ë“¤ì„ ì‰¼í‘œë¡œ ì—°ê²°
            const interval0_15 = intervals['0-15ì´ˆ'].join(',');
            const interval15_30 = intervals['15-30ì´ˆ'].join(',');
            const interval30_45 = intervals['30-45ì´ˆ'].join(',');
            const interval45_60 = intervals['45-60ì´ˆ'].join(',');
            
            csv += `${id},${gender},${age},${education},"${interval0_15}","${interval15_30}","${interval30_45}","${interval45_60}"`;
            
            console.log('ìƒì„±ëœ CSV ë°ì´í„°:');
            console.log(csv);
            console.log('êµ¬ê°„ë³„ ë™ë¬¼ ìˆ˜:', {
                '0-15ì´ˆ': intervals['0-15ì´ˆ'].length,
                '15-30ì´ˆ': intervals['15-30ì´ˆ'].length,
                '30-45ì´ˆ': intervals['30-45ì´ˆ'].length,
                '45-60ì´ˆ': intervals['45-60ì´ˆ'].length
            });
            
            return csv;
        }
        
        // CFTSCORING í†µí•© ë¶„ì„ í•¨ìˆ˜ (V15ì—ì„œëŠ” CSV ë‹¤ìš´ë¡œë“œ ì—†ì´ ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬)
        function analyzeWithCFTSCORING() {
            console.log('CFTSCORING í†µí•© ë¶„ì„ ì‹œì‘...');
            
            // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            document.getElementById('analyzing-overlay').style.display = 'flex';
            
            // CSV ë°ì´í„° ìƒì„±
            const csvData = generateCSVData();
            console.log('ìƒì„±ëœ CSV ë°ì´í„°:', csvData);
            
            // CSV ë‹¤ìš´ë¡œë“œ ì—†ì´ ë°”ë¡œ CFTSCORING ë¶„ì„ ìˆ˜í–‰
            setTimeout(() => {
                // CFTSCORING iframeì„ í†µí•œ ë¶„ì„
                performCFTSCORINGAnalysisWithIframe(csvData);
            }, 100);
        }
        
        // CFTSCORING iframeì„ í†µí•œ ë¶„ì„
        function performCFTSCORINGAnalysisWithIframe(csvData) {
            console.log('CFTSCORING iframe ë¶„ì„ ì‹œì‘...');
            
            // ë©”ì‹œì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            function handleMessage(event) {
                // ë³´ì•ˆì„ ìœ„í•´ origin í™•ì¸
                if (event.origin !== window.location.origin) {
                    return;
                }
                
                if (event.data && event.data.type === 'CFTSCORING_RESULT') {
                    console.log('CFTSCORING ê²°ê³¼ ìˆ˜ì‹ :', event.data);
                    
                    // ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì œê±°
                    window.removeEventListener('message', handleMessage);
                    
                    // iframe ì œê±°
                    const iframe = document.getElementById('cftscoring-iframe');
                    if (iframe) {
                        document.body.removeChild(iframe);
                    }
                    
                    // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                    document.getElementById('analyzing-overlay').style.display = 'none';
                    
                    // ê²°ê³¼ í‘œì‹œ
                    if (event.data.result) {
                        const resultHTML = generateCFTSCORINGResultFromData(event.data.result);
                        displayCFTSCORINGResults(resultHTML);
                    } else {
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‚´ë¶€ ë¶„ì„ ì‚¬ìš©
                        performCFTSCORINGAnalysis(csvData);
                    }
                }
            }
            
            // ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            window.addEventListener('message', handleMessage);
            
            // ìˆ¨ê²¨ì§„ iframe ìƒì„±
            const iframe = document.createElement('iframe');
            iframe.id = 'cftscoring-iframe';
            iframe.style.display = 'none';
            iframe.src = 'CFTSCORING/CFTSCORING.html';
            
            // iframe ë¡œë“œ í›„ CSV ë°ì´í„° ì „ì†¡
            iframe.onload = function() {
                console.log('CFTSCORING iframe ë¡œë“œ ì™„ë£Œ');
                
                // CSV ë°ì´í„°ë¥¼ iframeìœ¼ë¡œ ì „ì†¡
                iframe.contentWindow.postMessage({
                    type: 'PROCESS_CSV',
                    csvData: csvData
                }, window.location.origin);
                
                // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
                setTimeout(() => {
                    if (document.getElementById('cftscoring-iframe')) {
                        console.log('CFTSCORING ì‘ë‹µ íƒ€ì„ì•„ì›ƒ');
                        window.removeEventListener('message', handleMessage);
                        document.body.removeChild(iframe);
                        document.getElementById('analyzing-overlay').style.display = 'none';
                        // í´ë°±: ë‚´ë¶€ ë¶„ì„ ì‚¬ìš©
                        performCFTSCORINGAnalysis(csvData);
                    }
                }, 10000);
            };
            
            // iframeì„ bodyì— ì¶”ê°€
            document.body.appendChild(iframe);
        }
        
        // CFTSCORING ê²°ê³¼ë¡œë¶€í„° HTML ìƒì„±
        function generateCFTSCORINGResultFromData(result) {
            const testDate = new Date().toLocaleDateString('ko-KR');
            
            let html = `
                <div class="result-container" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #333; margin-bottom: 30px;">ë™ë¬¼ ìœ ì°½ì„± ê²€ì‚¬ ê²°ê³¼</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #495057; margin-bottom: 15px;">ê¸°ë³¸ ì •ë³´</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <p><strong>ID:</strong> ${result.id}</p>
                            <p><strong>ê²€ì‚¬ì¼:</strong> ${testDate}</p>
                            <p><strong>ì„±ë³„:</strong> ${result.gender}</p>
                            <p><strong>ì—°ë ¹:</strong> ${result.age}ì„¸</p>
                            <p><strong>í•™ë ¥:</strong> ${result.education}ë…„</p>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2; margin-bottom: 15px;">ì£¼ìš” ì ìˆ˜</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <p style="font-size: 18px; margin: 5px 0;"><strong>ì´ì :</strong> <span style="color: #1976d2; font-size: 24px;">${result.totalScore}</span>ì </p>
                                <p><strong>ì „ë°˜ë¶€ (0-30ì´ˆ):</strong> ${result.firstHalfScore}ì </p>
                                <p><strong>í›„ë°˜ë¶€ (30-60ì´ˆ):</strong> ${result.secondHalfScore}ì </p>
                            </div>
                            <div>
                                <p><strong>ë³´ì†:</strong> ${result.perseverationScore}ê°œ</p>
                                <p><strong>ì¹¨íˆ¬:</strong> ${result.intrusionScore}ê°œ</p>
                                <p><strong>ì „í™˜:</strong> ${result.switchingScore}íšŒ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #7b1fa2; margin-bottom: 15px;">í´ëŸ¬ìŠ¤í„° ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <p><strong>ë²”ì£¼ ìˆ˜:</strong> ${result.clusterCount || 0}ê°œ</p>
                            <p><strong>í‰ê·  í¬ê¸°:</strong> ${result.avgClusterSize || 0}</p>
                            <p><strong>ìµœëŒ€ í¬ê¸°:</strong> ${result.maxClusterSize || 0}</p>
                        </div>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #f57c00; margin-bottom: 15px;">êµ¬ê°„ë³„ ë°˜ì‘</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <p><strong>0-15ì´ˆ:</strong> ${result.interval1Count || 0}ê°œ</p>
                            <p><strong>15-30ì´ˆ:</strong> ${result.interval2Count || 0}ê°œ</p>
                            <p><strong>30-45ì´ˆ:</strong> ${result.interval3Count || 0}ê°œ</p>
                            <p><strong>45-60ì´ˆ:</strong> ${result.interval4Count || 0}ê°œ</p>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // CFTSCORING ë¶„ì„ ìˆ˜í–‰ í•¨ìˆ˜ (í´ë°±)
        function performCFTSCORINGAnalysis(csvData) {
            console.log('CFTSCORING ë¶„ì„ ìˆ˜í–‰ ì‹œì‘...');
            
            try {
                // CSV ë°ì´í„° íŒŒì‹±
                const rows = parseCSV(csvData);
                
                if (rows.length < 2) {
                    console.error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('analyzing-overlay').style.display = 'none';
                    performInternalAnalysis();
                    return;
                }
                
                // ì²« ë²ˆì§¸ ë°ì´í„° í–‰ ì²˜ë¦¬ (í—¤ë” ì œì™¸)
                const dataRow = rows[1];
                const id = dataRow[0];
                const gender = dataRow[1];
                const age = parseInt(dataRow[2]) || 0;
                const education = parseInt(dataRow[3]) || 0;
                
                // ê° ì‹œê°„ëŒ€ë³„ ë°˜ì‘ íŒŒì‹±
                const responses = {
                    '0-15': parseAnimals(dataRow[4]),
                    '15-30': parseAnimals(dataRow[5]),
                    '30-45': parseAnimals(dataRow[6]),
                    '45-60': parseAnimals(dataRow[7])
                };
                
                // CFTSCORING ì ìˆ˜ ê³„ì‚°
                const scores = calculateCFTScores({
                    id: id,
                    gender: gender,
                    age: age,
                    education: education,
                    responses: responses
                });
                
                // ê²°ê³¼ HTML ìƒì„±
                const resultHTML = generateCFTSCORINGResultHTML(scores);
                
                // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                document.getElementById('analyzing-overlay').style.display = 'none';
                
                // ê²°ê³¼ í‘œì‹œ
                displayCFTSCORINGResults(resultHTML);
                
            } catch (error) {
                console.error('CFTSCORING ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('analyzing-overlay').style.display = 'none';
                alert('CFTSCORING ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚´ë¶€ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                performInternalAnalysis();
            }
        }
        
        // CSV íŒŒì‹± í•¨ìˆ˜
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const rows = [];
            
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let cell = '';
                    let insideQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            row.push(cell.trim());
                            cell = '';
                        } else {
                            cell += char;
                        }
                    }
                    
                    // ë§ˆì§€ë§‰ ì…€ ì¶”ê°€
                    row.push(cell.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // ë™ë¬¼ ì´ë¦„ íŒŒì‹±
        function parseAnimals(text) {
            if (!text) return [];
            return text.split(',').map(a => a.trim()).filter(a => a.length > 0);
        }
        
        // CFTSCORING ì ìˆ˜ ê³„ì‚°
        function calculateCFTScores(data) {
            const allAnimals = [];
            const intervalAnimals = {};
            let totalScore = 0;
            
            // ê° êµ¬ê°„ë³„ ë™ë¬¼ ìˆ˜ì§‘
            ['0-15', '15-30', '30-45', '45-60'].forEach(interval => {
                const animals = data.responses[interval] || [];
                intervalAnimals[interval] = animals;
                allAnimals.push(...animals);
                totalScore += animals.length;
            });
            
            // ì „ë°˜/í›„ë°˜ ì ìˆ˜
            const firstHalfScore = (data.responses['0-15'] || []).length + (data.responses['15-30'] || []).length;
            const secondHalfScore = (data.responses['30-45'] || []).length + (data.responses['45-60'] || []).length;
            
            // ë³´ì† ë° ì¹¨íˆ¬ ê³„ì‚°
            const uniqueAnimals = new Set();
            let perseverationScore = 0;
            let intrusionScore = 0;
            
            allAnimals.forEach(animal => {
                if (uniqueAnimals.has(animal)) {
                    perseverationScore++;
                } else {
                    uniqueAnimals.add(animal);
                    // ë™ë¬¼ ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬ (ê°„ë‹¨í•œ ë²„ì „)
                    if (!isValidAnimalName(animal)) {
                        intrusionScore++;
                    }
                }
            });
            
            // í´ëŸ¬ìŠ¤í„° ë¶„ì„ (ê°„ë‹¨í•œ ë²„ì „)
            const clusterData = analyzeSimpleClusters(allAnimals);
            
            return {
                id: data.id,
                gender: data.gender,
                age: data.age,
                education: data.education,
                totalScore: totalScore,
                firstHalfScore: firstHalfScore,
                secondHalfScore: secondHalfScore,
                perseverationScore: perseverationScore,
                intrusionScore: intrusionScore,
                switchingScore: clusterData.switchingScore,
                clusterCount: clusterData.clusterCount,
                avgClusterSize: clusterData.avgClusterSize,
                maxClusterSize: clusterData.maxClusterSize,
                intervalAnimals: intervalAnimals,
                allAnimals: allAnimals,
                interval1Count: (data.responses['0-15'] || []).length,
                interval2Count: (data.responses['15-30'] || []).length,
                interval3Count: (data.responses['30-45'] || []).length,
                interval4Count: (data.responses['45-60'] || []).length
            };
        }
        
        // ê°„ë‹¨í•œ ë™ë¬¼ ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬
        function isValidAnimalName(name) {
            // ê¸°ë³¸ì ì¸ ë™ë¬¼ ì´ë¦„ íŒ¨í„´ ê²€ì‚¬
            const commonAnimals = ['ê°œ', 'ê³ ì–‘ì´', 'ì†Œ', 'ë§', 'ë¼ì§€', 'ë‹­', 'í˜¸ë‘ì´', 'ì‚¬ì', 'í† ë¼', 'ì¿ '];
            return commonAnimals.some(animal => name.includes(animal)) || name.length >= 2;
        }
        
        // ê°„ë‹¨í•œ í´ëŸ¬ìŠ¤í„° ë¶„ì„
        function analyzeSimpleClusters(animals) {
            // ê°„ë‹¨í•œ í´ëŸ¬ìŠ¤í„° ë¶„ì„ ë¡œì§
            const clusters = [];
            let currentCluster = [];
            
            animals.forEach((animal, index) => {
                if (currentCluster.length === 0) {
                    currentCluster.push(animal);
                } else {
                    // ê°„ë‹¨í•œ ì¹´í…Œê³ ë¦¬ íŒë‹¨
                    const isSameCategory = checkSimpleCategory(currentCluster[currentCluster.length - 1], animal);
                    if (isSameCategory) {
                        currentCluster.push(animal);
                    } else {
                        if (currentCluster.length > 1) {
                            clusters.push(currentCluster);
                        }
                        currentCluster = [animal];
                    }
                }
            });
            
            if (currentCluster.length > 1) {
                clusters.push(currentCluster);
            }
            
            const clusterCount = clusters.length;
            const avgClusterSize = clusterCount > 0 ? clusters.reduce((sum, c) => sum + c.length, 0) / clusterCount : 0;
            const maxClusterSize = clusterCount > 0 ? Math.max(...clusters.map(c => c.length)) : 0;
            const switchingScore = Math.max(0, animals.length - clusters.reduce((sum, c) => sum + c.length, 0));
            
            return {
                clusterCount: clusterCount,
                avgClusterSize: avgClusterSize.toFixed(1),
                maxClusterSize: maxClusterSize,
                switchingScore: switchingScore
            };
        }
        
        // ê°„ë‹¨í•œ ì¹´í…Œê³ ë¦¬ íŒë‹¨
        function checkSimpleCategory(animal1, animal2) {
            // ê°„ë‹¨í•œ ì¹´í…Œê³ ë¦¬ íŒë‹¨ ë¡œì§
            const categories = {
                'ìœ¡ìƒ': ['ê°œ', 'ê³ ì–‘ì´', 'ì†Œ', 'ë§', 'ë¼ì§€', 'í˜¸ë‘ì´', 'ì‚¬ì', 'í† ë¼'],
                'ì¡°ë¥˜': ['ë‹­', 'ì˜¤ë¦¬', 'ê±°ìœ„', 'ë¹„ë‘˜ê¸°', 'ì°¸ìƒˆ', 'ë…ìˆ˜ë¦¬'],
                'ìˆ˜ìƒ': ['ë¬¼ê³ ê¸°', 'ê³ ë˜', 'ìƒì–´', 'ê°€ì˜¤ë¦¬', 'ì˜¤ì§•ì–´'],
                'íŒŒì¶©ë¥˜': ['ë¹€', 'ê±°ë¶ì´', 'ì•…ì–´', 'ë„ë§ˆë±€']
            };
            
            for (let category in categories) {
                const animals = categories[category];
                if (animals.some(a => animal1.includes(a)) && animals.some(a => animal2.includes(a))) {
                    return true;
                }
            }
            return false;
        }
        
        // CFTSCORING ê²°ê³¼ HTML ìƒì„±
        function generateCFTSCORINGResultHTML(scores) {
            const testDate = new Date().toLocaleDateString('ko-KR');
            
            let html = `
                <div class="result-container" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #333; margin-bottom: 30px;">ë™ë¬¼ ìœ ì°½ì„± ê²€ì‚¬ ê²°ê³¼</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #495057; margin-bottom: 15px;">ê¸°ë³¸ ì •ë³´</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <p><strong>ID:</strong> ${scores.id}</p>
                            <p><strong>ê²€ì‚¬ì¼:</strong> ${testDate}</p>
                            <p><strong>ì„±ë³„:</strong> ${scores.gender}</p>
                            <p><strong>ì—°ë ¹:</strong> ${scores.age}ì„¸</p>
                            <p><strong>í•™ë ¥:</strong> ${scores.education}ë…„</p>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2; margin-bottom: 15px;">ì£¼ìš” ì ìˆ˜</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <p style="font-size: 18px; margin: 5px 0;"><strong>ì´ì :</strong> <span style="color: #1976d2; font-size: 24px;">${scores.totalScore}</span>ì </p>
                                <p><strong>ì „ë°˜ë¶€ (0-30ì´ˆ):</strong> ${scores.firstHalfScore}ì </p>
                                <p><strong>í›„ë°˜ë¶€ (30-60ì´ˆ):</strong> ${scores.secondHalfScore}ì </p>
                            </div>
                            <div>
                                <p><strong>ë³´ì†:</strong> ${scores.perseverationScore}ê°œ</p>
                                <p><strong>ì¹¨íˆ¬:</strong> ${scores.intrusionScore}ê°œ</p>
                                <p><strong>ì „í™˜:</strong> ${scores.switchingScore}íšŒ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #7b1fa2; margin-bottom: 15px;">í´ëŸ¬ìŠ¤í„° ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <p><strong>ë²”ì£¼ ìˆ˜:</strong> ${scores.clusterCount}ê°œ</p>
                            <p><strong>í‰ê·  í¬ê¸°:</strong> ${scores.avgClusterSize}</p>
                            <p><strong>ìµœëŒ€ í¬ê¸°:</strong> ${scores.maxClusterSize}</p>
                        </div>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #f57c00; margin-bottom: 15px;">êµ¬ê°„ë³„ ë°˜ì‘</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <p><strong>0-15ì´ˆ:</strong> ${scores.intervalAnimals['0-15'].length}ê°œ</p>
                            <p><strong>15-30ì´ˆ:</strong> ${scores.intervalAnimals['15-30'].length}ê°œ</p>
                            <p><strong>30-45ì´ˆ:</strong> ${scores.intervalAnimals['30-45'].length}ê°œ</p>
                            <p><strong>45-60ì´ˆ:</strong> ${scores.intervalAnimals['45-60'].length}ê°œ</p>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // CFTSCORING ê²°ê³¼ í‘œì‹œ
        function displayCFTSCORINGResults(resultHTML) {
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            resultsSection.style.display = 'block';
            resultsSection.innerHTML = resultHTML;
            
            // íƒ€ì´ë¨¸ ë° ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const timerElement = document.getElementById('timer');
            const stopButton = document.getElementById('stopBtn');
            if (timerElement) timerElement.style.display = 'none';
            if (stopButton) stopButton.style.display = 'none';
            
            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // ê²°ê³¼ ìŒì„± ì•ˆë‚´
            speak('ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        
        // ë‚´ë¶€ ë¶„ì„ (í´ë°±)
        function performInternalAnalysis() {
            console.log('ë‚´ë¶€ ë¶„ì„ ì‹œì‘...');
            
            // ê°„ê²©ë³„ í†µê³„ ê³„ì‚°
            const intervalStats = calculateIntervalStats();
            const uniqueCount = uniqueAnimals.size;
            const totalCount = animals.length;
            
            // ê°„ë‹¨í•œ ê²°ê³¼ HTML ìƒì„±
            const resultHTML = `
                <div style="padding: 20px;">
                    <h2>ê²€ì‚¬ ê²°ê³¼</h2>
                    <p><strong>ì´ ì‘ë‹µ ìˆ˜:</strong> ${totalCount}ê°œ</p>
                    <p><strong>ê³ ìœ  ë™ë¬¼ ìˆ˜:</strong> ${uniqueCount}ê°œ</p>
                    <p><strong>ì¤‘ë³µ ì‘ë‹µ ìˆ˜:</strong> ${totalCount - uniqueCount}ê°œ</p>
                    <hr>
                    <h3>ì‹œê°„ëŒ€ë³„ ì‘ë‹µ</h3>
                    <p>0-15ì´ˆ: ${intervalStats['0-15ì´ˆ'].length}ê°œ</p>
                    <p>15-30ì´ˆ: ${intervalStats['15-30ì´ˆ'].length}ê°œ</p>
                    <p>30-45ì´ˆ: ${intervalStats['30-45ì´ˆ'].length}ê°œ</p>
                    <p>45-60ì´ˆ: ${intervalStats['45-60ì´ˆ'].length}ê°œ</p>
                </div>
            `;
            
            document.getElementById('analyzing-overlay').style.display = 'none';
            displayCFTSCORINGResults(resultHTML);
        }
        
        // í´ëŸ¬ìŠ¤í„° ë¶„ì„ í•¨ìˆ˜ (ë‚´ë¶€ ë¶„ì„ìš©)
        function analyzeInternalClusters() {
            const testDate = new Date();
            const totalCount = animals.length;
            const intervalStats = calculateIntervalStats();
            const intervalCounts = {
                '0-15ì´ˆ': intervalStats['0-15ì´ˆ'].length,
                '15-30ì´ˆ': intervalStats['15-30ì´ˆ'].length,
                '30-45ì´ˆ': intervalStats['30-45ì´ˆ'].length,
                '45-60ì´ˆ': intervalStats['45-60ì´ˆ'].length
            };
            
            // ì „ë°˜ë¶€/í›„ë°˜ë¶€ ë¶„ì„
            const firstHalfCount = intervalCounts['0-15ì´ˆ'] + intervalCounts['15-30ì´ˆ'];
            const secondHalfCount = intervalCounts['30-45ì´ˆ'] + intervalCounts['45-60ì´ˆ'];
            
            // ì¤‘ë³µ ê³„ì‚°
            const animalFrequency = {};
            animals.forEach(animal => {
                animalFrequency[animal.name] = (animalFrequency[animal.name] || 0) + 1;
            });
            const duplicates = Object.values(animalFrequency).filter(count => count > 1).reduce((sum, count) => sum + (count - 1), 0);
            
            // í´ëŸ¬ìŠ¤í„° ë¶„ì„ (ê°„ë‹¨í•œ ë²„ì „)
            const clusters = analyzeClusters(animals.map(a => a.name));
            
            // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚° (CFTSCORING ì•Œê³ ë¦¬ì¦˜)
            const weightedScore = intervalCounts['0-15ì´ˆ'] * 1.0 + 
                                intervalCounts['15-30ì´ˆ'] * 0.75 + 
                                intervalCounts['30-45ì´ˆ'] * 0.5 + 
                                intervalCounts['45-60ì´ˆ'] * 0.25;
            
            // ìˆ˜í–‰ ìˆ˜ì¤€ íŒì •
            let performanceLevel = '';
            let performanceColor = '';
            if (uniqueCount >= 15) {
                performanceLevel = 'ì •ìƒ ë²”ìœ„';
                performanceColor = '#28a745';
            } else if (uniqueCount >= 10) {
                performanceLevel = 'ê²½ê³„ì„  ìˆ˜ì¤€';
                performanceColor = '#ffc107';
            } else {
                performanceLevel = 'ì €ì¡°í•œ ìˆ˜í–‰';
                performanceColor = '#dc3545';
            }
            
            // CFTSCORING ìŠ¤íƒ€ì¼ì˜ ìƒì„¸ ë³´ê³ ì„œ ìƒì„±
            resultsSection.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                    <!-- í—¤ë” -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
                        <h1 style="margin: 0; font-size: 32px;">ë™ë¬¼ ë²”ì£¼ ì–¸ì–´ìœ ì°½ì„±ê²€ì‚¬ ê²°ê³¼ ë³´ê³ ì„œ</h1>
                        <p style="margin-top: 10px; opacity: 0.9;">ê²€ì‚¬ì¼ì‹œ: ${testDate.toLocaleString()}</p>
                    </div>
                    
                    <!-- ì£¼ìš” ê²°ê³¼ ìš”ì•½ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì£¼ìš” ê²°ê³¼</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #667eea;">${uniqueCount}</div>
                                <div style="color: #666; margin-top: 5px;">ê³ ìœ  ë™ë¬¼ ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #764ba2;">${totalCount}</div>
                                <div style="color: #666; margin-top: 5px;">ì´ ì‘ë‹µ ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #ff6b6b;">${duplicates}</div>
                                <div style="color: #666; margin-top: 5px;">ì¤‘ë³µ ì‘ë‹µ</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #51cf66;">${weightedScore.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ê°€ì¤‘ì¹˜ ì ìˆ˜</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìˆ˜í–‰ í‰ê°€ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ìˆ˜í–‰ í‰ê°€</h2>
                        <div style="text-align: center; padding: 30px; background: ${performanceColor}20; border-radius: 10px; border: 2px solid ${performanceColor};">
                            <div style="font-size: 28px; font-weight: bold; color: ${performanceColor};">
                                ${performanceLevel}
                            </div>
                            <div style="margin-top: 10px; color: #666;">
                                ${uniqueCount >= 15 ? 'ì •ìƒì ì¸ ì–¸ì–´ìœ ì°½ì„±ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.' : 
                                  uniqueCount >= 10 ? 'ì¶”ê°€ì ì¸ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 
                                  'ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‹œê°„ëŒ€ë³„ ë¶„ì„ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì‹œê°„ëŒ€ë³„ ìˆ˜í–‰ ë¶„ì„</h2>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <div style="background: #667eea; color: white; padding: 10px; border-radius: 5px 5px 0 0;">0-15ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['0-15ì´ˆ']}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #764ba2; color: white; padding: 10px; border-radius: 5px 5px 0 0;">15-30ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['15-30ì´ˆ']}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #9775fa; color: white; padding: 10px; border-radius: 5px 5px 0 0;">30-45ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['30-45ì´ˆ']}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #b197fc; color: white; padding: 10px; border-radius: 5px 5px 0 0;">45-60ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['45-60ì´ˆ']}</div>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-around;">
                                <div>
                                    <strong>ì „ë°˜ë¶€ (0-30ì´ˆ):</strong> ${firstHalfCount}ê°œ
                                </div>
                                <div>
                                    <strong>í›„ë°˜ë¶€ (30-60ì´ˆ):</strong> ${secondHalfCount}ê°œ
                                </div>
                                <div>
                                    <strong>ê°ì†Œìœ¨:</strong> ${firstHalfCount > 0 ? ((1 - secondHalfCount/firstHalfCount) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‘ë‹µ ëª©ë¡ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì‘ë‹µ ëª©ë¡</h2>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                            ${animals.map((animal, index) => {
                                const time = ((animal.timestamp - startTime) / 1000).toFixed(1);
                                const isDuplicate = animalFrequency[animal.name] > 1;
                                return `<span style="display: inline-block; margin: 5px; padding: 5px 10px; background: ${isDuplicate ? '#ffe8e8' : '#e8f5e9'}; border-radius: 5px; ${isDuplicate ? 'color: #d32f2f;' : ''}">${index + 1}. ${animal.name} (${time}ì´ˆ)</span>`;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- í´ëŸ¬ìŠ¤í„° ë¶„ì„ -->
                    ${clusters.length > 0 ? `
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì˜ë¯¸ ë²”ì£¼ ë¶„ì„</h2>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p><strong>í™•ì¸ëœ ì˜ë¯¸ ë²”ì£¼:</strong> ${clusters.length}ê°œ</p>
                            <div style="margin-top: 10px;">
                                ${clusters.map(cluster => `
                                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${cluster.category}:</strong> ${cluster.items.join(', ')} (${cluster.items.length}ê°œ)
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ë²„íŠ¼ -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="background-color: #667eea; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-print"></i> ì¸ì‡„í•˜ê¸°
                        </button>
                        <button onclick="window.location.href = window.location.pathname" style="background-color: #764ba2; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-redo"></i> ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // ìŒì„± ì•ˆë‚´
            speak("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
        
        // ë‚´ë¶€ ë¶„ì„ í•¨ìˆ˜ë“¤ì€ ëª¨ë‘ ì œê±°
        /*
            const counts = {
                '0-15ì´ˆ': intervalStats['0-15ì´ˆ'].length,
                '15-30ì´ˆ': intervalStats['15-30ì´ˆ'].length,
                '30-45ì´ˆ': intervalStats['30-45ì´ˆ'].length,
                '45-60ì´ˆ': intervalStats['45-60ì´ˆ'].length
            };
            
            // ì „ì²´ ë™ë¬¼ ë¦¬ìŠ¤íŠ¸
            const allAnimals = [];
            Object.values(intervalStats).forEach(interval => {
                allAnimals.push(...interval);
            });
            
            // ì „ë°˜ë¶€/í›„ë°˜ë¶€ ê³„ì‚°
            const firstHalfAnimals = [...intervalStats['0-15ì´ˆ'], ...intervalStats['15-30ì´ˆ']];
            const secondHalfAnimals = [...intervalStats['30-45ì´ˆ'], ...intervalStats['45-60ì´ˆ']];
            const firstHalfScore = new Set(firstHalfAnimals).size;
            const secondHalfScore = new Set(secondHalfAnimals).size;
            
            // ë³´ì† ê³„ì‚° (ì¤‘ë³µëœ ë™ë¬¼)
            const animalCounts = {};
            allAnimals.forEach(animal => {
                animalCounts[animal] = (animalCounts[animal] || 0) + 1;
            });
            const perseverationScore = Object.values(animalCounts).filter(count => count > 1).reduce((sum, count) => sum + (count - 1), 0);
            
            // ì¹¨íˆ¬ ê³„ì‚° (ë™ë¬¼ì´ ì•„ë‹Œ ê²ƒ - ì—¬ê¸°ì„œëŠ” 0ìœ¼ë¡œ í‘œì‹œ)
            const intrusionScore = 0;
            
            // ë²”ì£¼ ë¶„ì„ (ê°„ë‹¨í•œ ë²„ì „)
            const categoryAnalysis = analyzeClusters(allAnimals);
            
            // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚° (CFTSCORING ë¡œì§ ì°¸ì¡°)
            const weightedScore = 
                counts['0-15ì´ˆ'] * 1.0 + 
                counts['15-30ì´ˆ'] * 0.75 + 
                counts['30-45ì´ˆ'] * 0.5 + 
                counts['45-60ì´ˆ'] * 0.25;
            
            // ì´ì 
            const totalScore = uniqueAnimals.size;
            
            // ê²°ê³¼ í•´ì„
            let interpretation = '';
            if (totalScore >= 15) {
                interpretation = 'ì •ìƒ ë²”ìœ„ì˜ ìˆ˜í–‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ë™ë¬¼ ì´ë¦„ ìƒì„± ëŠ¥ë ¥ì´ ì—°ë ¹ëŒ€ì— ì í•©í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ë²”ì£¼ ê°„ ì „í™˜ ëŠ¥ë ¥ê³¼ ì§€ì†ì ì¸ ì¸ì¶œ ëŠ¥ë ¥ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.';
            } else if (totalScore >= 10) {
                interpretation = 'ê²½ê³„ì„  ìˆ˜ì¤€ì˜ ìˆ˜í–‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ì¸ì§€ê¸°ëŠ¥ í‰ê°€ë¥¼ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ ì „ë°˜ë¶€ì™€ í›„ë°˜ë¶€ì˜ ìˆ˜í–‰ ì°¨ì´ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.';
            } else {
                interpretation = 'ì €ì¡°í•œ ìˆ˜í–‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì˜ ìƒë‹´ì„ ë°›ì•„ë³´ì‹œê¸°ë¥¼ ê¶Œí•©ë‹ˆë‹¤. ì–¸ì–´ ìœ ì°½ì„±ê³¼ ì¸ì§€ ê¸°ëŠ¥ì— ëŒ€í•œ ì¢…í•©ì ì¸ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            
            // ì „ë¬¸ ë¶„ì„ ê²°ê³¼ HTML ìƒì„± (CFTSCORING ìŠ¤íƒ€ì¼ ì ìš©)
            const resultHTML = `
                <style>
                    .results { background: white; padding: 30px; border-radius: 12px; margin-top: 20px; }
                    .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
                    .score-card { background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; transition: transform 0.2s; }
                    .score-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                    .score-card h4 { font-size: 14px; color: #666; margin-bottom: 10px; font-weight: normal; }
                    .score { font-size: 32px; font-weight: bold; color: #2196F3; }
                    @media (max-width: 768px) { .score-grid { grid-template-columns: repeat(2, 1fr); } }
                </style>
                
                <div id="results" class="results">
                    <h2 style="color: #333; margin-bottom: 30px; text-align: center; font-size: 26px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">ê²€ì‚¬ ê²°ê³¼</h2>
                    
                    <!-- ì²«ë²ˆì§¸ ì¤„: ì´ì , ì „ë°˜ì ìˆ˜, í›„ë°˜ì ìˆ˜, ë³´ì†, ì¹¨íˆ¬ -->
                    <div class="score-grid">
                        <div class="score-card">
                            <h4>ì´ì <br>(Total Score)</h4>
                            <div class="score">${totalScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>ì „ë°˜ì ìˆ˜<br>(First Half Score)</h4>
                            <div class="score">${firstHalfScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>í›„ë°˜ì ìˆ˜<br>(Second Half Score)</h4>
                            <div class="score">${secondHalfScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>ë³´ì†<br>(Perseveration)</h4>
                            <div class="score" style="color: ${perseverationScore > 2 ? '#FF5722' : '#2196F3'};">${perseverationScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>ì¹¨íˆ¬<br>(Intrusion)</h4>
                            <div class="score">${intrusionScore}</div>
                        </div>
                    </div>
                    
                    <!-- ë‘ë²ˆì§¸ ì¤„: ë²”ì£¼ìˆ˜, í‰ê· ë²”ì£¼í¬ê¸°, ìµœëŒ€ë²”ì£¼í¬ê¸°, ì „í™˜, ë¹„íš¨ìœ¨ì „í™˜ -->
                    <div class="score-grid">
                        <div class="score-card">
                            <h4>ë²”ì£¼ìˆ˜<br>(Number of Cluster)</h4>
                            <div class="score">${categoryAnalysis.numberOfClusters}</div>
                        </div>
                        <div class="score-card">
                            <h4>í‰ê· ë²”ì£¼í¬ê¸°<br>(Mean Size of Cluster)</h4>
                            <div class="score">${categoryAnalysis.meanClusterSize}</div>
                        </div>
                        <div class="score-card">
                            <h4>ìµœëŒ€ë²”ì£¼í¬ê¸°<br>(Max Size of Cluster)</h4>
                            <div class="score">${categoryAnalysis.maxClusterSize}</div>
                        </div>
                        <div class="score-card">
                            <h4>ì „í™˜<br>(Switching)</h4>
                            <div class="score">${categoryAnalysis.switching}</div>
                        </div>
                        <div class="score-card">
                            <h4>ë¹„íš¨ìœ¨ì „í™˜<br>(Hard Switching)</h4>
                            <div class="score">${categoryAnalysis.hardSwitching}</div>
                        </div>
                    </div>
                    
                    <!-- ì¶”ê°€ ë¶„ì„ ì •ë³´ -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="color: #495057; margin-bottom: 15px; font-size: 18px;">ì‹œê°„ëŒ€ë³„ ìƒì„¸ ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">0-15ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${counts['0-15ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['0-15ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">15-30ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${counts['15-30ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['15-30ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">30-45ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${counts['30-45ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['30-45ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">45-60ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${counts['45-60ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['45-60ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: ${totalScore >= 15 ? '#d4edda' : totalScore >= 10 ? '#fff3cd' : '#f8d7da'}; 
                                border: 1px solid ${totalScore >= 15 ? '#c3e6cb' : totalScore >= 10 ? '#ffeeba' : '#f5c6cb'};
                                color: ${totalScore >= 15 ? '#155724' : totalScore >= 10 ? '#856404' : '#721c24'};
                                border-radius: 8px;">
                        <h3 style="margin-bottom: 10px; font-size: 18px;">ì¢…í•© í•´ì„</h3>
                        <p style="margin: 0; line-height: 1.8;">${interpretation}</p>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #6c757d; font-size: 14px;">
                        <p>ê²€ì‚¬ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}</p>
                        <p>ê°€ì¤‘ì¹˜ ì ìˆ˜: ${weightedScore.toFixed(1)}ì </p>
                        <p style="margin-top: 10px;">* ë³¸ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì •í™•í•œ ì§„ë‹¨ì„ ìœ„í•´ì„œëŠ” ì „ë¬¸ê°€ì˜ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
            
            // ê²°ê³¼ í‘œì‹œ - ì´ ë¶€ë¶„ì€ CFTSCORING í†µí•©ìœ¼ë¡œ ì œê±°ë¨
            // displayCFTSCORINGFullResults(resultHTML);
            
            // ìŒì„± ì•ˆë‚´
            // speak("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
        
        // CFTSCORING ê²°ê³¼ í‘œì‹œ (ê¸°ì¡´ í•¨ìˆ˜ ì œê±°)
        /*
            // CFTSCORINGê³¼ ë™ì¼í•œ ë²”ì£¼ ì²´ê³„ ì‚¬ìš©
            const CATEGORIES = {
                // ìƒë¬¼í•™ì  ë¶„ë¥˜
                MAMMAL: 'í¬ìœ ë¥˜',
                BIRD: 'ì¡°ë¥˜',
                REPTILE: 'íŒŒì¶©ë¥˜',
                AMPHIBIAN: 'ì–‘ì„œë¥˜',
                FISH: 'ì–´ë¥˜',
                INSECT: 'ê³¤ì¶©',
                MOLLUSK: 'ì—°ì²´ë™ë¬¼',
                CRUSTACEAN: 'ê°‘ê°ë¥˜',
                
                // ì„œì‹ì§€ë³„ ë¶„ë¥˜
                AQUATIC: 'ìˆ˜ìƒë™ë¬¼',
                MARINE: 'í•´ì–‘ë™ë¬¼',
                FRESHWATER: 'ë‹´ìˆ˜ë™ë¬¼',
                AERIAL: 'ë¹„í–‰ë™ë¬¼',
                
                // ì¸ê°„ê³¼ì˜ ê´€ê³„
                DOMESTIC: 'ê°€ì¶•',
                PET: 'ì• ì™„ë™ë¬¼',
                WILD: 'ì•¼ìƒë™ë¬¼',
                
                // ë¬¸í™”ì  ë¶„ë¥˜
                ZODIAC: '12ê°„ì§€',
                MYTHOLOGY: 'ì‹ í™”ë™ë¬¼',
                IMAGINARY: 'ìƒìƒì˜ ë™ë¬¼',
                PREHISTORIC: 'ì„ ì‚¬ì‹œëŒ€ ë™ë¬¼'
            };
            
            // ê°„ë‹¨í•œ ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ (ì£¼ìš” ë™ë¬¼ë§Œ í¬í•¨)
            const ANIMAL_DATA = {
                'ê°œ': { MAMMAL: true, DOMESTIC: true, PET: true, ZODIAC: true },
                'ê³ ì–‘ì´': { MAMMAL: true, DOMESTIC: true, PET: true },
                'ì†Œ': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ë§': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ë¼ì§€': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ì–‘': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ì—¼ì†Œ': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'í† ë¼': { MAMMAL: true, DOMESTIC: true, PET: true, ZODIAC: true },
                'í˜¸ë‘ì´': { MAMMAL: true, WILD: true, ZODIAC: true },
                'ì‚¬ì': { MAMMAL: true, WILD: true },
                'ì½”ë¼ë¦¬': { MAMMAL: true, WILD: true },
                'ê¸°ë¦°': { MAMMAL: true, WILD: true },
                'ê³°': { MAMMAL: true, WILD: true },
                'ëŠ‘ëŒ€': { MAMMAL: true, WILD: true },
                'ì—¬ìš°': { MAMMAL: true, WILD: true },
                'ì›ìˆ­ì´': { MAMMAL: true, WILD: true, ZODIAC: true },
                'ì¥': { MAMMAL: true, WILD: true, ZODIAC: true },
                'ë‹­': { BIRD: true, DOMESTIC: true, ZODIAC: true },
                'ì˜¤ë¦¬': { BIRD: true, DOMESTIC: true, AQUATIC: true },
                'ê±°ìœ„': { BIRD: true, DOMESTIC: true },
                'ì°¸ìƒˆ': { BIRD: true, WILD: true, AERIAL: true },
                'ë¹„ë‘˜ê¸°': { BIRD: true, WILD: true, AERIAL: true },
                'ë…ìˆ˜ë¦¬': { BIRD: true, WILD: true, AERIAL: true },
                'ë±€': { REPTILE: true, WILD: true, ZODIAC: true },
                'ê±°ë¶ì´': { REPTILE: true, PET: true, AQUATIC: true },
                'ì•…ì–´': { REPTILE: true, WILD: true, AQUATIC: true },
                'ê°œêµ¬ë¦¬': { AMPHIBIAN: true, WILD: true, AQUATIC: true },
                'ë‘êº¼ë¹„': { AMPHIBIAN: true, WILD: true },
                'ë¬¼ê³ ê¸°': { FISH: true, AQUATIC: true },
                'ìƒì–´': { FISH: true, MARINE: true, WILD: true },
                'ê³ ë˜': { MAMMAL: true, MARINE: true, WILD: true },
                'ëŒê³ ë˜': { MAMMAL: true, MARINE: true, WILD: true },
                'ë¬¸ì–´': { MOLLUSK: true, MARINE: true },
                'ì˜¤ì§•ì–´': { MOLLUSK: true, MARINE: true },
                'ìƒˆìš°': { CRUSTACEAN: true, MARINE: true },
                'ê²Œ': { CRUSTACEAN: true, MARINE: true },
                'ë‚˜ë¹„': { INSECT: true, AERIAL: true },
                'ë²Œ': { INSECT: true, AERIAL: true },
                'ê°œë¯¸': { INSECT: true, WILD: true },
                'ìš©': { ZODIAC: true, MYTHOLOGY: true, IMAGINARY: true, AERIAL: true }
            };
            
            // í´ëŸ¬ìŠ¤í„° ìƒì„±
            const clusters = [];
            let currentCluster = null;
            let lastCategories = [];
            
            animals.forEach((animal, index) => {
                // í˜„ì¬ ë™ë¬¼ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const animalData = ANIMAL_DATA[animal] || {};
                const animalCategories = [];
                
                // í˜„ì¬ ë™ë¬¼ì´ ì†í•œ ë²”ì£¼ë“¤ ì°¾ê¸°
                for (let [categoryKey, hasCategory] of Object.entries(animalData)) {
                    if (hasCategory === true) {
                        animalCategories.push(categoryKey);
                    }
                }
                
                // ì´ì „ í´ëŸ¬ìŠ¤í„°ì™€ ê³µìœ  ë²”ì£¼ê°€ ìˆëŠ”ì§€ í™•ì¸
                const hasSharedCategory = lastCategories.some(cat => animalCategories.includes(cat));
                
                if (hasSharedCategory && currentCluster) {
                    // ê°™ì€ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€
                    currentCluster.animals.push(animal);
                    currentCluster.size++;
                } else {
                    // ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„° ì‹œì‘
                    if (currentCluster) {
                        clusters.push(currentCluster);
                    }
                    currentCluster = {
                        animals: [animal],
                        size: 1,
                        categories: animalCategories
                    };
                }
                
                lastCategories = animalCategories;
            });
            
            // ë§ˆì§€ë§‰ í´ëŸ¬ìŠ¤í„° ì¶”ê°€
            if (currentCluster) {
                clusters.push(currentCluster);
            }
            
            // ì „í™˜ íšŸìˆ˜
            const switching = Math.max(0, clusters.length - 1);
            
            // ë¹„íš¨ìœ¨ì „í™˜ ê³„ì‚° (í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„° ë‹¤ìŒì˜ ì „í™˜)
            let hardSwitching = 0;
            for (let i = 0; i < clusters.length - 1; i++) {
                if (clusters[i].size === 1) {
                    // ë‹¤ìŒ í´ëŸ¬ìŠ¤í„°ì™€ ê³µìœ  ë²”ì£¼ê°€ ì—†ëŠ”ì§€ í™•ì¸
                    const currentCategories = clusters[i].categories;
                    const nextCategories = clusters[i + 1].categories;
                    const hasShared = currentCategories.some(cat => nextCategories.includes(cat));
                    if (!hasShared) {
                        hardSwitching++;
                    }
                }
            }
            
            // í´ëŸ¬ìŠ¤í„° í†µê³„
            const numberOfClusters = clusters.length;
            const clusterSizes = clusters.map(c => c.size);
            const meanClusterSize = numberOfClusters > 0 ? 
                (clusterSizes.reduce((sum, size) => sum + size, 0) / numberOfClusters).toFixed(1) : '0.0';
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            return {
                numberOfClusters,
                meanClusterSize,
                maxClusterSize,
                switching,
                hardSwitching
            };
        */
        
        
        // CFTSCORINGì—ì„œ ë°›ì€ HTML ê²°ê³¼ í‘œì‹œ
        function displayCFTSCORINGResult(htmlContent) {
            console.log('CFTSCORING ê²°ê³¼ HTML í‘œì‹œ');
            
            // ê²°ê³¼ ì„¹ì…˜ ì´ˆê¸°í™” ë° HTML í‘œì‹œ
            resultsSection.innerHTML = '';
            
            // CFTSCORING ê²°ê³¼ ì»¨í…Œì´ë„ˆ ìƒì„±
            const containerDiv = document.createElement('div');
            containerDiv.style.cssText = 'margin: 20px auto; max-width: 1200px; padding: 20px;';
            containerDiv.innerHTML = htmlContent;
            
            // ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸° ë²„íŠ¼ ì¶”ê°€
            const buttonDiv = document.createElement('div');
            buttonDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px;';
            buttonDiv.innerHTML = '<button onclick="window.location.href = window.location.pathname" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°</button>';
            
            resultsSection.appendChild(containerDiv);
            resultsSection.appendChild(buttonDiv);
            resultsSection.style.display = 'block';
            
            // ìŠ¤í¬ë¡¤
            containerDiv.scrollIntoView({ behavior: 'smooth' });
            
            // ìŒì„± ì•ˆë‚´
            speak("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
        

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì„¤ëª… í˜ì´ì§€ ê´€ë ¨ ì´ë²¤íŠ¸ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ìœ ì§€)
        if (instructionsNextBtn) {
            instructionsNextBtn.addEventListener('click', () => showPage('test'));
        }
        if (instructionsVoiceGuideBtn) {
            instructionsVoiceGuideBtn.addEventListener('click', () => {
                instructionsVoiceGuideActive = !instructionsVoiceGuideActive;
                if (instructionsVoiceGuideActive) {
                    instructionsVoiceGuideBtn.textContent = 'ğŸ”Š ìŒì„± ì•ˆë‚´ ì¤‘ì§€';
                    instructionsVoiceGuide();
                } else {
                    instructionsVoiceGuideBtn.textContent = 'ğŸ”Š ìŒì„± ì•ˆë‚´ ë“£ê¸°';
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                    hideVoiceGuide();
                }
            });
        }
        // testPrevBtn.addEventListener('click', () => showPage('instructions')); // ì œê±°ë¨
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” DOM ìš”ì†Œ ì´ˆê¸°í™” í›„ì— ì¶”ê°€ë¨

        // í‚¤ë³´ë“œ ì…ë ¥ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨

        // ìŒì„± ëª©ë¡ ë¡œë“œ
        function loadVoices() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        };
                    }
                } else {
                    resolve([]);
                }
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì„¤ëª… í˜ì´ì§€ ê´€ë ¨ ì´ë²¤íŠ¸ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ìœ ì§€)
        if (instructionsNextBtn) {
            instructionsNextBtn.addEventListener('click', () => showPage('test'));
        }
        if (instructionsVoiceGuideBtn) {
            instructionsVoiceGuideBtn.addEventListener('click', () => {
                instructionsVoiceGuideActive = !instructionsVoiceGuideActive;
                if (instructionsVoiceGuideActive) {
                    instructionsVoiceGuideBtn.textContent = 'ğŸ”Š ìŒì„± ì•ˆë‚´ ì¤‘ì§€';
                    instructionsVoiceGuide();
                } else {
                    instructionsVoiceGuideBtn.textContent = 'ğŸ”Š ìŒì„± ì•ˆë‚´ ë“£ê¸°';
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                    hideVoiceGuide();
                }
            });
        }
        // testPrevBtn.addEventListener('click', () => showPage('instructions')); // ì œê±°ë¨
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” DOM ìš”ì†Œ ì´ˆê¸°í™” í›„ì— ì¶”ê°€ë¨

        // í‚¤ë³´ë“œ ì…ë ¥ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨

        // ìŒì„± ëª©ë¡ ë¡œë“œ
        function loadVoices() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        };
                    }
                } else {
                    resolve([]);
                }
            });
        }

        // ë§ˆì´í¬ ê¶Œí•œ ë° ìŒì„±ì¸ì‹ ì¤€ë¹„ (ê¶Œí•œ ìš”ì²­ ì—†ì´)
        async function prepareMicrophoneAndRecognition() {
            console.log('ë§ˆì´í¬ ê¶Œí•œ ë° ìŒì„±ì¸ì‹ ì¤€ë¹„');
            
            // ìŒì„±ì¸ì‹ ì´ˆê¸°í™”
            if (!recognition) {
                initializeSpeechRecognition();
            }
            
            // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('ë§ˆì´í¬ ê¶Œí•œ íšë“ ì„±ê³µ');
                
                // ì˜¤ë””ì˜¤ ì‹œê°í™”ë¥¼ ìœ„í•œ ìŠ¤íŠ¸ë¦¼ ì €ì¥
                audioStream = stream;
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    
                    // ìŠ¤íŠ¸ë¦¼ ì €ì¥
                    audioStream = stream;
                }
                
                return true;
            } catch (error) {
                console.error('ë§ˆì´í¬ ê¶Œí•œ íšë“ ì‹¤íŒ¨:', error);
                alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return false;
            }
        }

        // ìë™ ìŒì„± ì‹œì‘ ì‹œë„ í•¨ìˆ˜
        async function tryAutoVoiceStart() {
            console.log('tryAutoVoiceStart í˜¸ì¶œë¨');
            
            // DOM ìš”ì†Œ ì´ˆê¸°í™”
            initializeDOMElements();
            
            // ìŒì„±ì¸ì‹ ì´ˆê¸°í™”ë§Œ í•˜ê³  ê¶Œí•œì€ ë‚˜ì¤‘ì— ìš”ì²­
            if (!recognition) {
                console.log('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì‹œë„');
                initializeSpeechRecognition();
            }
            
            // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì˜¤ë””ì˜¤ë¡œ ìë™ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            const testAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAA==');
            testAudio.play().then(() => {
                console.log('ìë™ì¬ìƒ ê°€ëŠ¥ - ìë™ìœ¼ë¡œ ì‹œì‘');
                // ë²„íŠ¼ ìˆ¨ê¸°ê³  ë°”ë¡œ ì‹œì‘
                document.getElementById('manualStartBtn').style.display = 'none';
                setTimeout(() => {
                    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ - handleStartClickì—ì„œ ì´ë¯¸ ì‹¤í–‰ë¨
                    // startInstructions();
                }, 1000);
            }).catch(error => {
                console.log('ìë™ì¬ìƒ ì°¨ë‹¨ë¨ - ì‹œì‘ ë²„íŠ¼ í‘œì‹œ');
                // ì‹œì‘ ë²„íŠ¼ì€ ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìŒ
                // ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ handleStartClickì´ í˜¸ì¶œë¨
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            // DOM ìš”ì†Œ ì´ˆê¸°í™”
            initializeDOMElements();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (startBtn) startBtn.addEventListener('click', () => startTest());
            if (stopBtn) stopBtn.addEventListener('click', stopTest);
            if (resetBtn) resetBtn.addEventListener('click', resetTest);
            if (downloadBtn) downloadBtn.addEventListener('click', downloadResults);
            
            // ìŒì„± ëª©ë¡ ë¨¼ì € ë¡œë“œ
            const voices = loadVoices();
            console.log('ë¡œë“œëœ ìŒì„± ëª©ë¡:', voices.length, 'ê°œ');
            
            // í•˜ë“œì›¨ì–´ ì„¤ì • í™•ì¸
            const hasSettings = loadHardwareSettings();
            
            if (!hasSettings) {
                console.log('í•˜ë“œì›¨ì–´ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
                // ì„¤ì •ì´ ì—†ì–´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰
                setupWarning.style.display = 'none';
            } else {
                console.log('í•˜ë“œì›¨ì–´ ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                setupWarning.style.display = 'none';
            }
            
            // DOM ìš”ì†Œ í™•ì¸
            console.log('DOM ìš”ì†Œ í™•ì¸:', {
                manualStartBtn: document.getElementById('manualStartBtn'),
                readyBox: document.getElementById('readyBox'),
                testPage: document.getElementById('testPage')
            });
            
            // ì‹œì‘ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const manualStartBtn = document.getElementById('manualStartBtn');
            if (manualStartBtn) {
                console.log('ì‹œì‘ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                console.log('ì‹œì‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼:', {
                    display: window.getComputedStyle(manualStartBtn).display,
                    visibility: window.getComputedStyle(manualStartBtn).visibility,
                    opacity: window.getComputedStyle(manualStartBtn).opacity,
                    zIndex: window.getComputedStyle(manualStartBtn).zIndex
                });
                
                // ê°•ì œë¡œ ë²„íŠ¼ì„ ë³´ì´ë„ë¡ ì„¤ì •
                manualStartBtn.style.display = 'inline-block';
                manualStartBtn.style.visibility = 'visible';
                manualStartBtn.style.opacity = '1';
                manualStartBtn.style.position = 'relative';
                manualStartBtn.style.zIndex = '99999';
                
                console.log('ì‹œì‘ ë²„íŠ¼ ê°•ì œ í‘œì‹œ ì™„ë£Œ');
                
                manualStartBtn.addEventListener('click', function() {
                    console.log('ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨!');
                    if (!isStartClicked) {
                        window.handleStartClick();
                    }
                });
            } else {
                console.error('manualStartBtnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            // ì¤‘ë³µ ì œê±°ë¨ - ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬
            
            // ë°”ë¡œ ê²€ì‚¬ í˜ì´ì§€ë¡œ ì´ë™
            showPage('test');
            
            // testPageê°€ í™•ì‹¤íˆ ë³´ì´ë„ë¡ ê°•ì œ ì„¤ì •
            const testPage = document.getElementById('testPage');
            if (testPage) {
                testPage.style.display = 'block';
                testPage.classList.add('active');
                console.log('testPage ê°•ì œ í‘œì‹œ ì™„ë£Œ');
            }
            
            // ë¸Œë¼ìš°ì € ì²´í¬
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome && (isSafari || isEdge)) {
                // Chromeì´ ì•„ë‹Œ ê²½ìš° ê²½ê³  í‘œì‹œ
                document.getElementById('browserWarning').style.display = 'block';
            } else {
                // Chromeì¸ ê²½ìš° 1ì´ˆ í›„ ìë™ ìŒì„± ì‹œì‘ ì‹œë„
                setTimeout(() => {
                    tryAutoVoiceStart();
                }, 1000);
            }
        });
    </script>
    </div> <!-- container ë‹«ê¸° -->
</body>
</html>