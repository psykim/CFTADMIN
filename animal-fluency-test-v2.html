<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동물 범주 언어유창성검사</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .instructions-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .instruction-card {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .instruction-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-content {
            background: transparent;
            padding: 30px;
            border-radius: 8px;
        }
        .timer-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .btn {
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .input-section {
            margin: 20px 0;
            text-align: center;
        }
        #manualInput {
            padding: 10px;
            font-size: 18px;
            width: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .animal-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 50px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .animal-item {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
        }
        .animal-item.duplicate {
            background: #e74c3c;
        }
        .stats {
            margin-top: 30px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .stat-value {
            font-weight: bold;
            color: #2c3e50;
        }
        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            color: #e74c3c;
            font-weight: bold;
        }
        .recording-indicator.active {
            display: flex;
        }
        .rec-dot {
            width: 12px;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .prev-btn {
            background-color: #95a5a6;
            color: white;
        }
        .prev-btn:hover {
            background-color: #7f8c8d;
        }
        .next-btn {
            background-color: #2ecc71;
            color: white;
        }
        .next-btn:hover {
            background-color: #27ae60;
        }
        .voice-guide-btn {
            background-color: #f39c12;
            color: white;
        }
        .voice-guide-btn:hover {
            background-color: #e67e22;
        }
        .download-btn {
            background-color: #9b59b6;
            color: white;
            margin-top: 20px;
        }
        .download-btn:hover {
            background-color: #8e44ad;
        }
        .ready-box {
            text-align: center;
            color: white;
        }
        .ready-check {
            font-size: 18px;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        .ready-check p {
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
        }
        .start-button {
            background: 
                radial-gradient(ellipse at center, #16a34a 0%, #22c55e 40%, #4ade80 100%);
            color: white;
            border: none;
            width: 160px;
            height: 160px;
            font-size: 26px;
            font-weight: 700;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(34, 197, 94, 0.1),
                inset 0 -8px 16px rgba(255, 255, 255, 0.2),
                inset 0 8px 16px rgba(0, 0, 0, 0.3),
                inset 0 0 40px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 0;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.5),
                0 -1px 0 rgba(255, 255, 255, 0.1);
        }
        .start-button::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            bottom: 10%;
            border-radius: 50%;
            background: 
                radial-gradient(ellipse at center bottom, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
            opacity: 0.8;
        }
        .start-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            border-radius: 50%;
            box-shadow: 
                inset 0 -3px 8px rgba(255, 255, 255, 0.3),
                inset 0 3px 8px rgba(0, 0, 0, 0.3);
            opacity: 0.5;
        }
        .start-button span {
            position: relative;
            z-index: 1;
        }
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 0 10px rgba(34, 197, 94, 0.15),
                inset 0 -8px 16px rgba(255, 255, 255, 0.25),
                inset 0 8px 16px rgba(0, 0, 0, 0.25),
                inset 0 0 40px rgba(0, 0, 0, 0.15);
            background: 
                radial-gradient(ellipse at center, #1fb85a 0%, #2ed068 40%, #52e88e 100%);
        }
        .start-button:active {
            transform: translateY(2px);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(34, 197, 94, 0.1),
                inset 0 -4px 8px rgba(255, 255, 255, 0.15),
                inset 0 10px 20px rgba(0, 0, 0, 0.4),
                inset 0 0 50px rgba(0, 0, 0, 0.3);
            background: 
                radial-gradient(ellipse at center, #148f42 0%, #1fb34e 40%, #3ec670 100%);
        }
        .voice-guide-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 300px;
            transform: translateY(100px);
            transition: transform 0.3s;
            z-index: 1000;
            opacity: 0;
        }
        .voice-guide-box.active {
            transform: translateY(0);
            opacity: 1;
        }
        .no-setup-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .interval-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .interval-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .interval-stat h5 {
            margin: 0 0 5px 0;
            color: #666;
            font-size: 14px;
        }
        .interval-stat .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        /* 검사 시작 화면 효과 */
        .test-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }
        .test-start-overlay.active {
            display: flex;
        }
        .mic-icon {
            width: 120px;
            height: 120px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 1.5s infinite;
        }
        .mic-icon svg {
            width: 60px;
            height: 60px;
            fill: white;
        }
        .test-start-text {
            font-size: 48px;
            color: white;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            animation-delay: 0.3s;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* 테스트 화면 스타일 */
        .test-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        .test-screen.active {
            display: flex;
        }
        .test-mic-container {
            margin-bottom: 40px;
            text-align: center;
        }
        .test-mic-icon {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px;
            transition: all 0.3s ease;
            box-shadow: 
                0 8px 30px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.1),
                inset 0 -4px 8px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .test-mic-icon::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
            border-radius: 50%;
            opacity: 0.8;
        }
        .test-mic-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: transparent;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1);
        }
        .test-mic-icon.active {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 
                0 0 50px rgba(239, 68, 68, 0.6),
                0 8px 30px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -4px 8px rgba(0,0,0,0.3);
        }
        .test-mic-icon.active::before {
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { opacity: 0.8; transform: translateX(0) translateY(0); }
            50% { opacity: 1; transform: translateX(10px) translateY(10px); }
        }
        .test-mic-icon svg {
            width: 70px;
            height: 70px;
            fill: white;
            z-index: 1;
            position: relative;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .test-mic-icon.active svg {
            animation: mic-pulse 1.5s ease-in-out infinite;
        }
        @keyframes mic-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .response-display {
            width: 90%;
            max-width: 600px;
            height: 200px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .response-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .response-item {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            animation: fadeIn 0.3s ease-in;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 제목 제거 -->
        
        <!-- 설정 확인 메시지 -->
        <div id="setupWarning" class="no-setup-warning" style="display: none;">
            <h3>⚠️ 하드웨어 설정이 필요합니다</h3>
            <p>음성 기반 검사를 위해 먼저 하드웨어 설정을 완료해주세요.</p>
            <button class="btn btn-primary" onclick="goToSetup()">하드웨어 설정하기</button>
        </div>

        <!-- 브라우저 경고 메시지 -->
        <div id="browserWarning" class="no-setup-warning" style="display: none; background: #ffebee; border-color: #ef5350;">
            <h3>⚠️ 브라우저 호환성 안내</h3>
            <p>이 검사는 <strong>Chrome 브라우저</strong>에서 가장 잘 작동합니다.</p>
            <p style="margin-top: 10px; font-size: 14px;">
                현재 브라우저에서는 음성인식이 제한적이거나 마이크 권한 요청이 반복될 수 있습니다.<br>
                <strong>Chrome 브라우저</strong>를 사용하시면 더 원활한 검사가 가능합니다.
            </p>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="continueDespiteBrowser()">그래도 계속하기</button>
                <a href="https://www.google.com/chrome/" target="_blank" class="btn btn-success" style="margin-left: 10px;">Chrome 다운로드</a>
            </div>
        </div>

        <!-- Instructions Page -->
        <div class="page" id="instructionsPage">
            <div class="instructions-content">
                <h2>검사 안내</h2>
                
                <div class="instruction-card">
                    <h4>🕐 검사 시간</h4>
                    <p><strong>1분 (60초)</strong> 동안 진행됩니다.</p>
                    <p>시간이 종료되면 자동으로 검사가 끝납니다.</p>
                </div>

                <div class="instruction-card">
                    <h4>📋 검사 방법</h4>
                    <p>제가 "시작"이라고 말씀드리면, <strong>생각나는 동물 이름을 최대한 많이</strong> 말씀해 주세요.</p>
                    <p>음성인식 또는 키보드 입력 모두 가능합니다.</p>
                </div>

                <div class="instruction-card">
                    <h4>✅ 포함 가능한 동물</h4>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>포유류 (예: 개, 고양이, 사자, 코끼리)</li>
                        <li>조류 (예: 참새, 독수리, 펭귄)</li>
                        <li>어류 (예: 금붕어, 상어, 고등어)</li>
                        <li>파충류 (예: 뱀, 거북이, 악어)</li>
                        <li>양서류 (예: 개구리, 도롱뇽)</li>
                        <li>곤충 (예: 나비, 개미, 벌)</li>
                        <li>멸종 동물 (예: 공룡, 매머드)</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <h4>⚠️ 주의사항</h4>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li><strong>같은 동물을 반복하지 마세요</strong> (중복은 자동으로 표시됩니다)</li>
                        <li><strong>애완동물 이름은 제외</strong> (예: 바둑이, 나비 ✗)</li>
                        <li><strong>가상의 동물은 제외</strong> (예: 용, 유니콘, 포켓몬 ✗)</li>
                        <li><strong>동물 종류만 말씀하세요</strong> (예: "큰 사자" ✗ → "사자" ✓)</li>
                    </ul>
                </div>

                <div class="navigation">
                    <button class="btn voice-guide-btn" id="instructionsVoiceGuideBtn">🔊 음성 안내 듣기</button>
                    <button class="btn next-btn" id="instructionsNextBtn">다음 단계</button>
                </div>
            </div>
        </div>

        <!-- Test Page -->
        <div class="page active" id="testPage">
            <div class="test-content">
                <!-- 검사 진행 텍스트와 타이머 숫자 제거 -->
                
                <div class="timer-display" id="timer" style="display: none;">60</div>
                
                <div class="ready-box" id="readyBox">
                    <button class="start-button" id="manualStartBtn" onclick="handleStartClick()"><span>시작하기</span></button>
                    <div class="ready-check">
                        <p>조용한 장소에서 검사를 시작하세요</p>
                    </div>
                    <div id="audioPermissionNotice" style="display: none; margin-top: 30px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <p style="margin: 0; color: white; opacity: 0.8; font-size: 16px;">🔊 음성 안내를 시작하려면 화면을 클릭하세요</p>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-success" id="startBtn" style="display: none;">시작</button>
                    <button class="btn btn-danger" id="stopBtn" style="display: none;">중지</button>
                    <button class="btn btn-primary" id="resetBtn" style="display: none;">다시 시작</button>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <div class="rec-dot"></div>
                    <span>음성 인식 중...</span>
                </div>

                <!-- 키보드 입력 섹션 제거 -->
                <!--
                <div class="input-section">
                    <input type="text" id="manualInput" placeholder="키보드로 입력 (Enter로 추가)" disabled>
                    <button class="btn btn-primary" id="addBtn" disabled>추가</button>
                </div>
                -->
            </div>

            <!-- 결과 섹션은 검사 시작 후에만 표시 -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <h3>입력된 동물 목록</h3>
                <div class="animal-list" id="animalList"></div>
                
                <div class="stats" id="stats" style="display: none;">
                    <h3>검사 결과</h3>
                    
                    <div class="interval-stats" id="intervalStats"></div>
                    
                    <div class="stat-item">
                        <span class="stat-label">총 응답 수:</span>
                        <span class="stat-value" id="totalCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">유효 응답 수 (중복 제외):</span>
                        <span class="stat-value" id="uniqueCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">중복 응답 수:</span>
                        <span class="stat-value" id="duplicateCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">소요 시간:</span>
                        <span class="stat-value" id="elapsedTime">0초</span>
                    </div>
                    <button class="btn download-btn" id="downloadBtn">결과 다운로드</button>
                </div>
            </div>

            <!-- 이전 단계 버튼 제거 - 첫 페이지가 없으므로 필요 없음 -->
            <!-- <div class="navigation">
                <button class="btn prev-btn" id="testPrevBtn">이전 단계</button>
                <div></div>
            </div> -->
        </div>
    </div>

    <div class="voice-guide-box" id="voiceGuideBox">
        <div id="voiceGuideText"></div>
    </div>

    <!-- 검사 시작 오버레이 -->
    <div class="test-start-overlay" id="testStartOverlay">
        <div class="mic-icon">
            <svg viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
            </svg>
        </div>
        <div class="test-start-text">검사 시작</div>
    </div>

    <!-- 테스트 화면 -->
    <div class="test-screen" id="testScreen">
        <div class="test-mic-container">
            <div class="test-mic-icon" id="testMicIcon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                </svg>
            </div>
        </div>
        <div class="response-display" id="responseDisplay">
            <div class="response-list" id="responseList"></div>
        </div>
    </div>

    <script>
        // 간단한 테스트 함수
        function testClick() {
            console.log('버튼 클릭 테스트 성공!');
            alert('버튼이 정상적으로 작동합니다!');
        }
        
        // 페이지 로드 즉시 실행 - 디버깅 완료됨
        
        // 전역 변수
        let animals = [];
        let uniqueAnimals = new Set();
        let startTime = null;
        let endTime = null;
        let timerInterval = null;
        let timeRemaining = 60;
        let recognition = null;
        let isRecognizing = false;
        let currentStep = 1;
        let hardwareSettings = null;
        let instructionsVoiceGuideActive = false;
        let microphonePermissionGranted = false;
        let practiceItems = [];
        let isPracticePhase = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let mediaStream = null; // 마이크 스트림 유지

        // ElevenLabs 관련 변수
        let elevenLabsApiKey = 'sk_191de859c1c1dbd4601051930c5952b467ac46716aa97057'; // 기본값
        let elevenLabsVoiceId = 'XrExE9yKIg1WjnnlVkGX'; // 마틸다 (여성) 기본값
        let elevenLabsConnected = true; // 기본값
        let audioQueue = [];
        let isPlaying = false;

        // DOM 요소 (초기에는 null로 설정)
        let pages = null;
        let instructionsNextBtn = null;
        let instructionsVoiceGuideBtn = null;
        let timer = null;
        let startBtn = null;
        let stopBtn = null;
        let resetBtn = null;
        let animalList = null;
        let stats = null;
        let recordingIndicator = null;
        let downloadBtn = null;
        let voiceGuideBox = null;
        let voiceGuideText = null;
        let readyBox = null;
        let setupWarning = null;
        let testStartOverlay = null;
        let testScreen = null;
        let responseList = null;
        let resultsSection = null;
        let testMicIcon = null;
        
        // DOM 요소 초기화 함수
        function initializeDOMElements() {
            pages = {
                instructions: document.getElementById('instructionsPage'),
                test: document.getElementById('testPage')
            };
            instructionsNextBtn = document.getElementById('instructionsNextBtn');
            instructionsVoiceGuideBtn = document.getElementById('instructionsVoiceGuideBtn');
            timer = document.getElementById('timer');
            startBtn = document.getElementById('startBtn');
            stopBtn = document.getElementById('stopBtn');
            resetBtn = document.getElementById('resetBtn');
            animalList = document.getElementById('animalList');
            stats = document.getElementById('stats');
            recordingIndicator = document.getElementById('recordingIndicator');
            downloadBtn = document.getElementById('downloadBtn');
            voiceGuideBox = document.getElementById('voiceGuideBox');
            voiceGuideText = document.getElementById('voiceGuideText');
            readyBox = document.getElementById('readyBox');
            setupWarning = document.getElementById('setupWarning');
            testStartOverlay = document.getElementById('testStartOverlay');
            testScreen = document.getElementById('testScreen');
            responseList = document.getElementById('responseList');
            resultsSection = document.getElementById('resultsSection');
            testMicIcon = document.getElementById('testMicIcon');
            
            // 디버깅을 위한 로그
            console.log('DOM 요소 초기화 결과:', {
                timer: timer ? 'OK' : 'NULL',
                startBtn: startBtn ? 'OK' : 'NULL',
                stopBtn: stopBtn ? 'OK' : 'NULL',
                testScreen: testScreen ? 'OK' : 'NULL'
            });
        }

        // 하드웨어 설정 페이지로 이동
        function goToSetup() {
            window.location.href = 'hardware-setup.html?next=animal-fluency-test-v2.html';
        }
        
        // 브라우저 경고 무시하고 계속
        function continueDespiteBrowser() {
            document.getElementById('browserWarning').style.display = 'none';
            tryAutoVoiceStart();
        }
        
        
        // 시작 버튼 클릭 처리
        async function handleStartClick() {
            try {
                    console.log('현재 상태:', {
                    microphonePermissionGranted,
                    recognition,
                    elevenLabsConnected,
                    hardwareSettings
                });
                
                // 버튼 숨기기
                const btn = document.getElementById('manualStartBtn');
                if (btn) {
                    btn.style.display = 'none';
                    console.log('버튼 숨김 완료');
                }
                
                const readyCheck = document.querySelector('.ready-check p');
                if (readyCheck) {
                    readyCheck.style.display = 'none';
                }
                
                // 먼저 마이크 권한 요청 (한 번만)
                if (!microphonePermissionGranted) {
                    try {
                        await startAudioVisualization();
                        console.log('마이크 권한 사전 획득 완료');
                        
                        // 음성인식은 초기화만 하고 시작하지 않음
                        if (!recognition) {
                            initializeSpeechRecognition();
                            console.log('음성인식 초기화 완료');
                        }
                    } catch (error) {
                        console.error('마이크 권한 획득 실패:', error);
                    }
                }
                
                // 음성 안내 시작
                console.log('startVoiceIntroduction 호출 직전');
                startVoiceIntroduction();
                console.log('startVoiceIntroduction 호출 완료');
                
            } catch (error) {
                console.error('handleStartClick 실행 중 에러:', error);
                alert('오류가 발생했습니다. 콘솔을 확인해주세요.');
            }
        }
        
        // 음성 테스트 함수
        function testVoice() {
            console.log('=== 음성 테스트 시작 ===');
            console.log('ElevenLabs 설정:', {
                apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                voiceId: elevenLabsVoiceId,
                connected: elevenLabsConnected
            });
            console.log('하드웨어 설정:', hardwareSettings);
            
            // 1. 브라우저 기본 TTS 테스트
            const utterance = new SpeechSynthesisUtterance("브라우저 기본 음성 테스트입니다.");
            utterance.lang = 'ko-KR';
            utterance.onend = () => console.log('브라우저 TTS 완료');
            utterance.onerror = (e) => console.error('브라우저 TTS 오류:', e);
            window.speechSynthesis.speak(utterance);
            
            // 2. speak 함수 테스트
            setTimeout(() => {
                speak("이것은 통합 음성 함수 테스트입니다.", () => {
                    console.log('speak 함수 테스트 완료');
                });
            }, 2000);
        }
        
        // 음성 안내 시작 여부 추적
        let voiceIntroStarted = false;
        
        // 음성 안내 시작 함수
        function startVoiceIntroduction() {
            
            // 이미 시작된 경우 중복 실행 방지
            if (voiceIntroStarted) {
                console.log('음성 안내가 이미 시작되었습니다.');
                return;
            }
            
            voiceIntroStarted = true;
            console.log('음성 안내 시작...');
            
            // 브라우저 체크 및 안내
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome) {
                console.log('Chrome이 아닌 브라우저 감지:', navigator.userAgent);
            }
            
            // 즉시 시작 화면 숨기고 테스트 화면 표시
            if (readyBox) readyBox.style.display = 'none';
            const testContent = document.querySelector('.test-content');
            if (testContent) testContent.style.display = 'none';
            if (testScreen) testScreen.classList.add('active');
            
            // 마이크 아이콘은 비활성 상태로 표시
            const localTestMicIcon = document.getElementById('testMicIcon');
            if (localTestMicIcon) localTestMicIcon.classList.remove('active');
            
            // 바로 음성 안내 시작 (무음 오디오 재생 없이)
            speak("이제 검사를 시작하겠습니다.", () => {
                console.log('첫 번째 안내 완료');
                
                setTimeout(() => {
                    speak("제가, 어떤 종류를 말씀드리면, 되도록, 빨리, 그 종류에 속하는 사물들의 이름을, 모두 말씀해주세요.", () => {
                        speak("예를 들어, 제가, '옷 종류'라고 말하면, 셔츠, 넥타이, 모자 등의 이름을, 말씀하시면 됩니다.", () => {
                            speak("옷 종류에 속하는 것 중에, 또 다른 것들도 있죠.", () => {
                                speak("삐 소리가 나고 마이크에 불이 들어오면, 옷종류에 속하는 다른 것들을 제가 그만할 때까지 최대한 많이 말씀해 보세요.", () => {
                                    setTimeout(() => {
                                        isPracticePhase = true;
                                        practiceItems = [];
                                        responseList.innerHTML = '';
                                        
                                        // 1초 삐 소리
                                        playBeep(880, 1000).then(async () => {
                                            // 마이크 활성화 표시
                                            testMicIcon.classList.add('active');
                                            
                                            // 오디오 시각화 시작 (이미 권한이 있으면 재사용)
                                            await startAudioVisualization();
                                            
                                            // 삐 소리 후 짧은 대기 시간을 두고 음성인식 시작
                                            setTimeout(() => {
                                                // 음성인식 시작 (연습용)
                                                if (recognition && !isRecognizing) {
                                                    try {
                                                        recognition.start();
                                                        isRecognizing = true;
                                                        console.log('연습용 음성인식 시작');
                                                    } catch (e) {
                                                        console.log('음성인식 시작 실패:', e);
                                                    }
                                                }
                                            }, 500)  // 0.5초 대기
                                            
                                            // 10초 연습 시간
                                            setTimeout(() => {
                                                console.log('10초 연습 시간 종료');
                                                console.log('연습 항목 개수:', practiceItems.length);
                                                console.log('연습 항목:', practiceItems);
                                                
                                                // 연습 모드 종료
                                                isPracticePhase = false;
                                                // 음성인식 비활성화 (안내 음성이 인식되지 않도록)
                                                isRecognizing = false;
                                                console.log('연습 종료 - 음성인식 일시 비활성화');
                                                
                                                // 마이크 비활성화 표시
                                                if (testMicIcon) testMicIcon.classList.remove('active');
                                                
                                                // 오디오 시각화 중지
                                                stopAudioVisualization();
                                                
                                                // 응답이 있었는지 확인
                                                if (practiceItems.length === 0) {
                                                    console.log('연습 응답 없음 - 재시도 안내');
                                                    speak("아무 말씀도 들리지 않았습니다. 다시 한번 연습해보겠습니다.", () => {
                                                        setTimeout(() => {
                                                            speak("제가 옷 종류라고 말하면, 삐 소리가 나고 마이크에 불이 들어올 때 옷에 속하는 것들을 말씀해주세요.", () => {
                                                                setTimeout(() => {
                                                                    // 연습 재시작
                                                                    isPracticePhase = true;
                                                                    practiceItems = [];
                                                                    responseList.innerHTML = '';
                                                                    
                                                                    playBeep(880, 1000).then(async () => {
                                                                        testMicIcon.classList.add('active');
                                                                        await startAudioVisualization();
                                                                        
                                                                        setTimeout(() => {
                                                                            if (recognition && !isRecognizing) {
                                                                                try {
                                                                                    recognition.start();
                                                                                    isRecognizing = true;
                                                                                    console.log('연습 재시도 - 음성인식 시작');
                                                                                } catch (e) {
                                                                                    console.log('음성인식 시작 실패:', e);
                                                                                }
                                                                            }
                                                                        }, 500);
                                                                        
                                                                        // 10초 후 다시 체크
                                                                        setTimeout(() => {
                                                                            isPracticePhase = false;
                                                                            isRecognizing = false;
                                                                            testMicIcon.classList.remove('active');
                                                                            stopAudioVisualization();
                                                                            
                                                                            // 두 번째 시도에서도 응답이 없으면 그냥 진행
                                                                            if (practiceItems.length === 0) {
                                                                                speak("옷의 종류를 말씀하셔야 합니다. 예를 들어 셔츠, 바지, 모자 같은 것들입니다. 본 검사로 넘어가겠습니다.", () => {
                                                                                    proceedToMainTest();
                                                                                });
                                                                            } else {
                                                                                speak("잘하셨습니다. 그렇게 하시면 됩니다.", () => {
                                                                                    proceedToMainTest();
                                                                                });
                                                                            }
                                                                        }, 10000);
                                                                    });
                                                                }, 1000);
                                                            });
                                                        }, 800);
                                                    });
                                                } else {
                                                    speak("잘하셨습니다. 그렇게 하시면 됩니다.", () => {
                                                        proceedToMainTest();
                                                    });
                                                }
                                            }, 10000); // 10초 대기
                                        });
                                    }, 1000);
                                });
                            });
                        });
                    });
                }, 1000);
            });
        }
        
        // 본 검사 진행 함수
        function proceedToMainTest() {
            console.log('proceedToMainTest 함수 호출됨');
            setTimeout(() => {
                console.log('본시행 안내 시작');
                speak("지금부터는, 다른 종류, 즉 '동물' 종류에 속하는 것들의 이름을, 모두 말씀해보십시오.", () => {
                    setTimeout(() => {
                        speak("1분의 시간을 드리겠습니다. 1분 동안, 생각나는 동물의 이름을, 마이크가 꺼질 때까지 포기하지 마시고, 최대한 많이 말씀해 보세요.", () => {
                            setTimeout(() => {
                                speak("준비되셨습니까? 삐 소리가 나고 마이크에 불이 들어오면, 바로 시작해 주세요.", () => {
                                    console.log('모든 안내 완료');
                                    
                                    // 자동으로 카운트다운 시작
                                    setTimeout(async () => {
                                        await startTest(); // 시작 함수 직접 호출
                                    }, 1000);
                                });
                            }, 800);
                        });
                    }, 800);
                });
            }, 800);
        }

        // 하드웨어 설정 불러오기
        function loadHardwareSettings() {
            const settingsStr = localStorage.getItem('hardwareSettings');
            if (settingsStr) {
                try {
                    hardwareSettings = JSON.parse(settingsStr);
                    console.log('하드웨어 설정 로드:', hardwareSettings);
                    
                    // ElevenLabs 설정 적용 (설정이 있으면 덮어쓰기)
                    if (hardwareSettings.elevenLabsApiKey) {
                        elevenLabsApiKey = hardwareSettings.elevenLabsApiKey;
                    }
                    if (hardwareSettings.elevenLabsVoiceId) {
                        elevenLabsVoiceId = hardwareSettings.elevenLabsVoiceId;
                    }
                    if (hardwareSettings.elevenLabsConnected !== undefined) {
                        elevenLabsConnected = hardwareSettings.elevenLabsConnected;
                    }
                    
                    console.log('ElevenLabs 설정:', {
                        apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                        voiceId: elevenLabsVoiceId,
                        connected: elevenLabsConnected
                    });
                    
                    // 음성 설정이 활성화되어 있는지 확인
                    if (!hardwareSettings.voiceEnabled) {
                        console.log('음성 기능이 비활성화되어 있습니다.');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('하드웨어 설정 파싱 오류:', error);
                    return false;
                }
            }
            console.log('하드웨어 설정이 없습니다.');
            return false;
        }

        // 페이지 전환
        function showPage(pageName) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages[pageName].classList.add('active');
        }

        // 음성 안내 표시
        function showVoiceGuide(text) {
            voiceGuideText.textContent = text;
            voiceGuideBox.classList.add('active');
        }

        function hideVoiceGuide() {
            voiceGuideBox.classList.remove('active');
        }

        // ElevenLabs TTS
        async function elevenLabsTTS(text, callback) {
            console.log('elevenLabsTTS 호출:', {
                apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                voiceId: elevenLabsVoiceId,
                text: text
            });
            
            if (!elevenLabsApiKey || !elevenLabsVoiceId) {
                console.error('ElevenLabs 설정이 누락되었습니다');
                // ElevenLabs 실패 시 기본 TTS로 폴백
                defaultTTS(text, callback);
                return;
            }

            audioQueue.push({ text, callback });
            if (!isPlaying) {
                playNextInQueue();
            }
        }

        async function playNextInQueue() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const { text, callback } = audioQueue.shift();

            try {
                console.log('ElevenLabs API 호출 시작:', {
                    url: `https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}/stream`,
                    text: text
                });
                
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}/stream`, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': elevenLabsApiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: hardwareSettings?.voiceSettings || {
                            stability: 0.85,  // 더 안정적인 발음을 위해 증가
                            similarity_boost: 0.75,
                            style: 0.3,  // 더 명확한 발음을 위해 감소
                            use_speaker_boost: true
                        }
                    })
                });

                console.log('ElevenLabs API 응답:', {
                    status: response.status,
                    ok: response.ok
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        hideVoiceGuide();
                        
                        // 음성 안내가 끝난 후에도 음성인식을 자동으로 재시작하지 않음
                        // 삐 소리 후에만 시작하도록 함
                        
                        if (callback) callback();
                        playNextInQueue();
                    };

                    audio.onerror = () => {
                        console.error('오디오 재생 오류');
                        hideVoiceGuide();
                        if (callback) callback();
                        playNextInQueue();
                    };

                    audio.play();
                } else {
                    // API 응답 실패 시 에러 내용 확인
                    const errorText = await response.text();
                    console.error('ElevenLabs API 에러:', {
                        status: response.status,
                        error: errorText
                    });
                    // 기본 TTS로 폴백
                    hideVoiceGuide();
                    defaultTTS(text, callback);
                    playNextInQueue();
                }
            } catch (error) {
                console.error('ElevenLabs TTS 오류:', error);
                hideVoiceGuide();
                // 기본 TTS로 폴백
                defaultTTS(text, callback);
                playNextInQueue();
            }
        }

        // 기본 브라우저 TTS
        function defaultTTS(text, callback) {
            console.log('defaultTTS 호출:', text);
            
            if (!window.speechSynthesis) {
                console.error('브라우저가 음성 합성을 지원하지 않습니다.');
                if (callback) callback();
                return;
            }

            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = hardwareSettings?.voiceSpeed || 1;
            utterance.pitch = 1;
            utterance.volume = 1;

            const voices = window.speechSynthesis.getVoices();
            console.log('사용 가능한 음성:', voices.length);
            
            const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
                utterance.voice = koreanVoice;
                console.log('한국어 음성 선택:', koreanVoice.name);
            } else {
                console.log('한국어 음성을 찾을 수 없습니다.');
            }

            utterance.onstart = () => {
                console.log('음성 출력 시작');
            };
            
            utterance.onend = () => {
                console.log('음성 출력 완료');
                hideVoiceGuide();
                
                // 음성 안내가 끝난 후에도 음성인식을 자동으로 재시작하지 않음
                // 삐 소리 후에만 시작하도록 함
                
                if (callback) callback();
            };
            
            utterance.onerror = (event) => {
                console.error('음성 출력 오류:', event);
                hideVoiceGuide();
                if (callback) callback();
            };

            window.speechSynthesis.speak(utterance);
            console.log('음성 합성 요청됨');
        }

        // 음성 합성 (통합 함수)
        function speak(text, callback) {
            console.log('speak 함수 호출:', {
                text: text,
                hardwareSettings: hardwareSettings,
                voiceEnabled: hardwareSettings?.voiceEnabled !== false, // undefined일 때도 true
                elevenLabsConnected: elevenLabsConnected,
                elevenLabsApiKey: elevenLabsApiKey ? 'Set' : 'Not set'
            });
            
            // 음성 기능이 명시적으로 비활성화된 경우에만 스킵
            if (hardwareSettings && hardwareSettings.voiceEnabled === false) {
                console.log('음성 기능이 명시적으로 비활성화되어 있습니다.');
                if (callback) callback();
                return;
            }
            
            // 음성 안내 중에는 음성인식 일시 중지
            if (recognition && isRecognizing) {
                console.log('음성 안내 중 음성인식 일시 중지');
                recognition.stop();
                isRecognizing = false;
            }

            showVoiceGuide(text);

            if (elevenLabsConnected && elevenLabsApiKey && elevenLabsVoiceId) {
                console.log('ElevenLabs TTS 사용');
                elevenLabsTTS(text, callback);
            } else {
                console.log('기본 브라우저 TTS 사용');
                defaultTTS(text, callback);
            }
        }

        // 검사 안내 음성 가이드
        function instructionsVoiceGuide() {
            const guides = [
                "검사 안내를 시작하겠습니다.",
                "이 검사는 1분 동안 진행됩니다.",
                "시작 신호가 나면 생각나는 동물 이름을 최대한 많이 말씀해 주세요.",
                "포유류, 조류, 어류, 파충류, 양서류, 곤충 등 모든 종류의 동물이 가능합니다.",
                "멸종된 동물도 포함할 수 있습니다.",
                "단, 애완동물의 이름이나 가상의 동물은 제외됩니다.",
                "같은 동물을 반복하지 않도록 주의해 주세요.",
                "음성인식이 어려운 경우 키보드로 입력하실 수도 있습니다.",
                "준비가 되셨으면 다음 단계로 진행해 주세요."
            ];

            let index = 0;
            function speakNext() {
                if (index < guides.length) {
                    speak(guides[index], () => {
                        index++;
                        if (index < guides.length) {
                            setTimeout(speakNext, 800);
                        }
                    });
                }
            }
            speakNext();
        }

        // 음성인식 초기화
        function initializeSpeechRecognition() {
            // 브라우저별 호환성 체크
            const SpeechRecognition = window.SpeechRecognition || 
                                    window.webkitSpeechRecognition || 
                                    window.mozSpeechRecognition || 
                                    window.msSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('이 브라우저는 음성인식을 지원하지 않습니다.');
                alert('죄송합니다. 이 브라우저는 음성인식을 지원하지 않습니다.\n\nChrome 브라우저 사용을 권장합니다.');
                return false;
            }
            
            try {
                // 이미 recognition 객체가 있으면 재사용
                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'ko-KR';
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.maxAlternatives = 1;
                    
                    recognition.onstart = () => {
                        console.log('음성인식 시작됨');
                    };

                    // 각 음성 세그먼트의 시작 시간을 저장하는 맵
                    const speechStartTimes = new Map();
                    
                    recognition.onresult = (event) => {
                        // 연습 모드이거나 본 검사가 진행 중일 때만 처리
                        if (!isPracticePhase && !isRecognizing) {
                            console.log('음성인식 결과 무시 - 연습/본시행 중이 아님');
                            return;
                        }
                        if (!isPracticePhase && timeRemaining <= 0) {
                            console.log('음성인식 결과 무시 - 시간 종료');
                            return;
                        }
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const result = event.results[i];
                            
                            // 이 결과에 대한 시작 시간이 아직 기록되지 않았다면 기록
                            if (!speechStartTimes.has(i)) {
                                const speechStartTime = Date.now() - startTime;
                                speechStartTimes.set(i, speechStartTime);
                                console.log(`음성 세그먼트 ${i} 시작 시간: ${speechStartTime}ms (${Math.floor(speechStartTime/1000)}초)`);
                            }
                            
                            if (result.isFinal) {
                                const transcript = result[0].transcript.trim();
                                const speechStartTime = speechStartTimes.get(i);
                                console.log('인식된 텍스트:', transcript, '연습모드:', isPracticePhase);
                                console.log('음성 입력 시작 시간:', speechStartTime, 'ms');
                                
                                const words = transcript.split(/[\s,，、]+/).filter(word => word.length > 0);
                                words.forEach((word, index) => {
                                    if (word.length > 0) {
                                        // 여러 단어가 한 번에 인식된 경우, 각 단어에 약간의 시간 간격 추가
                                        const adjustedTime = speechStartTime + (index * 500);
                                        console.log('단어 추가:', word, '연습모드:', isPracticePhase, '조정된 시간:', adjustedTime);
                                        if (isPracticePhase) {
                                            addPracticeItem(word);
                                        } else {
                                            // 음성 입력 시작 시간을 함께 전달
                                            addAnimal(word, adjustedTime);
                                        }
                                    }
                                });
                                
                                // 처리 완료된 결과의 시작 시간 삭제
                                speechStartTimes.delete(i);
                            }
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error('음성인식 오류:', event.error);
                        if (event.error === 'no-speech' && isRecognizing) {
                            // no-speech 오류는 무시
                        }
                    };

                    recognition.onend = () => {
                        console.log('음성인식 종료됨');
                        // 연습 모드이거나 본 검사가 진행 중일 때 재시작
                        if ((isPracticePhase || isRecognizing) && timeRemaining > 0) {
                            setTimeout(() => {
                                try {
                                    recognition.start();
                                    console.log('음성인식 재시작됨');
                                } catch (e) {
                                    console.error('음성인식 재시작 오류:', e);
                                }
                            }, 100);
                        }
                    };
                }
                
                return true;
            } catch (error) {
                console.error('음성인식 초기화 오류:', error);
                alert('음성인식 초기화 중 오류가 발생했습니다.\n\n' + error.message);
                return false;
            }
        }

        // 신호음 재생 함수
        function playBeep(frequency = 880, duration = 200) {
            return new Promise((resolve) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
                
                setTimeout(resolve, duration);
            });
        }


        // 오디오 분석 시작
        async function startAudioVisualization() {
            try {
                // 이미 스트림이 있고 활성 상태인지 확인
                if (!mediaStream || mediaStream.getTracks().every(track => track.readyState !== 'live')) {
                    console.log('새로운 마이크 스트림 요청');
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphonePermissionGranted = true;
                    console.log('마이크 권한 획득 완료');
                } else {
                    console.log('기존 마이크 스트림 재사용');
                }
                
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (!analyser) {
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                }
                
                if (!microphone) {
                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    microphone.connect(analyser);
                }
            } catch (error) {
                console.error('오디오 시각화 초기화 오류:', error);
            }
        }


        // 오디오 시각화 중지
        function stopAudioVisualization() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // 마이크와 오디오 컨텍스트는 유지하고 시각화만 중지
            // 이렇게 하면 마이크 권한을 계속 유지할 수 있음
        }

        // 검사 시작 시각적 효과와 신호음
        async function startTestCountdown(callback) {
            console.log('startTestCountdown 시작');
            
            // 마이크 권한 및 음성인식 준비 (이미 준비되지 않은 경우)
            if (!audioContext || !recognition) {
                console.log('마이크/음성인식 준비 필요');
                await prepareMicrophoneAndRecognition();
            }
            
            // 테스트 화면 표시
            const testContent = document.querySelector('.test-content');
            console.log('테스트 콘텐츠 요소:', testContent);
            if (testContent) {
                testContent.style.display = 'none';
            }
            
            console.log('testScreen 요소:', testScreen);
            if (testScreen) {
                testScreen.classList.add('active');
            } else {
                console.error('testScreen 요소를 찾을 수 없음');
            }
            
            if (responseList) {
                responseList.innerHTML = '';
            }
            isPracticePhase = false;
            
            // 1초의 긴 신호음
            console.log('신호음 재생 시작');
            await playBeep(1000, 1000);
            console.log('신호음 재생 완료');
            
            // 마이크 활성화 표시
            if (testMicIcon) {
                testMicIcon.classList.add('active');
                console.log('마이크 아이콘 활성화');
            } else {
                console.error('testMicIcon 요소를 찾을 수 없음');
            }
            
            // 오디오 시각화 시작
            console.log('오디오 시각화 시작');
            await startAudioVisualization();
            
            // 콜백 실행
            if (callback) {
                console.log('콜백 함수 실행');
                callback();
            }
        }

        // 연습 항목 추가
        function addPracticeItem(item) {
            if (!item || item.trim() === '') return;
            
            const trimmedItem = item.trim();
            practiceItems.push(trimmedItem);
            
            // 응답 표시에 추가
            const itemElement = document.createElement('div');
            itemElement.className = 'response-item';
            itemElement.textContent = trimmedItem;
            responseList.appendChild(itemElement);
        }

        // 동물 추가
        function addAnimal(animal, speechTimestamp) {
            if (!animal || animal.trim() === '') return;
            
            const trimmedAnimal = animal.trim();
            // speechTimestamp가 전달되면 사용하고, 없으면 현재 시간 사용
            const timestamp = speechTimestamp !== undefined ? speechTimestamp : (Date.now() - startTime);
            
            console.log(`동물 추가: ${trimmedAnimal}, 시간: ${timestamp}ms (${Math.floor(timestamp/1000)}초)`);
            
            animals.push({
                name: trimmedAnimal,
                timestamp: timestamp,
                isDuplicate: uniqueAnimals.has(trimmedAnimal.toLowerCase())
            });
            
            uniqueAnimals.add(trimmedAnimal.toLowerCase());
            updateAnimalList();
            
            // 테스트 화면에도 추가
            const itemElement = document.createElement('div');
            itemElement.className = 'response-item';
            itemElement.textContent = trimmedAnimal;
            responseList.appendChild(itemElement);
        }

        // 동물 목록 업데이트
        function updateAnimalList() {
            animalList.innerHTML = '';
            animals.forEach(animal => {
                const item = document.createElement('div');
                item.className = 'animal-item' + (animal.isDuplicate ? ' duplicate' : '');
                item.textContent = animal.name;
                animalList.appendChild(item);
            });
        }

        // 타이머 시작
        function startTimer() {
            console.log('startTimer 호출됨');
            if (!timer) {
                console.error('timer 요소가 null입니다');
                return;
            }
            
            // 타이머 표시
            timer.style.display = 'block';
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                timer.textContent = timeRemaining;
                
                if (timeRemaining <= 0) {
                    stopTest();
                }
            }, 1000);
            
            console.log('타이머 시작됨');
        }

        // 음성인식 시작 (권한은 이미 hardware-setup에서 획득)
        function startSpeechRecognition() {
            if (!recognition) {
                console.log('음성인식 초기화 시도');
                initializeSpeechRecognition();
            }
            
            if (!recognition) {
                console.error('음성인식을 초기화할 수 없습니다.');
                return;
            }
            
            // 음성인식이 실행 중이 아니면 시작
            try {
                if (!isRecognizing) {
                    recognition.start();
                    console.log('음성인식 시작');
                }
                isRecognizing = true;
                recordingIndicator.classList.add('active');
                
                // 마이크 아이콘 활성화
                if (testMicIcon) {
                    testMicIcon.classList.add('active');
                }
            } catch (e) {
                console.error('음성인식 시작 오류:', e);
                // 이미 실행 중인 경우에도 플래그 설정
                isRecognizing = true;
                recordingIndicator.classList.add('active');
                if (testMicIcon) {
                    testMicIcon.classList.add('active');
                }
            }
        }

        // 검사 시작
        async function startTest() {
            console.log('startTest 함수 호출됨');
            if (readyBox) readyBox.style.display = 'none';
            animals = [];
            uniqueAnimals.clear();
            startTime = Date.now();
            timeRemaining = 60;
            if (timer) {
                timer.textContent = timeRemaining;
                timer.style.display = 'block'; // 검사 시작 시 타이머 표시
            } else {
                console.error('timer 요소가 null입니다');
            }
            
            if (startBtn) {
                startBtn.style.display = 'none';
                console.log('시작 버튼 숨김');
            } else {
                console.error('startBtn이 null입니다');
            }
            
            if (stopBtn) {
                stopBtn.style.display = 'inline-block';
                console.log('중지 버튼 표시');
            } else {
                console.error('stopBtn이 null입니다');
            }
            
            if (resetBtn) {
                resetBtn.style.display = 'none';
                console.log('리셋 버튼 숨김');
            } else {
                console.error('resetBtn이 null입니다');
            }
            if (stats) stats.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'block'; // 결과 섹션 표시
            
            updateAnimalList();
            
            console.log('startTestCountdown 호출 전');
            // 신호음과 시각적 효과로 카운트다운
            await startTestCountdown(() => {
                console.log('startTestCountdown 콜백 실행');
                startTimer();
                // 삐 소리 후 음성인식 시작을 위해 약간의 대기 시간 추가
                setTimeout(() => {
                    if (recognition) {
                        console.log('음성인식 시작 시도');
                        startSpeechRecognition();
                    } else {
                        console.log('recognition 객체가 없음');
                    }
                }, 500);  // 0.5초 대기
            });
            console.log('startTestCountdown 완료');
        }

        // 검사 중지
        function stopTest() {
            endTime = Date.now();
            clearInterval(timerInterval);
            
            if (isRecognizing) {
                isRecognizing = false;
                recordingIndicator.classList.remove('active');
                // 음성인식은 계속 실행 중으로 유지
                console.log('검사 종료 - 음성인식은 계속 유지');
            }
            
            // 테스트 화면 숨기기
            testScreen.classList.remove('active');
            document.querySelector('.test-content').style.display = 'block';
            
            // 마이크 비활성화
            testMicIcon.classList.remove('active');
            
            // 오디오 시각화 중지
            stopAudioVisualization();
            
            if (startBtn) startBtn.style.display = 'none';
            if (stopBtn) stopBtn.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'inline-block';
            
            showResults();
            
            speak("검사가 종료되었습니다. 수고하셨습니다. 결과를 분석하고 있습니다.", () => {
                // 자동으로 CFTSCORING 분석 시작
                setTimeout(() => {
                    analyzeWithCFTSCORING();
                }, 1000);
            });
        }

        // 검사 리셋
        function resetTest() {
            readyBox.style.display = 'block';
            animals = [];
            uniqueAnimals.clear();
            timeRemaining = 60;
            timer.textContent = timeRemaining;
            timer.style.display = 'none'; // 리셋 시 타이머 숨기기
            resultsSection.style.display = 'none'; // 결과 섹션 숨기기
            
            if (startBtn) startBtn.style.display = 'inline-block';
            if (stopBtn) stopBtn.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'none';
            stats.style.display = 'none';
            
            updateAnimalList();
        }

        // 결과 표시
        function showResults() {
            const totalCount = animals.length;
            const uniqueCount = uniqueAnimals.size;
            const duplicateCount = totalCount - uniqueCount;
            const elapsedTime = Math.round((endTime - startTime) / 1000);
            
            // 15초 간격 통계 계산
            const intervals = [
                { start: 0, end: 15, count: 0 },
                { start: 15, end: 30, count: 0 },
                { start: 30, end: 45, count: 0 },
                { start: 45, end: 60, count: 0 }
            ];
            
            animals.forEach(animal => {
                const seconds = animal.timestamp / 1000;
                for (let interval of intervals) {
                    if (seconds >= interval.start && seconds < interval.end) {
                        interval.count++;
                        break;
                    }
                }
            });
            
            // 간격별 통계 표시
            const intervalStats = document.getElementById('intervalStats');
            intervalStats.innerHTML = '';
            intervals.forEach((interval, index) => {
                const div = document.createElement('div');
                div.className = 'interval-stat';
                div.innerHTML = `
                    <h5>${interval.start}-${interval.end}초</h5>
                    <div class="count">${interval.count}</div>
                `;
                intervalStats.appendChild(div);
            });
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('uniqueCount').textContent = uniqueCount;
            document.getElementById('duplicateCount').textContent = duplicateCount;
            document.getElementById('elapsedTime').textContent = elapsedTime + '초';
            
            stats.style.display = 'block';
        }

        // 결과 다운로드 (CSV 형식)
        function downloadResults() {
            const testDate = new Date();
            const intervalStats = calculateIntervalStats();
            
            // CSV BOM 추가 (한글 엑셀 호환)
            let csvContent = '\ufeff';
            
            // CSV 헤더
            csvContent += 'ID,성별,연령,학력,0-15초,15-30초,30-45초,45-60초\n';
            
            // 데이터 행 추가
            const id = testDate.toISOString().slice(0,10).replace(/-/g,'') + '_' + testDate.getHours().toString().padStart(2,'0') + testDate.getMinutes().toString().padStart(2,'0');
            const gender = '미입력';
            const age = '미입력';
            const education = '미입력';
            
            // 각 구간별 동물 목록
            const intervals = [
                intervalStats['0-15초'] || [],
                intervalStats['15-30초'] || [],
                intervalStats['30-45초'] || [],
                intervalStats['45-60초'] || []
            ];
            
            // CSV 행 생성
            csvContent += `${id},${gender},${age},${education},`;
            csvContent += intervals.map(interval => `"${interval.join(',')}"`).join(',');
            csvContent += '\n';
            
            // Blob 생성 및 다운로드
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `동물유창성검사_${testDate.toISOString().slice(0,10).replace(/-/g,'')}_${testDate.getHours().toString().padStart(2,'0')}${testDate.getMinutes().toString().padStart(2,'0')}${testDate.getSeconds().toString().padStart(2,'0')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        
        function calculateIntervalStats() {
            const intervals = {
                '0-15초': [],
                '15-30초': [],
                '30-45초': [],
                '45-60초': []
            };
            
            animals.forEach(animal => {
                const seconds = animal.timestamp / 1000;
                if (seconds < 15) {
                    intervals['0-15초'].push(animal.name);
                } else if (seconds < 30) {
                    intervals['15-30초'].push(animal.name);
                } else if (seconds < 45) {
                    intervals['30-45초'].push(animal.name);
                } else {
                    intervals['45-60초'].push(animal.name);
                }
            });
            
            return intervals;
        }
        
        // CFTSCORING과 연동하여 결과 분석
        function analyzeWithCFTSCORING() {
            console.log('CFTSCORING 분석 시작...');
            
            // CSV 데이터 생성
            const testDate = new Date();
            const intervalStats = calculateIntervalStats();
            
            // CFTSCORING이 요구하는 CSV 형식의 데이터 준비
            const csvHeader = 'ID,Gender,Age,Education,0-15s,15-30s,30-45s,45-60s';
            const csvData = [
                testDate.toISOString().slice(0,10).replace(/-/g,'') + '_' + 
                    testDate.getHours().toString().padStart(2,'0') + 
                    testDate.getMinutes().toString().padStart(2,'0'),
                '미입력',
                '미입력', 
                '미입력',
                intervalStats['0-15초'].join(' '),  // 공백으로 구분된 동물 목록
                intervalStats['15-30초'].join(' '),
                intervalStats['30-45초'].join(' '),
                intervalStats['45-60초'].join(' ')
            ].join(',');
            
            const fullCsvData = csvHeader + '\n' + csvData;
            
            // iframe으로 CFTSCORING을 백그라운드에서 열기
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';  // 사용자에게 보이지 않음
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.position = 'absolute';
            iframe.style.left = '-9999px';
            iframe.src = 'https://psykim.github.io/CFTSCORING/CFTSCORING.html';
            
            // 메시지 이벤트 리스너 설정 (CFTSCORING에서 결과 받기)
            const messageHandler = function(event) {
                // CFTSCORING 도메인에서 온 메시지인지 확인
                if (event.origin !== 'https://psykim.github.io') {
                    return;
                }
                
                // CFTSCORING 결과인지 확인
                if (event.data && event.data.type === 'CFTSCORING_RESULT') {
                    console.log('CFTSCORING 결과 수신');
                    
                    // 결과 HTML 표시
                    displayCFTSCORINGResult(event.data.html);
                    
                    // iframe 제거
                    document.body.removeChild(iframe);
                    
                    // 리스너 제거
                    window.removeEventListener('message', messageHandler);
                }
            };
            
            window.addEventListener('message', messageHandler);
            
            // iframe이 로드되면 CSV 데이터 전송
            iframe.onload = function() {
                setTimeout(() => {
                    // CSV 데이터를 CFTSCORING으로 전송
                    iframe.contentWindow.postMessage({
                        type: 'CSV_DATA',
                        data: fullCsvData,
                        source: 'CFTADMIN'
                    }, 'https://psykim.github.io');
                    
                    console.log('CSV 데이터 전송 완료');
                }, 1000); // 페이지 완전 로드를 위한 대기
            };
            
            // iframe을 body에 추가
            document.body.appendChild(iframe);
            
            // 타임아웃 설정 (30초 후에도 응답이 없으면 에러 처리)
            setTimeout(() => {
                window.removeEventListener('message', messageHandler);
                // 응답이 없으면 에러 메시지
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection && !resultsSection.innerHTML.includes('CFTSCORING')) {
                    console.error('CFTSCORING 응답 시간 초과');
                    resultsSection.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 24px; color: #dc3545; margin-bottom: 20px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                분석 중 오류가 발생했습니다
                            </div>
                            <p style="color: #666;">잠시 후 다시 시도해주세요.</p>
                            <button onclick="window.location.href = window.location.pathname" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-top: 20px;">다시 검사하기</button>
                        </div>
                    `;
                    // iframe 제거
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                }
            }, 30000);
        }
        
        // CFTSCORING에서 받은 HTML 결과 표시
        function displayCFTSCORINGResult(htmlContent) {
            console.log('CFTSCORING 결과 HTML 표시');
            
            // 결과 섹션 초기화 및 HTML 표시
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.innerHTML = '';
            
            // CFTSCORING 결과 컨테이너 생성
            const containerDiv = document.createElement('div');
            containerDiv.style.cssText = 'margin: 20px auto; max-width: 1200px; padding: 20px;';
            containerDiv.innerHTML = htmlContent;
            
            // 다시 검사하기 버튼 추가
            const buttonDiv = document.createElement('div');
            buttonDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px;';
            buttonDiv.innerHTML = '<button onclick="window.location.href = window.location.pathname" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">다시 검사하기</button>';
            
            resultsSection.appendChild(containerDiv);
            resultsSection.appendChild(buttonDiv);
            resultsSection.style.display = 'block';
            
            // 스크롤
            containerDiv.scrollIntoView({ behavior: 'smooth' });
            
            // 음성 안내
            speak("분석이 완료되었습니다. 결과를 확인해 주세요.");
        }
        
        // 내부 분석 함수들은 모두 제거
        /*
            const counts = {
                '0-15초': intervalStats['0-15초'].length,
                '15-30초': intervalStats['15-30초'].length,
                '30-45초': intervalStats['30-45초'].length,
                '45-60초': intervalStats['45-60초'].length
            };
            
            // 전체 동물 리스트
            const allAnimals = [];
            Object.values(intervalStats).forEach(interval => {
                allAnimals.push(...interval);
            });
            
            // 전반부/후반부 계산
            const firstHalfAnimals = [...intervalStats['0-15초'], ...intervalStats['15-30초']];
            const secondHalfAnimals = [...intervalStats['30-45초'], ...intervalStats['45-60초']];
            const firstHalfScore = new Set(firstHalfAnimals).size;
            const secondHalfScore = new Set(secondHalfAnimals).size;
            
            // 보속 계산 (중복된 동물)
            const animalCounts = {};
            allAnimals.forEach(animal => {
                animalCounts[animal] = (animalCounts[animal] || 0) + 1;
            });
            const perseverationScore = Object.values(animalCounts).filter(count => count > 1).reduce((sum, count) => sum + (count - 1), 0);
            
            // 침투 계산 (동물이 아닌 것 - 여기서는 0으로 표시)
            const intrusionScore = 0;
            
            // 범주 분석 (간단한 버전)
            const categoryAnalysis = analyzeClusters(allAnimals);
            
            // 가중치 점수 계산 (CFTSCORING 로직 참조)
            const weightedScore = 
                counts['0-15초'] * 1.0 + 
                counts['15-30초'] * 0.75 + 
                counts['30-45초'] * 0.5 + 
                counts['45-60초'] * 0.25;
            
            // 총점
            const totalScore = uniqueAnimals.size;
            
            // 결과 해석
            let interpretation = '';
            if (totalScore >= 15) {
                interpretation = '정상 범위의 수행을 보이고 있습니다. 동물 이름 생성 능력이 연령대에 적합한 수준입니다. 범주 간 전환 능력과 지속적인 인출 능력이 양호합니다.';
            } else if (totalScore >= 10) {
                interpretation = '경계선 수준의 수행을 보이고 있습니다. 추가적인 인지기능 평가를 고려해볼 수 있습니다. 특히 전반부와 후반부의 수행 차이를 확인하는 것이 중요합니다.';
            } else {
                interpretation = '저조한 수행을 보이고 있습니다. 전문가의 상담을 받아보시기를 권합니다. 언어 유창성과 인지 기능에 대한 종합적인 평가가 필요할 수 있습니다.';
            }
            
            // 전문 분석 결과 HTML 생성 (CFTSCORING 스타일 적용)
            const resultHTML = `
                <style>
                    .results { background: white; padding: 30px; border-radius: 12px; margin-top: 20px; }
                    .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
                    .score-card { background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; transition: transform 0.2s; }
                    .score-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                    .score-card h4 { font-size: 14px; color: #666; margin-bottom: 10px; font-weight: normal; }
                    .score { font-size: 32px; font-weight: bold; color: #2196F3; }
                    @media (max-width: 768px) { .score-grid { grid-template-columns: repeat(2, 1fr); } }
                </style>
                
                <div id="results" class="results">
                    <h2 style="color: #333; margin-bottom: 30px; text-align: center; font-size: 26px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">검사 결과</h2>
                    
                    <!-- 첫번째 줄: 총점, 전반점수, 후반점수, 보속, 침투 -->
                    <div class="score-grid">
                        <div class="score-card">
                            <h4>총점<br>(Total Score)</h4>
                            <div class="score">${totalScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>전반점수<br>(First Half Score)</h4>
                            <div class="score">${firstHalfScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>후반점수<br>(Second Half Score)</h4>
                            <div class="score">${secondHalfScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>보속<br>(Perseveration)</h4>
                            <div class="score" style="color: ${perseverationScore > 2 ? '#FF5722' : '#2196F3'};">${perseverationScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>침투<br>(Intrusion)</h4>
                            <div class="score">${intrusionScore}</div>
                        </div>
                    </div>
                    
                    <!-- 두번째 줄: 범주수, 평균범주크기, 최대범주크기, 전환, 비효율전환 -->
                    <div class="score-grid">
                        <div class="score-card">
                            <h4>범주수<br>(Number of Cluster)</h4>
                            <div class="score">${categoryAnalysis.numberOfClusters}</div>
                        </div>
                        <div class="score-card">
                            <h4>평균범주크기<br>(Mean Size of Cluster)</h4>
                            <div class="score">${categoryAnalysis.meanClusterSize}</div>
                        </div>
                        <div class="score-card">
                            <h4>최대범주크기<br>(Max Size of Cluster)</h4>
                            <div class="score">${categoryAnalysis.maxClusterSize}</div>
                        </div>
                        <div class="score-card">
                            <h4>전환<br>(Switching)</h4>
                            <div class="score">${categoryAnalysis.switching}</div>
                        </div>
                        <div class="score-card">
                            <h4>비효율전환<br>(Hard Switching)</h4>
                            <div class="score">${categoryAnalysis.hardSwitching}</div>
                        </div>
                    </div>
                    
                    <!-- 추가 분석 정보 -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="color: #495057; margin-bottom: 15px; font-size: 18px;">시간대별 상세 분석</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">0-15초</div>
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${counts['0-15초']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['0-15초'].join(', ') || '없음'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">15-30초</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${counts['15-30초']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['15-30초'].join(', ') || '없음'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">30-45초</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${counts['30-45초']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['30-45초'].join(', ') || '없음'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">45-60초</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${counts['45-60초']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['45-60초'].join(', ') || '없음'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: ${totalScore >= 15 ? '#d4edda' : totalScore >= 10 ? '#fff3cd' : '#f8d7da'}; 
                                border: 1px solid ${totalScore >= 15 ? '#c3e6cb' : totalScore >= 10 ? '#ffeeba' : '#f5c6cb'};
                                color: ${totalScore >= 15 ? '#155724' : totalScore >= 10 ? '#856404' : '#721c24'};
                                border-radius: 8px;">
                        <h3 style="margin-bottom: 10px; font-size: 18px;">종합 해석</h3>
                        <p style="margin: 0; line-height: 1.8;">${interpretation}</p>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #6c757d; font-size: 14px;">
                        <p>검사일시: ${new Date().toLocaleString('ko-KR')}</p>
                        <p>가중치 점수: ${weightedScore.toFixed(1)}점</p>
                        <p style="margin-top: 10px;">* 본 결과는 참고용이며, 정확한 진단을 위해서는 전문가의 상담이 필요합니다.</p>
                    </div>
                </div>
            `;
            
            // 결과 표시 - 이 부분은 CFTSCORING 통합으로 제거됨
            // displayCFTSCORINGFullResults(resultHTML);
            
            // 음성 안내
            // speak("분석이 완료되었습니다. 결과를 확인해 주세요.");
        }
        
        // CFTSCORING 결과 표시 (기존 함수 제거)
        /*
            // CFTSCORING과 동일한 범주 체계 사용
            const CATEGORIES = {
                // 생물학적 분류
                MAMMAL: '포유류',
                BIRD: '조류',
                REPTILE: '파충류',
                AMPHIBIAN: '양서류',
                FISH: '어류',
                INSECT: '곤충',
                MOLLUSK: '연체동물',
                CRUSTACEAN: '갑각류',
                
                // 서식지별 분류
                AQUATIC: '수생동물',
                MARINE: '해양동물',
                FRESHWATER: '담수동물',
                AERIAL: '비행동물',
                
                // 인간과의 관계
                DOMESTIC: '가축',
                PET: '애완동물',
                WILD: '야생동물',
                
                // 문화적 분류
                ZODIAC: '12간지',
                MYTHOLOGY: '신화동물',
                IMAGINARY: '상상의 동물',
                PREHISTORIC: '선사시대 동물'
            };
            
            // 간단한 동물 데이터베이스 (주요 동물만 포함)
            const ANIMAL_DATA = {
                '개': { MAMMAL: true, DOMESTIC: true, PET: true, ZODIAC: true },
                '고양이': { MAMMAL: true, DOMESTIC: true, PET: true },
                '소': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                '말': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                '돼지': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                '양': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                '염소': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                '토끼': { MAMMAL: true, DOMESTIC: true, PET: true, ZODIAC: true },
                '호랑이': { MAMMAL: true, WILD: true, ZODIAC: true },
                '사자': { MAMMAL: true, WILD: true },
                '코끼리': { MAMMAL: true, WILD: true },
                '기린': { MAMMAL: true, WILD: true },
                '곰': { MAMMAL: true, WILD: true },
                '늑대': { MAMMAL: true, WILD: true },
                '여우': { MAMMAL: true, WILD: true },
                '원숭이': { MAMMAL: true, WILD: true, ZODIAC: true },
                '쥐': { MAMMAL: true, WILD: true, ZODIAC: true },
                '닭': { BIRD: true, DOMESTIC: true, ZODIAC: true },
                '오리': { BIRD: true, DOMESTIC: true, AQUATIC: true },
                '거위': { BIRD: true, DOMESTIC: true },
                '참새': { BIRD: true, WILD: true, AERIAL: true },
                '비둘기': { BIRD: true, WILD: true, AERIAL: true },
                '독수리': { BIRD: true, WILD: true, AERIAL: true },
                '뱀': { REPTILE: true, WILD: true, ZODIAC: true },
                '거북이': { REPTILE: true, PET: true, AQUATIC: true },
                '악어': { REPTILE: true, WILD: true, AQUATIC: true },
                '개구리': { AMPHIBIAN: true, WILD: true, AQUATIC: true },
                '두꺼비': { AMPHIBIAN: true, WILD: true },
                '물고기': { FISH: true, AQUATIC: true },
                '상어': { FISH: true, MARINE: true, WILD: true },
                '고래': { MAMMAL: true, MARINE: true, WILD: true },
                '돌고래': { MAMMAL: true, MARINE: true, WILD: true },
                '문어': { MOLLUSK: true, MARINE: true },
                '오징어': { MOLLUSK: true, MARINE: true },
                '새우': { CRUSTACEAN: true, MARINE: true },
                '게': { CRUSTACEAN: true, MARINE: true },
                '나비': { INSECT: true, AERIAL: true },
                '벌': { INSECT: true, AERIAL: true },
                '개미': { INSECT: true, WILD: true },
                '용': { ZODIAC: true, MYTHOLOGY: true, IMAGINARY: true, AERIAL: true }
            };
            
            // 클러스터 생성
            const clusters = [];
            let currentCluster = null;
            let lastCategories = [];
            
            animals.forEach((animal, index) => {
                // 현재 동물의 데이터 가져오기
                const animalData = ANIMAL_DATA[animal] || {};
                const animalCategories = [];
                
                // 현재 동물이 속한 범주들 찾기
                for (let [categoryKey, hasCategory] of Object.entries(animalData)) {
                    if (hasCategory === true) {
                        animalCategories.push(categoryKey);
                    }
                }
                
                // 이전 클러스터와 공유 범주가 있는지 확인
                const hasSharedCategory = lastCategories.some(cat => animalCategories.includes(cat));
                
                if (hasSharedCategory && currentCluster) {
                    // 같은 클러스터에 추가
                    currentCluster.animals.push(animal);
                    currentCluster.size++;
                } else {
                    // 새로운 클러스터 시작
                    if (currentCluster) {
                        clusters.push(currentCluster);
                    }
                    currentCluster = {
                        animals: [animal],
                        size: 1,
                        categories: animalCategories
                    };
                }
                
                lastCategories = animalCategories;
            });
            
            // 마지막 클러스터 추가
            if (currentCluster) {
                clusters.push(currentCluster);
            }
            
            // 전환 횟수
            const switching = Math.max(0, clusters.length - 1);
            
            // 비효율전환 계산 (크기 1인 클러스터 다음의 전환)
            let hardSwitching = 0;
            for (let i = 0; i < clusters.length - 1; i++) {
                if (clusters[i].size === 1) {
                    // 다음 클러스터와 공유 범주가 없는지 확인
                    const currentCategories = clusters[i].categories;
                    const nextCategories = clusters[i + 1].categories;
                    const hasShared = currentCategories.some(cat => nextCategories.includes(cat));
                    if (!hasShared) {
                        hardSwitching++;
                    }
                }
            }
            
            // 클러스터 통계
            const numberOfClusters = clusters.length;
            const clusterSizes = clusters.map(c => c.size);
            const meanClusterSize = numberOfClusters > 0 ? 
                (clusterSizes.reduce((sum, size) => sum + size, 0) / numberOfClusters).toFixed(1) : '0.0';
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            return {
                numberOfClusters,
                meanClusterSize,
                maxClusterSize,
                switching,
                hardSwitching
            };
        */
        
        // 이벤트 리스너 (설명 페이지 관련 이벤트는 사용하지 않지만 에러 방지를 위해 유지)
        if (instructionsNextBtn) {
            console.log('전체 결과 표시');
            
            // 결과를 담을 컨테이너 생성
            let containerHTML = '<div class="cft-analysis-container" style="margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 10px;">';
            containerHTML += '<h3 style="color: #333; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold;">🔍 동물범주형유창성검사 전문 분석 결과</h3>';
            
            // CFTSCORING의 원본 HTML과 스타일을 그대로 사용
            containerHTML += '<div class="cft-results-wrapper">';
            // containerHTML += resultHTML; // resultHTML이 정의되지 않음
            containerHTML += '</div>';
            containerHTML += '</div>';
            
            // 결과 섹션에 추가
            const resultsSection = document.getElementById('resultsSection');
            const analysisDiv = document.createElement('div');
            analysisDiv.innerHTML = containerHTML;
            resultsSection.appendChild(analysisDiv);
            
            // 스크롤
            analysisDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // CFTSCORING에서 받은 HTML 결과 표시
        function displayCFTSCORINGResult(htmlContent) {
            console.log('CFTSCORING 결과 HTML 표시');
            
            // 결과 섹션 초기화 및 HTML 표시
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.innerHTML = '';
            
            // CFTSCORING 결과 컨테이너 생성
            const containerDiv = document.createElement('div');
            containerDiv.style.cssText = 'margin: 20px auto; max-width: 1200px; padding: 20px;';
            containerDiv.innerHTML = htmlContent;
            
            // 다시 검사하기 버튼 추가
            const buttonDiv = document.createElement('div');
            buttonDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px;';
            buttonDiv.innerHTML = '<button onclick="window.location.href = window.location.pathname" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">다시 검사하기</button>';
            
            resultsSection.appendChild(containerDiv);
            resultsSection.appendChild(buttonDiv);
            resultsSection.style.display = 'block';
            
            // 스크롤
            containerDiv.scrollIntoView({ behavior: 'smooth' });
            
            // 음성 안내
            speak("분석이 완료되었습니다. 결과를 확인해 주세요.");
        }
        
        // CFTSCORING 결과 표시 (기존 함수 유지)
        function displayCFTSCORINGResults(result) {
            if (!result) {
                console.error('분석 결과가 없습니다.');
                return;
            }
            
            // 결과를 보기 좋게 표시
            let resultHTML = '<div class="cft-analysis-result" style="margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 10px;">';
            resultHTML += '<h3 style="color: #333; margin-bottom: 20px;">🔍 전문가 분석 결과</h3>';
            
            resultHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
            resultHTML += `<div class="result-item" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h5 style="color: #666; margin-bottom: 5px;">총점</h5>
                <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${result.totalScore || uniqueAnimals.size}</div>
            </div>`;
            
            if (result.interpretation) {
                resultHTML += '</div>';
                resultHTML += '<div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">';
                resultHTML += '<h4 style="color: #333; margin-bottom: 10px;">해석</h4>';
                resultHTML += `<p style="line-height: 1.8; color: #555;">${result.interpretation}</p>`;
                resultHTML += '</div>';
            }
            
            resultHTML += '</div>';
            
            // 결과 섹션에 추가
            const resultsSection = document.getElementById('resultsSection');
            const analysisDiv = document.createElement('div');
            analysisDiv.innerHTML = resultHTML;
            resultsSection.appendChild(analysisDiv);
            
            // 스크롤
            analysisDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // 이벤트 리스너 (설명 페이지 관련 이벤트는 사용하지 않지만 에러 방지를 위해 유지)
        if (instructionsNextBtn) {
            instructionsNextBtn.addEventListener('click', () => showPage('test'));
        }
        if (instructionsVoiceGuideBtn) {
            instructionsVoiceGuideBtn.addEventListener('click', () => {
                instructionsVoiceGuideActive = !instructionsVoiceGuideActive;
                if (instructionsVoiceGuideActive) {
                    instructionsVoiceGuideBtn.textContent = '🔊 음성 안내 중지';
                    instructionsVoiceGuide();
                } else {
                    instructionsVoiceGuideBtn.textContent = '🔊 음성 안내 듣기';
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                    hideVoiceGuide();
                }
            });
        }
        // testPrevBtn.addEventListener('click', () => showPage('instructions')); // 제거됨
        
        // 이벤트 리스너는 DOM 요소 초기화 후에 추가됨

        // 키보드 입력 관련 이벤트 리스너 제거됨

        // 음성 목록 로드
        function loadVoices() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        };
                    }
                } else {
                    resolve([]);
                }
            });
        }

        // 이벤트 리스너 (설명 페이지 관련 이벤트는 사용하지 않지만 에러 방지를 위해 유지)
        if (instructionsNextBtn) {
            instructionsNextBtn.addEventListener('click', () => showPage('test'));
        }
        if (instructionsVoiceGuideBtn) {
            instructionsVoiceGuideBtn.addEventListener('click', () => {
                instructionsVoiceGuideActive = !instructionsVoiceGuideActive;
                if (instructionsVoiceGuideActive) {
                    instructionsVoiceGuideBtn.textContent = '🔊 음성 안내 중지';
                    instructionsVoiceGuide();
                } else {
                    instructionsVoiceGuideBtn.textContent = '🔊 음성 안내 듣기';
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                    hideVoiceGuide();
                }
            });
        }
        // testPrevBtn.addEventListener('click', () => showPage('instructions')); // 제거됨
        
        // 이벤트 리스너는 DOM 요소 초기화 후에 추가됨

        // 키보드 입력 관련 이벤트 리스너 제거됨

        // 음성 목록 로드
        function loadVoices() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        };
                    }
                } else {
                    resolve([]);
                }
            });
        }

        // 마이크 권한 및 음성인식 준비 (권한 요청 없이)
        async function prepareMicrophoneAndRecognition() {
            console.log('마이크 권한 및 음성인식 준비');
            
            // 음성인식 초기화
            if (!recognition) {
                initializeSpeechRecognition();
            }
            
            // 마이크 권한 요청
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('마이크 권한 획득 성공');
                
                // 오디오 시각화를 위한 스트림 저장
                audioStream = stream;
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    
                    // 스트림 저장
                    audioStream = stream;
                }
                
                return true;
            } catch (error) {
                console.error('마이크 권한 획득 실패:', error);
                alert('마이크 권한이 필요합니다. 브라우저 설정에서 마이크 권한을 허용해주세요.');
                return false;
            }
        }

        // 자동 음성 시작 시도 함수
        async function tryAutoVoiceStart() {
            // 음성인식 초기화만 하고 권한은 나중에 요청
            if (!recognition) {
                initializeSpeechRecognition();
            }
            
            // 간단한 테스트 오디오로 자동재생 가능 여부 확인
            const testAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAA==');
            testAudio.play().then(() => {
                console.log('자동재생 가능 - 자동으로 시작');
                // 버튼 숨기고 바로 시작
                document.getElementById('manualStartBtn').style.display = 'none';
                setTimeout(() => {
                    startVoiceIntroduction();
                }, 1000);
            }).catch(error => {
                console.log('자동재생 차단됨 - 시작 버튼 표시');
                // 시작 버튼은 이미 표시되어 있음
                // 사용자가 버튼을 클릭하면 handleStartClick이 호출됨
            });
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', async () => {
            // DOM 요소 초기화
            initializeDOMElements();
            
            // 이벤트 리스너 추가
            if (startBtn) startBtn.addEventListener('click', async () => await startTest());
            if (stopBtn) stopBtn.addEventListener('click', stopTest);
            if (resetBtn) resetBtn.addEventListener('click', resetTest);
            if (downloadBtn) downloadBtn.addEventListener('click', downloadResults);
            
            // 음성 목록 먼저 로드
            const voices = await loadVoices();
            console.log('로드된 음성 목록:', voices.length, '개');
            
            // 하드웨어 설정 확인
            const hasSettings = loadHardwareSettings();
            
            if (!hasSettings) {
                console.log('하드웨어 설정이 없습니다. 기본 설정으로 진행합니다.');
                // 설정이 없어도 기본값으로 진행
                setupWarning.style.display = 'none';
            } else {
                console.log('하드웨어 설정을 성공적으로 불러왔습니다.');
                setupWarning.style.display = 'none';
            }
            
            // DOM 요소 확인
            console.log('DOM 요소 확인:', {
                manualStartBtn: document.getElementById('manualStartBtn'),
                readyBox: document.getElementById('readyBox'),
                testPage: document.getElementById('testPage')
            });
            
            // 중복 제거됨 - 위에서 이미 처리
            
            // 바로 검사 페이지로 이동
            showPage('test');
            
            // 브라우저 체크
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome && (isSafari || isEdge)) {
                // Chrome이 아닌 경우 경고 표시
                document.getElementById('browserWarning').style.display = 'block';
            } else {
                // Chrome인 경우 1초 후 자동 음성 시작 시도
                setTimeout(() => {
                    tryAutoVoiceStart();
                }, 1000);
            }
        });
    </script>
</body>
</html>