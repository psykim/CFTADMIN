<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ë¬¼ ë²”ì£¼ ì–¸ì–´ìœ ì°½ì„±ê²€ì‚¬ V46 - CFTSCORING ì•Œê³ ë¦¬ì¦˜ 100% ì¼ì¹˜ êµ¬í˜„</title>
    <!-- favicon.ico 404 ì˜¤ë¥˜ ë°©ì§€ -->
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" type="image/x-icon">
    <!-- Version 6.0 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .instructions-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .content {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 800px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .content h2 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .instruction-card {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .instruction-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-content {
            background: transparent;
            padding: 30px;
            border-radius: 8px;
            display: block !important;
        }
        .timer-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .btn {
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .input-section {
            margin: 20px 0;
            text-align: center;
        }
        #manualInput {
            padding: 10px;
            font-size: 18px;
            width: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .animal-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 50px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .animal-item {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
        }
        .animal-item.duplicate {
            background: #e74c3c;
        }
        .stats {
            margin-top: 30px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .stat-value {
            font-weight: bold;
            color: #2c3e50;
        }
        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            color: #e74c3c;
            font-weight: bold;
        }
        .recording-indicator.active {
            display: flex;
        }
        .rec-dot {
            width: 12px;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .prev-btn {
            background-color: #95a5a6;
            color: white;
        }
        .prev-btn:hover {
            background-color: #7f8c8d;
        }
        .next-btn {
            background-color: #2ecc71;
            color: white;
        }
        .next-btn:hover {
            background-color: #27ae60;
        }
        .voice-guide-btn {
            background-color: #f39c12;
            color: white;
        }
        .voice-guide-btn:hover {
            background-color: #e67e22;
        }
        .download-btn {
            background-color: #9b59b6;
            color: white;
            margin-top: 20px;
        }
        .download-btn:hover {
            background-color: #8e44ad;
        }
        .user-info-form {
            max-width: 600px;
            margin: 30px auto;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-group small {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            margin-top: 5px;
            display: block;
        }
        .gender-group {
            width: 100%;
            flex: none;
        }
        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            margin: 0;
        }
        .radio-label input[type="radio"] {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
        }
        .radio-label span {
            font-size: 16px;
            color: white;
        }
        .ready-box {
            text-align: center;
            color: white;
            position: relative;
            z-index: 9999;
            display: none !important; /* ë™ê·¸ë€ ì‹œì‘ ë²„íŠ¼ í™”ë©´ ì™„ì „ ì œê±° */
        }
        .ready-check {
            font-size: 18px;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        .ready-check p {
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
        }
        .start-button {
            background: 
                radial-gradient(ellipse at center, #16a34a 0%, #22c55e 40%, #4ade80 100%);
            color: white;
            border: none;
            width: 160px;
            height: 160px;
            font-size: 26px;
            font-weight: 700;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(34, 197, 94, 0.1),
                inset 0 -8px 16px rgba(255, 255, 255, 0.2),
                inset 0 8px 16px rgba(0, 0, 0, 0.3),
                inset 0 0 40px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 0;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.5),
                0 -1px 0 rgba(255, 255, 255, 0.1);
            z-index: 10000;
        }
        .start-button::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            bottom: 10%;
            border-radius: 50%;
            background: 
                radial-gradient(ellipse at center bottom, rgba(0, 0, 0, 0.2) 0%, transparent 70%);
            opacity: 0.8;
        }
        .start-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            border-radius: 50%;
            box-shadow: 
                inset 0 -3px 8px rgba(255, 255, 255, 0.3),
                inset 0 3px 8px rgba(0, 0, 0, 0.3);
            opacity: 0.5;
        }
        .start-button span {
            position: relative;
            z-index: 1;
        }
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 0 10px rgba(34, 197, 94, 0.15),
                inset 0 -8px 16px rgba(255, 255, 255, 0.25),
                inset 0 8px 16px rgba(0, 0, 0, 0.25),
                inset 0 0 40px rgba(0, 0, 0, 0.15);
            background: 
                radial-gradient(ellipse at center, #1fb85a 0%, #2ed068 40%, #52e88e 100%);
        }
        .start-button:active {
            transform: translateY(2px);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(34, 197, 94, 0.1),
                inset 0 -4px 8px rgba(255, 255, 255, 0.15),
                inset 0 10px 20px rgba(0, 0, 0, 0.4),
                inset 0 0 50px rgba(0, 0, 0, 0.3);
            background: 
                radial-gradient(ellipse at center, #148f42 0%, #1fb34e 40%, #3ec670 100%);
        }
        .voice-guide-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 300px;
            transform: translateY(100px);
            transition: transform 0.3s;
            z-index: 1000;
            opacity: 0;
        }
        .voice-guide-box.active {
            transform: translateY(0);
            opacity: 1;
        }
        .no-setup-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .interval-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .interval-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .interval-stat h5 {
            margin: 0 0 5px 0;
            color: #666;
            font-size: 14px;
        }
        .interval-stat .count {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        /* ê²€ì‚¬ ì‹œì‘ í™”ë©´ íš¨ê³¼ */
        .test-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }
        .test-start-overlay.active {
            display: flex;
        }
        .mic-icon {
            width: 120px;
            height: 120px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 1.5s infinite;
        }
        .mic-icon svg {
            width: 60px;
            height: 60px;
            fill: white;
        }
        .test-start-text {
            font-size: 48px;
            color: white;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            animation-delay: 0.3s;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* í…ŒìŠ¤íŠ¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .test-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        .test-screen.active {
            display: flex;
        }
        .test-mic-container {
            margin-bottom: 40px;
            text-align: center;
        }
        .test-mic-icon {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px;
            transition: all 0.3s ease;
            box-shadow: 
                0 8px 30px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.1),
                inset 0 -4px 8px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .test-mic-icon::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
            border-radius: 50%;
            opacity: 0.8;
        }
        .test-mic-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: transparent;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1);
        }
        .test-mic-icon.active {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 
                0 0 50px rgba(239, 68, 68, 0.6),
                0 8px 30px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -4px 8px rgba(0,0,0,0.3);
        }
        .test-mic-icon.active::before {
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { opacity: 0.8; transform: translateX(0) translateY(0); }
            50% { opacity: 1; transform: translateX(10px) translateY(10px); }
        }
        .test-mic-icon svg {
            width: 70px;
            height: 70px;
            fill: white;
            z-index: 1;
            position: relative;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .test-mic-icon.active svg {
            animation: mic-pulse 1.5s ease-in-out infinite;
        }
        @keyframes mic-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .response-display {
            width: 90%;
            max-width: 600px;
            height: 200px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .response-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .response-item {
            background: rgba(33, 150, 243, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            animation: fadeIn 0.3s ease-in;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
    </style>
    <!-- CFTSCORING ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ -->
    <script src="CFTSCORING/animal-database.js"></script>
    <script src="CFTSCORING/animal-variants.js"></script>
</head>
<body>
    <!-- ì˜¤ë²„ë ˆì´ ìš”ì†Œë“¤ -->
    <div id="analyzing-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center; color: white;">
            <div style="font-size: 24px; margin-bottom: 20px;">ë¶„ì„ ì¤‘...</div>
            <div style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    </div>

    <div id="setupWarning" class="no-setup-warning" style="display: none;">
        <h3>âš ï¸ í•˜ë“œì›¨ì–´ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p>ìŒì„± ê¸°ë°˜ ê²€ì‚¬ë¥¼ ìœ„í•´ ë¨¼ì € í•˜ë“œì›¨ì–´ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
        <button class="btn btn-primary" onclick="goToSetup()">í•˜ë“œì›¨ì–´ ì„¤ì •í•˜ê¸°</button>
    </div>

    <div id="browserWarning" class="no-setup-warning" style="display: none; background: #ffebee; border-color: #ef5350;">
        <h3>âš ï¸ ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì•ˆë‚´</h3>
        <p>ì´ ê²€ì‚¬ëŠ” <strong>Chrome ë¸Œë¼ìš°ì €</strong>ì—ì„œ ê°€ì¥ ì˜ ì‘ë™í•©ë‹ˆë‹¤.</p>
        <p style="margin-top: 10px; font-size: 14px;">
            í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„±ì¸ì‹ì´ ì œí•œì ì´ê±°ë‚˜ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ì´ ë°˜ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            <strong>Chrome ë¸Œë¼ìš°ì €</strong>ë¥¼ ì‚¬ìš©í•˜ì‹œë©´ ë” ì›í™œí•œ ê²€ì‚¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>
        <div style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="continueDespiteBrowser()">ê·¸ë˜ë„ ê³„ì†í•˜ê¸°</button>
            <!-- Chrome ë‹¤ìš´ë¡œë“œ ë§í¬ ì œê±° (ì™¸ë¶€ ì°¸ì¡° ìµœì†Œí™”) -->
        </div>
    </div>

    <div class="container">
        <!-- User Information Page -->
        <div class="page active" id="userInfoPage">
            <div class="content">
                <h2>ì°¸ê°€ì ì •ë³´ ì…ë ¥</h2>
                
                <div class="user-info-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="participantId">ì°¸ê°€ì ID</label>
                            <input type="text" id="participantId" placeholder="ì˜ˆ: TEST001" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userAge">ì—°ë ¹</label>
                            <input type="number" id="userAge" min="1" max="120" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="userEducation">êµìœ¡ë…„ìˆ˜</label>
                            <input type="number" id="userEducation" min="0" max="30" placeholder="ì´ êµìœ¡ë…„ìˆ˜" required>
                            <small>ì´ˆë“± 6ë…„ + ì¤‘í•™ 3ë…„ + ê³ ë“± 3ë…„ + ëŒ€í•™ 4ë…„ ë“±</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group gender-group">
                            <label>ì„±ë³„</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="ë‚¨" id="genderMale" required>
                                    <span>ë‚¨ì„±</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="gender" value="ì—¬" id="genderFemale" required>
                                    <span>ì—¬ì„±</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn next-btn" id="userInfoNextBtn" style="margin-left: auto;">ê²€ì‚¬ ì‹œì‘</button>
                </div>
            </div>
        </div>

        <!-- Test Page -->
        <div class="page" id="testPage">
            <div class="test-content">
                <!-- ê²€ì‚¬ ì§„í–‰ í…ìŠ¤íŠ¸ì™€ íƒ€ì´ë¨¸ ìˆ«ì ì œê±° -->
                
                <div class="timer-display" id="timer" style="display: none;">60</div>
                
                <div class="ready-box" id="readyBox">
                    <button class="start-button" id="manualStartBtn" style="display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 99999 !important;"><span>ì‹œì‘í•˜ê¸°</span></button>
                    <div class="ready-check" id="readyCheckMessage">
                        <p>ì¡°ìš©í•œ ì¥ì†Œì—ì„œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                    </div>
                    <div id="audioPermissionNotice" style="display: none; margin-top: 30px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <p style="margin: 0; color: white; opacity: 0.8; font-size: 16px;">ğŸ”Š ìŒì„± ì•ˆë‚´ë¥¼ ì‹œì‘í•˜ë ¤ë©´ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-success" id="startBtn" style="display: none;">ì‹œì‘</button>
                    <button class="btn btn-danger" id="stopBtn" style="display: none;">ì¤‘ì§€</button>
                    <button class="btn btn-primary" id="resetBtn" style="display: none;">ë‹¤ì‹œ ì‹œì‘</button>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <div class="rec-dot"></div>
                    <span>ìŒì„± ì¸ì‹ ì¤‘...</span>
                </div>

                <!-- í‚¤ë³´ë“œ ì…ë ¥ ì„¹ì…˜ ì œê±° -->
                <!--
                <div class="input-section">
                    <input type="text" id="manualInput" placeholder="í‚¤ë³´ë“œë¡œ ì…ë ¥ (Enterë¡œ ì¶”ê°€)" disabled>
                    <button class="btn btn-primary" id="addBtn" disabled>ì¶”ê°€</button>
                </div>
                -->
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ì€ ê²€ì‚¬ ì‹œì‘ í›„ì—ë§Œ í‘œì‹œ -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <h3>ì…ë ¥ëœ ë™ë¬¼ ëª©ë¡</h3>
                <div class="animal-list" id="animalList"></div>
                
                <div class="stats" id="stats" style="display: none;">
                    <h3>ê²€ì‚¬ ê²°ê³¼</h3>
                    
                    <div class="interval-stats" id="intervalStats"></div>
                    
                    <div class="stat-item">
                        <span class="stat-label">ì´ ì‘ë‹µ ìˆ˜:</span>
                        <span class="stat-value" id="totalCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ìœ íš¨ ì‘ë‹µ ìˆ˜ (ì¤‘ë³µ ì œì™¸):</span>
                        <span class="stat-value" id="uniqueCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì¤‘ë³µ ì‘ë‹µ ìˆ˜:</span>
                        <span class="stat-value" id="duplicateCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì†Œìš” ì‹œê°„:</span>
                        <span class="stat-value" id="elapsedTime">0ì´ˆ</span>
                    </div>
                    <button class="btn download-btn" id="downloadBtn">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>

            <!-- ì´ì „ ë‹¨ê³„ ë²„íŠ¼ ì œê±° - ì²« í˜ì´ì§€ê°€ ì—†ìœ¼ë¯€ë¡œ í•„ìš” ì—†ìŒ -->
            <!-- <div class="navigation">
                <button class="btn prev-btn" id="testPrevBtn">ì´ì „ ë‹¨ê³„</button>
                <div></div>
            </div> -->
        </div>
    </div>

    <div class="voice-guide-box" id="voiceGuideBox">
        <div id="voiceGuideText"></div>
    </div>

    <!-- ê²€ì‚¬ ì‹œì‘ ì˜¤ë²„ë ˆì´ -->
    <div class="test-start-overlay" id="testStartOverlay">
        <div class="mic-icon">
            <svg viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
            </svg>
        </div>
        <div class="test-start-text">ê²€ì‚¬ ì‹œì‘</div>
    </div>

    <!-- í…ŒìŠ¤íŠ¸ í™”ë©´ -->
    <div class="test-screen" id="testScreen">
        <div class="test-mic-container">
            <div class="test-mic-icon" id="testMicIcon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                </svg>
            </div>
        </div>
        <div class="response-display" id="responseDisplay">
            <div class="response-list" id="responseList"></div>
        </div>
    </div>

    <script>
        // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testClick() {
            console.log('ë²„íŠ¼ í´ë¦­ í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
            alert('ë²„íŠ¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ì½˜ì†”ì— ë©”ì‹œì§€ ì¶œë ¥
        console.log('V6 í˜ì´ì§€ ë¡œë“œë¨ - ì‹œê°„:', new Date().toLocaleTimeString());
        console.log('testClick í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€:', typeof testClick);
        
        // ë””ë²„ê¹…: ìš”ì†Œ ìƒíƒœ í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            const readyBox = document.getElementById('readyBox');
            const testContent = document.querySelector('.test-content');
            const testPage = document.getElementById('testPage');
            const manualStartBtn = document.getElementById('manualStartBtn');
            
            console.log('=== ì‹œì‘ ë²„íŠ¼ ë””ë²„ê¹… ===');
            console.log('readyBox:', readyBox);
            console.log('readyBox display:', readyBox ? window.getComputedStyle(readyBox).display : 'null');
            console.log('testContent:', testContent);
            console.log('testContent display:', testContent ? window.getComputedStyle(testContent).display : 'null');
            console.log('testPage:', testPage);
            console.log('testPage display:', testPage ? window.getComputedStyle(testPage).display : 'null');
            console.log('manualStartBtn:', manualStartBtn);
            console.log('manualStartBtn display:', manualStartBtn ? window.getComputedStyle(manualStartBtn).display : 'null');
            console.log('======================');
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ì‹¤í–‰ - ë””ë²„ê¹… ì™„ë£Œë¨
        
        // ë²”ì£¼ ì •ì˜ (CFTSCORINGì—ì„œ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´)
        const CATEGORIES = {
            // ìƒë¬¼í•™ì  ë¶„ë¥˜
            MAMMAL: 'í¬ìœ ë¥˜',
            BIRD: 'ì¡°ë¥˜',
            REPTILE: 'íŒŒì¶©ë¥˜',
            AMPHIBIAN: 'ì–‘ì„œë¥˜',
            FISH: 'ì–´ë¥˜',
            INSECT: 'ê³¤ì¶©',
            MOLLUSK: 'ì—°ì²´ë™ë¬¼',
            CRUSTACEAN: 'ê°‘ê°ë¥˜',
            
            // ì„œì‹ì§€ë³„ ë¶„ë¥˜
            MARINE: 'í•´ì–‘ë™ë¬¼',
            FRESHWATER: 'ë‹´ìˆ˜ë™ë¬¼',
            
            // ì¸ê°„ê³¼ì˜ ê´€ê³„
            DOMESTIC: 'ê°€ì¶•',
            PET: 'ì• ì™„ë™ë¬¼',
            WILD: 'ì•¼ìƒë™ë¬¼',
            
            // ë¬¸í™”ì  ë¶„ë¥˜
            ZODIAC: '12ê°„ì§€',
            MYTHOLOGY: 'ì‹ í™”/ìƒìƒì˜ ë™ë¬¼',
            PREHISTORIC: 'ì„ ì‚¬ì‹œëŒ€ ë™ë¬¼'
        };

        // CFTSCORINGì˜ ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì™¸ë¶€ íŒŒì¼ì—ì„œ ë¡œë“œë¨
        // ANIMAL_CATEGORIESì™€ variantToBaseëŠ” animal-database.jsì™€ animal-variants.jsì—ì„œ ì •ì˜ë¨
        
        // ë™ë¬¼ ë³€í˜• ì‚¬ì „ (CFTSCORINGì—ì„œ ê°€ì ¸ì˜´)
        const ANIMAL_VARIANTS = {
            'ê°œ': ['ê°œ', 'ê°•ì•„ì§€', 'ë©ë©ì´', 'ê°œìƒˆë¼', 'ì•”ìº', 'ìˆ˜ìº', 'ê²¬', 'ë˜¥ê°œ', 'ëˆ„ë ì´', 'ë°”ë‘‘ì´', 'ë°±êµ¬'],
            'ê³ ì–‘ì´': ['ê³ ì–‘ì´', 'ëƒ¥ì´', 'ì•¼ì˜¹ì´', 'ê³ ëƒ¥ì´', 'ì•”ê³ ì–‘ì´', 'ìˆ˜ê³ ì–‘ì´', 'ìƒˆë¼ê³ ì–‘ì´', 'ì•„ê¸°ê³ ì–‘ì´', 'ëƒ¥ëƒ¥ì´'],
            'ì†Œ': ['ì†Œ', 'ì†¡ì•„ì§€', 'ì•”ì†Œ', 'ìˆ˜ì†Œ', 'í™©ì†Œ', 'ì†Œìƒˆë¼', 'ì•”ì‡ ', 'ìˆ˜ì‡ ', 'ë©ì—ì†Œ', 'ëˆ„ë ì†Œ', 'ì–¼ë£©ì†Œ', 'í•œìš°', 'ì –ì†Œ'],
            'ë¼ì§€': ['ë¼ì§€', 'ìƒˆë¼ë¼ì§€', 'ì•„ê¸°ë¼ì§€', 'ì•”í‡˜ì§€', 'ìˆ˜í‡˜ì§€', 'ë©§ë¼ì§€', 'ë', 'ì €', 'ê¿€ê¿€ì´', 'ë¼ì§€ìƒˆë¼'],
            'ë‹­': ['ë‹­', 'ë³‘ì•„ë¦¬', 'ì•”íƒ‰', 'ìˆ˜íƒ‰', 'ì¥ë‹­', 'ì”¨ì•”íƒ‰', 'ì”¨ìˆ˜íƒ‰', 'ë‹­ìƒˆë¼', 'ê¼¬ê¼¬', 'ê¼¬ë¼ì˜¤'],
            'ë§': ['ë§', 'ë§ì•„ì§€', 'ì•”ë§', 'ìˆ˜ë§', 'ì¡°ë‘ë§', 'ë§ìƒˆë¼', 'ì¤€ë§ˆ', 'ë§ˆ', 'ì²œë¦¬ë§ˆ', 'ê²½ì£¼ë§ˆ'],
            'í† ë¼': ['í† ë¼', 'ì‚°í† ë¼', 'ì§‘í† ë¼', 'ìƒˆë¼í† ë¼', 'ì•„ê¸°í† ë¼', 'ì•”í† ë¼', 'ìˆ˜í† ë¼', 'í† ë¼ìƒˆë¼', 'í† ê¹½ì´'],
            'ì¥': ['ì¥', 'ìƒì¥', 'ì§‘ì¥', 'ë“¤ì¥', 'ìƒˆë¼ì¥', 'ì•„ê¸°ì¥', 'ì•”ì¥', 'ìˆ˜ì¥', 'ì¥ìƒˆë¼', 'ì°ì°ì´', 'ì‹œê¶ì¥'],
            'í˜¸ë‘ì´': ['í˜¸ë‘ì´', 'ìƒˆë¼í˜¸ë‘ì´', 'ì•”í˜¸ë‘ì´', 'ìˆ˜í˜¸ë‘ì´', 'í˜¸ë‘ì´ìƒˆë¼', 'ë²”', 'ë°±í˜¸'],
            'ì‚¬ì': ['ì‚¬ì', 'ìƒˆë¼ì‚¬ì', 'ì•”ì‚¬ì', 'ìˆ˜ì‚¬ì', 'ì‚¬ììƒˆë¼', 'ë¼ì´ì˜¨']
        };
        
        // ë™ë¬¼ ì´ë¦„ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ (CFTSCORINGê³¼ ë™ì¼)
        function isAnimalName(word) {
            if (!word || typeof word !== 'string') return false;
            
            // normalizeAnimalNameì„ ì‚¬ìš©í•˜ì—¬ í™•ì¸
            const normalized = normalizeAnimalName(word);
            return normalized !== null;
        }
        
        // ë™ë¬¼ ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜ (CFTSCORINGê³¼ ë™ì¼)
        function normalizeAnimalName(animalName) {
            if (!animalName || typeof animalName !== 'string') return null;
            
            // variantToBase ë§¤í•‘ì´ ìˆìœ¼ë©´ ì‚¬ìš©
            if (typeof variantToBase !== 'undefined' && variantToBase[animalName]) {
                return variantToBase[animalName];
            }
            
            // ì§ì ‘ ANIMAL_CATEGORIESì— ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
            if (typeof ANIMAL_CATEGORIES !== 'undefined' && ANIMAL_CATEGORIES[animalName]) {
                return animalName;
            }
            
            return null;
        }
        
        // ê¸°ë³¸ ë™ë¬¼ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë³€í˜•ì„ ê¸°ë³¸í˜•ìœ¼ë¡œ ë³€í™˜)
        function getBaseAnimalName(word) {
            const normalized = normalizeAnimalName(word);
            return normalized || word;
        }
        
        // ì „ì—­ ë³€ìˆ˜
        let animals = [];
        let uniqueAnimals = new Set();
        let startTime = null;
        let endTime = null;
        let timerInterval = null;
        let timeRemaining = 60;
        let recognition = null;
        let isRecognizing = false;
        let currentStep = 1;
        let hardwareSettings = null;
        let microphonePermissionGranted = false;
        let practiceItems = [];
        let isPracticePhase = false;
        let practiceRetryCount = 0; // ì—°ìŠµ ì¬ì‹œë„ íšŸìˆ˜ ì¶”ê°€
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let mediaStream = null; // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ìœ ì§€
        
        // ì‚¬ìš©ì ì •ë³´ ì €ì¥
        let userInfo = {
            participantId: '',
            age: '',
            gender: '',
            education: ''
        };

        // ElevenLabs ê´€ë ¨ ë³€ìˆ˜
        let elevenLabsApiKey = null; // ê¸°ë³¸ê°’ ì œê±° (í•˜ë“œì›¨ì–´ ì„¤ì •ì—ì„œë§Œ ë¡œë“œ)
        let elevenLabsVoiceId = null; // ê¸°ë³¸ê°’ ì œê±°
        let elevenLabsConnected = false; // ê¸°ë³¸ê°’ falseë¡œ ë³€ê²½
        let audioQueue = [];
        let isPlaying = false;

        // ì‹œì‘ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        let isStartClicked = false;
        
        window.handleStartClick = function() {
            if (isStartClicked) {
                console.log('ì´ë¯¸ ì‹œì‘ë¨ - ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€');
                return;
            }
            isStartClicked = true;
            
            console.log('handleStartClick í˜¸ì¶œë¨');
            console.log('DOM ìš”ì†Œ ìƒíƒœ:', {
                voiceGuideBox: voiceGuideBox,
                voiceGuideText: voiceGuideText,
                readyBox: readyBox
            });
            
            // DOM ìš”ì†Œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´ˆê¸°í™”
            if (!voiceGuideBox || !voiceGuideText) {
                console.log('DOM ìš”ì†Œê°€ nullì…ë‹ˆë‹¤. ì´ˆê¸°í™” ì‹œë„...');
                initializeDOMElements();
            }
            
            const manualStartBtn = document.getElementById('manualStartBtn');
            const audioPermissionNotice = document.getElementById('audioPermissionNotice');
            const readyBoxElement = document.getElementById('readyBox');
            
            // ì‹œì‘ ë²„íŠ¼ê³¼ readyBoxë¥¼ ì¦‰ì‹œ ìˆ¨ê¹€
            if (manualStartBtn) {
                manualStartBtn.style.display = 'none';
                console.log('ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€');
            }
            
            if (readyBoxElement) {
                readyBoxElement.style.display = 'none';
                console.log('readyBox ìˆ¨ê¹€');
            }
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheckMessage = document.getElementById('readyCheckMessage');
            if (readyCheckMessage) {
                readyCheckMessage.style.display = 'none';
                console.log('readyCheckMessage ìˆ¨ê¹€');
            }
            
            // testScreen í‘œì‹œ (ë¹„í™œì„±í™”ëœ ë§ˆì´í¬ ì•„ì´ì½˜ í¬í•¨)
            if (testScreen) {
                testScreen.classList.add('active');
                testScreen.style.display = 'flex';
                console.log('testScreen í‘œì‹œë¨');
            }
            
            // ë§ˆì´í¬ ì•„ì´ì½˜ì€ ë¹„í™œì„± ìƒíƒœë¡œ í‘œì‹œ
            if (testMicIcon) {
                testMicIcon.classList.remove('active');
                console.log('ë§ˆì´í¬ ì•„ì´ì½˜ ë¹„í™œì„± ìƒíƒœ');
            }
            
            try {
                // ìŒì„± ì•ˆë‚´ ì‹œì‘
                startInstructions();
            } catch (error) {
                console.error('startInstructions ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        let isInstructionsStarted = false;
        
        // ìŒì„± ì•ˆë‚´ ì‹œì‘ í•¨ìˆ˜
        function startInstructions() {
            if (isInstructionsStarted) {
                console.log('startInstructions ì´ë¯¸ ì‹œì‘ë¨ - ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€');
                return;
            }
            isInstructionsStarted = true;
            
            console.log('startInstructions í˜¸ì¶œë¨');
            
            // ì‹œì‘ ë²„íŠ¼ê³¼ ready box ìˆ¨ê¸°ê¸°
            if (readyBox) readyBox.style.display = 'none';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheck = document.getElementById('readyCheckMessage');
            if (readyCheck) readyCheck.style.display = 'none';
            
            // ì²« ë²ˆì§¸ ë‹¨ê³„: ì—°ìŠµ ì•ˆë‚´
            speak("ì§€ê¸ˆë¶€í„°, ê°„ë‹¨í•œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                setTimeout(() => {
                    speak("ë¨¼ì €, ì—°ìŠµë¶€í„° í•´ë³´ê² ìŠµë‹ˆë‹¤.", () => {
                        setTimeout(() => {
                            speak("ì œê°€ 'ì˜·' ì¢…ë¥˜ë¼ê³  í•˜ë©´, ì˜·ì— ì†í•˜ëŠ” ê²ƒë“¤ì˜ ì´ë¦„ì„ ë§ì”€í•´ ë³´ì‹­ì‹œì˜¤.", () => {
                                setTimeout(() => {
                                    speak("ì˜ˆë¥¼ ë“¤ì–´, ì…”ì¸ , ë°”ì§€, ëª¨ì, ê·¸ ì™¸ ë¬´ì—‡ì´ë“ ì§€ ìƒê´€ì—†ìŠµë‹ˆë‹¤.", () => {
                                        setTimeout(() => {
                                            speak("ì˜· ì¢…ë¥˜ì— ì†í•˜ëŠ” ê²ƒ ì¤‘ì—, ë˜ ë‹¤ë¥¸ ê²ƒë“¤ë„ ìˆì£ .", () => {
                                                speak("ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¤ë©´, ì˜·ì¢…ë¥˜ì— ì†í•˜ëŠ” ë‹¤ë¥¸ ê²ƒë“¤ì„ ì œê°€ ê·¸ë§Œí•  ë•Œê¹Œì§€ ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ë³´ì„¸ìš”.", () => {
                                                    console.log('ì—°ìŠµ ì•ˆë‚´ ì™„ë£Œ - ì‚ ì†Œë¦¬ ì¤€ë¹„');
                                                    setTimeout(() => {
                                                        console.log('ì—°ìŠµ ëª¨ë“œ ì‹œì‘');
                                                        isPracticePhase = true;
                                                        practiceItems = [];
                                                        practiceRetryCount = 0; // ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
                                                        if (responseList) responseList.innerHTML = '';
                                                        
                                                        // 1ì´ˆ ì‚ ì†Œë¦¬
                                                        playBeep(880, 1000).then(() => {
                                                            console.log('ì‚ ì†Œë¦¬ ì™„ë£Œ - ë§ˆì´í¬ í™œì„±í™”');
                                                            
                                                            // ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”
                                                            if (testMicIcon) {
                                                                testMicIcon.classList.add('active');
                                                            }
                                                            
                                                            // testScreen í‘œì‹œ
                                                            if (testScreen) {
                                                                testScreen.classList.add('active');
                                                                testScreen.style.display = 'flex';
                                                            }
                                                            
                                                            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘
                                                            startAudioVisualization();
                                                            
                                                            // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° ìŒì„±ì¸ì‹ ì‹œì‘
                                                            setTimeout(() => {
                                                                // ìŒì„±ì¸ì‹ ì´ˆê¸°í™” í™•ì¸
                                                                if (!recognition) {
                                                                    console.log('ì—°ìŠµ ì‹œì‘ ì „ ìŒì„±ì¸ì‹ ì´ˆê¸°í™”');
                                                                    initializeSpeechRecognition();
                                                                }
                                                                
                                                                // ìŒì„±ì¸ì‹ ì‹œì‘
                                                                console.log('ì—°ìŠµ ëª¨ë“œì—ì„œ ìŒì„±ì¸ì‹ ì‹œì‘ ì¤€ë¹„');
                                                                isPracticePhase = true;  // ì—°ìŠµ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
                                                                isRecognizing = true;  // ìŒì„±ì¸ì‹ í”Œë˜ê·¸ë„ trueë¡œ ì„¤ì •
                                                                startSpeechRecognition();
                                                                console.log('ì—°ìŠµ ìŒì„±ì¸ì‹ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œë¨');
                                                            }, 500)  // 0.5ì´ˆ ëŒ€ê¸°
                                                            
                                                            // 10ì´ˆ ì—°ìŠµ ì‹œê°„
                                                            setTimeout(() => {
                                                                console.log('10ì´ˆ ì—°ìŠµ ì‹œê°„ ì¢…ë£Œ');
                                                                console.log('ì—°ìŠµ í•­ëª© ê°œìˆ˜:', practiceItems.length);
                                                                console.log('ì—°ìŠµ í•­ëª©:', practiceItems);
                                                                
                                                                // ì—°ìŠµ ëª¨ë“œ ì¢…ë£Œ
                                                                isPracticePhase = false;
                                                                // ìŒì„±ì¸ì‹ì€ ê³„ì† ìœ ì§€ (ë³¸ ê²€ì‚¬ë¥¼ ìœ„í•´)
                                                                // isRecognizing = false; // ì£¼ì„ ì²˜ë¦¬ - ìŒì„±ì¸ì‹ ìœ ì§€
                                                                
                                                                // ë§ˆì´í¬ ì•„ì´ì½˜ ë¹„í™œì„±í™”
                                                                if (testMicIcon) {
                                                                    testMicIcon.classList.remove('active');
                                                                }
                                                                
                                                                // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
                                                                stopAudioVisualization();
                                                                
                                                                // ì‘ë‹µì´ ìˆì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ë³¸ ê²€ì‚¬ë¡œ ì§„í–‰
                                                                if (practiceItems.length === 0 && practiceRetryCount < 1) {
                                                                    console.log('ì—°ìŠµ ì‘ë‹µ ì—†ìŒ - ì¬ì‹œë„ ì•ˆë‚´');
                                                                    practiceRetryCount++; // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€
                                                                    speak("ì•„ë¬´ ë§ì”€ë„ ë“¤ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ ì—°ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.", () => {
                                                                        setTimeout(() => {
                                                                            speak("ì œê°€ ì˜· ì¢…ë¥˜ë¼ê³  ë§í•˜ë©´, ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¬ ë•Œ ì˜·ì— ì†í•˜ëŠ” ê²ƒë“¤ì„ ë§ì”€í•´ì£¼ì„¸ìš”.", () => {
                                                                                setTimeout(() => {
                                                                                    // ì—°ìŠµ ì¬ì‹œì‘
                                                                                    practiceItems = [];
                                                                                    if (responseList) responseList.innerHTML = '';
                                                                                    
                                                                                    // 1ì´ˆ ì‚ ì†Œë¦¬
                                                                                    playBeep(880, 1000).then(() => {
                                                                                        // ë§ˆì´í¬ í™œì„±í™” í‘œì‹œ
                                                                                        if (testMicIcon) testMicIcon.classList.add('active');
                                                                                        
                                                                                        // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘
                                                                                        startAudioVisualization();
                                                                                        
                                                                                        console.log('ì—°ìŠµ ì¬ì‹œë„ ì‹œì‘ - 10ì´ˆ ëŒ€ê¸°');
                                                                                        setTimeout(() => {
                                                                                            console.log('ì—°ìŠµ ì¬ì‹œë„ ì¢…ë£Œ');
                                                                                            isPracticePhase = false;
                                                                                            
                                                                                            // ë§ˆì´í¬ ë¹„í™œì„±í™”
                                                                                            if (testMicIcon) testMicIcon.classList.remove('active');
                                                                                            
                                                                                            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
                                                                                            stopAudioVisualization();
                                                                                            
                                                                                            // ë‘ ë²ˆì§¸ ì—°ìŠµì—ì„œë„ ì‘ë‹µì´ ì—†ìœ¼ë©´ ë³¸ê²€ì‚¬ë¡œ ì§„í–‰
                                                                                            if (practiceItems.length === 0) {
                                                                                                console.log('ì—°ìŠµ ì¬ì‹œë„ì—ë„ ì‘ë‹µ ì—†ìŒ - ë³¸ê²€ì‚¬ë¡œ ì§„í–‰');
                                                                                                speak("ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                                                                    proceedToMainTest();
                                                                                                });
                                                                                            } else {
                                                                                                speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                                                                    proceedToMainTest();
                                                                                                });
                                                                                            }
                                                                                        }, 10000); // 10ì´ˆ
                                                                                    });
                                                                                }, 1000);
                                                                            });
                                                                        }, 800);
                                                                    });
                                                                } else if (practiceItems.length === 0 && practiceRetryCount >= 1) {
                                                                    // ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ë°”ë¡œ ë³¸ê²€ì‚¬ë¡œ ì§„í–‰
                                                                    console.log('ì—°ìŠµ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ - ë³¸ê²€ì‚¬ë¡œ ì§„í–‰');
                                                                    speak("ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                                        proceedToMainTest();
                                                                    });
                                                                } else {
                                                                    speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                                        proceedToMainTest();
                                                                    });
                                                                }
                                                            }, 10000); // 10ì´ˆ
                                                        });
                                                    }, 1500);
                                                });
                                            });
                                        }, 800);
                                    });
                                }, 800);
                            });
                        }, 800);
                    });
                }, 800);
            });
        }

        // DOM ìš”ì†Œ (ì´ˆê¸°ì—ëŠ” nullë¡œ ì„¤ì •)
        let pages = null;
        let timer = null;
        let startBtn = null;
        let stopBtn = null;
        let resetBtn = null;
        let animalList = null;
        let stats = null;
        let recordingIndicator = null;
        let downloadBtn = null;
        let voiceGuideBox = null;
        let voiceGuideText = null;
        let readyBox = null;
        let setupWarning = null;
        let testStartOverlay = null;
        let testScreen = null;
        let responseList = null;
        let resultsSection = null;
        let testMicIcon = null;
        
        // DOM ìš”ì†Œ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeDOMElements() {
            pages = {
                test: document.getElementById('testPage'),
                userInfo: document.getElementById('userInfoPage')
            };
            
            // User info page elements
            const userInfoPrevBtn = document.getElementById('userInfoPrevBtn');
            const userInfoNextBtn = document.getElementById('userInfoNextBtn');
            const participantIdInput = document.getElementById('participantId');
            const userAgeInput = document.getElementById('userAge');
            const userGenderSelect = document.getElementById('userGender');
            const userEducationInput = document.getElementById('userEducation');
            
            timer = document.getElementById('timer');
            startBtn = document.getElementById('startBtn');
            stopBtn = document.getElementById('stopBtn');
            resetBtn = document.getElementById('resetBtn');
            animalList = document.getElementById('animalList');
            stats = document.getElementById('stats');
            recordingIndicator = document.getElementById('recordingIndicator');
            downloadBtn = document.getElementById('downloadBtn');
            voiceGuideBox = document.getElementById('voiceGuideBox');
            voiceGuideText = document.getElementById('voiceGuideText');
            readyBox = document.getElementById('readyBox');
            setupWarning = document.getElementById('setupWarning');
            testStartOverlay = document.getElementById('testStartOverlay');
            testScreen = document.getElementById('testScreen');
            responseList = document.getElementById('responseList');
            resultsSection = document.getElementById('resultsSection');
            testMicIcon = document.getElementById('testMicIcon');
            
            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸
            console.log('DOM ìš”ì†Œ ì´ˆê¸°í™” ê²°ê³¼:', {
                timer: timer ? 'OK' : 'NULL',
                startBtn: startBtn ? 'OK' : 'NULL',
                stopBtn: stopBtn ? 'OK' : 'NULL',
                testScreen: testScreen ? 'OK' : 'NULL'
            });
        }

        // í•˜ë“œì›¨ì–´ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
        function goToSetup() {
            // í•˜ë“œì›¨ì–´ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ì§€ ì•Šê³  ê²½ê³ ë§Œ í‘œì‹œ
            alert('í•˜ë“œì›¨ì–´ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìŒì„± ê¸°ëŠ¥ ì—†ì´ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.');
            // window.location.href = 'hardware-setup.html?next=animal-fluency-test-v2.html';
        }
        
        // ë¸Œë¼ìš°ì € ê²½ê³  ë¬´ì‹œí•˜ê³  ê³„ì†
        function continueDespiteBrowser() {
            document.getElementById('browserWarning').style.display = 'none';
            tryAutoVoiceStart();
        }
        
        
        
        // ìŒì„± í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testVoice() {
            console.log('=== ìŒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            console.log('ElevenLabs ì„¤ì •:', {
                apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                voiceId: elevenLabsVoiceId,
                connected: elevenLabsConnected
            });
            console.log('í•˜ë“œì›¨ì–´ ì„¤ì •:', hardwareSettings);
            
            // 1. ë¸Œë¼ìš°ì € ê¸°ë³¸ TTS í…ŒìŠ¤íŠ¸
            const utterance = new SpeechSynthesisUtterance("ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.");
            utterance.lang = 'ko-KR';
            utterance.onend = () => console.log('ë¸Œë¼ìš°ì € TTS ì™„ë£Œ');
            utterance.onerror = (e) => console.error('ë¸Œë¼ìš°ì € TTS ì˜¤ë¥˜:', e);
            window.speechSynthesis.speak(utterance);
            
            // 2. speak í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
            setTimeout(() => {
                speak("ì´ê²ƒì€ í†µí•© ìŒì„± í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.", () => {
                    console.log('speak í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                });
            }, 2000);
        }
        
        // ìŒì„± ì•ˆë‚´ ì‹œì‘ ì—¬ë¶€ ì¶”ì 
        let voiceIntroStarted = false;
        
        // ìŒì„± ì•ˆë‚´ ì‹œì‘ í•¨ìˆ˜
        function startVoiceIntroduction() {
            
            // ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (voiceIntroStarted) {
                console.log('ìŒì„± ì•ˆë‚´ê°€ ì´ë¯¸ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            voiceIntroStarted = true;
            console.log('ìŒì„± ì•ˆë‚´ ì‹œì‘...');
            
            // ë¸Œë¼ìš°ì € ì²´í¬ ë° ì•ˆë‚´
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome) {
                console.log('Chromeì´ ì•„ë‹Œ ë¸Œë¼ìš°ì € ê°ì§€:', navigator.userAgent);
            }
            
            // ì¦‰ì‹œ ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê³  í…ŒìŠ¤íŠ¸ í™”ë©´ í‘œì‹œ
            if (readyBox) readyBox.style.display = 'none';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheckMsg = document.getElementById('readyCheckMessage');
            if (readyCheckMsg) readyCheckMsg.style.display = 'none';
            
            // startInstructions í•¨ìˆ˜ í˜¸ì¶œë¡œ ì—°ê²° - ì œê±° (ì¤‘ë³µ ë°©ì§€)
            // startInstructions();
            
            // ë§ˆì´í¬ ì•„ì´ì½˜ì€ ë¹„í™œì„± ìƒíƒœë¡œ í‘œì‹œ
            const localTestMicIcon = document.getElementById('testMicIcon');
            if (localTestMicIcon) localTestMicIcon.classList.remove('active');
            
            // ë°”ë¡œ ìŒì„± ì•ˆë‚´ ì‹œì‘ (ë¬´ìŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì—†ì´)
            speak("ì´ì œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                console.log('ì²« ë²ˆì§¸ ì•ˆë‚´ ì™„ë£Œ');
                
                setTimeout(() => {
                    speak("ì œê°€, ì–´ë–¤ ì¢…ë¥˜ë¥¼ ë§ì”€ë“œë¦¬ë©´, ë˜ë„ë¡, ë¹¨ë¦¬, ê·¸ ì¢…ë¥˜ì— ì†í•˜ëŠ” ì‚¬ë¬¼ë“¤ì˜ ì´ë¦„ì„, ëª¨ë‘ ë§ì”€í•´ì£¼ì„¸ìš”.", () => {
                        speak("ì˜ˆë¥¼ ë“¤ì–´, ì œê°€, 'ì˜· ì¢…ë¥˜'ë¼ê³  ë§í•˜ë©´, ì…”ì¸ , ë„¥íƒ€ì´, ëª¨ì ë“±ì˜ ì´ë¦„ì„, ë§ì”€í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                            speak("ì˜· ì¢…ë¥˜ì— ì†í•˜ëŠ” ê²ƒ ì¤‘ì—, ë˜ ë‹¤ë¥¸ ê²ƒë“¤ë„ ìˆì£ .", () => {
                                speak("ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¤ë©´, ì˜·ì¢…ë¥˜ì— ì†í•˜ëŠ” ë‹¤ë¥¸ ê²ƒë“¤ì„ ì œê°€ ê·¸ë§Œí•  ë•Œê¹Œì§€ ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ë³´ì„¸ìš”.", () => {
                                    console.log('ì—°ìŠµ ì•ˆë‚´ ì™„ë£Œ - ì‚ ì†Œë¦¬ ì¤€ë¹„');
                                    setTimeout(() => {
                                        console.log('ì—°ìŠµ ëª¨ë“œ ì‹œì‘');
                                        isPracticePhase = true;
                                        practiceItems = [];
                                        practiceRetryCount = 0; // ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
                                        if (responseList) responseList.innerHTML = '';
                                        
                                        // 1ì´ˆ ì‚ ì†Œë¦¬
                                        playBeep(880, 1000).then(async () => {
                                            // ë§ˆì´í¬ í™œì„±í™” í‘œì‹œ
                                            if (testMicIcon) testMicIcon.classList.add('active');
                                            
                                            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘ (ì´ë¯¸ ê¶Œí•œì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
                                            startAudioVisualization();
                                            
                                            // ì‚ ì†Œë¦¬ í›„ ì§§ì€ ëŒ€ê¸° ì‹œê°„ì„ ë‘ê³  ìŒì„±ì¸ì‹ ì‹œì‘
                                            setTimeout(() => {
                                                // ìŒì„±ì¸ì‹ ì‹œì‘ (ì—°ìŠµìš©)
                                                if (!recognition) {
                                                    console.log('ì—°ìŠµìš© ìŒì„±ì¸ì‹ ì´ˆê¸°í™”');
                                                    initializeSpeechRecognition();
                                                }
                                                
                                                if (recognition) {
                                                    isPracticePhase = true;  // ì—°ìŠµ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
                                                    isRecognizing = true;  // ìŒì„±ì¸ì‹ í”Œë˜ê·¸ë„ trueë¡œ ì„¤ì •
                                                    startSpeechRecognition();
                                                    console.log('ì—°ìŠµìš© ìŒì„±ì¸ì‹ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ');
                                                } else {
                                                    console.error('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì‹¤íŒ¨');
                                                }
                                            }, 500)  // 0.5ì´ˆ ëŒ€ê¸°
                                            
                                            // 10ì´ˆ ì—°ìŠµ ì‹œê°„
                                            setTimeout(() => {
                                                console.log('10ì´ˆ ì—°ìŠµ ì‹œê°„ ì¢…ë£Œ');
                                                console.log('ì—°ìŠµ í•­ëª© ê°œìˆ˜:', practiceItems.length);
                                                console.log('ì—°ìŠµ í•­ëª©:', practiceItems);
                                                
                                                // ì—°ìŠµ ëª¨ë“œ ì¢…ë£Œ
                                                isPracticePhase = false;
                                                // ìŒì„±ì¸ì‹ì€ ê³„ì† ìœ ì§€ (ë³¸ ê²€ì‚¬ë¥¼ ìœ„í•´)
                                                // isRecognizing = false; // ì£¼ì„ ì²˜ë¦¬ - ìŒì„±ì¸ì‹ ìœ ì§€
                                                console.log('ì—°ìŠµ ì¢…ë£Œ - ìŒì„±ì¸ì‹ì€ ê³„ì† ìœ ì§€');
                                                
                                                // ë§ˆì´í¬ ë¹„í™œì„±í™” í‘œì‹œ
                                                if (testMicIcon) testMicIcon.classList.remove('active');
                                                
                                                // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
                                                stopAudioVisualization();
                                                
                                                // ì‘ë‹µì´ ìˆì—ˆëŠ”ì§€ í™•ì¸
                                                if (practiceItems.length === 0 && practiceRetryCount < 1) {
                                                    console.log('ì—°ìŠµ ì‘ë‹µ ì—†ìŒ - ì¬ì‹œë„ ì•ˆë‚´');
                                                    practiceRetryCount++; // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€
                                                    speak("ì•„ë¬´ ë§ì”€ë„ ë“¤ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ ì—°ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.", () => {
                                                        setTimeout(() => {
                                                            speak("ì œê°€ ì˜· ì¢…ë¥˜ë¼ê³  ë§í•˜ë©´, ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¬ ë•Œ ì˜·ì— ì†í•˜ëŠ” ê²ƒë“¤ì„ ë§ì”€í•´ì£¼ì„¸ìš”.", () => {
                                                                setTimeout(() => {
                                                                    // ì—°ìŠµ ì¬ì‹œì‘
                                                                    isPracticePhase = true;
                                                                    practiceItems = [];
                                                                    responseList.innerHTML = '';
                                                                    
                                                                    playBeep(880, 1000).then(() => {
                                                                        if (testMicIcon) testMicIcon.classList.add('active');
                                                                        startAudioVisualization();
                                                                        
                                                                        setTimeout(() => {
                                                                            if (recognition && !isRecognizing) {
                                                                                try {
                                                                                    recognition.start();
                                                                                    isRecognizing = true;
                                                                                    console.log('ì—°ìŠµ ì¬ì‹œë„ - ìŒì„±ì¸ì‹ ì‹œì‘');
                                                                                } catch (e) {
                                                                                    console.log('ìŒì„±ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', e);
                                                                                }
                                                                            }
                                                                        }, 500);
                                                                        
                                                                        // 10ì´ˆ í›„ ë‹¤ì‹œ ì²´í¬
                                                                        setTimeout(() => {
                                                                            isPracticePhase = false;
                                                                            isRecognizing = false;
                                                                            if (testMicIcon) testMicIcon.classList.remove('active');
                                                                            stopAudioVisualization();
                                                                            
                                                                            // ë‘ ë²ˆì§¸ ì‹œë„ì—ì„œë„ ì‘ë‹µì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì§„í–‰
                                                                            if (practiceItems.length === 0) {
                                                                                speak("ì˜·ì˜ ì¢…ë¥˜ë¥¼ ë§ì”€í•˜ì…”ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì…”ì¸ , ë°”ì§€, ëª¨ì ê°™ì€ ê²ƒë“¤ì…ë‹ˆë‹¤. ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                                                    proceedToMainTest();
                                                                                });
                                                                            } else {
                                                                                speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                                                    proceedToMainTest();
                                                                                });
                                                                            }
                                                                        }, 10000);
                                                                    });
                                                                }, 1000);
                                                            });
                                                        }, 800);
                                                    });
                                                } else if (practiceItems.length === 0 && practiceRetryCount >= 1) {
                                                    // ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ë°”ë¡œ ë³¸ê²€ì‚¬ë¡œ ì§„í–‰
                                                    console.log('ì—°ìŠµ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ - ë³¸ê²€ì‚¬ë¡œ ì§„í–‰');
                                                    speak("ë³¸ ê²€ì‚¬ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.", () => {
                                                        proceedToMainTest();
                                                    });
                                                } else {
                                                    speak("ì˜í•˜ì…¨ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                                                        proceedToMainTest();
                                                    });
                                                }
                                            }, 10000); // 10ì´ˆ ëŒ€ê¸°
                                        });
                                    }, 1000);
                                });
                            });
                        });
                    });
                }, 1000);
            });
        }
        
        // ë³¸ ê²€ì‚¬ ì§„í–‰ í•¨ìˆ˜
        function proceedToMainTest() {
            console.log('proceedToMainTest í•¨ìˆ˜ í˜¸ì¶œë¨');
            setTimeout(() => {
                console.log('ë³¸ì‹œí–‰ ì•ˆë‚´ ì‹œì‘');
                speak("ì§€ê¸ˆë¶€í„°ëŠ”, ë‹¤ë¥¸ ì¢…ë¥˜, ì¦‰ 'ë™ë¬¼' ì¢…ë¥˜ì— ì†í•˜ëŠ” ê²ƒë“¤ì˜ ì´ë¦„ì„, ëª¨ë‘ ë§ì”€í•´ë³´ì‹­ì‹œì˜¤.", () => {
                    setTimeout(() => {
                        speak("1ë¶„ì˜ ì‹œê°„ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. 1ë¶„ ë™ì•ˆ, ìƒê°ë‚˜ëŠ” ë™ë¬¼ì˜ ì´ë¦„ì„, ë§ˆì´í¬ê°€ êº¼ì§ˆ ë•Œê¹Œì§€ í¬ê¸°í•˜ì§€ ë§ˆì‹œê³ , ìµœëŒ€í•œ ë§ì´ ë§ì”€í•´ ë³´ì„¸ìš”.", () => {
                            setTimeout(() => {
                                speak("ì¤€ë¹„ë˜ì…¨ìŠµë‹ˆê¹Œ? ì‚ ì†Œë¦¬ê°€ ë‚˜ê³  ë§ˆì´í¬ì— ë¶ˆì´ ë“¤ì–´ì˜¤ë©´, ë°”ë¡œ ì‹œì‘í•´ ì£¼ì„¸ìš”.", () => {
                                    console.log('ëª¨ë“  ì•ˆë‚´ ì™„ë£Œ - í˜„ì¬ ì‹œê°:', new Date().toLocaleTimeString());
                                    
                                    // ì•ˆë‚´ ì¢…ë£Œ í›„ 1ì´ˆ ëŒ€ê¸°
                                    console.log('1ì´ˆ ëŒ€ê¸° ì‹œì‘');
                                    setTimeout(() => {
                                        console.log('1ì´ˆ ëŒ€ê¸° ì™„ë£Œ - ë³¸ì‹œí–‰ ì‹œì‘:', new Date().toLocaleTimeString());
                                        startTest(); // ì‹œì‘ í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ
                                    }, 1000);
                                });
                            }, 800);
                        });
                    }, 800);
                });
            }, 800);
        }

        // í•˜ë“œì›¨ì–´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadHardwareSettings() {
            const settingsStr = localStorage.getItem('hardwareSettings');
            if (settingsStr) {
                try {
                    hardwareSettings = JSON.parse(settingsStr);
                    console.log('í•˜ë“œì›¨ì–´ ì„¤ì • ë¡œë“œ:', hardwareSettings);
                    
                    // ElevenLabs ì„¤ì • ì ìš© (ì„¤ì •ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°)
                    if (hardwareSettings.elevenLabsApiKey) {
                        elevenLabsApiKey = hardwareSettings.elevenLabsApiKey;
                    }
                    if (hardwareSettings.elevenLabsVoiceId) {
                        elevenLabsVoiceId = hardwareSettings.elevenLabsVoiceId;
                    }
                    if (hardwareSettings.elevenLabsConnected !== undefined) {
                        elevenLabsConnected = hardwareSettings.elevenLabsConnected;
                    }
                    
                    console.log('ElevenLabs ì„¤ì •:', {
                        apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                        voiceId: elevenLabsVoiceId,
                        connected: elevenLabsConnected
                    });
                    
                    // ìŒì„± ì„¤ì •ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if (!hardwareSettings.voiceEnabled) {
                        console.log('ìŒì„± ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('í•˜ë“œì›¨ì–´ ì„¤ì • íŒŒì‹± ì˜¤ë¥˜:', error);
                    return false;
                }
            }
            console.log('í•˜ë“œì›¨ì–´ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }

        // í˜ì´ì§€ ì „í™˜
        function showPage(pageId) {
            console.log('showPage í˜¸ì¶œ:', pageId);
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
                console.log('í˜ì´ì§€ í‘œì‹œ ì™„ë£Œ:', pageId);
            } else {
                console.error('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', pageId);
            }
        }

        // ìŒì„± ì•ˆë‚´ í‘œì‹œ
        function showVoiceGuide(text) {
            console.log('showVoiceGuide í˜¸ì¶œ:', {
                text: text,
                voiceGuideBox: voiceGuideBox,
                voiceGuideText: voiceGuideText
            });
            
            if (!voiceGuideBox || !voiceGuideText) {
                console.error('voiceGuideBox ë˜ëŠ” voiceGuideTextê°€ nullì…ë‹ˆë‹¤');
                return;
            }
            
            voiceGuideText.textContent = text;
            voiceGuideBox.classList.add('active');
        }

        function hideVoiceGuide() {
            voiceGuideBox.classList.remove('active');
        }

        // ElevenLabs TTS
        async function elevenLabsTTS(text, callback) {
            console.log('elevenLabsTTS í˜¸ì¶œ:', {
                apiKey: elevenLabsApiKey ? 'Set' : 'Not set',
                voiceId: elevenLabsVoiceId,
                text: text
            });
            
            if (!elevenLabsApiKey || !elevenLabsVoiceId) {
                console.error('ElevenLabs ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤');
                // ElevenLabs ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ TTSë¡œ í´ë°±
                defaultTTS(text, callback);
                return;
            }

            audioQueue.push({ text, callback });
            if (!isPlaying) {
                playNextInQueue();
            }
        }

        async function playNextInQueue() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const { text, callback } = audioQueue.shift();

            try {
                // API í‚¤ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
                if (!elevenLabsApiKey || !elevenLabsVoiceId) {
                    throw new Error('ElevenLabs API í‚¤ ë˜ëŠ” Voice IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                console.log('ElevenLabs API í˜¸ì¶œ ì‹œì‘:', {
                    url: `https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}/stream`,
                    text: text
                });
                
                // ElevenLabs API í˜¸ì¶œ ë¹„í™œì„±í™” (404 ì˜¤ë¥˜ ë°©ì§€)
                throw new Error('ElevenLabs API í˜¸ì¶œ ë¹„í™œì„±í™”ë¨');
                /* 404 ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}/stream`, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': elevenLabsApiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: hardwareSettings?.voiceSettings || {
                            stability: 0.85,  // ë” ì•ˆì •ì ì¸ ë°œìŒì„ ìœ„í•´ ì¦ê°€
                            similarity_boost: 0.75,
                            style: 0.3,  // ë” ëª…í™•í•œ ë°œìŒì„ ìœ„í•´ ê°ì†Œ
                            use_speaker_boost: true
                        }
                    })
                });

                console.log('ElevenLabs API ì‘ë‹µ:', {
                    status: response.status,
                    ok: response.ok
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        hideVoiceGuide();
                        
                        // ìŒì„± ì•ˆë‚´ê°€ ëë‚œ í›„ì—ë„ ìŒì„±ì¸ì‹ì„ ìë™ìœ¼ë¡œ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ
                        // ì‚ ì†Œë¦¬ í›„ì—ë§Œ ì‹œì‘í•˜ë„ë¡ í•¨
                        
                        if (callback) callback();
                        playNextInQueue();
                    };

                    audio.onerror = () => {
                        console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜');
                        hideVoiceGuide();
                        if (callback) callback();
                        playNextInQueue();
                    };

                    audio.play();
                } else {
                    // API ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë‚´ìš© í™•ì¸
                    const errorText = await response.text();
                    console.error('ElevenLabs API ì—ëŸ¬:', {
                        status: response.status,
                        error: errorText
                    });
                    // ê¸°ë³¸ TTSë¡œ í´ë°±
                    hideVoiceGuide();
                    defaultTTS(text, callback);
                    playNextInQueue();
                }
                */ // 404 ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬ ë
            } catch (error) {
                console.error('ElevenLabs TTS ì˜¤ë¥˜:', error);
                hideVoiceGuide();
                // ê¸°ë³¸ TTSë¡œ í´ë°±
                defaultTTS(text, callback);
                playNextInQueue();
            }
        }

        // ê¸°ë³¸ ë¸Œë¼ìš°ì € TTS
        function defaultTTS(text, callback) {
            console.log('defaultTTS í˜¸ì¶œ:', text);
            
            if (!window.speechSynthesis) {
                console.error('ë¸Œë¼ìš°ì €ê°€ ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                if (callback) callback();
                return;
            }

            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = hardwareSettings?.voiceSpeed || 1;
            utterance.pitch = 1;
            utterance.volume = 1;

            const voices = window.speechSynthesis.getVoices();
            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:', voices.length);
            
            const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
                utterance.voice = koreanVoice;
                console.log('í•œêµ­ì–´ ìŒì„± ì„ íƒ:', koreanVoice.name);
            } else {
                console.log('í•œêµ­ì–´ ìŒì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            utterance.onstart = () => {
                console.log('ìŒì„± ì¶œë ¥ ì‹œì‘');
            };
            
            utterance.onend = () => {
                console.log('ìŒì„± ì¶œë ¥ ì™„ë£Œ');
                hideVoiceGuide();
                
                // ìŒì„± ì•ˆë‚´ê°€ ëë‚œ í›„ì—ë„ ìŒì„±ì¸ì‹ì„ ìë™ìœ¼ë¡œ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ
                // ì‚ ì†Œë¦¬ í›„ì—ë§Œ ì‹œì‘í•˜ë„ë¡ í•¨
                
                if (callback) callback();
            };
            
            utterance.onerror = (event) => {
                console.error('ìŒì„± ì¶œë ¥ ì˜¤ë¥˜:', event);
                hideVoiceGuide();
                if (callback) callback();
            };

            window.speechSynthesis.speak(utterance);
            console.log('ìŒì„± í•©ì„± ìš”ì²­ë¨');
        }

        // ìŒì„± í•©ì„± (í†µí•© í•¨ìˆ˜)
        function speak(text, callback) {
            // ì´ë¯¸ ê°™ì€ í…ìŠ¤íŠ¸ê°€ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                console.log('ìŒì„±ì´ ì´ë¯¸ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€:', text);
                return;
            }
            
            console.log('speak í•¨ìˆ˜ í˜¸ì¶œ:', {
                text: text,
                hardwareSettings: hardwareSettings,
                voiceEnabled: hardwareSettings?.voiceEnabled !== false, // undefinedì¼ ë•Œë„ true
                elevenLabsConnected: elevenLabsConnected,
                elevenLabsApiKey: elevenLabsApiKey ? 'Set' : 'Not set'
            });
            
            // ìŒì„± ê¸°ëŠ¥ì´ ëª…ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ìŠ¤í‚µ
            if (hardwareSettings && hardwareSettings.voiceEnabled === false) {
                console.log('ìŒì„± ê¸°ëŠ¥ì´ ëª…ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                if (callback) callback();
                return;
            }
            
            // ìŒì„± ì•ˆë‚´ ì¤‘ì—ëŠ” ìŒì„±ì¸ì‹ ì¼ì‹œ ì¤‘ì§€
            if (recognition && isRecognizing) {
                console.log('ìŒì„± ì•ˆë‚´ ì¤‘ ìŒì„±ì¸ì‹ ì¼ì‹œ ì¤‘ì§€');
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('ìŒì„±ì¸ì‹ ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜:', e);
                }
                isRecognizing = false;
            }

            showVoiceGuide(text);

            if (elevenLabsConnected && elevenLabsApiKey && elevenLabsVoiceId) {
                console.log('ElevenLabs TTS ì‚¬ìš©');
                elevenLabsTTS(text, callback);
            } else {
                console.log('ê¸°ë³¸ ë¸Œë¼ìš°ì € TTS ì‚¬ìš©');
                defaultTTS(text, callback);
            }
        }


        // ìŒì„±ì¸ì‹ ì´ˆê¸°í™”
        function initializeSpeechRecognition() {
            // ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„± ì²´í¬
            const SpeechRecognition = window.SpeechRecognition || 
                                    window.webkitSpeechRecognition || 
                                    window.mozSpeechRecognition || 
                                    window.msSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                alert('ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nChrome ë¸Œë¼ìš°ì € ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.');
                return false;
            }
            
            try {
                // ì´ë¯¸ recognition ê°ì²´ê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'ko-KR';
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.maxAlternatives = 1;
                    
                    recognition.onstart = () => {
                        console.log('ìŒì„±ì¸ì‹ ì‹œì‘ë¨');
                        isRecognizing = true;
                        
                        // ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”
                        const testMicIcon = document.querySelector('.test-mic-icon');
                        if (testMicIcon) {
                            testMicIcon.classList.add('active');
                            console.log('ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”ë¨');
                        }
                    };

                    // ê° ìŒì„± ì„¸ê·¸ë¨¼íŠ¸ì˜ ì‹œì‘ ì‹œê°„ì„ ì €ì¥í•˜ëŠ” ë§µ
                    const speechStartTimes = new Map();
                    
                    recognition.onresult = (event) => {
                        // ì—°ìŠµ ëª¨ë“œì´ê±°ë‚˜ ë³¸ ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ ì²˜ë¦¬
                        if (!isPracticePhase && !isRecognizing) {
                            console.log('ìŒì„±ì¸ì‹ ê²°ê³¼ ë¬´ì‹œ - ì—°ìŠµ/ë³¸ì‹œí–‰ ì¤‘ì´ ì•„ë‹˜');
                            return;
                        }
                        if (!isPracticePhase && timeRemaining <= 0) {
                            console.log('ìŒì„±ì¸ì‹ ê²°ê³¼ ë¬´ì‹œ - ì‹œê°„ ì¢…ë£Œ');
                            return;
                        }
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const result = event.results[i];
                            
                            // ì´ ê²°ê³¼ì— ëŒ€í•œ ì‹œì‘ ì‹œê°„ì´ ì•„ì§ ê¸°ë¡ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ë¡
                            if (!speechStartTimes.has(i)) {
                                const speechStartTime = Date.now() - startTime;
                                speechStartTimes.set(i, speechStartTime);
                                console.log(`ìŒì„± ì„¸ê·¸ë¨¼íŠ¸ ${i} ì‹œì‘ ì‹œê°„: ${speechStartTime}ms (${Math.floor(speechStartTime/1000)}ì´ˆ)`);
                            }
                            
                            if (result.isFinal) {
                                const transcript = result[0].transcript.trim();
                                const speechStartTime = speechStartTimes.get(i);
                                console.log('ì¸ì‹ëœ í…ìŠ¤íŠ¸:', transcript, 'ì—°ìŠµëª¨ë“œ:', isPracticePhase);
                                console.log('ìŒì„± ì…ë ¥ ì‹œì‘ ì‹œê°„:', speechStartTime, 'ms');
                                
                                const words = transcript.split(/[\s,ï¼Œã€]+/).filter(word => word.length > 0);
                                words.forEach((word, index) => {
                                    if (word.length > 0) {
                                        if (isPracticePhase) {
                                            // ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ëª¨ë“  ë‹¨ì–´ í—ˆìš© (ì˜· ì¢…ë¥˜)
                                            console.log('ì—°ìŠµ í•­ëª© ì¶”ê°€:', word);
                                            addPracticeItem(word);
                                        } else {
                                            // ë³¸ ê²€ì‚¬ì—ì„œëŠ” ëª¨ë“  ëª…ì‚¬ ì¸ì‹ (V15 ìˆ˜ì •)
                                            // ì—¬ëŸ¬ ë‹¨ì–´ê°€ í•œ ë²ˆì— ì¸ì‹ëœ ê²½ìš°, ê° ë‹¨ì–´ì— ì•½ê°„ì˜ ì‹œê°„ ê°„ê²© ì¶”ê°€
                                            const adjustedTime = speechStartTime + (index * 500);
                                            console.log('ë‹¨ì–´ ì¶”ê°€:', word, 'ì¡°ì •ëœ ì‹œê°„:', adjustedTime);
                                            // ìŒì„± ì…ë ¥ ì‹œì‘ ì‹œê°„ì„ í•¨ê»˜ ì „ë‹¬
                                            addAnimal(word, adjustedTime);
                                        }
                                    }
                                });
                                
                                // ì²˜ë¦¬ ì™„ë£Œëœ ê²°ê³¼ì˜ ì‹œì‘ ì‹œê°„ ì‚­ì œ
                                speechStartTimes.delete(i);
                            }
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error('ìŒì„±ì¸ì‹ ì˜¤ë¥˜:', event.error);
                        if (event.error === 'no-speech' && isRecognizing) {
                            // no-speech ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
                            console.log('no-speech ì˜¤ë¥˜ ë¬´ì‹œ');
                        } else if (event.error === 'not-allowed') {
                            console.error('ë§ˆì´í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            alert('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                        }
                    };

                    recognition.onend = () => {
                        console.log('ìŒì„±ì¸ì‹ ì¢…ë£Œë¨');
                        // ì—°ìŠµ ëª¨ë“œì´ê±°ë‚˜ ë³¸ ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì¼ ë•Œ ì¬ì‹œì‘
                        if ((isPracticePhase || isRecognizing) && timeRemaining > 0) {
                            setTimeout(() => {
                                try {
                                    recognition.start();
                                    console.log('ìŒì„±ì¸ì‹ ì¬ì‹œì‘ë¨');
                                } catch (e) {
                                    console.error('ìŒì„±ì¸ì‹ ì¬ì‹œì‘ ì˜¤ë¥˜:', e);
                                }
                            }, 100);
                        }
                    };
                }
                
                return true;
            } catch (error) {
                console.error('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
                return false;
            }
        }

        // ì‹ í˜¸ìŒ ì¬ìƒ í•¨ìˆ˜
        function playBeep(frequency = 880, duration = 200) {
            return new Promise((resolve) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
                
                setTimeout(resolve, duration);
            });
        }


        // ì˜¤ë””ì˜¤ ë¶„ì„ ì‹œì‘
        async function startAudioVisualization() {
            try {
                // ì´ë¯¸ ìŠ¤íŠ¸ë¦¼ì´ ìˆê³  í™œì„± ìƒíƒœì¸ì§€ í™•ì¸
                if (!mediaStream || mediaStream.getTracks().every(track => track.readyState !== 'live')) {
                    console.log('ìƒˆë¡œìš´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ìš”ì²­');
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphonePermissionGranted = true;
                    console.log('ë§ˆì´í¬ ê¶Œí•œ íšë“ ì™„ë£Œ');
                } else {
                    console.log('ê¸°ì¡´ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ì¬ì‚¬ìš©');
                }
                
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (!analyser) {
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                }
                
                if (!microphone) {
                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    microphone.connect(analyser);
                }
            } catch (error) {
                console.error('ì˜¤ë””ì˜¤ ì‹œê°í™” ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }


        // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
        function stopAudioVisualization() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // ë§ˆì´í¬ì™€ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ëŠ” ìœ ì§€í•˜ê³  ì‹œê°í™”ë§Œ ì¤‘ì§€
            // ì´ë ‡ê²Œ í•˜ë©´ ë§ˆì´í¬ ê¶Œí•œì„ ê³„ì† ìœ ì§€í•  ìˆ˜ ìˆìŒ
        }

        // ê²€ì‚¬ ì‹œì‘ ì‹œê°ì  íš¨ê³¼ì™€ ì‹ í˜¸ìŒ
        function startTestCountdown(callback) {
            console.log('startTestCountdown ì‹œì‘');
            
            // ë§ˆì´í¬ ê¶Œí•œ ë° ìŒì„±ì¸ì‹ ì¤€ë¹„ (ì´ë¯¸ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!audioContext || !recognition) {
                console.log('ë§ˆì´í¬/ìŒì„±ì¸ì‹ ì¤€ë¹„ í•„ìš”');
                prepareMicrophoneAndRecognition();
            }
            
            // í…ŒìŠ¤íŠ¸ í™”ë©´ í‘œì‹œ
            const testContent = document.querySelector('.test-content');
            console.log('í…ŒìŠ¤íŠ¸ ì½˜í…ì¸  ìš”ì†Œ:', testContent);
            // testContentë¥¼ ìˆ¨ê¸°ì§€ ì•ŠìŒ - ì‹œì‘ ë²„íŠ¼ì´ í‘œì‹œë˜ì–´ì•¼ í•¨
            
            console.log('testScreen ìš”ì†Œ:', testScreen);
            if (testScreen) {
                testScreen.classList.add('active');
            } else {
                console.error('testScreen ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            if (responseList) {
                responseList.innerHTML = '';
            }
            isPracticePhase = false;
            
            // 1ì´ˆì˜ ê¸´ ì‹ í˜¸ìŒ
            console.log('ì‹ í˜¸ìŒ ì¬ìƒ ì‹œì‘');
            playBeep(1000, 1000);
            console.log('ì‹ í˜¸ìŒ ì¬ìƒ ì™„ë£Œ');
            
            // ë§ˆì´í¬ í™œì„±í™” í‘œì‹œ
            if (testMicIcon) {
                testMicIcon.classList.add('active');
                console.log('ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”');
            } else {
                console.error('testMicIcon ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘
            console.log('ì˜¤ë””ì˜¤ ì‹œê°í™” ì‹œì‘');
            startAudioVisualization();
            
            // ì½œë°± ì‹¤í–‰
            if (callback) {
                console.log('ì½œë°± í•¨ìˆ˜ ì‹¤í–‰');
                callback();
            }
        }

        // ì—°ìŠµ í•­ëª© ì¶”ê°€
        function addPracticeItem(item) {
            if (!item || item.trim() === '') return;
            
            const trimmedItem = item.trim();
            practiceItems.push(trimmedItem);
            
            // ì‘ë‹µ í‘œì‹œì— ì¶”ê°€
            const itemElement = document.createElement('div');
            itemElement.className = 'response-item';
            itemElement.textContent = trimmedItem;
            responseList.appendChild(itemElement);
        }

        // ë™ë¬¼ ì¶”ê°€
        // ê°•í™”ëœ ëª…ì‚¬ í•„í„°ë§ í•¨ìˆ˜
        function isNoun(word) {
            // í•œêµ­ì–´ ëª…ì‚¬ íŒë³„ì„ ìœ„í•œ ê°•í™”ëœ ê·œì¹™
            // 1. 1ê¸€ì ì´ìƒ
            if (word.length < 1) return false;
            
            // 2. ê°íƒ„ì‚¬ ì œì™¸
            const interjections = ['ì–´', 'ì•„', 'ì˜¤', 'ìš°', 'ì—', 'ìŒ', 'í ', 'ì•„ì´ê³ ', 'ì•„ì´êµ¬', 'ì–´ë¨¸', 'ì–´ë¨¸ë‚˜', 'ì–´ì´êµ¬', 'ì—ì´', 'ì•„ë‹ˆ', 'ì•„ì°¨', 'ì•—', 'ì™€', 'ì›Œ', 'í—', 'í—‰', 'í—ˆ', 'í•˜', 'íˆ', 'í›„', 'íœ´', 'í'];
            if (interjections.includes(word)) return false;
            
            // 3. ë¶€ì‚¬ ì œì™¸
            const adverbs = ['ë˜', 'ë”', 'ì˜', 'ëª»', 'ì•ˆ', 'ê¼­', 'ê³§', 'ì¦‰', 'ë°”ë¡œ', 'ì•„ì£¼', 'ë§¤ìš°', 'ë„ˆë¬´', 'ì •ë§', 'ì°¸', 'ì¢€', 'ì¡°ê¸ˆ', 'ë§ì´', 'ì ê²Œ', 'ë¹¨ë¦¬', 'ì²œì²œíˆ', 'ê°‘ìê¸°', 'ì´ë¯¸', 'ë²Œì¨', 'ì•„ì§', 'ê°€ì•¼ì§€', 'í•´ì•¼ì§€', 'ê°™ì´', 'í•¨ê»˜', 'í˜¼ì', 'ë”°ë¡œ'];
            if (adverbs.includes(word)) return false;
            
            // 4. í˜•ìš©ì‚¬ ì–´ê°„ ì œì™¸
            const adjectives = ['í¬ë‹¤', 'ì‘ë‹¤', 'ë§ë‹¤', 'ì ë‹¤', 'ì¢‹ë‹¤', 'ë‚˜ì˜ë‹¤', 'ì˜ˆì˜ë‹¤', 'ë°‰ë‹¤', 'ë†’ë‹¤', 'ë‚®ë‹¤', 'ê¸¸ë‹¤', 'ì§§ë‹¤', 'ë„“ë‹¤', 'ì¢ë‹¤', 'ê¹Šë‹¤', 'ì–•ë‹¤'];
            if (adjectives.includes(word)) return false;
            
            // 5. ë™ì‚¬/í˜•ìš©ì‚¬ í™œìš©í˜• ì œì™¸
            const verbEndings = ['í•˜ë‹¤', 'í–ˆë‹¤', 'í•œë‹¤', 'í•´ìš”', 'í•©ë‹ˆë‹¤', 'í•˜ëŠ”', 'í•˜ê³ ', 'í•˜ì§€', 'í•˜ë©°', 'í•˜ë‹ˆ', 'í•˜ë©´', 'í•´ì„œ', 'ë˜ë‹¤', 'ëœë‹¤', 'ëë‹¤', 'ìˆë‹¤', 'ì—†ë‹¤', 'ê°™ë‹¤', 'ê² ë‹¤', 'ì§€ë‹¤', 'ì—ˆë‹¤', 'ì•˜ë‹¤', 'ë ¤ê³ ', 'ë¼ê³ ', 'ë‹¤ê³ '];
            for (const ending of verbEndings) {
                if (word.endsWith(ending)) return false;
            }
            
            // 6. ì¡°ì‚¬ ì œì™¸
            const particles = ['ì€', 'ëŠ”', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì—ì„œ', 'ì—ê²Œ', 'í•œí…Œ', 'ì˜', 'ì™€', 'ê³¼', 'ë¡œ', 'ìœ¼ë¡œ', 'ë¶€í„°', 'ê¹Œì§€', 'ë„', 'ë§Œ', 'ì¡°ì°¨', 'ë§ˆì €', 'ë°–ì—', 'ì²˜ëŸ¼', 'ë³´ë‹¤', 'ë§ˆë‹¤', 'ë¼ë„', 'ì´ë‚˜', 'ë‚˜', 'ë“ ì§€', 'ë˜ì§€'];
            if (particles.includes(word)) return false;
            
            // 7. ìˆ«ìë§Œìœ¼ë¡œ ì´ë£¨ì–´ì§„ ê²ƒ ì œì™¸
            if (/^\d+$/.test(word)) return false;
            
            // 8. íŠ¹ìˆ˜ë¬¸ìë§Œìœ¼ë¡œ ì´ë£¨ì–´ì§„ ê²ƒ ì œì™¸
            if (/^[^\wê°€-í£]+$/.test(word)) return false;
            
            return true;
        }
        
        function addAnimal(animal, speechTimestamp) {
            if (!animal || animal.trim() === '') return;
            
            const trimmedAnimal = animal.trim();
            
            // ëª…ì‚¬ê°€ ì•„ë‹Œ ê²ƒì€ ì œì™¸ (ì¹¨íˆ¬ë¡œ ê³„ì‚°í•˜ì§€ ì•ŠìŒ)
            if (!isNoun(trimmedAnimal)) {
                console.log(`ëª…ì‚¬ê°€ ì•„ë‹˜ (ë¬´íš¨ ì²˜ë¦¬, ì¹¨íˆ¬ ì•„ë‹˜): ${trimmedAnimal}`);
                return;
            }
            
            // speechTimestampê°€ ì „ë‹¬ë˜ë©´ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ ì‚¬ìš©
            const timestamp = speechTimestamp !== undefined ? speechTimestamp : (Date.now() - startTime);
            
            // ë™ë¬¼ ì—¬ë¶€ í™•ì¸
            const isValidAnimal = isAnimalName(trimmedAnimal);
            const baseAnimal = getBaseAnimalName(trimmedAnimal);
            
            console.log(`ë‹¨ì–´ ì¶”ê°€: ${trimmedAnimal}, ë™ë¬¼ì—¬ë¶€: ${isValidAnimal}, ê¸°ë³¸í˜•: ${baseAnimal}, ì‹œê°„: ${timestamp}ms (${Math.floor(timestamp/1000)}ì´ˆ)`);
            
            animals.push({
                name: trimmedAnimal,
                timestamp: timestamp,
                isDuplicate: uniqueAnimals.has(trimmedAnimal.toLowerCase()),
                isAnimal: isValidAnimal,
                baseAnimal: baseAnimal
            });
            
            uniqueAnimals.add(trimmedAnimal.toLowerCase());
            updateAnimalList();
            
            // í…ŒìŠ¤íŠ¸ í™”ë©´ì—ë„ ì¶”ê°€
            const itemElement = document.createElement('div');
            itemElement.className = 'response-item';
            itemElement.textContent = trimmedAnimal;
            responseList.appendChild(itemElement);
        }

        // ë™ë¬¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAnimalList() {
            animalList.innerHTML = '';
            animals.forEach(animal => {
                const item = document.createElement('div');
                item.className = 'animal-item' + (animal.isDuplicate ? ' duplicate' : '');
                item.textContent = animal.name;
                animalList.appendChild(item);
            });
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            console.log('startTimer í˜¸ì¶œë¨');
            if (!timer) {
                console.error('timer ìš”ì†Œê°€ nullì…ë‹ˆë‹¤');
                return;
            }
            
            // íƒ€ì´ë¨¸ í‘œì‹œ
            console.log('íƒ€ì´ë¨¸ í‘œì‹œ ì „ display:', timer.style.display);
            timer.style.display = 'block';
            console.log('íƒ€ì´ë¨¸ í‘œì‹œ í›„ display:', timer.style.display);
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                timer.textContent = timeRemaining;
                
                if (timeRemaining <= 0) {
                    stopTest();
                }
            }, 1000);
            
            console.log('íƒ€ì´ë¨¸ ì‹œì‘ë¨');
        }

        // ìŒì„±ì¸ì‹ ì‹œì‘ (ê¶Œí•œì€ ì´ë¯¸ hardware-setupì—ì„œ íšë“)
        function startSpeechRecognition() {
            console.log('startSpeechRecognition í˜¸ì¶œë¨');
            
            if (!recognition) {
                console.log('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì‹œë„');
                initializeSpeechRecognition();
            }
            
            if (!recognition) {
                console.error('ìŒì„±ì¸ì‹ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ìŒì„±ì¸ì‹ì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ ì‹œì‘
            try {
                console.log('ìŒì„±ì¸ì‹ ìƒíƒœ:', { isRecognizing, isPracticePhase });
                if (!isRecognizing) {
                    recognition.start();
                    console.log('recognition.start() í˜¸ì¶œë¨');
                } else {
                    console.log('ìŒì„±ì¸ì‹ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘');
                    // ì—°ìŠµ ëª¨ë“œì¸ ê²½ìš° ì¬ì‹œì‘ ì‹œë„
                    if (isPracticePhase) {
                        console.log('ì—°ìŠµ ëª¨ë“œ - ìŒì„±ì¸ì‹ ì¬ì‹œì‘ ì‹œë„');
                        try {
                            recognition.stop();
                            setTimeout(() => {
                                recognition.start();
                                console.log('ì—°ìŠµ ëª¨ë“œ ìŒì„±ì¸ì‹ ì¬ì‹œì‘ë¨');
                            }, 100);
                        } catch (e) {
                            console.log('ìŒì„±ì¸ì‹ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜:', e);
                        }
                    }
                }
                isRecognizing = true;
                if (recordingIndicator) {
                    recordingIndicator.classList.add('active');
                }
                
                // ë§ˆì´í¬ ì•„ì´ì½˜ í™œì„±í™”
                if (testMicIcon) {
                    testMicIcon.classList.add('active');
                }
            } catch (e) {
                console.error('ìŒì„±ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜:', e);
                // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°ì—ë„ í”Œë˜ê·¸ ì„¤ì •
                isRecognizing = true;
                recordingIndicator.classList.add('active');
                if (testMicIcon) {
                    testMicIcon.classList.add('active');
                }
            }
        }

        // ê²€ì‚¬ ì‹œì‘
        function startTest() {
            console.log('startTest í•¨ìˆ˜ í˜¸ì¶œë¨');
            if (readyBox) readyBox.style.display = 'none';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ìˆ¨ê¹€
            const readyCheckElement = document.getElementById('readyCheckMessage');
            if (readyCheckElement) readyCheckElement.style.display = 'none';
            animals = [];
            uniqueAnimals.clear();
            startTime = Date.now();
            timeRemaining = 60;
            if (timer) {
                timer.textContent = timeRemaining;
                timer.style.display = 'block'; // ê²€ì‚¬ ì‹œì‘ ì‹œ íƒ€ì´ë¨¸ í‘œì‹œ
            } else {
                console.error('timer ìš”ì†Œê°€ nullì…ë‹ˆë‹¤');
            }
            
            if (startBtn) {
                startBtn.style.display = 'none';
                console.log('ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€');
            } else {
                console.error('startBtnì´ nullì…ë‹ˆë‹¤');
            }
            
            if (stopBtn) {
                stopBtn.style.display = 'inline-block';
                console.log('ì¤‘ì§€ ë²„íŠ¼ í‘œì‹œ');
            } else {
                console.error('stopBtnì´ nullì…ë‹ˆë‹¤');
            }
            
            if (resetBtn) {
                resetBtn.style.display = 'none';
                console.log('ë¦¬ì…‹ ë²„íŠ¼ ìˆ¨ê¹€');
            } else {
                console.error('resetBtnì´ nullì…ë‹ˆë‹¤');
            }
            if (stats) stats.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'block'; // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            
            updateAnimalList();
            
            console.log('startTestCountdown í˜¸ì¶œ ì „');
            // ì‹ í˜¸ìŒê³¼ ì‹œê°ì  íš¨ê³¼ë¡œ ì¹´ìš´íŠ¸ë‹¤ìš´
            startTestCountdown(() => {
                console.log('startTestCountdown ì½œë°± ì‹¤í–‰');
                startTimer();
                // ì‚ ì†Œë¦¬ í›„ ìŒì„±ì¸ì‹ ì‹œì‘ì„ ìœ„í•´ ì•½ê°„ì˜ ëŒ€ê¸° ì‹œê°„ ì¶”ê°€
                setTimeout(() => {
                    console.log('ë³¸ ê²€ì‚¬ ìŒì„±ì¸ì‹ ì‹œì‘ ì¤€ë¹„');
                    if (!recognition) {
                        console.log('recognition ê°ì²´ê°€ ì—†ì–´ì„œ ì´ˆê¸°í™”');
                        initializeSpeechRecognition();
                    }
                    console.log('ìŒì„±ì¸ì‹ ì‹œì‘ ì‹œë„');
                    startSpeechRecognition();
                }, 500);  // 0.5ì´ˆ ëŒ€ê¸°
            });
            console.log('startTestCountdown ì™„ë£Œ');
        }

        // ê²€ì‚¬ ì¤‘ì§€
        function stopTest() {
            endTime = Date.now();
            clearInterval(timerInterval);
            
            if (isRecognizing) {
                isRecognizing = false;
                recordingIndicator.classList.remove('active');
                // ìŒì„±ì¸ì‹ì€ ê³„ì† ì‹¤í–‰ ì¤‘ìœ¼ë¡œ ìœ ì§€
                console.log('ê²€ì‚¬ ì¢…ë£Œ - ìŒì„±ì¸ì‹ì€ ê³„ì† ìœ ì§€');
            }
            
            // í…ŒìŠ¤íŠ¸ í™”ë©´ ìˆ¨ê¸°ê¸°
            testScreen.classList.remove('active');
            document.querySelector('.test-content').style.display = 'block';
            
            // ë§ˆì´í¬ ë¹„í™œì„±í™”
            testMicIcon.classList.remove('active');
            
            // ì˜¤ë””ì˜¤ ì‹œê°í™” ì¤‘ì§€
            stopAudioVisualization();
            
            if (startBtn) startBtn.style.display = 'none';
            if (stopBtn) stopBtn.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'inline-block';
            
            // V21 ìˆ˜ì •: ê¸°ë³¸ ê²°ê³¼ í‘œì‹œ ê±´ë„ˆë›°ê³  ë°”ë¡œ CFTSCORING ë¶„ì„
            // showResults(); // ê¸°ë³¸ í†µê³„ í‘œì‹œ ê±´ë„ˆëœ€
            
            // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ ì¦‰ì‹œ í‘œì‹œ
            document.getElementById('analyzing-overlay').style.display = 'flex';
            
            speak("ê²€ì‚¬ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.", () => {
                // ë°”ë¡œ CFTSCORING ë¶„ì„ ì‹œì‘
                analyzeWithCFTSCORING();
            });
        }

        // ê²€ì‚¬ ë¦¬ì…‹
        function resetTest() {
            readyBox.style.display = 'block';
            
            // 'ì¡°ìš©í•œ ì¥ì†Œì—ì„œ' ë©”ì‹œì§€ë„ ë‹¤ì‹œ í‘œì‹œ
            const readyCheckReset = document.getElementById('readyCheckMessage');
            if (readyCheckReset) readyCheckReset.style.display = 'block';
            animals = [];
            uniqueAnimals.clear();
            timeRemaining = 60;
            timer.textContent = timeRemaining;
            timer.style.display = 'none'; // ë¦¬ì…‹ ì‹œ íƒ€ì´ë¨¸ ìˆ¨ê¸°ê¸°
            resultsSection.style.display = 'none'; // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            
            if (startBtn) startBtn.style.display = 'inline-block';
            if (stopBtn) stopBtn.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'none';
            stats.style.display = 'none';
            
            updateAnimalList();
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResults() {
            const totalCount = animals.length;
            const uniqueCount = uniqueAnimals.size;
            const duplicateCount = totalCount - uniqueCount;
            const elapsedTime = Math.round((endTime - startTime) / 1000);
            
            // 15ì´ˆ ê°„ê²© í†µê³„ ê³„ì‚°
            const intervals = [
                { start: 0, end: 15, count: 0 },
                { start: 15, end: 30, count: 0 },
                { start: 30, end: 45, count: 0 },
                { start: 45, end: 60, count: 0 }
            ];
            
            animals.forEach(animal => {
                const seconds = animal.timestamp / 1000;
                for (let interval of intervals) {
                    if (seconds >= interval.start && seconds < interval.end) {
                        interval.count++;
                        break;
                    }
                }
            });
            
            // ê°„ê²©ë³„ í†µê³„ í‘œì‹œ
            const intervalStats = document.getElementById('intervalStats');
            intervalStats.innerHTML = '';
            intervals.forEach((interval, index) => {
                const div = document.createElement('div');
                div.className = 'interval-stat';
                div.innerHTML = `
                    <h5>${interval.start}-${interval.end}ì´ˆ</h5>
                    <div class="count">${interval.count}</div>
                `;
                intervalStats.appendChild(div);
            });
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('uniqueCount').textContent = uniqueCount;
            document.getElementById('duplicateCount').textContent = duplicateCount;
            document.getElementById('elapsedTime').textContent = elapsedTime + 'ì´ˆ';
            
            stats.style.display = 'block';
            
            // V20 ìˆ˜ì •: resultsSectionë„ í‘œì‹œí•´ì•¼ í•¨
            if (resultsSection) {
                resultsSection.style.display = 'block';
                console.log('ê²°ê³¼ ì„¹ì…˜ í‘œì‹œë¨');
            } else {
                console.error('resultsSectionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (CSV í˜•ì‹)
        function downloadResults() {
            const testDate = new Date();
            const intervalStats = calculateIntervalStats();
            
            // CSV BOM ì¶”ê°€ (í•œê¸€ ì—‘ì…€ í˜¸í™˜)
            let csvContent = '\ufeff';
            
            // CSV í—¤ë”
            csvContent += 'ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,0-15ì´ˆ,15-30ì´ˆ,30-45ì´ˆ,45-60ì´ˆ\n';
            
            // ë°ì´í„° í–‰ ì¶”ê°€
            const id = testDate.toISOString().slice(0,10).replace(/-/g,'') + '_' + testDate.getHours().toString().padStart(2,'0') + testDate.getMinutes().toString().padStart(2,'0');
            const gender = 'ë¯¸ì…ë ¥';
            const age = 'ë¯¸ì…ë ¥';
            const education = 'ë¯¸ì…ë ¥';
            
            // ê° êµ¬ê°„ë³„ ë™ë¬¼ ëª©ë¡
            const intervals = [
                intervalStats['0-15ì´ˆ'] || [],
                intervalStats['15-30ì´ˆ'] || [],
                intervalStats['30-45ì´ˆ'] || [],
                intervalStats['45-60ì´ˆ'] || []
            ];
            
            // CSV í–‰ ìƒì„±
            csvContent += `${id},${gender},${age},${education},`;
            csvContent += intervals.map(interval => `"${interval.join(',')}"`).join(',');
            csvContent += '\n';
            
            // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ë™ë¬¼ìœ ì°½ì„±ê²€ì‚¬_${testDate.toISOString().slice(0,10).replace(/-/g,'')}_${testDate.getHours().toString().padStart(2,'0')}${testDate.getMinutes().toString().padStart(2,'0')}${testDate.getSeconds().toString().padStart(2,'0')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ë™ë¬¼ ì´ë¦„ í•„í„°ë§ í•¨ìˆ˜
        function isAnimalName(text) {
            // ê¸°ë³¸ì ì¸ í•œêµ­ì–´ ë™ë¬¼ ì´ë¦„ íŒ¨í„´
            const animalPatterns = [
                // ì¼ë°˜ì ì¸ ë™ë¬¼ ì´ë¦„ë“¤
                'ê°œ', 'ê³ ì–‘ì´', 'ì†Œ', 'ë§', 'ë¼ì§€', 'ë‹­', 'ì˜¤ë¦¬', 'ì—¼ì†Œ', 'ì–‘', 'í† ë¼',
                'ì‚¬ì', 'í˜¸ë‘ì´', 'ê³°', 'ëŠ‘ëŒ€', 'ì—¬ìš°', 'ì‚¬ìŠ´', 'ë…¸ë£¨', 'ë©§ë¼ì§€', 'ì½”ë¼ë¦¬', 'ê¸°ë¦°',
                'ì›ìˆ­ì´', 'ê³ ë¦´ë¼', 'ì¹¨íŒ¬ì§€', 'ì˜¤ë‘ìš°íƒ„', 'ê°œë¯¸', 'ë²Œ', 'ë‚˜ë¹„', 'ì ìë¦¬', 'ë©”ëšœê¸°',
                'ë±€', 'ë„ë§ˆë±€', 'ì•…ì–´', 'ê±°ë¶ì´', 'ê°œêµ¬ë¦¬', 'ë‘êº¼ë¹„', 'ì´êµ¬ì•„ë‚˜', 'ì¹´ë©œë ˆì˜¨',
                'ë…ìˆ˜ë¦¬', 'ë§¤', 'ê¹Œë§ˆê·€', 'ê¹Œì¹˜', 'ì°¸ìƒˆ', 'ë¹„ë‘˜ê¸°', 'ì œë¹„', 'ë‘ë£¨ë¯¸', 'ë°±ë¡œ', 'ì˜¬ë¹¼ë¯¸',
                'ê³ ë˜', 'ëŒê³ ë˜', 'ìƒì–´', 'ë¬¼ê°œ', 'ë°”ë‹¤ì‚¬ì', 'í­ê·„', 'í•´ë§ˆ', 'ì˜¤ì§•ì–´', 'ë¬¸ì–´',
                'ì¥', 'ë‹¤ëŒì¥', 'ì²­ì„¤ëª¨', 'í–„ìŠ¤í„°', 'ê¸°ë‹ˆí”¼ê·¸', 'ì¹œì¹ ë¼', 'ê³ ìŠ´ë„ì¹˜', 'ë‘ë”ì§€',
                'í‘œë²”', 'ì¬ê·œì–´', 'ì¹˜íƒ€', 'í•˜ì´ì—ë‚˜', 'ë¯¸ì–´ìº£', 'ìˆ˜ë‹¬', 'ë„ˆêµ¬ë¦¬', 'ì˜¤ì†Œë¦¬',
                'ìº¥ê±°ë£¨', 'ì½”ì•Œë¼', 'ì›œë±ƒ', 'íƒ€ì¡°', 'ì—ë®¤', 'í”Œë¼ë°ê³ ', 'ì•µë¬´ìƒˆ', 'ê³µì‘'
            ];
            
            // í…ìŠ¤íŠ¸ ì •ë¦¬
            const cleaned = text.trim().toLowerCase();
            
            // ë„ˆë¬´ ê¸´ í…ìŠ¤íŠ¸ëŠ” ì œì™¸ (ë³´í†µ ë™ë¬¼ ì´ë¦„ì€ 5ê¸€ì ì´í•˜)
            if (cleaned.length > 5) return false;
            
            // ì¡°ì‚¬ë‚˜ ë¬¸ì¥ ë¶€í˜¸ê°€ í¬í•¨ëœ ê²½ìš° ì œì™¸
            if (/[.,!?~]/.test(cleaned)) return false;
            
            // ë™ë¬¼ ì´ë¦„ íŒ¨í„´ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
            return animalPatterns.some(animal => 
                cleaned === animal || 
                cleaned.includes(animal) || 
                animal.includes(cleaned)
            );
        }
        
        // ê³µí†µ ë²”ì£¼ ê¸°ë°˜ ì „í™˜ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ (CFTSCORINGê³¼ ë™ì¼)
        function analyzeTransitionsAndClusters(responses) {
            console.log('=== ì „í™˜ ë¶„ì„ ì‹œì‘ ===');
            console.log('ì…ë ¥ëœ ë™ë¬¼ë“¤:', responses.map(r => r.normalizedResponse));
            
            if (responses.length === 0) return { transitions: [], clusters: [], switchingScore: 0, inefficientSwitchingScore: 0 };
            
            // ì¤‘ë³µ ì œê±°í•˜ì—¬ uniqueí•œ ë™ë¬¼ë§Œ ë‚¨ê¸°ë˜, ìˆœì„œëŠ” ì²« ì¶œí˜„ ìˆœì„œ ìœ ì§€
            const seenAnimals = new Set();
            const uniqueResponses = [];
            
            for (const response of responses) {
                if (!seenAnimals.has(response.normalizedResponse)) {
                    seenAnimals.add(response.normalizedResponse);
                    uniqueResponses.push(response);
                }
            }
            
            console.log('ì¤‘ë³µ ì œê±° í›„ ë™ë¬¼ë“¤:', uniqueResponses.map(r => r.normalizedResponse));
            
            // ê° ë™ë¬¼ì˜ ë²”ì£¼ ì •ë³´ë¥¼ ë¯¸ë¦¬ ì¤€ë¹„
            const animalData = [];
            for (const response of uniqueResponses) {
                const originalAnimal = response.normalizedResponse;
                const normalizedAnimal = normalizeAnimalName(originalAnimal);
                const animal = normalizedAnimal || originalAnimal;
                const categories = [];
                const categoryData = ANIMAL_CATEGORIES[animal] || {};
                
                for (const [cat, value] of Object.entries(categoryData)) {
                    if (value === true) {
                        categories.push(cat);
                    }
                }
                
                animalData.push({
                    name: animal,
                    categories: categories,
                    originalName: originalAnimal
                });
            }
            
            // í´ëŸ¬ìŠ¤í„°ë§ ë° ì „í™˜ ë¶„ì„
            const clusters = [];
            const transitions = [];
            let switchingScore = 0;
            let inefficientSwitchingScore = 0;
            
            let currentClusterStart = 0;
            let currentClusterCategories = [...animalData[0].categories]; // ì²« ë™ë¬¼ì˜ ëª¨ë“  ë²”ì£¼ë¡œ ì‹œì‘
            
            console.log(`\nì²« ë™ë¬¼: ${animalData[0].name}, ë²”ì£¼: ${currentClusterCategories.map(c => CATEGORIES[c] || c)}`);
            
            for (let i = 1; i < animalData.length; i++) {
                const currentAnimal = animalData[i];
                console.log(`\n${i+1}ë²ˆì§¸ ë™ë¬¼: ${currentAnimal.name}`);
                console.log(`  ë²”ì£¼: ${currentAnimal.categories.map(c => CATEGORIES[c] || c)}`);
                
                // í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ ê³µí†µ ë²”ì£¼ì™€ ê²¹ì¹˜ëŠ” ë²”ì£¼ê°€ ìˆëŠ”ì§€ í™•ì¸
                const overlappingCategories = currentAnimal.categories.filter(cat => 
                    currentClusterCategories.includes(cat)
                );
                
                console.log(`  í˜„ì¬ í´ëŸ¬ìŠ¤í„° ê³µí†µë²”ì£¼: ${currentClusterCategories.map(c => CATEGORIES[c] || c)}`);
                console.log(`  ê²¹ì¹˜ëŠ” ë²”ì£¼: ${overlappingCategories.map(c => CATEGORIES[c] || c)}`);
                
                if (overlappingCategories.length > 0) {
                    // ê²¹ì¹˜ëŠ” ë²”ì£¼ê°€ ìˆìœ¼ë©´ ê°™ì€ í´ëŸ¬ìŠ¤í„°ì— ì†í•¨
                    // ê³µí†µ ë²”ì£¼ë¥¼ ê²¹ì¹˜ëŠ” ë²”ì£¼ë¡œ ì—…ë°ì´íŠ¸
                    currentClusterCategories = overlappingCategories;
                    console.log(`  â†’ ê°™ì€ í´ëŸ¬ìŠ¤í„° ìœ ì§€, ê³µí†µë²”ì£¼ ì—…ë°ì´íŠ¸: ${currentClusterCategories.map(c => CATEGORIES[c] || c)}`);
                } else {
                    // ê²¹ì¹˜ëŠ” ë²”ì£¼ê°€ ì—†ìœ¼ë©´ ì „í™˜ ë°œìƒ
                    console.log(`  â†’ ì „í™˜ ë°œìƒ!`);
                    
                    // ì´ì „ í´ëŸ¬ìŠ¤í„° ì €ì¥
                    const clusterSize = i - currentClusterStart;
                    const clusterAnimals = animalData.slice(currentClusterStart, i).map(a => a.name);
                    
                    // í´ëŸ¬ìŠ¤í„°ì˜ ìµœì¢… ê³µí†µ ë²”ì£¼ ê²°ì • (ìµœëŒ€ í¬ê¸°ë¥¼ ë§Œë“œëŠ” ë²”ì£¼)
                    const bestCategory = findBestCategoryForCluster(animalData.slice(currentClusterStart, i));
                    
                    clusters.push({
                        animals: clusterAnimals,
                        size: clusterSize,
                        commonCategories: bestCategory.categories,
                        startIndex: currentClusterStart,
                        endIndex: i - 1
                    });
                    
                    console.log(`  ì´ì „ í´ëŸ¬ìŠ¤í„°: ${clusterAnimals.join(', ')} (í¬ê¸°: ${clusterSize}, ë²”ì£¼: ${bestCategory.categories.map(c => CATEGORIES[c] || c)})`);
                    
                    // ì „í™˜ ì •ë³´ ì¶”ê°€
                    transitions.push({
                        index: i,
                        from: animalData[i-1].name,
                        to: currentAnimal.name,
                        fromCategories: animalData[i-1].categories,
                        toCategories: currentAnimal.categories
                    });
                    switchingScore++;
                    
                    // í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì „í™˜ì´ë©´ ë¹„íš¨ìœ¨ ì „í™˜
                    if (clusterSize === 1) {
                        inefficientSwitchingScore++;
                        console.log(`  â†’ ë¹„íš¨ìœ¨ ì „í™˜! (í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì „í™˜)`);
                    }
                    
                    // ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„° ì‹œì‘
                    currentClusterStart = i;
                    currentClusterCategories = [...currentAnimal.categories];
                }
            }
            
            // ë§ˆì§€ë§‰ í´ëŸ¬ìŠ¤í„° ì €ì¥
            if (animalData.length > 0) {
                const lastClusterSize = animalData.length - currentClusterStart;
                const lastClusterAnimals = animalData.slice(currentClusterStart).map(a => a.name);
                const bestLastCategory = findBestCategoryForCluster(animalData.slice(currentClusterStart));
                
                clusters.push({
                    animals: lastClusterAnimals,
                    size: lastClusterSize,
                    commonCategories: bestLastCategory.categories,
                    startIndex: currentClusterStart,
                    endIndex: animalData.length - 1
                });
                
                console.log(`\në§ˆì§€ë§‰ í´ëŸ¬ìŠ¤í„°: ${lastClusterAnimals.join(', ')} (í¬ê¸°: ${lastClusterSize}, ë²”ì£¼: ${bestLastCategory.categories.map(c => CATEGORIES[c] || c)})`);
            }
            
            console.log('\n=== ì „í™˜ ë¶„ì„ ê²°ê³¼ ===');
            console.log(`ì´ ì „í™˜ íšŸìˆ˜: ${switchingScore}`);
            console.log(`ë¹„íš¨ìœ¨ì „í™˜ íšŸìˆ˜: ${inefficientSwitchingScore}`);
            console.log(`í´ëŸ¬ìŠ¤í„° ìˆ˜: ${clusters.length}`);
            console.log('í´ëŸ¬ìŠ¤í„° êµ¬ì„±:');
            clusters.forEach((cluster, idx) => {
                const categoryNames = cluster.commonCategories.map(cat => CATEGORIES[cat] || cat).join(', ');
                console.log(`  í´ëŸ¬ìŠ¤í„° ${idx + 1}: ${cluster.animals.join(', ')} (í¬ê¸°: ${cluster.size}, ê³µí†µë²”ì£¼: ${categoryNames})`);
            });
            
            return { transitions, clusters, switchingScore, inefficientSwitchingScore };
        }
        
        // í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•´ ìµœì ì˜ ê³µí†µ ë²”ì£¼ë¥¼ ì°¾ëŠ” í•¨ìˆ˜
        function findBestCategoryForCluster(animals) {
            if (animals.length === 0) return { categories: [], count: 0 };
            if (animals.length === 1) return { categories: animals[0].categories, count: 1 };
            
            // ëª¨ë“  ê°€ëŠ¥í•œ ë²”ì£¼ ì¡°í•©ì„ ì°¾ì•„ì„œ ê°€ì¥ ë§ì€ ë™ë¬¼ì„ í¬í•¨í•˜ëŠ” ë²”ì£¼ ì„ íƒ
            const allCategories = new Set();
            animals.forEach(animal => {
                animal.categories.forEach(cat => allCategories.add(cat));
            });
            
            let bestCategories = [];
            let bestCount = 0;
            
            // ê° ë²”ì£¼ë³„ë¡œ ëª‡ ê°œì˜ ë™ë¬¼ì´ ì†í•˜ëŠ”ì§€ í™•ì¸
            for (const category of allCategories) {
                const count = animals.filter(animal => 
                    animal.categories.includes(category)
                ).length;
                
                if (count > bestCount) {
                    bestCount = count;
                    bestCategories = [category];
                }
            }
            
            // ì—¬ëŸ¬ ë²”ì£¼ì˜ êµì§‘í•©ë„ í™•ì¸ (2ê°œ ë²”ì£¼ì˜ êµì§‘í•©ë§Œ)
            const categoriesArray = Array.from(allCategories);
            for (let i = 0; i < categoriesArray.length; i++) {
                for (let j = i + 1; j < categoriesArray.length; j++) {
                    const cat1 = categoriesArray[i];
                    const cat2 = categoriesArray[j];
                    
                    const count = animals.filter(animal => 
                        animal.categories.includes(cat1) && animal.categories.includes(cat2)
                    ).length;
                    
                    if (count > bestCount) {
                        bestCount = count;
                        bestCategories = [cat1, cat2];
                    }
                }
            }
            
            return { categories: bestCategories, count: bestCount };
        }
        
        function calculateIntervalStats() {
            const intervals = {
                '0-15ì´ˆ': [],
                '15-30ì´ˆ': [],
                '30-45ì´ˆ': [],
                '45-60ì´ˆ': []
            };
            
            animals.forEach(animal => {
                const seconds = animal.timestamp / 1000;
                if (seconds < 15) {
                    intervals['0-15ì´ˆ'].push(animal);
                } else if (seconds < 30) {
                    intervals['15-30ì´ˆ'].push(animal);
                } else if (seconds < 45) {
                    intervals['30-45ì´ˆ'].push(animal);
                } else {
                    intervals['45-60ì´ˆ'].push(animal);
                }
            });
            
            return intervals;
        }
        
        // CSV ë°ì´í„° ìƒì„±
        function generateCSVData() {
            // 15ì´ˆ ê°„ê²©ìœ¼ë¡œ ë™ë¬¼ ë¶„ë¥˜
            const intervals = {
                '0-15ì´ˆ': [],
                '15-30ì´ˆ': [],
                '30-45ì´ˆ': [],
                '45-60ì´ˆ': []
            };
            
            animals.forEach(animal => {
                const seconds = animal.elapsedTime / 1000;
                if (seconds <= 15) {
                    intervals['0-15ì´ˆ'].push(animal.name);
                } else if (seconds <= 30) {
                    intervals['15-30ì´ˆ'].push(animal.name);
                } else if (seconds <= 45) {
                    intervals['30-45ì´ˆ'].push(animal.name);
                } else {
                    intervals['45-60ì´ˆ'].push(animal.name);
                }
            });
            
            // CSV í—¤ë”ì™€ ë°ì´í„° ìƒì„± - BOM ì¶”ê°€ë¡œ í•œê¸€ ì¸ì½”ë”© ë¬¸ì œ í•´ê²°
            let csv = '\ufeff';  // UTF-8 BOM ì¶”ê°€
            csv += 'ID,ì„±ë³„,ì—°ë ¹,í•™ë ¥,0-15ì´ˆ,15-30ì´ˆ,30-45ì´ˆ,45-60ì´ˆ\n';
            
            // ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©
            const id = userInfo.participantId || 'TEST001';
            const gender = userInfo.gender || 'ë¯¸ì…ë ¥';
            const age = userInfo.age || 'ë¯¸ì…ë ¥';
            const education = userInfo.education || 'ë¯¸ì…ë ¥';
            
            // ê° êµ¬ê°„ì˜ ë™ë¬¼ë“¤ì„ ì‰¼í‘œë¡œ ì—°ê²°
            const interval0_15 = intervals['0-15ì´ˆ'].join(',');
            const interval15_30 = intervals['15-30ì´ˆ'].join(',');
            const interval30_45 = intervals['30-45ì´ˆ'].join(',');
            const interval45_60 = intervals['45-60ì´ˆ'].join(',');
            
            csv += `${id},${gender},${age},${education},"${interval0_15}","${interval15_30}","${interval30_45}","${interval45_60}"`;
            
            console.log('ìƒì„±ëœ CSV ë°ì´í„°:');
            console.log(csv);
            console.log('êµ¬ê°„ë³„ ë™ë¬¼ ìˆ˜:', {
                '0-15ì´ˆ': intervals['0-15ì´ˆ'].length,
                '15-30ì´ˆ': intervals['15-30ì´ˆ'].length,
                '30-45ì´ˆ': intervals['30-45ì´ˆ'].length,
                '45-60ì´ˆ': intervals['45-60ì´ˆ'].length
            });
            
            return csv;
        }
        
        // CFTSCORING í†µí•© ë¶„ì„ í•¨ìˆ˜ (V15ì—ì„œëŠ” CSV ë‹¤ìš´ë¡œë“œ ì—†ì´ ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬)
        function analyzeWithCFTSCORING() {
            console.log('CFTSCORING í†µí•© ë¶„ì„ ì‹œì‘...');
            
            // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ëŠ” ì´ë¯¸ í‘œì‹œë¨ (V21)
            
            // CSV ë°ì´í„° ìƒì„± ì „ì— ê¸°ë³¸ ì •ë³´ ì„¤ì •
            console.log('í˜„ì¬ animals ë°°ì—´:', animals);
            console.log('animals ê¸¸ì´:', animals.length);
            
            if (!animals || animals.length === 0) {
                console.log('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‚´ë¶€ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                setTimeout(() => {
                    document.getElementById('analyzing-overlay').style.display = 'none';
                    performInternalAnalysis();
                }, 500);
                return;
            }
            
            // CSV ë°ì´í„° ìƒì„±
            const csvData = generateCSVData();
            console.log('ìƒì„±ëœ CSV ë°ì´í„°:', csvData);
            
            // CSV ë‹¤ìš´ë¡œë“œ ì—†ì´ ë°”ë¡œ CFTSCORING ë¶„ì„ ìˆ˜í–‰
            setTimeout(() => {
                try {
                    performCFTSCORINGAnalysis(csvData);
                } catch (error) {
                    console.error('CFTSCORING ë¶„ì„ ì˜¤ë¥˜:', error);
                    document.getElementById('analyzing-overlay').style.display = 'none';
                    performInternalAnalysis();
                }
            }, 100);
        }
        
        // CFTSCORING iframeì„ í†µí•œ ë¶„ì„ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - 404 ì˜¤ë¥˜ ë°©ì§€)
        function performCFTSCORINGAnalysisWithIframe(csvData) {
            console.log('iframe ë°©ì‹ ëŒ€ì‹  ì§ì ‘ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            performCFTSCORINGAnalysis(csvData);
        }
        
        // CFTSCORING ê²°ê³¼ë¡œë¶€í„° HTML ìƒì„±
        function generateCFTSCORINGResultFromData(result) {
            const testDate = new Date().toLocaleDateString('ko-KR');
            
            let html = `
                <div class="result-container" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #333; margin-bottom: 30px;">ë™ë¬¼ ìœ ì°½ì„± ê²€ì‚¬ ê²°ê³¼</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #495057; margin-bottom: 15px;">ê¸°ë³¸ ì •ë³´</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <p><strong>ID:</strong> ${result.id}</p>
                            <p><strong>ê²€ì‚¬ì¼:</strong> ${testDate}</p>
                            <p><strong>ì„±ë³„:</strong> ${result.gender}</p>
                            <p><strong>ì—°ë ¹:</strong> ${result.age}ì„¸</p>
                            <p><strong>í•™ë ¥:</strong> ${result.education}ë…„</p>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2; margin-bottom: 15px;">ì£¼ìš” ì ìˆ˜</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <p style="font-size: 18px; margin: 5px 0;"><strong>ì´ì :</strong> <span style="color: #1976d2; font-size: 24px;">${result.totalScore}</span>ì </p>
                                <p><strong>ì „ë°˜ë¶€ (0-30ì´ˆ):</strong> ${result.firstHalfScore}ì </p>
                                <p><strong>í›„ë°˜ë¶€ (30-60ì´ˆ):</strong> ${result.secondHalfScore}ì </p>
                            </div>
                            <div>
                                <p><strong>ë³´ì†:</strong> ${result.perseverationScore}ê°œ</p>
                                <p><strong>ì¹¨íˆ¬:</strong> ${result.intrusionScore}ê°œ</p>
                                <p><strong>ì „í™˜:</strong> ${result.switchingScore}íšŒ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #7b1fa2; margin-bottom: 15px;">í´ëŸ¬ìŠ¤í„° ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <p><strong>ë²”ì£¼ ìˆ˜:</strong> ${result.clusterCount || 0}ê°œ</p>
                            <p><strong>í‰ê·  í¬ê¸°:</strong> ${result.avgClusterSize || 0}</p>
                            <p><strong>ìµœëŒ€ í¬ê¸°:</strong> ${result.maxClusterSize || 0}</p>
                        </div>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #f57c00; margin-bottom: 15px;">êµ¬ê°„ë³„ ë°˜ì‘</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <p><strong>0-15ì´ˆ:</strong> ${result.interval1Count || 0}ê°œ</p>
                            <p><strong>15-30ì´ˆ:</strong> ${result.interval2Count || 0}ê°œ</p>
                            <p><strong>30-45ì´ˆ:</strong> ${result.interval3Count || 0}ê°œ</p>
                            <p><strong>45-60ì´ˆ:</strong> ${result.interval4Count || 0}ê°œ</p>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // CFTSCORING ë¶„ì„ ìˆ˜í–‰ í•¨ìˆ˜ (í´ë°±)
        function performCFTSCORINGAnalysis(csvData) {
            console.log('CFTSCORING ë¶„ì„ ìˆ˜í–‰ ì‹œì‘...');
            console.log('ë°›ì€ CSV ë°ì´í„°:', csvData);
            
            try {
                // CSV ë°ì´í„° íŒŒì‹±
                const rows = parseCSV(csvData);
                console.log('íŒŒì‹±ëœ í–‰ ìˆ˜:', rows.length);
                
                if (rows.length < 2) {
                    console.error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('analyzing-overlay').style.display = 'none';
                    performInternalAnalysis();
                    return;
                }
                
                // ì²« ë²ˆì§¸ ë°ì´í„° í–‰ ì²˜ë¦¬ (í—¤ë” ì œì™¸)
                const dataRow = rows[1];
                const id = dataRow[0];
                const gender = dataRow[1];
                const age = parseInt(dataRow[2]) || 0;
                const education = parseInt(dataRow[3]) || 0;
                
                // ê° ì‹œê°„ëŒ€ë³„ ë°˜ì‘ íŒŒì‹±
                const responses = {
                    '0-15': parseAnimals(dataRow[4]),
                    '15-30': parseAnimals(dataRow[5]),
                    '30-45': parseAnimals(dataRow[6]),
                    '45-60': parseAnimals(dataRow[7])
                };
                
                // CFTSCORING ì ìˆ˜ ê³„ì‚°
                const scores = calculateCFTScores({
                    id: id,
                    gender: gender,
                    age: age,
                    education: education,
                    responses: responses
                });
                
                // ê²°ê³¼ HTML ìƒì„±
                const resultHTML = generateCFTSCORINGResultHTML(scores);
                console.log('ìƒì„±ëœ ê²°ê³¼ HTML:', resultHTML ? 'ìˆìŒ' : 'ì—†ìŒ');
                console.log('ê²°ê³¼ HTML ê¸¸ì´:', resultHTML ? resultHTML.length : 0);
                
                // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                document.getElementById('analyzing-overlay').style.display = 'none';
                
                // ê²°ê³¼ í‘œì‹œ
                console.log('displayCFTSCORINGResults í˜¸ì¶œ ì§ì „');
                displayCFTSCORINGResults(resultHTML);
                
            } catch (error) {
                console.error('CFTSCORING ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('analyzing-overlay').style.display = 'none';
                alert('CFTSCORING ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚´ë¶€ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                performInternalAnalysis();
            }
        }
        
        // CSV íŒŒì‹± í•¨ìˆ˜
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const rows = [];
            
            for (let line of lines) {
                if (line.trim()) {
                    const row = [];
                    let cell = '';
                    let insideQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            row.push(cell.trim());
                            cell = '';
                        } else {
                            cell += char;
                        }
                    }
                    
                    // ë§ˆì§€ë§‰ ì…€ ì¶”ê°€
                    row.push(cell.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // ë™ë¬¼ ì´ë¦„ íŒŒì‹±
        function parseAnimals(text) {
            if (!text) return [];
            return text.split(',').map(a => a.trim()).filter(a => a.length > 0);
        }
        
        // CFTSCORING ì ìˆ˜ ê³„ì‚° - CFTSCORING.htmlì˜ ì •í™•í•œ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
        function calculateCFTScores(data) {
            // ëª¨ë“  ë°˜ì‘ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬
            const allResponses = [];
            let order = 1;
            
            ['0-15', '15-30', '30-45', '45-60'].forEach(range => {
                const timeRange = range;
                (data.responses[range] || []).forEach(response => {
                    const trimmed = response.trim();
                    if (!trimmed) return;
                    
                    // ì •ê·œí™”ëœ ë™ë¬¼ ì´ë¦„ ì°¾ê¸°
                    const normalizedResponse = normalizeAnimalName(trimmed);
                    
                    allResponses.push({
                        response: trimmed,
                        originalResponse: trimmed,
                        normalizedResponse: normalizedResponse,
                        timeRange: timeRange,
                        order: order++
                    });
                });
            });
            
            // ìœ íš¨í•œ ë°˜ì‘ (ì •ê·œí™”ëœ ë™ë¬¼ ì´ë¦„ì´ ìˆëŠ” ê²ƒ)
            const validResponses = allResponses.filter(r => r.normalizedResponse !== null);
            const uniqueResponses = [...new Set(validResponses.map(r => r.normalizedResponse))];
            const totalScore = uniqueResponses.length;
            
            // ì „ë°˜/í›„ë°˜ ì ìˆ˜
            const firstHalfResponses = allResponses.filter(r => 
                (r.timeRange === '0-15' || r.timeRange === '15-30') && r.normalizedResponse !== null
            );
            const firstHalfScore = new Set(firstHalfResponses.map(r => r.normalizedResponse)).size;
            
            const secondHalfResponses = allResponses.filter(r => 
                (r.timeRange === '30-45' || r.timeRange === '45-60') && r.normalizedResponse !== null
            );
            const secondHalfScore = new Set(secondHalfResponses.map(r => r.normalizedResponse)).size;
            
            // ë³´ì† ì˜¤ë¥˜ ê³„ì‚°
            const responseCount = {};
            validResponses.forEach(r => {
                responseCount[r.normalizedResponse] = (responseCount[r.normalizedResponse] || 0) + 1;
            });
            const perseverationScore = Object.values(responseCount)
                .filter(count => count > 1)
                .reduce((sum, count) => sum + (count - 1), 0);
            
            // ì¹¨íˆ¬ ì˜¤ë¥˜ ê³„ì‚°
            const intrusionScore = allResponses.filter(r => r.normalizedResponse === null).length;
            
            // CFTSCORINGì˜ ì •í™•í•œ ì „í™˜ ë° í´ëŸ¬ìŠ¤í„° ë¶„ì„
            const { transitions, clusters, switchingScore, inefficientSwitchingScore } = 
                analyzeTransitionsAndClusters(validResponses);
            
            // ë²”ì£¼ ì ìˆ˜ ê³„ì‚° (í¬ê¸° 2 ì´ìƒì˜ í´ëŸ¬ìŠ¤í„°ë§Œ ë²”ì£¼ë¡œ ì¸ì •)
            const validClusters = clusters.filter(cluster => cluster.size >= 2);
            const usedCategories = new Set();
            validClusters.forEach(cluster => {
                if (cluster.commonCategories.length > 0) {
                    usedCategories.add(cluster.commonCategories[0]);
                }
            });
            const categoryScore = usedCategories.size;
            
            // í´ëŸ¬ìŠ¤í„° í†µê³„
            const validClusterSizes = validClusters.map(c => c.size);
            const avgClusterSize = validClusterSizes.length > 0 
                ? (validClusterSizes.reduce((sum, size) => sum + size, 0) / validClusterSizes.length).toFixed(1)
                : '0.0';
            const maxClusterSize = Math.max(...validClusterSizes, 0);
            
            // êµ¬ê°„ë³„ ë™ë¬¼ ì •ë¦¬
            const intervalAnimals = {
                '0-15': [],
                '15-30': [],
                '30-45': [],
                '45-60': []
            };
            
            allResponses.forEach(r => {
                if (r.normalizedResponse) {
                    intervalAnimals[r.timeRange].push(r.normalizedResponse);
                }
            });
            
            return {
                id: data.id,
                gender: data.gender,
                age: data.age,
                education: data.education,
                totalScore: totalScore,
                firstHalfScore: firstHalfScore,
                secondHalfScore: secondHalfScore,
                perseverationScore: perseverationScore,
                intrusionScore: intrusionScore,
                switchingScore: switchingScore,
                inefficientSwitchingScore: inefficientSwitchingScore,
                clusterCount: clusters.length,
                categoryScore: categoryScore,
                avgClusterSize: avgClusterSize,
                maxClusterSize: maxClusterSize,
                clusterSizes: validClusterSizes,
                intervalAnimals: intervalAnimals,
                allAnimals: validResponses.map(r => r.normalizedResponse),
                clusters: clusters,
                transitions: transitions
            };
        }
        
        // ê°„ë‹¨í•œ ë™ë¬¼ ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬
        function isValidAnimalName(name) {
            // ê¸°ë³¸ì ì¸ ë™ë¬¼ ì´ë¦„ íŒ¨í„´ ê²€ì‚¬
            const commonAnimals = ['ê°œ', 'ê³ ì–‘ì´', 'ì†Œ', 'ë§', 'ë¼ì§€', 'ë‹­', 'í˜¸ë‘ì´', 'ì‚¬ì', 'í† ë¼', 'ì¿ '];
            return commonAnimals.some(animal => name.includes(animal)) || name.length >= 2;
        }
        
                        currentCluster = [animal];
                    }
                }
            });
            
            if (currentCluster.length > 1) {
                clusters.push(currentCluster);
            }
            
            const clusterCount = clusters.length;
            const avgClusterSize = clusterCount > 0 ? clusters.reduce((sum, c) => sum + c.length, 0) / clusterCount : 0;
            const maxClusterSize = clusterCount > 0 ? Math.max(...clusters.map(c => c.length)) : 0;
            const switchingScore = Math.max(0, animals.length - clusters.reduce((sum, c) => sum + c.length, 0));
            
            return {
                clusterCount: clusterCount,
                avgClusterSize: avgClusterSize.toFixed(1),
                maxClusterSize: maxClusterSize,
                switchingScore: switchingScore
            };
        }
        
        // ê°„ë‹¨í•œ ì¹´í…Œê³ ë¦¬ íŒë‹¨
        
        // CFTSCORING ê²°ê³¼ HTML ìƒì„± - CFTSCORING.htmlê³¼ ì™„ì „íˆ ë™ì¼í•œ ë””ìì¸
        function generateCFTSCORINGResultHTML(scores) {
            const testDate = new Date().toLocaleDateString('ko-KR');
            
            // Z-scoreì™€ í¼ì„¼íƒ€ì¼ ê³„ì‚°
            const zScore = ((scores.totalScore - 15) / 5).toFixed(2);
            const percentile = Math.min(99, Math.max(1, Math.round(50 + (zScore * 16))));
            
            // íŒ¨í„´ ë¶„ì„ ê²°ê³¼ ìƒì„±
            const interpretationData = {
                uniqueCount: scores.totalScore,
                intervalCounts: {
                    '0-15ì´ˆ': scores.intervalAnimals['0-15'].length,
                    '15-30ì´ˆ': scores.intervalAnimals['15-30'].length,
                    '30-45ì´ˆ': scores.intervalAnimals['30-45'].length,
                    '45-60ì´ˆ': scores.intervalAnimals['45-60'].length
                },
                duplicates: scores.perseverationScore,
                intrusions: scores.intrusionScore,
                numberOfClusters: scores.clusterCount,
                meanClusterSize: scores.avgClusterSize,
                clusterSizes: scores.clusterSizes || []
            };
            
            console.log('í•´ì„ ë°ì´í„°:', interpretationData);
            const patternAnalysis = analyzePatternAndGenerateInterpretation(interpretationData);
            console.log('ìƒì„±ëœ í•´ì„:', patternAnalysis);
            
            // CFTSCORINGê³¼ ë™ì¼í•œ CSS ìŠ¤íƒ€ì¼ ì‚¬ìš©
            let html = `
                <style>
                    .score-table {
                        width: 100%;
                        max-width: 1200px;
                        margin: 0 auto;
                        table-layout: fixed;
                        border-collapse: collapse;
                        background: white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        border-radius: 10px;
                        overflow: hidden;
                        margin-bottom: 20px;
                    }
                    
                    .score-table th,
                    .score-table td {
                        padding: 8px 10px;
                        text-align: center;
                        border: 1px solid #e0e0e0;
                    }
                    
                    .score-table th {
                        background-color: #f5f5f5;
                        font-weight: 600;
                        color: #333;
                        font-size: 13px;
                        white-space: nowrap;
                        padding: 10px 8px;
                    }
                    
                    .score-table tr.header-row {
                        background-color: #f5f5f5;
                    }
                    
                    .score-table td {
                        font-size: 16px;
                        font-weight: bold;
                        color: #1565c0;
                        white-space: nowrap;
                        background-color: white;
                    }
                    
                    .score-table tbody td:first-child:not(.data-cell) {
                        font-weight: bold;
                        background-color: #f5f5f5;
                    }
                </style>
                
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                    <h2 style="text-align: center; color: #90a4ae; font-size: 24px; font-weight: 500; margin: 30px 0 20px 0;">ë™ë¬¼ ìœ ì°½ì„± ê²€ì‚¬ ê²°ê³¼</h2>
                    
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                            <p style="margin: 0;"><strong>ID:</strong> ${scores.id}</p>
                            <p style="margin: 0;"><strong>ê²€ì‚¬ì¼:</strong> ${testDate}</p>
                            <p style="margin: 0;"><strong>ì„±ë³„:</strong> ${scores.gender}</p>
                            <p style="margin: 0;"><strong>ì—°ë ¹:</strong> ${scores.age}ì„¸</p>
                            <p style="margin: 0;"><strong>í•™ë ¥:</strong> ${scores.education}ë…„</p>
                        </div>
                    </div>
                    
                    <!-- CFTSCORING í˜•ì‹ì˜ í†µí•© ê²°ê³¼ í…Œì´ë¸” -->
                    <table class="score-table">
                        <colgroup>
                            <col style="width: 15%;">
                            <col style="width: 12.14%;">
                            <col style="width: 12.14%;">
                            <col style="width: 12.14%;">
                            <col style="width: 12.14%;">
                            <col style="width: 12.14%;">
                            <col style="width: 12.14%;">
                            <col style="width: 12.14%;">
                        </colgroup>
                        <tbody>
                            <!-- 60ì´ˆ ë°˜ì‘ ì²«ë²ˆì§¸ í–‰ -->
                            <tr class="header-row">
                                <th rowspan="4" style="vertical-align: middle; font-weight: bold; background-color: #e8f4f8;">60ì´ˆ ë°˜ì‘</th>
                                <th>ì´ì </th>
                                <th>Zì ìˆ˜</th>
                                <th>í¼ì„¼íƒ€ì¼</th>
                                <th>ì „ë°˜ì ìˆ˜</th>
                                <th>í›„ë°˜ì ìˆ˜</th>
                                <th>ë³´ì†ì˜¤ë¥˜</th>
                                <th>ì¹¨íˆ¬ì˜¤ë¥˜</th>
                            </tr>
                            <tr class="data-row">
                                <td class="data-cell" style="font-size: 18px; color: #1565c0;">${scores.totalScore}</td>
                                <td class="data-cell">${zScore}</td>
                                <td class="data-cell">${percentile}%</td>
                                <td class="data-cell">${scores.firstHalfScore}</td>
                                <td class="data-cell">${scores.secondHalfScore}</td>
                                <td class="data-cell">${scores.perseverationScore}</td>
                                <td class="data-cell">${scores.intrusionScore}</td>
                            </tr>
                            
                            <!-- ì „í™˜ ë¶„ì„ í–‰ -->
                            <tr class="header-row">
                                <th>ì „í™˜</th>
                                <th>ë¹„íš¨ìœ¨ì „í™˜</th>
                                <th>ë²”ì£¼ìˆ˜</th>
                                <th>í‰ê· í¬ê¸°</th>
                                <th>ìµœëŒ€í¬ê¸°</th>
                                <th colspan="2">í´ëŸ¬ìŠ¤í„° í¬ê¸° ë¶„í¬</th>
                            </tr>
                            <tr class="data-row">
                                <td class="data-cell">${scores.switchingScore}</td>
                                <td class="data-cell">${scores.inefficientSwitchingScore || 0}</td>
                                <td class="data-cell">${scores.clusterCount}</td>
                                <td class="data-cell">${scores.avgClusterSize}</td>
                                <td class="data-cell">${scores.maxClusterSize}</td>
                                <td class="data-cell" colspan="2">${scores.clusterSizes ? scores.clusterSizes.join(', ') : ''}</td>
                            </tr>
                            
                            <!-- ì‹œê°„ëŒ€ë³„ ì •ë³´ -->
                            <tr class="header-row">
                                <th rowspan="2" style="vertical-align: middle; font-weight: bold; background-color: #e8f4f8;">ì‹œê°„ëŒ€ë³„<br>ë¶„ì„</th>
                                <th>êµ¬ê°„</th>
                                <th>0-15ì´ˆ</th>
                                <th>15-30ì´ˆ</th>
                                <th>30-45ì´ˆ</th>
                                <th>45-60ì´ˆ</th>
                                <th colspan="2">í•©ê³„</th>
                            </tr>
                            <tr class="data-row">
                                <td style="font-weight: bold; background-color: #f5f5f5;">ê°œìˆ˜</td>
                                <td class="data-cell">${scores.intervalAnimals['0-15'].length}</td>
                                <td class="data-cell">${scores.intervalAnimals['15-30'].length}</td>
                                <td class="data-cell">${scores.intervalAnimals['30-45'].length}</td>
                                <td class="data-cell">${scores.intervalAnimals['45-60'].length}</td>
                                <td class="data-cell" colspan="2" style="font-weight: bold;">${scores.totalScore}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- ì„ìƒì  í•´ì„ (CFTSCORINGì˜ patternAnalysis ë™ì¼ ìŠ¤íƒ€ì¼) -->
                    <div id="patternAnalysis" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #1976d2;">
                        <div style="line-height: 1.8; color: #333;">
                            ${patternAnalysis || 'í•´ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...'}
                        </div>
                    </div>
                    
                    <!-- ë²„íŠ¼ë“¤ -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="showAnalysisDetails()" style="background-color: #17a2b8; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-right: 10px;">
                            ë¶„ì„ ê³¼ì • ë³´ê¸°
                        </button>
                        <button onclick="window.location.reload()" style="background-color: #1976d2; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                            ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // CFTSCORING ê²°ê³¼ í‘œì‹œ
        function displayCFTSCORINGResults(resultHTML) {
            console.log('displayCFTSCORINGResults í˜¸ì¶œë¨');
            
            // resultsSection ë‹¤ì‹œ í™•ì¸
            if (!resultsSection) {
                resultsSection = document.getElementById('resultsSection');
            }
            
            if (!resultsSection) {
                console.error('resultsSectionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                // ëŒ€ì²´ ë°©ë²•: bodyì— ì§ì ‘ ì¶”ê°€
                const div = document.createElement('div');
                div.id = 'cftscoring-results';
                div.innerHTML = resultHTML;
                div.style.cssText = 'padding: 20px; max-width: 1200px; margin: 20px auto;';
                document.body.appendChild(div);
                div.scrollIntoView({ behavior: 'smooth' });
                speak('ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            console.log('ê²°ê³¼ HTML ê¸¸ì´:', resultHTML.length);
            resultsSection.innerHTML = resultHTML;
            resultsSection.style.display = 'block';
            resultsSection.style.visibility = 'visible';
            resultsSection.style.opacity = '1';
            
            // íƒ€ì´ë¨¸ ë° ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const timerElement = document.getElementById('timer');
            const stopButton = document.getElementById('stopBtn');
            const testPage = document.getElementById('testPage');
            
            if (timerElement) timerElement.style.display = 'none';
            if (stopButton) stopButton.style.display = 'none';
            // Don't hide testPage since resultsSection is inside it
            // if (testPage) testPage.style.display = 'none';  // ê²€ì‚¬ í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            
            // Instead, hide specific elements inside testPage
            const readyBox = document.getElementById('readyBox');
            const testScreen = document.getElementById('testScreen');
            const voiceGuideBox = document.getElementById('voiceGuideBox');
            const recordingIndicator = document.getElementById('recordingIndicator');
            const controlButtons = document.querySelector('.control-buttons');
            
            if (readyBox) readyBox.style.display = 'none';
            if (testScreen) testScreen.style.display = 'none';
            if (voiceGuideBox) voiceGuideBox.style.display = 'none';
            if (recordingIndicator) recordingIndicator.style.display = 'none';
            if (controlButtons) controlButtons.style.display = 'none';
            
            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log('ìŠ¤í¬ë¡¤ ì™„ë£Œ');
            }, 100);
            
            // ê²°ê³¼ ìŒì„± ì•ˆë‚´
            speak('ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        
        // ë‚´ë¶€ ë¶„ì„ (í´ë°±)
        function performInternalAnalysis() {
            console.log('ë‚´ë¶€ ë¶„ì„ ì‹œì‘...');
            
            // ë¶„ì„ ì¤‘ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            document.getElementById('analyzing-overlay').style.display = 'none';
            
            // ìƒì„¸í•œ ë‚´ë¶€ ë¶„ì„ ìˆ˜í–‰
            analyzeInternalClusters();
        }
        
        // í´ëŸ¬ìŠ¤í„° ë¶„ì„ í•¨ìˆ˜ (ë‚´ë¶€ ë¶„ì„ìš©)
        function analyzeInternalClusters() {
            console.log('analyzeInternalClusters ì‹œì‘');
            
            // resultsSection ë³€ìˆ˜ í™•ì¸ ë° ê°€ì ¸ì˜¤ê¸°
            if (!resultsSection) {
                resultsSection = document.getElementById('resultsSection');
            }
            
            if (!resultsSection) {
                console.error('ê²°ê³¼ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const testDate = new Date();
            const totalCount = animals.length;
            const intervalStats = calculateIntervalStats();
            const intervalCounts = {
                '0-15ì´ˆ': intervalStats['0-15ì´ˆ'].length,
                '15-30ì´ˆ': intervalStats['15-30ì´ˆ'].length,
                '30-45ì´ˆ': intervalStats['30-45ì´ˆ'].length,
                '45-60ì´ˆ': intervalStats['45-60ì´ˆ'].length
            };
            
            // ì „ë°˜ë¶€/í›„ë°˜ë¶€ ë¶„ì„
            const firstHalfCount = intervalCounts['0-15ì´ˆ'] + intervalCounts['15-30ì´ˆ'];
            const secondHalfCount = intervalCounts['30-45ì´ˆ'] + intervalCounts['45-60ì´ˆ'];
            
            // ì¤‘ë³µ ë° ì¹¨íˆ¬ ê³„ì‚°
            const animalFrequency = {};
            let intrusionCount = 0;
            let validAnimalCount = 0;
            
            animals.forEach(animal => {
                if (animal.isAnimal) {
                    // ë™ë¬¼ì¸ ê²½ìš° ê¸°ë³¸í˜•ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬
                    const baseAnimal = animal.baseAnimal || animal.name;
                    animalFrequency[baseAnimal] = (animalFrequency[baseAnimal] || 0) + 1;
                    validAnimalCount++;
                } else {
                    // ë™ë¬¼ì´ ì•„ë‹Œ ê²½ìš° ì¹¨íˆ¬ë¡œ ê³„ì‚°
                    intrusionCount++;
                }
            });
            const duplicates = Object.values(animalFrequency).filter(count => count > 1).reduce((sum, count) => sum + (count - 1), 0);
            
            // CFTSCORING ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ë¶„ì„
            const allResponses = [];
            animals.forEach((animal, index) => {
                const timestamp = animal.timestamp;
                const timeSeconds = Math.floor(timestamp / 1000);
                const timeRange = timeSeconds < 15 ? '0-15' : 
                                timeSeconds < 30 ? '15-30' : 
                                timeSeconds < 45 ? '30-45' : '45-60';
                
                const normalizedResponse = normalizeAnimalName(animal.name);
                if (normalizedResponse) {
                    allResponses.push({
                        response: animal.name,
                        normalizedResponse: normalizedResponse,
                        timeRange: timeRange,
                        order: index + 1
                    });
                }
            });
            
            const { transitions, clusters, switchingScore, inefficientSwitchingScore } = 
                analyzeTransitionsAndClusters(allResponses);
            
            // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚° (CFTSCORING ì•Œê³ ë¦¬ì¦˜)
            const weightedScore = intervalCounts['0-15ì´ˆ'] * 1.0 + 
                                intervalCounts['15-30ì´ˆ'] * 0.75 + 
                                intervalCounts['30-45ì´ˆ'] * 0.5 + 
                                intervalCounts['45-60ì´ˆ'] * 0.25;
            
            // ë²”ì£¼ ì ìˆ˜ ê³„ì‚° (í¬ê¸° 2 ì´ìƒì˜ í´ëŸ¬ìŠ¤í„°ë§Œ ë²”ì£¼ë¡œ ì¸ì •)
            const validClusters = clusters.filter(cluster => cluster.size >= 2);
            const usedCategories = new Set();
            validClusters.forEach(cluster => {
                if (cluster.commonCategories.length > 0) {
                    usedCategories.add(cluster.commonCategories[0]);
                }
            });
            const categoryScore = usedCategories.size;
            
            // í´ëŸ¬ìŠ¤í„° í†µê³„
            const validClusterSizes = validClusters.map(c => c.size);
            const avgClusterSize = validClusterSizes.length > 0 
                ? (validClusterSizes.reduce((sum, size) => sum + size, 0) / validClusterSizes.length).toFixed(1)
                : '0.0';
            const maxClusterSize = Math.max(...validClusterSizes, 0);
            
            // CFTSCORING íŒë…ë¬¸ ìƒì„±
            const scores = {
                uniqueCount: uniqueCount,
                intervalCounts: intervalCounts,
                duplicates: duplicates,
                intrusions: 0, // ëª…ì‚¬ë§Œ ì¸ì‹í•˜ë¯€ë¡œ ì¹¨íˆ¬ ì˜¤ë¥˜ëŠ” 0
                numberOfClusters: clusters.length,
                meanClusterSize: parseFloat(avgClusterSize),
                clusterSizes: validClusterSizes,
                switchingScore: switchingScore,
                inefficientSwitchingScore: inefficientSwitchingScore,
                categoryScore: categoryScore
            };
            
            const interpretationResult = analyzePatternAndGenerateInterpretation(scores);
            
            // ìˆ˜í–‰ ìˆ˜ì¤€ íŒì •
            let performanceLevel = '';
            let performanceColor = '';
            if (uniqueCount >= 15) {
                performanceLevel = 'ì •ìƒ ë²”ìœ„';
                performanceColor = '#28a745';
            } else if (uniqueCount >= 10) {
                performanceLevel = 'ê²½ê³„ì„  ìˆ˜ì¤€';
                performanceColor = '#ffc107';
            } else {
                performanceLevel = 'ì €ì¡°í•œ ìˆ˜í–‰';
                performanceColor = '#dc3545';
            }
            
            // CFTSCORING ìŠ¤íƒ€ì¼ì˜ ìƒì„¸ ë³´ê³ ì„œ ìƒì„±
            resultsSection.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                    <!-- í—¤ë” -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
                        <h1 style="margin: 0; font-size: 32px;">ë™ë¬¼ ë²”ì£¼ ì–¸ì–´ìœ ì°½ì„±ê²€ì‚¬ ê²°ê³¼ ë³´ê³ ì„œ</h1>
                        <p style="margin-top: 10px; opacity: 0.9;">ê²€ì‚¬ì¼ì‹œ: ${testDate.toLocaleString()}</p>
                    </div>
                    
                    <!-- ì£¼ìš” ê²°ê³¼ ìš”ì•½ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì£¼ìš” ê²°ê³¼</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #667eea;">${uniqueCount}</div>
                                <div style="color: #666; margin-top: 5px;">ê³ ìœ  ë™ë¬¼ ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #764ba2;">${totalCount}</div>
                                <div style="color: #666; margin-top: 5px;">ì´ ì‘ë‹µ ìˆ˜</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #ff6b6b;">${duplicates}</div>
                                <div style="color: #666; margin-top: 5px;">ì¤‘ë³µ ì‘ë‹µ</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 48px; font-weight: bold; color: #51cf66;">${weightedScore.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ê°€ì¤‘ì¹˜ ì ìˆ˜</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìˆ˜í–‰ í‰ê°€ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ìˆ˜í–‰ í‰ê°€</h2>
                        <div style="text-align: center; padding: 30px; background: ${performanceColor}20; border-radius: 10px; border: 2px solid ${performanceColor};">
                            <div style="font-size: 28px; font-weight: bold; color: ${performanceColor};">
                                ${performanceLevel}
                            </div>
                            <div style="margin-top: 10px; color: #666;">
                                ${uniqueCount >= 15 ? 'ì •ìƒì ì¸ ì–¸ì–´ìœ ì°½ì„±ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.' : 
                                  uniqueCount >= 10 ? 'ì¶”ê°€ì ì¸ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 
                                  'ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‹œê°„ëŒ€ë³„ ë¶„ì„ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì‹œê°„ëŒ€ë³„ ìˆ˜í–‰ ë¶„ì„</h2>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <div style="background: #667eea; color: white; padding: 10px; border-radius: 5px 5px 0 0;">0-15ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['0-15ì´ˆ']}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #764ba2; color: white; padding: 10px; border-radius: 5px 5px 0 0;">15-30ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['15-30ì´ˆ']}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #9775fa; color: white; padding: 10px; border-radius: 5px 5px 0 0;">30-45ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['30-45ì´ˆ']}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: #b197fc; color: white; padding: 10px; border-radius: 5px 5px 0 0;">45-60ì´ˆ</div>
                                <div style="background: #f8f9fa; padding: 20px; font-size: 24px; font-weight: bold;">${intervalCounts['45-60ì´ˆ']}</div>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-around;">
                                <div>
                                    <strong>ì „ë°˜ë¶€ (0-30ì´ˆ):</strong> ${firstHalfCount}ê°œ
                                </div>
                                <div>
                                    <strong>í›„ë°˜ë¶€ (30-60ì´ˆ):</strong> ${secondHalfCount}ê°œ
                                </div>
                                <div>
                                    <strong>ê°ì†Œìœ¨:</strong> ${firstHalfCount > 0 ? ((1 - secondHalfCount/firstHalfCount) * 100).toFixed(1) : 0}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‘ë‹µ ëª©ë¡ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì‘ë‹µ ëª©ë¡</h2>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                            ${animals.map((animal, index) => {
                                const time = ((animal.timestamp - startTime) / 1000).toFixed(1);
                                const isDuplicate = animalFrequency[animal.name] > 1;
                                return `<span style="display: inline-block; margin: 5px; padding: 5px 10px; background: ${isDuplicate ? '#ffe8e8' : '#e8f5e9'}; border-radius: 5px; ${isDuplicate ? 'color: #d32f2f;' : ''}">${index + 1}. ${animal.name} (${time}ì´ˆ)</span>`;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- í´ëŸ¬ìŠ¤í„° ë¶„ì„ -->
                    ${clusters.length > 0 ? `
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">ì˜ë¯¸ ë²”ì£¼ ë¶„ì„</h2>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p><strong>í™•ì¸ëœ ì˜ë¯¸ ë²”ì£¼:</strong> ${clusters.length}ê°œ</p>
                            <div style="margin-top: 10px;">
                                ${clusters.map(cluster => `
                                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${cluster.category}:</strong> ${cluster.items.join(', ')} (${cluster.items.length}ê°œ)
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- CFTSCORING íŒë… ê²°ê³¼ -->
                    <div style="background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">íŒë… ê²°ê³¼</h2>
                        <div style="background: #f0f8ff; padding: 25px; border-radius: 10px; border-left: 5px solid #1565c0;">
                            <p style="line-height: 1.8; color: #333; font-size: 16px; margin: 0;">
                                ${interpretationResult.interpretation}
                            </p>
                        </div>
                    </div>
                    
                    <!-- ë²„íŠ¼ -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="background-color: #667eea; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-print"></i> ì¸ì‡„í•˜ê¸°
                        </button>
                        <button onclick="window.location.href = window.location.pathname" style="background-color: #764ba2; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-redo"></i> ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // ìŒì„± ì•ˆë‚´
            speak("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
        
        // CFTSCORING AnimalFluencyInterpreter í´ë˜ìŠ¤ ì¶”ê°€
        class AnimalFluencyInterpreter {
            constructor() {
                this.normData = {
                    '20-29': { mean: 21.7, sd: 5.1 },
                    '30-39': { mean: 21.2, sd: 5.2 },
                    '40-49': { mean: 19.8, sd: 4.8 },
                    '50-59': { mean: 18.5, sd: 4.6 },
                    '60-69': { mean: 16.3, sd: 4.4 },
                    '70-79': { mean: 14.2, sd: 3.9 },
                    '80+': { mean: 11.8, sd: 3.5 }
                };
                
                this.qualitative_criteria = {
                    ìµœëŒ€ë²”ì£¼í¬ê¸°: 4,
                    ì „í™˜ë¹„ìœ¨: 0.5,
                    ë¹„íš¨ìœ¨ì „í™˜ë¹„ìœ¨: 0.3
                };
            }
            
            getAgeGroup(age) {
                if (age < 30) return '20-29';
                if (age < 40) return '30-39';
                if (age < 50) return '40-49';
                if (age < 60) return '50-59';
                if (age < 70) return '60-69';
                if (age < 80) return '70-79';
                return '80+';
            }
            
            calculateZScore(score, ageGroup) {
                const norm = this.normData[ageGroup];
                return (score - norm.mean) / norm.sd;
            }
            
            calculatePercentile(zScore) {
                // ê°„ë‹¨í•œ ì •ê·œë¶„í¬ ê·¼ì‚¬
                const percentile = 50 + (zScore * 15);
                return Math.max(1, Math.min(99, Math.round(percentile)));
            }
            
            ì´ì _í•´ì„(ì´ì , z_score, percentile) {
                let í•´ì„ = `ì´ ${ì´ì }ê°œì˜ ë™ë¬¼ì„ ë§ì”€í•˜ì…¨ìŠµë‹ˆë‹¤. `;
                let ìˆ˜í–‰ìˆ˜ì¤€ = '';
                
                if (z_score >= 0) {
                    í•´ì„ += `ì´ëŠ” ì—°ë ¹ ê·œì¤€ ìƒ í‰ê·  ì´ìƒì˜ ìˆ˜í–‰ìœ¼ë¡œ, ìƒìœ„ ${100-percentile}% ìˆ˜ì¤€ì…ë‹ˆë‹¤. `;
                    ìˆ˜í–‰ìˆ˜ì¤€ = 'ì •ìƒ';
                } else if (z_score > -1) {
                    í•´ì„ += `ì´ëŠ” ì—°ë ¹ ê·œì¤€ ìƒ í‰ê·  ë²”ìœ„ì˜ ìˆ˜í–‰ìœ¼ë¡œ, í•˜ìœ„ ${percentile}% ìˆ˜ì¤€ì…ë‹ˆë‹¤. `;
                    ìˆ˜í–‰ìˆ˜ì¤€ = 'ì •ìƒ';
                } else if (z_score > -1.5) {
                    í•´ì„ += `ì´ëŠ” ì—°ë ¹ ê·œì¤€ ìƒ í‰ê·  í•˜ ìˆ˜ì¤€ì˜ ìˆ˜í–‰ìœ¼ë¡œ, í•˜ìœ„ ${percentile}% ìˆ˜ì¤€ì…ë‹ˆë‹¤. `;
                    ìˆ˜í–‰ìˆ˜ì¤€ = 'ê²½ê³„ì„ ';
                } else {
                    í•´ì„ += `ì´ëŠ” ì—°ë ¹ ê·œì¤€ ìƒ í˜„ì €íˆ ë‚®ì€ ìˆ˜í–‰ìœ¼ë¡œ, í•˜ìœ„ ${percentile}% ìˆ˜ì¤€ì…ë‹ˆë‹¤. `;
                    ìˆ˜í–‰ìˆ˜ì¤€ = 'ì €í•˜';
                }
                
                return [í•´ì„, ìˆ˜í–‰ìˆ˜ì¤€];
            }
            
            ì‹œê°„íŒ¨í„´_í•´ì„(ì „ë°˜30ì´ˆ, í›„ë°˜30ì´ˆ) {
                const ê°ì†Œìœ¨ = ì „ë°˜30ì´ˆ > 0 ? ((ì „ë°˜30ì´ˆ - í›„ë°˜30ì´ˆ) / ì „ë°˜30ì´ˆ * 100).toFixed(0) : 0;
                
                if (ê°ì†Œìœ¨ < 30) {
                    return `ì „ë°˜ 30ì´ˆì™€ í›„ë°˜ 30ì´ˆì˜ ìˆ˜í–‰ì´ ë¹„êµì  ê· ë“±í•˜ì—¬ ì§€ì†ì ì¸ ì¸ì¶œ ëŠ¥ë ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.`;
                } else if (ê°ì†Œìœ¨ < 50) {
                    return `í›„ë°˜ë¶€ë¡œ ê°ˆìˆ˜ë¡ ì•½ê°„ì˜ ìˆ˜í–‰ ì €í•˜ê°€ ê´€ì°°ë˜ë‚˜ ì •ìƒ ë²”ìœ„ ë‚´ì˜ íŒ¨í„´ì…ë‹ˆë‹¤.`;
                } else {
                    return `í›„ë°˜ë¶€ì— í˜„ì €í•œ ìˆ˜í–‰ ì €í•˜(${ê°ì†Œìœ¨}% ê°ì†Œ)ê°€ ê´€ì°°ë˜ì–´ ì¸ì¶œ íš¨ìœ¨ì„±ì˜ ì €í•˜ê°€ ì‹œì‚¬ë©ë‹ˆë‹¤.`;
                }
            }
            
            ì˜¤ë¥˜_í•´ì„(ë³´ì†ì˜¤ë¥˜, ì¹¨íˆ¬ì˜¤ë¥˜) {
                let í•´ì„ = [];
                
                if (ë³´ì†ì˜¤ë¥˜ === 0 && ì¹¨íˆ¬ì˜¤ë¥˜ === 0) {
                    í•´ì„.push("ì˜¤ë¥˜ ë°˜ì‘ ì—†ì´ ì •í™•í•œ ìˆ˜í–‰ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.");
                } else {
                    if (ë³´ì†ì˜¤ë¥˜ > 0) {
                        if (ë³´ì†ì˜¤ë¥˜ <= 2) {
                            í•´ì„.push(`${ë³´ì†ì˜¤ë¥˜}íšŒì˜ ë°˜ë³µ ì˜¤ë¥˜ê°€ ìˆì—ˆìœ¼ë‚˜ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤.`);
                        } else {
                            í•´ì„.push(`${ë³´ì†ì˜¤ë¥˜}íšŒì˜ ë°˜ë³µ ì˜¤ë¥˜ê°€ ê´€ì°°ë˜ì–´ ìê¸° ì ê²€ ëŠ¥ë ¥ì˜ ì €í•˜ê°€ ì‹œì‚¬ë©ë‹ˆë‹¤.`);
                        }
                    }
                    
                    if (ì¹¨íˆ¬ì˜¤ë¥˜ > 0) {
                        í•´ì„.push(`${ì¹¨íˆ¬ì˜¤ë¥˜}íšŒì˜ ì¹¨íˆ¬ ì˜¤ë¥˜ê°€ ê´€ì°°ë˜ì–´ ë²”ì£¼ ìœ ì§€ ëŠ¥ë ¥ì˜ ì €í•˜ê°€ ì‹œì‚¬ë©ë‹ˆë‹¤.`);
                    }
                }
                
                return í•´ì„.join(" ");
            }
            
            ë²”ì£¼í¬ê¸°_í•´ì„(í‰ê· ë²”ì£¼í¬ê¸°, ìµœëŒ€ë²”ì£¼í¬ê¸°, ë²”ì£¼ìˆ˜) {
                let í•´ì„ = [];
                
                if (í‰ê· ë²”ì£¼í¬ê¸° >= 3) {
                    í•´ì„.push("ì˜ë¯¸ì ìœ¼ë¡œ ì—°ê´€ëœ í•­ëª©ë“¤ì„ íš¨ê³¼ì ìœ¼ë¡œ êµ°ì§‘í™”í•˜ì—¬ ì¸ì¶œí•˜ì˜€ìŠµë‹ˆë‹¤.");
                } else if (í‰ê· ë²”ì£¼í¬ê¸° >= 2) {
                    í•´ì„.push("ì¼ë¶€ ì˜ë¯¸ì  êµ°ì§‘í™”ê°€ ê´€ì°°ë˜ë‚˜ ì œí•œì ì…ë‹ˆë‹¤.");
                } else {
                    í•´ì„.push("ì˜ë¯¸ì  êµ°ì§‘í™”ê°€ ê±°ì˜ ê´€ì°°ë˜ì§€ ì•Šì•„ ì²´ê³„ì  ì¸ì¶œ ì „ëµì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                }
                
                if (ìµœëŒ€ë²”ì£¼í¬ê¸° >= this.qualitative_criteria.ìµœëŒ€ë²”ì£¼í¬ê¸°) {
                    í•´ì„.push(`ìµœëŒ€ ${ìµœëŒ€ë²”ì£¼í¬ê¸°}ê°œì˜ í•­ëª©ì„ í¬í•¨í•˜ëŠ” ë²”ì£¼ë¥¼ ìƒì„±í•˜ì—¬ íŠ¹ì • í•˜ìœ„ ë²”ì£¼ì— ëŒ€í•œ ì–‘í˜¸í•œ ì§€ì‹ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.`);
                }
                
                return í•´ì„.join(" ");
            }
            
            ì „í™˜íŒ¨í„´_í•´ì„(ì „í™˜ìˆ˜, ë¹„íš¨ìœ¨ì „í™˜ìˆ˜, ë²”ì£¼ìˆ˜) {
                const ì „í™˜ë¹„ìœ¨ = ë²”ì£¼ìˆ˜ > 0 ? ì „í™˜ìˆ˜ / ë²”ì£¼ìˆ˜ : 0;
                const ë¹„íš¨ìœ¨ì „í™˜ë¹„ìœ¨ = ì „í™˜ìˆ˜ > 0 ? ë¹„íš¨ìœ¨ì „í™˜ìˆ˜ / ì „í™˜ìˆ˜ : 0;
                
                let í•´ì„ = [];
                
                if (ì „í™˜ë¹„ìœ¨ >= 1.5) {
                    í•´ì„.push("ë²”ì£¼ ê°„ ì „í™˜ì´ í™œë°œí•˜ì—¬ ì¸ì§€ì  ìœ ì—°ì„±ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.");
                } else if (ì „í™˜ë¹„ìœ¨ >= 0.8) {
                    í•´ì„.push("ì ì ˆí•œ ìˆ˜ì¤€ì˜ ë²”ì£¼ ê°„ ì „í™˜ì„ ë³´ì…ë‹ˆë‹¤.");
                } else {
                    í•´ì„.push("ë²”ì£¼ ê°„ ì „í™˜ì´ ì œí•œì ì´ì–´ì„œ ì¸ì§€ì  ìœ ì—°ì„±ì˜ ì €í•˜ê°€ ì‹œì‚¬ë©ë‹ˆë‹¤.");
                }
                
                if (ë¹„íš¨ìœ¨ì „í™˜ë¹„ìœ¨ > 0.3) {
                    í•´ì„.push("ë¹„íš¨ìœ¨ì  ì „í™˜ì´ ë§ì•„ ì²´ê³„ì  ì¸ì¶œ ì „ëµì˜ ë¶€ì¡±ì´ ì‹œì‚¬ë©ë‹ˆë‹¤.");
                }
                
                return í•´ì„.join(" ");
            }
            
            ë²”ì£¼ì¡°ì§í™”_ì¢…í•©í•´ì„(ë²”ì£¼ìˆ˜, í‰ê· ë²”ì£¼í¬ê¸°, ì „í™˜ìˆ˜, ë¹„íš¨ìœ¨ì „í™˜ìˆ˜) {
                if (ë²”ì£¼ìˆ˜ >= 5 && í‰ê· ë²”ì£¼í¬ê¸° >= 3) {
                    return "ì „ë°˜ì ìœ¼ë¡œ ì˜ë¯¸ ê¸°ì–µì˜ ì¡°ì§í™”ê°€ ì˜ ìœ ì§€ë˜ê³  ìˆìœ¼ë©°, íš¨ê³¼ì ì¸ ì¸ì¶œ ì „ëµì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.";
                } else if (ë²”ì£¼ìˆ˜ >= 3 && í‰ê· ë²”ì£¼í¬ê¸° >= 2) {
                    return "ì˜ë¯¸ ê¸°ì–µì˜ ì¡°ì§í™”ê°€ ë¶€ë¶„ì ìœ¼ë¡œ ìœ ì§€ë˜ê³  ìˆìœ¼ë‚˜, ì¸ì¶œ íš¨ìœ¨ì„±ì€ ë‹¤ì†Œ ì €í•˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
                } else {
                    return "ì˜ë¯¸ ê¸°ì–µì˜ ì¡°ì§í™”ì™€ ì²´ê³„ì  ì¸ì¶œ ì „ëµ ì‚¬ìš©ì— ì–´ë ¤ì›€ì´ ê´€ì°°ë©ë‹ˆë‹¤.";
                }
            }
            
            ì„ìƒí”„ë¡œíŒŒì¼_í•´ì„(ì „í™˜ìˆ˜, ë¹„íš¨ìœ¨ì „í™˜ìˆ˜, ë²”ì£¼ìˆ˜, í‰ê· ë²”ì£¼í¬ê¸°, ìµœëŒ€ë²”ì£¼í¬ê¸°) {
                // ì•Œì¸ í•˜ì´ë¨¸ íŒ¨í„´: ë‚®ì€ ì´ì , ì‘ì€ ë²”ì£¼ í¬ê¸°, ì ì€ ì „í™˜
                if (ë²”ì£¼ìˆ˜ < 3 && í‰ê· ë²”ì£¼í¬ê¸° < 2 && ì „í™˜ìˆ˜ < 5) {
                    return "ìˆ˜í–‰ íŒ¨í„´ì´ ì˜ë¯¸ ê¸°ì–µ ì €ì¥ì†Œ ìì²´ì˜ ì†ìƒì„ ì‹œì‚¬í•˜ë©°, ì¶”ê°€ì ì¸ ì‹ ê²½ì‹¬ë¦¬í‰ê°€ê°€ ê¶Œì¥ë©ë‹ˆë‹¤.";
                }
                
                // ì „ë‘ì—½ ê¸°ëŠ¥ì¥ì•  íŒ¨í„´: ë§ì€ ë¹„íš¨ìœ¨ì „í™˜, ë‚®ì€ êµ°ì§‘í™”
                if (ë¹„íš¨ìœ¨ì „í™˜ìˆ˜ > ì „í™˜ìˆ˜ * 0.4 && í‰ê· ë²”ì£¼í¬ê¸° < 2.5) {
                    return "ìˆ˜í–‰ íŒ¨í„´ì´ ì‹¤í–‰ê¸°ëŠ¥ì˜ ì €í•˜ë¥¼ ì‹œì‚¬í•˜ë©°, ì „ë‘ì—½ ê¸°ëŠ¥ì— ëŒ€í•œ ì¶”ê°€ í‰ê°€ê°€ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                }
                
                return null;
            }
            
            íŠ¹ì •íŒ¨í„´_íŒì •(ê²€ì‚¬ê²°ê³¼) {
                const patterns = [];
                
                // ì´ˆê¸° ë²„ìŠ¤íŠ¸ íŒ¨í„´
                if (ê²€ì‚¬ê²°ê³¼['0-15ì´ˆ'] >= ê²€ì‚¬ê²°ê³¼.ì´ì  * 0.5) {
                    patterns.push({
                        name: "ì´ˆê¸° ë²„ìŠ¤íŠ¸",
                        message: "ê²€ì‚¬ ì´ˆë°˜ì— ì§‘ì¤‘ì ìœ¼ë¡œ ë°˜ì‘ì´ ë‚˜íƒ€ë‚˜ëŠ” ì „í˜•ì ì¸ íŒ¨í„´ì„ ë³´ì…ë‹ˆë‹¤."
                    });
                }
                
                // ì§€ì†ì  ì‚°ì¶œ íŒ¨í„´
                const êµ¬ê°„ë³„_ë¹„ìœ¨ = [
                    ê²€ì‚¬ê²°ê³¼['0-15ì´ˆ'] / ê²€ì‚¬ê²°ê³¼.ì´ì ,
                    ê²€ì‚¬ê²°ê³¼['15-30ì´ˆ'] / ê²€ì‚¬ê²°ê³¼.ì´ì ,
                    ê²€ì‚¬ê²°ê³¼['30-45ì´ˆ'] / ê²€ì‚¬ê²°ê³¼.ì´ì ,
                    ê²€ì‚¬ê²°ê³¼['45-60ì´ˆ'] / ê²€ì‚¬ê²°ê³¼.ì´ì 
                ];
                
                const ë¹„ìœ¨_í‘œì¤€í¸ì°¨ = this.ê³„ì‚°_í‘œì¤€í¸ì°¨(êµ¬ê°„ë³„_ë¹„ìœ¨);
                if (ë¹„ìœ¨_í‘œì¤€í¸ì°¨ < 0.1) {
                    patterns.push({
                        name: "ì§€ì†ì  ì‚°ì¶œ",
                        message: "ì‹œê°„ëŒ€ë³„ë¡œ ê· ë“±í•œ ì‚°ì¶œì„ ë³´ì—¬ ì•ˆì •ì ì¸ ì¸ì¶œ ëŠ¥ë ¥ì„ ì‹œì‚¬í•©ë‹ˆë‹¤."
                    });
                }
                
                return patterns.length > 0 ? patterns[0] : null;
            }
            
            ê³„ì‚°_í‘œì¤€í¸ì°¨(ë°°ì—´) {
                const í‰ê·  = ë°°ì—´.reduce((a, b) => a + b, 0) / ë°°ì—´.length;
                const ë¶„ì‚° = ë°°ì—´.reduce((sum, x) => sum + Math.pow(x - í‰ê· , 2), 0) / ë°°ì—´.length;
                return Math.sqrt(ë¶„ì‚°);
            }
            
            í†µí•©_íŒë…ë¬¸_ìƒì„±(ê²€ì‚¬ê²°ê³¼) {
                const íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ = [];
                
                // 1. ì´ì  ê¸°ë°˜ í•´ì„
                const [ì´ì í•´ì„, ìˆ˜í–‰ìˆ˜ì¤€] = this.ì´ì _í•´ì„(ê²€ì‚¬ê²°ê³¼.ì´ì , ê²€ì‚¬ê²°ê³¼.z_score, ê²€ì‚¬ê²°ê³¼.percentile);
                íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(ì´ì í•´ì„);
                
                // 2. ì‹œê°„ íŒ¨í„´ í•´ì„
                const ì‹œê°„í•´ì„ = this.ì‹œê°„íŒ¨í„´_í•´ì„(ê²€ì‚¬ê²°ê³¼.ì „ë°˜30ì´ˆ, ê²€ì‚¬ê²°ê³¼.í›„ë°˜30ì´ˆ);
                íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(ì‹œê°„í•´ì„);
                
                // 3. ì˜¤ë¥˜ í•´ì„
                const ì˜¤ë¥˜í•´ì„ = this.ì˜¤ë¥˜_í•´ì„(ê²€ì‚¬ê²°ê³¼.ë³´ì†ì˜¤ë¥˜, ê²€ì‚¬ê²°ê³¼.ì¹¨íˆ¬ì˜¤ë¥˜);
                íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(ì˜¤ë¥˜í•´ì„);
                
                // 4. ë²”ì£¼ í¬ê¸° ë¶„ì„
                const ë²”ì£¼í¬ê¸°í•´ì„ = this.ë²”ì£¼í¬ê¸°_í•´ì„(ê²€ì‚¬ê²°ê³¼.í‰ê· ë²”ì£¼í¬ê¸°, ê²€ì‚¬ê²°ê³¼.ìµœëŒ€ë²”ì£¼í¬ê¸°, ê²€ì‚¬ê²°ê³¼.ë²”ì£¼ìˆ˜);
                íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(ë²”ì£¼í¬ê¸°í•´ì„);
                
                // 5. ì „í™˜ íŒ¨í„´ ë¶„ì„
                const ì „í™˜í•´ì„ = this.ì „í™˜íŒ¨í„´_í•´ì„(ê²€ì‚¬ê²°ê³¼.ì „í™˜ìˆ˜, ê²€ì‚¬ê²°ê³¼.ë¹„íš¨ìœ¨ì „í™˜ìˆ˜, ê²€ì‚¬ê²°ê³¼.ë²”ì£¼ìˆ˜);
                íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(ì „í™˜í•´ì„);
                
                // 6. ë²”ì£¼ ì¡°ì§í™” ì¢…í•©
                const ì¡°ì§í™”í•´ì„ = this.ë²”ì£¼ì¡°ì§í™”_ì¢…í•©í•´ì„(ê²€ì‚¬ê²°ê³¼.ë²”ì£¼ìˆ˜, ê²€ì‚¬ê²°ê³¼.í‰ê· ë²”ì£¼í¬ê¸°, ê²€ì‚¬ê²°ê³¼.ì „í™˜ìˆ˜, ê²€ì‚¬ê²°ê³¼.ë¹„íš¨ìœ¨ì „í™˜ìˆ˜);
                íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(ì¡°ì§í™”í•´ì„);
                
                // 7. ì„ìƒ í”„ë¡œíŒŒì¼
                const í”„ë¡œíŒŒì¼í•´ì„ = this.ì„ìƒí”„ë¡œíŒŒì¼_í•´ì„(ê²€ì‚¬ê²°ê³¼.ì „í™˜ìˆ˜, ê²€ì‚¬ê²°ê³¼.ë¹„íš¨ìœ¨ì „í™˜ìˆ˜, ê²€ì‚¬ê²°ê³¼.ë²”ì£¼ìˆ˜, ê²€ì‚¬ê²°ê³¼.í‰ê· ë²”ì£¼í¬ê¸°, ê²€ì‚¬ê²°ê³¼.ìµœëŒ€ë²”ì£¼í¬ê¸°);
                if (í”„ë¡œíŒŒì¼í•´ì„) {
                    íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(í”„ë¡œíŒŒì¼í•´ì„);
                }
                
                // 8. íŠ¹ì • íŒ¨í„´ íŒì • ì¶”ê°€
                const íŠ¹ì •íŒ¨í„´ = this.íŠ¹ì •íŒ¨í„´_íŒì •(ê²€ì‚¬ê²°ê³¼);
                if (íŠ¹ì •íŒ¨í„´) {
                    íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.push(íŠ¹ì •íŒ¨í„´.message);
                }
                
                return íŒë…ë¬¸_êµ¬ì„±ìš”ì†Œ.join(" ");
            }
        }
        
        // íŒ¨í„´ ë¶„ì„ í•¨ìˆ˜ ì¶”ê°€
        function analyzePatternAndGenerateInterpretation(scores) {
            const interpreter = new AnimalFluencyInterpreter();
            
            // ì‚¬ìš©ì ì—°ë ¹ ê¸°ë°˜ ì—°ë ¹ ê·¸ë£¹ ê²°ì •
            const age = parseInt(userInfo.age) || 65; // ê¸°ë³¸ê°’ 65ì„¸
            const ageGroup = interpreter.getAgeGroup(age);
            
            // Z-scoreì™€ percentile ê³„ì‚°
            const zScore = interpreter.calculateZScore(scores.uniqueCount, ageGroup);
            const percentile = interpreter.calculatePercentile(zScore);
            
            // ê²€ì‚¬ ê²°ê³¼ ë°ì´í„° êµ¬ì„±
            const totalScore = scores.uniqueCount;
            const switching = scores.numberOfClusters > 0 ? scores.numberOfClusters - 1 : 0;
            const meanClusterSize = scores.meanClusterSize || 1;
            const hardSwitching = Math.floor(switching * 0.2);
            
            const ê²€ì‚¬ê²°ê³¼ = {
                ì´ì : totalScore,
                z_score: zScore,
                percentile: percentile,
                '0-15ì´ˆ': scores.intervalCounts['0-15ì´ˆ'] || 0,
                '15-30ì´ˆ': scores.intervalCounts['15-30ì´ˆ'] || 0,
                '30-45ì´ˆ': scores.intervalCounts['30-45ì´ˆ'] || 0,
                '45-60ì´ˆ': scores.intervalCounts['45-60ì´ˆ'] || 0,
                ì „ë°˜30ì´ˆ: (scores.intervalCounts['0-15ì´ˆ'] || 0) + (scores.intervalCounts['15-30ì´ˆ'] || 0),
                í›„ë°˜30ì´ˆ: (scores.intervalCounts['30-45ì´ˆ'] || 0) + (scores.intervalCounts['45-60ì´ˆ'] || 0),
                ë³´ì†ì˜¤ë¥˜: scores.duplicates || 0,
                ì¹¨íˆ¬ì˜¤ë¥˜: scores.intrusions || 0,
                ë²”ì£¼ìˆ˜: scores.numberOfClusters || 1,
                í‰ê· ë²”ì£¼í¬ê¸°: meanClusterSize,
                ìµœëŒ€ë²”ì£¼í¬ê¸°: Math.max(...(scores.clusterSizes || [meanClusterSize])),
                ì „í™˜ìˆ˜: switching,
                ë¹„íš¨ìœ¨ì „í™˜ìˆ˜: hardSwitching
            };
            
            // í†µí•© íŒë…ë¬¸ ìƒì„±
            const interpretation = interpreter.í†µí•©_íŒë…ë¬¸_ìƒì„±(ê²€ì‚¬ê²°ê³¼);
            console.log('ìƒì„±ëœ í•´ì„:', interpretation);
            
            // í•´ì„ì´ ê°ì²´ì¸ ê²½ìš° interpretation ì†ì„±ì„ ë°˜í™˜, ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
            const finalInterpretation = typeof interpretation === 'object' && interpretation.interpretation 
                ? interpretation.interpretation 
                : interpretation;
            
            console.log('ìµœì¢… í•´ì„:', finalInterpretation);
            
            return finalInterpretation || 'ê²€ì‚¬ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„ìƒì  í•´ì„ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.';
        }
        
        // ë‚´ë¶€ ë¶„ì„ í•¨ìˆ˜ë“¤ì€ ëª¨ë‘ ì œê±°
        /*
            const counts = {
                '0-15ì´ˆ': intervalStats['0-15ì´ˆ'].length,
                '15-30ì´ˆ': intervalStats['15-30ì´ˆ'].length,
                '30-45ì´ˆ': intervalStats['30-45ì´ˆ'].length,
                '45-60ì´ˆ': intervalStats['45-60ì´ˆ'].length
            };
            
            // ì „ì²´ ë™ë¬¼ ë¦¬ìŠ¤íŠ¸ (ìœ íš¨í•œ ë™ë¬¼ë§Œ)
            const allAnimals = [];
            const allValidAnimals = [];
            Object.values(intervalStats).forEach(interval => {
                interval.forEach(animal => {
                    allAnimals.push(animal.name);
                    if (animal.isAnimal) {
                        allValidAnimals.push(animal.name);
                    }
                });
            });
            
            // ì „ë°˜ë¶€/í›„ë°˜ë¶€ ê³„ì‚°
            const firstHalfAnimals = [...intervalStats['0-15ì´ˆ'], ...intervalStats['15-30ì´ˆ']];
            const secondHalfAnimals = [...intervalStats['30-45ì´ˆ'], ...intervalStats['45-60ì´ˆ']];
            const firstHalfScore = new Set(firstHalfAnimals).size;
            const secondHalfScore = new Set(secondHalfAnimals).size;
            
            // ë³´ì† ê³„ì‚° (ì¤‘ë³µëœ ë™ë¬¼)
            const animalCounts = {};
            allAnimals.forEach(animal => {
                animalCounts[animal] = (animalCounts[animal] || 0) + 1;
            });
            const perseverationScore = Object.values(animalCounts).filter(count => count > 1).reduce((sum, count) => sum + (count - 1), 0);
            
            // ì¹¨íˆ¬ ê³„ì‚°ì€ ì´ë¯¸ ìœ„ì—ì„œ intrusionCountë¡œ ê³„ì‚°ë¨
            const intrusionScore = intrusionCount;
            
            // ë²”ì£¼ ë¶„ì„ (ê°„ë‹¨í•œ ë²„ì „)
            const categoryAnalysis = analyzeClusters(allAnimals);
            
            // ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚° (CFTSCORING ë¡œì§ ì°¸ì¡°)
            const weightedScore = 
                counts['0-15ì´ˆ'] * 1.0 + 
                counts['15-30ì´ˆ'] * 0.75 + 
                counts['30-45ì´ˆ'] * 0.5 + 
                counts['45-60ì´ˆ'] * 0.25;
            
            // ì´ì  (ìœ íš¨í•œ ë™ë¬¼ë§Œ ê³„ì‚°)
            const totalScore = validAnimalCount - duplicates;
            
            // ê²°ê³¼ í•´ì„
            let interpretation = '';
            if (totalScore >= 15) {
                interpretation = 'ì •ìƒ ë²”ìœ„ì˜ ìˆ˜í–‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ë™ë¬¼ ì´ë¦„ ìƒì„± ëŠ¥ë ¥ì´ ì—°ë ¹ëŒ€ì— ì í•©í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ë²”ì£¼ ê°„ ì „í™˜ ëŠ¥ë ¥ê³¼ ì§€ì†ì ì¸ ì¸ì¶œ ëŠ¥ë ¥ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.';
            } else if (totalScore >= 10) {
                interpretation = 'ê²½ê³„ì„  ìˆ˜ì¤€ì˜ ìˆ˜í–‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ì¸ì§€ê¸°ëŠ¥ í‰ê°€ë¥¼ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ ì „ë°˜ë¶€ì™€ í›„ë°˜ë¶€ì˜ ìˆ˜í–‰ ì°¨ì´ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.';
            } else {
                interpretation = 'ì €ì¡°í•œ ìˆ˜í–‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì˜ ìƒë‹´ì„ ë°›ì•„ë³´ì‹œê¸°ë¥¼ ê¶Œí•©ë‹ˆë‹¤. ì–¸ì–´ ìœ ì°½ì„±ê³¼ ì¸ì§€ ê¸°ëŠ¥ì— ëŒ€í•œ ì¢…í•©ì ì¸ í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            
            // ì „ë¬¸ ë¶„ì„ ê²°ê³¼ HTML ìƒì„± (CFTSCORING ìŠ¤íƒ€ì¼ ì ìš©)
            const resultHTML = `
                <style>
                    .results { background: white; padding: 30px; border-radius: 12px; margin-top: 20px; }
                    .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
                    .score-card { background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; transition: transform 0.2s; }
                    .score-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                    .score-card h4 { font-size: 14px; color: #666; margin-bottom: 10px; font-weight: normal; }
                    .score { font-size: 32px; font-weight: bold; color: #2196F3; }
                    @media (max-width: 768px) { .score-grid { grid-template-columns: repeat(2, 1fr); } }
                </style>
                
                <div id="results" class="results">
                    <h2 style="color: #333; margin-bottom: 30px; text-align: center; font-size: 26px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">ê²€ì‚¬ ê²°ê³¼</h2>
                    
                    <!-- ì²«ë²ˆì§¸ ì¤„: ì´ì , ì „ë°˜ì ìˆ˜, í›„ë°˜ì ìˆ˜, ë³´ì†, ì¹¨íˆ¬ -->
                    <div class="score-grid">
                        <div class="score-card">
                            <h4>ì´ì <br>(Total Score)</h4>
                            <div class="score">${totalScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>ì „ë°˜ì ìˆ˜<br>(First Half Score)</h4>
                            <div class="score">${firstHalfScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>í›„ë°˜ì ìˆ˜<br>(Second Half Score)</h4>
                            <div class="score">${secondHalfScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>ë³´ì†<br>(Perseveration)</h4>
                            <div class="score" style="color: ${perseverationScore > 2 ? '#FF5722' : '#2196F3'};">${perseverationScore}</div>
                        </div>
                        <div class="score-card">
                            <h4>ì¹¨íˆ¬<br>(Intrusion)</h4>
                            <div class="score">${intrusionScore}</div>
                        </div>
                    </div>
                    
                    <!-- ë‘ë²ˆì§¸ ì¤„: ë²”ì£¼ìˆ˜, í‰ê· ë²”ì£¼í¬ê¸°, ìµœëŒ€ë²”ì£¼í¬ê¸°, ì „í™˜, ë¹„íš¨ìœ¨ì „í™˜ -->
                    <div class="score-grid">
                        <div class="score-card">
                            <h4>ë²”ì£¼ìˆ˜<br>(Number of Cluster)</h4>
                            <div class="score">${categoryAnalysis.numberOfClusters}</div>
                        </div>
                        <div class="score-card">
                            <h4>í‰ê· ë²”ì£¼í¬ê¸°<br>(Mean Size of Cluster)</h4>
                            <div class="score">${categoryAnalysis.meanClusterSize}</div>
                        </div>
                        <div class="score-card">
                            <h4>ìµœëŒ€ë²”ì£¼í¬ê¸°<br>(Max Size of Cluster)</h4>
                            <div class="score">${categoryAnalysis.maxClusterSize}</div>
                        </div>
                        <div class="score-card">
                            <h4>ì „í™˜<br>(Switching)</h4>
                            <div class="score">${categoryAnalysis.switching}</div>
                        </div>
                        <div class="score-card">
                            <h4>ë¹„íš¨ìœ¨ì „í™˜<br>(Hard Switching)</h4>
                            <div class="score">${categoryAnalysis.hardSwitching}</div>
                        </div>
                    </div>
                    
                    <!-- ì¶”ê°€ ë¶„ì„ ì •ë³´ -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="color: #495057; margin-bottom: 15px; font-size: 18px;">ì‹œê°„ëŒ€ë³„ ìƒì„¸ ë¶„ì„</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">0-15ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${counts['0-15ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['0-15ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">15-30ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${counts['15-30ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['15-30ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">30-45ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${counts['30-45ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['30-45ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">45-60ì´ˆ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${counts['45-60ì´ˆ']}</div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">${intervalStats['45-60ì´ˆ'].join(', ') || 'ì—†ìŒ'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: ${totalScore >= 15 ? '#d4edda' : totalScore >= 10 ? '#fff3cd' : '#f8d7da'}; 
                                border: 1px solid ${totalScore >= 15 ? '#c3e6cb' : totalScore >= 10 ? '#ffeeba' : '#f5c6cb'};
                                color: ${totalScore >= 15 ? '#155724' : totalScore >= 10 ? '#856404' : '#721c24'};
                                border-radius: 8px;">
                        <h3 style="margin-bottom: 10px; font-size: 18px;">ì¢…í•© í•´ì„</h3>
                        <p style="margin: 0; line-height: 1.8;">${interpretation}</p>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #6c757d; font-size: 14px;">
                        <p>ê²€ì‚¬ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}</p>
                        <p>ê°€ì¤‘ì¹˜ ì ìˆ˜: ${weightedScore.toFixed(1)}ì </p>
                        <p style="margin-top: 10px;">* ë³¸ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì •í™•í•œ ì§„ë‹¨ì„ ìœ„í•´ì„œëŠ” ì „ë¬¸ê°€ì˜ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
            
            // ê²°ê³¼ í‘œì‹œ - ì§ì ‘ ì²˜ë¦¬
            console.log('ê²°ê³¼ HTML ìƒì„± ì™„ë£Œ, í‘œì‹œ ì‹œì‘');
            
            // ê²°ê³¼ ì„¹ì…˜ì— ì§ì ‘ HTML ì‚½ì…
            resultsSection.innerHTML = resultHTML;
            resultsSection.style.display = 'block';
            resultsSection.style.visibility = 'visible';
            
            // ìŠ¤í¬ë¡¤
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log('ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ');
            }, 100);
            
            // ìŒì„± ì•ˆë‚´
            speak("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
        
        // CFTSCORING ê²°ê³¼ í‘œì‹œ (ê¸°ì¡´ í•¨ìˆ˜ ì œê±°)
        /*
            // CFTSCORINGê³¼ ë™ì¼í•œ ë²”ì£¼ ì²´ê³„ ì‚¬ìš©
            const CATEGORIES = {
                // ìƒë¬¼í•™ì  ë¶„ë¥˜
                MAMMAL: 'í¬ìœ ë¥˜',
                BIRD: 'ì¡°ë¥˜',
                REPTILE: 'íŒŒì¶©ë¥˜',
                AMPHIBIAN: 'ì–‘ì„œë¥˜',
                FISH: 'ì–´ë¥˜',
                INSECT: 'ê³¤ì¶©',
                MOLLUSK: 'ì—°ì²´ë™ë¬¼',
                CRUSTACEAN: 'ê°‘ê°ë¥˜',
                
                // ì„œì‹ì§€ë³„ ë¶„ë¥˜
                AQUATIC: 'ìˆ˜ìƒë™ë¬¼',
                MARINE: 'í•´ì–‘ë™ë¬¼',
                FRESHWATER: 'ë‹´ìˆ˜ë™ë¬¼',
                AERIAL: 'ë¹„í–‰ë™ë¬¼',
                
                // ì¸ê°„ê³¼ì˜ ê´€ê³„
                DOMESTIC: 'ê°€ì¶•',
                PET: 'ì• ì™„ë™ë¬¼',
                WILD: 'ì•¼ìƒë™ë¬¼',
                
                // ë¬¸í™”ì  ë¶„ë¥˜
                ZODIAC: '12ê°„ì§€',
                MYTHOLOGY: 'ì‹ í™”ë™ë¬¼',
                IMAGINARY: 'ìƒìƒì˜ ë™ë¬¼',
                PREHISTORIC: 'ì„ ì‚¬ì‹œëŒ€ ë™ë¬¼'
            };
            
            // ê°„ë‹¨í•œ ë™ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ (ì£¼ìš” ë™ë¬¼ë§Œ í¬í•¨)
            const ANIMAL_DATA = {
                'ê°œ': { MAMMAL: true, DOMESTIC: true, PET: true, ZODIAC: true },
                'ê³ ì–‘ì´': { MAMMAL: true, DOMESTIC: true, PET: true },
                'ì†Œ': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ë§': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ë¼ì§€': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ì–‘': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'ì—¼ì†Œ': { MAMMAL: true, DOMESTIC: true, ZODIAC: true },
                'í† ë¼': { MAMMAL: true, DOMESTIC: true, PET: true, ZODIAC: true },
                'í˜¸ë‘ì´': { MAMMAL: true, WILD: true, ZODIAC: true },
                'ì‚¬ì': { MAMMAL: true, WILD: true },
                'ì½”ë¼ë¦¬': { MAMMAL: true, WILD: true },
                'ê¸°ë¦°': { MAMMAL: true, WILD: true },
                'ê³°': { MAMMAL: true, WILD: true },
                'ëŠ‘ëŒ€': { MAMMAL: true, WILD: true },
                'ì—¬ìš°': { MAMMAL: true, WILD: true },
                'ì›ìˆ­ì´': { MAMMAL: true, WILD: true, ZODIAC: true },
                'ì¥': { MAMMAL: true, WILD: true, ZODIAC: true },
                'ë‹­': { BIRD: true, DOMESTIC: true, ZODIAC: true },
                'ì˜¤ë¦¬': { BIRD: true, DOMESTIC: true, AQUATIC: true },
                'ê±°ìœ„': { BIRD: true, DOMESTIC: true },
                'ì°¸ìƒˆ': { BIRD: true, WILD: true, AERIAL: true },
                'ë¹„ë‘˜ê¸°': { BIRD: true, WILD: true, AERIAL: true },
                'ë…ìˆ˜ë¦¬': { BIRD: true, WILD: true, AERIAL: true },
                'ë±€': { REPTILE: true, WILD: true, ZODIAC: true },
                'ê±°ë¶ì´': { REPTILE: true, PET: true, AQUATIC: true },
                'ì•…ì–´': { REPTILE: true, WILD: true, AQUATIC: true },
                'ê°œêµ¬ë¦¬': { AMPHIBIAN: true, WILD: true, AQUATIC: true },
                'ë‘êº¼ë¹„': { AMPHIBIAN: true, WILD: true },
                'ë¬¼ê³ ê¸°': { FISH: true, AQUATIC: true },
                'ìƒì–´': { FISH: true, MARINE: true, WILD: true },
                'ê³ ë˜': { MAMMAL: true, MARINE: true, WILD: true },
                'ëŒê³ ë˜': { MAMMAL: true, MARINE: true, WILD: true },
                'ë¬¸ì–´': { MOLLUSK: true, MARINE: true },
                'ì˜¤ì§•ì–´': { MOLLUSK: true, MARINE: true },
                'ìƒˆìš°': { CRUSTACEAN: true, MARINE: true },
                'ê²Œ': { CRUSTACEAN: true, MARINE: true },
                'ë‚˜ë¹„': { INSECT: true, AERIAL: true },
                'ë²Œ': { INSECT: true, AERIAL: true },
                'ê°œë¯¸': { INSECT: true, WILD: true },
                'ìš©': { ZODIAC: true, MYTHOLOGY: true, IMAGINARY: true, AERIAL: true }
            };
            
            // í´ëŸ¬ìŠ¤í„° ìƒì„±
            const clusters = [];
            let currentCluster = null;
            let lastCategories = [];
            
            animals.forEach((animal, index) => {
                // í˜„ì¬ ë™ë¬¼ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const animalData = ANIMAL_DATA[animal] || {};
                const animalCategories = [];
                
                // í˜„ì¬ ë™ë¬¼ì´ ì†í•œ ë²”ì£¼ë“¤ ì°¾ê¸°
                for (let [categoryKey, hasCategory] of Object.entries(animalData)) {
                    if (hasCategory === true) {
                        animalCategories.push(categoryKey);
                    }
                }
                
                // ì´ì „ í´ëŸ¬ìŠ¤í„°ì™€ ê³µìœ  ë²”ì£¼ê°€ ìˆëŠ”ì§€ í™•ì¸
                const hasSharedCategory = lastCategories.some(cat => animalCategories.includes(cat));
                
                if (hasSharedCategory && currentCluster) {
                    // ê°™ì€ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€
                    currentCluster.animals.push(animal);
                    currentCluster.size++;
                } else {
                    // ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„° ì‹œì‘
                    if (currentCluster) {
                        clusters.push(currentCluster);
                    }
                    currentCluster = {
                        animals: [animal],
                        size: 1,
                        categories: animalCategories
                    };
                }
                
                lastCategories = animalCategories;
            });
            
            // ë§ˆì§€ë§‰ í´ëŸ¬ìŠ¤í„° ì¶”ê°€
            if (currentCluster) {
                clusters.push(currentCluster);
            }
            
            // ì „í™˜ íšŸìˆ˜
            const switching = Math.max(0, clusters.length - 1);
            
            // ë¹„íš¨ìœ¨ì „í™˜ ê³„ì‚° (í¬ê¸° 1ì¸ í´ëŸ¬ìŠ¤í„° ë‹¤ìŒì˜ ì „í™˜)
            let hardSwitching = 0;
            for (let i = 0; i < clusters.length - 1; i++) {
                if (clusters[i].size === 1) {
                    // ë‹¤ìŒ í´ëŸ¬ìŠ¤í„°ì™€ ê³µìœ  ë²”ì£¼ê°€ ì—†ëŠ”ì§€ í™•ì¸
                    const currentCategories = clusters[i].categories;
                    const nextCategories = clusters[i + 1].categories;
                    const hasShared = currentCategories.some(cat => nextCategories.includes(cat));
                    if (!hasShared) {
                        hardSwitching++;
                    }
                }
            }
            
            // í´ëŸ¬ìŠ¤í„° í†µê³„
            const numberOfClusters = clusters.length;
            const clusterSizes = clusters.map(c => c.size);
            const meanClusterSize = numberOfClusters > 0 ? 
                (clusterSizes.reduce((sum, size) => sum + size, 0) / numberOfClusters).toFixed(1) : '0.0';
            const maxClusterSize = Math.max(...clusterSizes, 0);
            
            return {
                numberOfClusters,
                meanClusterSize,
                maxClusterSize,
                switching,
                hardSwitching
            };
        */
        
        
        // CFTSCORINGì—ì„œ ë°›ì€ HTML ê²°ê³¼ í‘œì‹œ
        function displayCFTSCORINGResult(htmlContent) {
            console.log('CFTSCORING ê²°ê³¼ HTML í‘œì‹œ');
            
            // ê²°ê³¼ ì„¹ì…˜ ì´ˆê¸°í™” ë° HTML í‘œì‹œ
            resultsSection.innerHTML = '';
            
            // CFTSCORING ê²°ê³¼ ì»¨í…Œì´ë„ˆ ìƒì„±
            const containerDiv = document.createElement('div');
            containerDiv.style.cssText = 'margin: 20px auto; max-width: 1200px; padding: 20px;';
            containerDiv.innerHTML = htmlContent;
            
            // ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸° ë²„íŠ¼ ì¶”ê°€
            const buttonDiv = document.createElement('div');
            buttonDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px;';
            buttonDiv.innerHTML = '<button onclick="window.location.href = window.location.pathname" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°</button>';
            
            resultsSection.appendChild(containerDiv);
            resultsSection.appendChild(buttonDiv);
            resultsSection.style.display = 'block';
            
            // ìŠ¤í¬ë¡¤
            containerDiv.scrollIntoView({ behavior: 'smooth' });
            
            // ìŒì„± ì•ˆë‚´
            speak("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
        

        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” DOM ìš”ì†Œ ì´ˆê¸°í™” í›„ì— ì¶”ê°€ë¨

        // í‚¤ë³´ë“œ ì…ë ¥ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨

        // ìŒì„± ëª©ë¡ ë¡œë“œ
        function loadVoices() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        };
                    }
                } else {
                    resolve([]);
                }
            });
        }

        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” DOM ìš”ì†Œ ì´ˆê¸°í™” í›„ì— ì¶”ê°€ë¨

        // í‚¤ë³´ë“œ ì…ë ¥ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨

        // ìŒì„± ëª©ë¡ ë¡œë“œ
        function loadVoices() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            resolve(voices);
                        };
                    }
                } else {
                    resolve([]);
                }
            });
        }

        // ë§ˆì´í¬ ê¶Œí•œ ë° ìŒì„±ì¸ì‹ ì¤€ë¹„ (ê¶Œí•œ ìš”ì²­ ì—†ì´)
        async function prepareMicrophoneAndRecognition() {
            console.log('ë§ˆì´í¬ ê¶Œí•œ ë° ìŒì„±ì¸ì‹ ì¤€ë¹„');
            
            // ìŒì„±ì¸ì‹ ì´ˆê¸°í™”
            if (!recognition) {
                initializeSpeechRecognition();
            }
            
            // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('ë§ˆì´í¬ ê¶Œí•œ íšë“ ì„±ê³µ');
                
                // ì˜¤ë””ì˜¤ ì‹œê°í™”ë¥¼ ìœ„í•œ ìŠ¤íŠ¸ë¦¼ ì €ì¥
                audioStream = stream;
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    
                    // ìŠ¤íŠ¸ë¦¼ ì €ì¥
                    audioStream = stream;
                }
                
                return true;
            } catch (error) {
                console.error('ë§ˆì´í¬ ê¶Œí•œ íšë“ ì‹¤íŒ¨:', error);
                alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return false;
            }
        }

        // ìë™ ìŒì„± ì‹œì‘ ì‹œë„ í•¨ìˆ˜
        async function tryAutoVoiceStart() {
            console.log('tryAutoVoiceStart í˜¸ì¶œë¨');
            
            // DOM ìš”ì†Œ ì´ˆê¸°í™”
            initializeDOMElements();
            
            // ìŒì„±ì¸ì‹ ì´ˆê¸°í™”ë§Œ í•˜ê³  ê¶Œí•œì€ ë‚˜ì¤‘ì— ìš”ì²­
            if (!recognition) {
                console.log('ìŒì„±ì¸ì‹ ì´ˆê¸°í™” ì‹œë„');
                initializeSpeechRecognition();
            }
            
            // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì˜¤ë””ì˜¤ë¡œ ìë™ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            const testAudio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAA==');
            testAudio.play().then(() => {
                console.log('ìë™ì¬ìƒ ê°€ëŠ¥ - ìë™ìœ¼ë¡œ ì‹œì‘');
                // ë²„íŠ¼ ìˆ¨ê¸°ê³  ë°”ë¡œ ì‹œì‘
                document.getElementById('manualStartBtn').style.display = 'none';
                setTimeout(() => {
                    // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ - handleStartClickì—ì„œ ì´ë¯¸ ì‹¤í–‰ë¨
                    // startInstructions();
                }, 1000);
            }).catch(error => {
                console.log('ìë™ì¬ìƒ ì°¨ë‹¨ë¨ - ì‹œì‘ ë²„íŠ¼ í‘œì‹œ');
                // ì‹œì‘ ë²„íŠ¼ì€ ì´ë¯¸ í‘œì‹œë˜ì–´ ìˆìŒ
                // ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ handleStartClickì´ í˜¸ì¶œë¨
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            // DOM ìš”ì†Œ ì´ˆê¸°í™”
            initializeDOMElements();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (startBtn) startBtn.addEventListener('click', () => startTest());
            if (stopBtn) stopBtn.addEventListener('click', stopTest);
            if (resetBtn) resetBtn.addEventListener('click', resetTest);
            if (downloadBtn) downloadBtn.addEventListener('click', downloadResults);
            
            // ìŒì„± ëª©ë¡ ë¨¼ì € ë¡œë“œ
            const voices = loadVoices();
            console.log('ë¡œë“œëœ ìŒì„± ëª©ë¡:', voices.length, 'ê°œ');
            
            // í•˜ë“œì›¨ì–´ ì„¤ì • í™•ì¸
            const hasSettings = loadHardwareSettings();
            
            if (!hasSettings) {
                console.log('í•˜ë“œì›¨ì–´ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
                // ì„¤ì •ì´ ì—†ì–´ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰
                setupWarning.style.display = 'none';
            } else {
                console.log('í•˜ë“œì›¨ì–´ ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                setupWarning.style.display = 'none';
            }
            
            // DOM ìš”ì†Œ í™•ì¸
            console.log('DOM ìš”ì†Œ í™•ì¸:', {
                manualStartBtn: document.getElementById('manualStartBtn'),
                readyBox: document.getElementById('readyBox'),
                testPage: document.getElementById('testPage')
            });
            
            // ì‹œì‘ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const manualStartBtn = document.getElementById('manualStartBtn');
            if (manualStartBtn) {
                console.log('ì‹œì‘ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                console.log('ì‹œì‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼:', {
                    display: window.getComputedStyle(manualStartBtn).display,
                    visibility: window.getComputedStyle(manualStartBtn).visibility,
                    opacity: window.getComputedStyle(manualStartBtn).opacity,
                    zIndex: window.getComputedStyle(manualStartBtn).zIndex
                });
                
                // ê°•ì œë¡œ ë²„íŠ¼ì„ ë³´ì´ë„ë¡ ì„¤ì •
                manualStartBtn.style.display = 'inline-block';
                manualStartBtn.style.visibility = 'visible';
                manualStartBtn.style.opacity = '1';
                manualStartBtn.style.position = 'relative';
                manualStartBtn.style.zIndex = '99999';
                
                console.log('ì‹œì‘ ë²„íŠ¼ ê°•ì œ í‘œì‹œ ì™„ë£Œ');
                
                manualStartBtn.addEventListener('click', function() {
                    console.log('ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨!');
                    if (!isStartClicked) {
                        window.handleStartClick();
                    }
                });
            } else {
                console.error('manualStartBtnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            // ì¤‘ë³µ ì œê±°ë¨ - ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬
            
            // ì‚¬ìš©ì ì •ë³´ í˜ì´ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const userInfoPrevBtn = document.getElementById('userInfoPrevBtn');
            const userInfoNextBtn = document.getElementById('userInfoNextBtn');
            const participantIdInput = document.getElementById('participantId');
            const userAgeInput = document.getElementById('userAge');
            const userEducationInput = document.getElementById('userEducation');
            
            
            if (userInfoNextBtn) {
                userInfoNextBtn.addEventListener('click', () => {
                    // ì…ë ¥ê°’ ê²€ì¦
                    if (!participantIdInput.value.trim()) {
                        alert('ì°¸ê°€ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        participantIdInput.focus();
                        return;
                    }
                    if (!userAgeInput.value || userAgeInput.value < 1 || userAgeInput.value > 120) {
                        alert('ì˜¬ë°”ë¥¸ ì—°ë ¹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        userAgeInput.focus();
                        return;
                    }
                    if (!userEducationInput.value || userEducationInput.value < 0 || userEducationInput.value > 30) {
                        alert('ì˜¬ë°”ë¥¸ êµìœ¡ë…„ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        userEducationInput.focus();
                        return;
                    }
                    
                    // ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ ê²€ì¦
                    const selectedGender = document.querySelector('input[name="gender"]:checked');
                    if (!selectedGender) {
                        alert('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    // ì‚¬ìš©ì ì •ë³´ ì €ì¥
                    userInfo.participantId = participantIdInput.value.trim();
                    userInfo.age = userAgeInput.value;
                    userInfo.gender = selectedGender.value;
                    userInfo.education = userEducationInput.value;
                    
                    console.log('ì‚¬ìš©ì ì •ë³´ ì €ì¥ë¨:', userInfo);
                    
                    // ê²€ì‚¬ í˜ì´ì§€ë¡œ ì´ë™ í›„ ë°”ë¡œ ê²€ì‚¬ ì‹œì‘
                    showPage('testPage');
                    
                    // ì§§ì€ ë”œë ˆì´ í›„ ìë™ìœ¼ë¡œ ê²€ì‚¬ ì‹œì‘
                    setTimeout(() => {
                        if (window.handleStartClick) {
                            console.log('ìë™ìœ¼ë¡œ ê²€ì‚¬ ì‹œì‘');
                            window.handleStartClick();
                        }
                    }, 500);
                });
            }
            
            // ë°”ë¡œ ì‚¬ìš©ì ì •ë³´ í˜ì´ì§€ë¡œ ì´ë™
            showPage('userInfoPage');
            
            
            // ë¸Œë¼ìš°ì € ì²´í¬
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome && (isSafari || isEdge)) {
                // Chromeì´ ì•„ë‹Œ ê²½ìš° ê²½ê³  í‘œì‹œ
                document.getElementById('browserWarning').style.display = 'block';
            } else {
                // Chromeì¸ ê²½ìš° 1ì´ˆ í›„ ìë™ ìŒì„± ì‹œì‘ ì‹œë„
                setTimeout(() => {
                    tryAutoVoiceStart();
                }, 1000);
            }
        });
        
        // ë¶„ì„ ê³¼ì • ë³´ê¸° í•¨ìˆ˜
        window.showAnalysisDetails = function() {
            // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            
            // ë¶„ì„ ê³¼ì • ì„¹ì…˜ í‘œì‹œ
            const analysisSection = document.getElementById('analysisDetailsSection');
            if (!analysisSection) {
                // ë¶„ì„ ê³¼ì • ì„¹ì…˜ ìƒì„±
                const section = document.createElement('div');
                section.id = 'analysisDetailsSection';
                section.style.cssText = 'background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 10px; margin-top: 20px;';
                section.innerHTML = `
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="text-align: right; margin-bottom: 20px;">
                            <button onclick="backToResults()" style="background-color: #1976d2; color: white; border: none; padding: 10px 25px; font-size: 14px; border-radius: 8px; cursor: pointer;">
                                ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                        
                        <h2 style="text-align: center; color: #333; margin-bottom: 30px;">ë¶„ì„ ê³¼ì • ìƒì„¸</h2>
                        
                        <div id="analysisContent">
                            ${generateAnalysisProcessDetail()}
                        </div>
                    </div>
                `;
                // ìµœìƒë‹¨ì— ë°°ì¹˜
                document.body.insertBefore(section, document.body.firstChild);
            } else {
                analysisSection.style.display = 'block';
                // ë¶„ì„ ë‚´ìš© ì—…ë°ì´íŠ¸
                const analysisContent = document.getElementById('analysisContent');
                if (analysisContent) {
                    analysisContent.innerHTML = generateAnalysisProcessDetail();
                }
            }
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo(0, 0);
        };
        
        // ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸° í•¨ìˆ˜
        window.backToResults = function() {
            // ë¶„ì„ ê³¼ì • ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const analysisSection = document.getElementById('analysisDetailsSection');
            if (analysisSection) {
                analysisSection.style.display = 'none';
            }
            
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            if (resultsSection) {
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
        };
        
        // ë¶„ì„ ê³¼ì • ìƒì„¸ ë‚´ìš© ìƒì„± í•¨ìˆ˜ - CFTSCORINGê³¼ ë™ì¼
        window.generateAnalysisProcessDetail = function() {
            console.log('generateAnalysisProcessDetail í˜¸ì¶œë¨');
            console.log('animals ë°°ì—´:', animals);
            console.log('animals ê¸¸ì´:', animals.length);
            
            if (!animals || animals.length === 0) {
                return '<div style="text-align: center; padding: 50px; color: #666;">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            
            // CFTSCORING í˜•ì‹ì˜ responses ë°°ì—´ ìƒì„±
            const allResponses = animals.map((animal, idx) => {
                const timeSeconds = (animal.timestamp - startTime) / 1000;
                const timeRange = timeSeconds < 15 ? '0-15' :
                                timeSeconds < 30 ? '15-30' :
                                timeSeconds < 45 ? '30-45' : '45-60';
                
                return {
                    response: animal.name,
                    originalResponse: animal.name,
                    normalizedResponse: animal.isAnimal ? (animal.baseAnimal || normalizeAnimalName(animal.name) || animal.name) : null,
                    timeRange: timeRange,
                    timestamp: animal.timestamp
                };
            });
            
            // ì „í™˜ ë¶„ì„ ì‹¤í–‰
            const validResponses = allResponses.filter(r => r.normalizedResponse !== null);
            const { transitions, clusters, switchingScore, inefficientSwitchingScore } = analyzeTransitionsAndClusters(validResponses);
            
            let html = '<div style="font-size: 14px; line-height: 1.8;">';
            
            // ë‹¨ì–´ë³„ ë²”ì£¼ íŒì • ê³¼ì • í…Œì´ë¸” (CFTSCORINGê³¼ ë™ì¼)
            html += `<table class="detail-table" style="margin-bottom: 20px; width: 100%; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <thead>
                    <tr>
                        <th>ìˆœì„œ</th>
                        <th>ì‹œê°„ëŒ€</th>
                        <th>ë‹¨ì–´</th>
                        <th>ë°˜ì‘ìœ í˜•</th>
                        <th>ë³´ìœ  ë²”ì£¼</th>
                        <th>í´ëŸ¬ìŠ¤í„° ê³µí†µë²”ì£¼</th>
                        <th>ê²¹ì¹˜ëŠ” ë²”ì£¼</th>
                        <th>íŒì •</th>
                        <th>í´ëŸ¬ìŠ¤í„°</th>
                    </tr>
                </thead>
                <tbody>`;
            
            // ëª¨ë“  ë°˜ì‘ì— ëŒ€í•œ ìƒì„¸ ë¶„ì„ ì •ë³´ ìƒì„±
            let currentClusterIdx = 0;
            let processedAnimals = 0;
            const seenAnimals = {};
            
            allResponses.forEach((response, idx) => {
                const animal = response.normalizedResponse;
                const originalAnimal = response.originalResponse || response.response;
                
                // ì‹œê°„ëŒ€ ë§¤í•‘
                const timeRange = response.timeRange || '';
                const timeRangeDisplay = timeRange === '0-15' ? '0-15ì´ˆ' :
                                       timeRange === '15-30' ? '15-30ì´ˆ' :
                                       timeRange === '30-45' ? '30-45ì´ˆ' :
                                       timeRange === '45-60' ? '45-60ì´ˆ' : '';
                
                // ë°˜ì‘ìœ í˜• íŒì •
                let responseType = '';
                let rowColor = '#f0f0f0';
                
                if (animal === null) {
                    // ì¹¨íˆ¬ë°˜ì‘
                    responseType = '<span style="color: #f44336; font-weight: bold;">ì¹¨íˆ¬</span>';
                    rowColor = '#ffebee';
                    
                    html += `<tr style="background-color: ${rowColor};">
                        <td style="text-align: center;">${idx + 1}</td>
                        <td style="text-align: center;">${timeRangeDisplay}</td>
                        <td><strong>${originalAnimal}</strong></td>
                        <td style="text-align: center;">${responseType}</td>
                        <td colspan="5" style="text-align: center; color: #999;">ë™ë¬¼ì´ ì•„ë‹˜</td>
                    </tr>`;
                    return;
                }
                
                // ë³´ì†ë°˜ì‘ ì²´í¬
                seenAnimals[animal] = (seenAnimals[animal] || 0) + 1;
                if (seenAnimals[animal] > 1) {
                    responseType = '<span style="color: #ff9800; font-weight: bold;">ë³´ì†</span>';
                    rowColor = '#fff3e0';
                    
                    html += `<tr style="background-color: ${rowColor};">
                        <td style="text-align: center;">${idx + 1}</td>
                        <td style="text-align: center;">${timeRangeDisplay}</td>
                        <td><strong>${animal}</strong></td>
                        <td style="text-align: center;">${responseType}</td>
                        <td colspan="5" style="text-align: center; color: #999;">ì¤‘ë³µ ë°˜ì‘ (${seenAnimals[animal]}ë²ˆì§¸)</td>
                    </tr>`;
                    return;
                }
                
                // ì •ë°˜ì‘ ì²˜ë¦¬
                responseType = '<span style="color: #4caf50;">ì •ë°˜ì‘</span>';
                rowColor = '#f0f0f0';
                processedAnimals++;
                
                const animalData = ANIMAL_CATEGORIES[animal] || {};
                const categories = [];
                for (const [cat, value] of Object.entries(animalData)) {
                    if (value === true) categories.push(cat);
                }
                
                // í˜„ì¬ ë™ë¬¼ì´ ì†í•œ í´ëŸ¬ìŠ¤í„° ì°¾ê¸°
                let belongsToCluster = null;
                let clusterCommonCategories = [];
                let overlappingCategories = [];
                let decision = '';
                
                // ì²˜ë¦¬ëœ ì •ë°˜ì‘ ì¸ë±ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ì°¾ê¸°
                let validAnimalIdx = processedAnimals - 1;
                
                for (let i = 0; i < clusters.length; i++) {
                    const cluster = clusters[i];
                    if (cluster.animals.includes(animal)) {
                        belongsToCluster = i + 1;
                        clusterCommonCategories = cluster.commonCategories;
                        
                        // ì´ì „ ì •ë°˜ì‘ ë™ë¬¼ê³¼ì˜ ê´€ê³„ í™•ì¸
                        if (validAnimalIdx > 0 && i === currentClusterIdx) {
                            // ê°™ì€ í´ëŸ¬ìŠ¤í„° ìœ ì§€
                            overlappingCategories = categories.filter(cat => 
                                clusterCommonCategories.includes(cat)
                            );
                            decision = 'ìœ ì§€';
                        } else if (validAnimalIdx > 0 && i !== currentClusterIdx) {
                            // ì „í™˜ ë°œìƒ
                            decision = 'ì „í™˜';
                            currentClusterIdx = i;
                        } else if (validAnimalIdx === 0) {
                            // ì²« ì •ë°˜ì‘ ë™ë¬¼
                            decision = 'ì‹œì‘';
                            currentClusterIdx = i;
                            overlappingCategories = categories;
                        }
                        break;
                    }
                }
                
                // ì „í™˜ íŒì •ì— ë”°ë¥¸ í–‰ ìƒ‰ìƒ
                if (decision === 'ì „í™˜') {
                    rowColor = '#ffe0e0';
                } else if (decision === 'ì‹œì‘') {
                    rowColor = '#e0ffe0';
                }
                
                html += `<tr style="background-color: ${rowColor};">
                    <td style="text-align: center;">${idx + 1}</td>
                    <td style="text-align: center;">${timeRangeDisplay}</td>
                    <td><strong>${animal}</strong></td>
                    <td style="text-align: center;">${responseType}</td>
                    <td>${categories.map(c => CATEGORIES[c]).join(', ')}</td>
                    <td>${clusterCommonCategories.map(c => CATEGORIES[c]).join(', ') || '-'}</td>
                    <td>${overlappingCategories.map(c => CATEGORIES[c]).join(', ') || 'ì—†ìŒ'}</td>
                    <td style="text-align: center; font-weight: bold; color: ${decision === 'ì „í™˜' ? '#d32f2f' : decision === 'ì‹œì‘' ? '#4caf50' : '#2196f3'};">
                        ${decision}
                        ${decision === 'ì „í™˜' && clusters[currentClusterIdx-1]?.size === 1 ? 
                          '<span style="background: #ffeb3b; padding: 2px 6px; border-radius: 3px; color: #333; font-size: 11px; margin-left: 5px;">ë¹„íš¨ìœ¨</span>' : ''}
                    </td>
                    <td style="text-align: center;">í´ëŸ¬ìŠ¤í„° ${belongsToCluster}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            html += '</div>';
            return html;
        }
    </script>
    </div> <!-- container ë‹«ê¸° -->
</body>
</html>