<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동물 범주 언어유창성검사</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Progress Indicator */
        .progress-container {
            margin-bottom: 40px;
        }
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: #e0e0e0;
            z-index: -1;
        }
        .step.completed:not(:last-child)::after {
            background-color: #4caf50;
        }
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .step.active .step-circle {
            background-color: #2196f3;
            color: white;
            transform: scale(1.1);
        }
        .step.completed .step-circle {
            background-color: #4caf50;
            color: white;
        }
        .step-label {
            font-size: 14px;
            color: #666;
        }
        .step.active .step-label {
            font-weight: bold;
            color: #2196f3;
        }
        
        /* Voice Guide Box */
        .voice-guide {
            background-color: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        .voice-guide.active {
            display: block;
            animation: pulse 1.5s infinite;
        }
        .voice-guide-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .voice-guide-text {
            font-size: 16px;
            color: #856404;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        /* Setup Page Styles */
        .setup-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .setup-section h3 {
            margin-top: 0;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .check-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .check-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-icon {
            font-size: 24px;
        }
        .status-icon.pending { color: #666; }
        .status-icon.checking { color: #ff9800; animation: spin 1s linear infinite; }
        .status-icon.success { color: #4caf50; }
        .status-icon.error { color: #f44336; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .test-btn {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover:not(:disabled) {
            background-color: #1976d2;
        }
        .test-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Audio Visualizer */
        .audio-visualizer {
            margin: 15px 0;
            height: 60px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }
        .audio-bar {
            width: 4px;
            height: 20px;
            background-color: #4caf50;
            margin: 0 2px;
            transition: height 0.1s ease;
            border-radius: 2px;
        }
        
        /* Instructions Page */
        .instructions-content {
            max-width: 700px;
            margin: 0 auto;
        }
        .instruction-card {
            background-color: #f8f9fa;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .instruction-card h4 {
            margin-top: 0;
            color: #1976d2;
        }
        .example-box {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .warning-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .warning-box h4 {
            margin-top: 0;
            color: #c62828;
        }
        
        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .prev-btn {
            background-color: #666;
            color: white;
        }
        .prev-btn:hover {
            background-color: #555;
        }
        .next-btn {
            background-color: #4caf50;
            color: white;
        }
        .next-btn:hover:not(:disabled) {
            background-color: #45a049;
        }
        .next-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .voice-guide-btn {
            background-color: #ff9800;
            color: white;
        }
        .voice-guide-btn:hover {
            background-color: #f57c00;
        }
        
        /* Test Page Styles */
        .timer-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .timer {
            font-size: 48px;
            font-weight: bold;
            color: #2196f3;
            margin: 20px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .start-btn {
            background-color: #4caf50;
            color: white;
        }
        .start-btn:hover:not(:disabled) {
            background-color: #45a049;
        }
        .stop-btn {
            background-color: #f44336;
            color: white;
        }
        .stop-btn:hover:not(:disabled) {
            background-color: #da190b;
        }
        .reset-btn {
            background-color: #ff9800;
            color: white;
        }
        .reset-btn:hover:not(:disabled) {
            background-color: #e68900;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .input-section {
            margin-bottom: 30px;
        }
        .manual-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #manualInput {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .add-btn {
            background-color: #2196f3;
            color: white;
        }
        .add-btn:hover:not(:disabled) {
            background-color: #0b7dda;
        }
        .recording-indicator {
            display: none;
            color: #f44336;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .recording-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }
        .results-section {
            margin-top: 30px;
        }
        .animal-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 100px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .animal-item {
            background-color: #e3f2fd;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .animal-item.duplicate {
            background-color: #ffebee;
            color: #c62828;
        }
        .animal-rank {
            background-color: #1976d2;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .animal-interval {
            background-color: #fff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: #666;
            border: 1px solid #ddd;
        }
        .interval-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .interval-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        .interval-card h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 16px;
        }
        .interval-count {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .interval-time {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .stats {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }
        .stat-label {
            font-weight: bold;
            color: #666;
        }
        .stat-value {
            color: #2196f3;
            font-weight: bold;
        }
        .download-btn {
            background-color: #673ab7;
            color: white;
            margin-top: 20px;
            width: 100%;
        }
        .download-btn:hover {
            background-color: #5e35b1;
        }
        .voice-settings {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .voice-settings label {
            margin: 0 10px;
        }
        .voice-settings input[type="range"] {
            width: 100px;
            vertical-align: middle;
        }
        .api-settings {
            margin-top: 15px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
        }
        .api-input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        .api-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #90caf9;
            border-radius: 5px;
            font-size: 14px;
        }
        .api-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
        .api-status.connected {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .api-status.error {
            background-color: #ffcdd2;
            color: #c62828;
        }
        .voice-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-left: 10px;
        }
        .ready-box {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin: 30px 0;
        }
        .ready-box h3 {
            margin-top: 0;
            font-size: 24px;
        }
        .ready-check {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>동물 범주 언어유창성검사</h1>
        
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">환경 설정</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">검사 안내</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">검사 시행</div>
                </div>
            </div>
        </div>

        <!-- Voice Guide Box -->
        <div class="voice-guide" id="voiceGuideBox">
            <span class="voice-guide-icon">🔊</span>
            <span class="voice-guide-text" id="voiceGuideText">음성 안내 중...</span>
        </div>

        <!-- Setup Page (Step 1) -->
        <div class="page active" id="setupPage">
            <h2>1단계: 검사 환경 설정</h2>
            
            <div class="setup-section">
                <h3>🎤 마이크 설정</h3>
                <div class="check-item">
                    <div>
                        <strong>마이크 권한</strong>
                        <div style="font-size: 14px; color: #666;">음성인식을 위한 마이크 접근 권한</div>
                    </div>
                    <div class="check-status">
                        <span class="status-icon pending" id="micPermissionIcon">⚪</span>
                        <button class="test-btn" id="micPermissionBtn">권한 요청</button>
                    </div>
                </div>
                <div class="check-item">
                    <div>
                        <strong>마이크 테스트</strong>
                        <div style="font-size: 14px; color: #666;">소리를 내어 마이크가 작동하는지 확인하세요</div>
                    </div>
                    <div class="check-status">
                        <span class="status-icon pending" id="micTestIcon">⚪</span>
                        <button class="test-btn" id="micTestBtn" disabled>테스트</button>
                    </div>
                </div>
                <div class="audio-visualizer" id="micVisualizer" style="display: none;">
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                </div>
            </div>

            <div class="setup-section">
                <h3>🔊 스피커 설정</h3>
                <div class="check-item">
                    <div>
                        <strong>스피커 테스트</strong>
                        <div style="font-size: 14px; color: #666;">음성 안내가 들리는지 확인하세요</div>
                    </div>
                    <div class="check-status">
                        <span class="status-icon pending" id="speakerTestIcon">⚪</span>
                        <button class="test-btn" id="speakerTestBtn">테스트</button>
                    </div>
                </div>
                <div class="voice-settings">
                    <label>
                        <input type="checkbox" id="voiceEnabled" checked> 음성 안내 사용
                    </label>
                    <label>
                        속도 <span style="font-size: 12px; color: #666;">(브라우저 음성만)</span>: 
                        <input type="range" id="voiceSpeed" min="0.5" max="1.5" step="0.1" value="0.9">
                        <span id="speedValue">0.9</span>
                    </label>
                    
                    <div class="api-settings">
                        <h4 style="margin-top: 0;">🔊 ElevenLabs 음성 설정</h4>
                        <div class="api-input-group">
                            <input type="password" class="api-input" id="elevenLabsApiKey" placeholder="ElevenLabs API Key 입력">
                            <button class="test-btn" id="testApiBtn">연결 테스트</button>
                            <span class="api-status" id="apiStatus" style="display: none;"></span>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>
                                음성 선택:
                                <select class="voice-select" id="voiceSelect" disabled>
                                    <option value="">기본 음성 (브라우저)</option>
                                </select>
                            </label>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            * ElevenLabs API Key가 없으면 브라우저 기본 음성이 사용됩니다<br>
                            * API Key는 <a href="https://elevenlabs.io" target="_blank">ElevenLabs</a>에서 발급받을 수 있습니다<br>
                            * ElevenLabs 사용 시 음성 속도 조절은 적용되지 않습니다
                        </div>
                    </div>
                </div>
            </div>

            <div class="setup-section">
                <h3>⚙️ 환경 확인</h3>
                <div class="check-item">
                    <div>
                        <strong>HTTPS 연결</strong>
                        <div style="font-size: 14px; color: #666;">음성인식을 위한 보안 연결</div>
                    </div>
                    <div class="check-status">
                        <span class="status-icon" id="httpsIcon">⚪</span>
                        <span id="httpsStatus" style="font-size: 14px;"></span>
                    </div>
                </div>
                <div class="check-item">
                    <div>
                        <strong>브라우저 호환성</strong>
                        <div style="font-size: 14px; color: #666;">음성인식 지원 여부</div>
                    </div>
                    <div class="check-status">
                        <span class="status-icon" id="browserIcon">⚪</span>
                        <span id="browserStatus" style="font-size: 14px;"></span>
                    </div>
                </div>
            </div>

            <div class="navigation">
                <button class="voice-guide-btn" id="setupVoiceGuideBtn">🔊 음성 안내 듣기</button>
                <button class="next-btn" id="setupNextBtn">다음 단계</button>
            </div>
        </div>

        <!-- Instructions Page (Step 2) -->
        <div class="page" id="instructionsPage">
            <h2>2단계: 검사 안내</h2>
            
            <div class="instructions-content">
                <div class="instruction-card">
                    <h4>🕐 검사 시간</h4>
                    <p><strong>1분 (60초)</strong> 동안 진행됩니다.</p>
                    <p>시간이 종료되면 자동으로 검사가 끝납니다.</p>
                </div>

                <div class="instruction-card">
                    <h4>📋 검사 방법</h4>
                    <p>제가 "시작"이라고 말씀드리면, <strong>생각나는 동물 이름을 최대한 많이</strong> 말씀해 주세요.</p>
                    <p>음성인식 또는 키보드 입력 모두 가능합니다.</p>
                </div>

                <div class="instruction-card">
                    <h4>✅ 포함 가능한 동물</h4>
                    <div class="example-box">
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>포유류 (예: 개, 고양이, 사자, 코끼리)</li>
                            <li>조류 (예: 참새, 독수리, 펭귄)</li>
                            <li>어류 (예: 금붕어, 상어, 고등어)</li>
                            <li>파충류 (예: 뱀, 거북이, 악어)</li>
                            <li>양서류 (예: 개구리, 도롱뇽)</li>
                            <li>곤충 (예: 나비, 개미, 벌)</li>
                            <li>멸종 동물 (예: 공룡, 매머드)</li>
                        </ul>
                    </div>
                </div>

                <div class="warning-box">
                    <h4>⚠️ 주의사항</h4>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li><strong>같은 동물을 반복하지 마세요</strong> (중복은 자동으로 표시됩니다)</li>
                        <li><strong>애완동물 이름은 제외</strong> (예: 바둑이, 나비 ✗)</li>
                        <li><strong>가상의 동물은 제외</strong> (예: 용, 유니콘, 포켓몬 ✗)</li>
                        <li><strong>동물 종류만 말씀하세요</strong> (예: "큰 사자" ✗ → "사자" ✓)</li>
                    </ul>
                </div>

                <div class="instruction-card">
                    <h4>💡 도움말</h4>
                    <p>• 편안한 마음으로 생각나는 대로 말씀하세요</p>
                    <p>• 카테고리별로 생각하면 도움이 됩니다</p>
                    <p>• 막히면 다른 종류의 동물로 넘어가세요</p>
                </div>
            </div>

            <div class="navigation">
                <button class="prev-btn" id="instructionsPrevBtn">이전 단계</button>
                <div>
                    <button class="voice-guide-btn" id="instructionsVoiceGuideBtn">🔊 음성 안내 듣기</button>
                    <button class="next-btn" id="instructionsNextBtn">다음 단계</button>
                </div>
            </div>
        </div>

        <!-- Test Page (Step 3) -->
        <div class="page" id="testPage">
            <h2>3단계: 검사 시행</h2>
            
            <div class="ready-box">
                <h3>✅ 검사 준비 완료!</h3>
                <div class="ready-check">
                    <span>🎤 마이크 준비 완료</span>
                </div>
                <div class="ready-check">
                    <span>🔊 스피커 준비 완료</span>
                </div>
                <p style="margin-top: 20px; font-size: 16px;">
                    아래 <strong>"검사 시작"</strong> 버튼을 누르면 음성 안내 후 검사가 시작됩니다.
                </p>
            </div>
            
            <div class="timer-section">
                <div class="timer" id="timer">01:00</div>
                <div class="controls">
                    <button class="start-btn" id="startBtn">검사 시작</button>
                    <button class="stop-btn" id="stopBtn" disabled>검사 종료</button>
                    <button class="reset-btn" id="resetBtn">초기화</button>
                </div>
                <div class="recording-indicator" id="recordingIndicator">
                    🎤 음성 인식 중...
                </div>
            </div>

            <div class="input-section">
                <h3>수동 입력</h3>
                <div class="manual-input">
                    <input type="text" id="manualInput" placeholder="동물 이름을 입력하세요" disabled>
                    <button class="add-btn" id="addBtn" disabled>추가</button>
                </div>
            </div>

            <div class="results-section">
                <h3>입력된 동물 목록</h3>
                <div class="animal-list" id="animalList"></div>
                
                <div class="stats" id="stats" style="display: none;">
                    <h3>검사 결과</h3>
                    
                    <div class="interval-stats" id="intervalStats"></div>
                    
                    <div class="stat-item">
                        <span class="stat-label">총 응답 수:</span>
                        <span class="stat-value" id="totalCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">유효 응답 수 (중복 제외):</span>
                        <span class="stat-value" id="uniqueCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">중복 응답 수:</span>
                        <span class="stat-value" id="duplicateCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">소요 시간:</span>
                        <span class="stat-value" id="elapsedTime">0초</span>
                    </div>
                    <button class="download-btn" id="downloadBtn">결과 다운로드</button>
                </div>
            </div>

            <div class="navigation">
                <button class="prev-btn" id="testPrevBtn">이전 단계</button>
                <div></div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let animals = [];
        let uniqueAnimals = new Set();
        let startTime = null;
        let endTime = null;
        let timerInterval = null;
        let timeRemaining = 60;
        let recognition = null;
        let isRecognizing = false;
        let speechSynthesis = window.speechSynthesis;
        let voiceReady = false;
        let currentStep = 1;
        let micStream = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let animationId = null;

        // ElevenLabs 설정
        let elevenLabsApiKey = null;
        let elevenLabsVoiceId = null;
        let elevenLabsConnected = false;
        let audioQueue = [];
        let isPlaying = false;

        // 설정 상태
        let setupStatus = {
            micPermission: false,
            micTest: false,
            speakerTest: false,
            https: false,
            browser: false,
            elevenLabs: false
        };

        // DOM 요소
        const pages = {
            setup: document.getElementById('setupPage'),
            instructions: document.getElementById('instructionsPage'),
            test: document.getElementById('testPage')
        };
        
        const steps = {
            1: document.getElementById('step1'),
            2: document.getElementById('step2'),
            3: document.getElementById('step3')
        };

        const voiceGuideBox = document.getElementById('voiceGuideBox');
        const voiceGuideText = document.getElementById('voiceGuideText');

        // Navigation buttons
        const setupNextBtn = document.getElementById('setupNextBtn');
        const setupVoiceGuideBtn = document.getElementById('setupVoiceGuideBtn');
        const instructionsPrevBtn = document.getElementById('instructionsPrevBtn');
        const instructionsNextBtn = document.getElementById('instructionsNextBtn');
        const instructionsVoiceGuideBtn = document.getElementById('instructionsVoiceGuideBtn');
        const testPrevBtn = document.getElementById('testPrevBtn');
        
        // Setup DOM
        const micPermissionBtn = document.getElementById('micPermissionBtn');
        const micPermissionIcon = document.getElementById('micPermissionIcon');
        const micTestBtn = document.getElementById('micTestBtn');
        const micTestIcon = document.getElementById('micTestIcon');
        const micVisualizer = document.getElementById('micVisualizer');
        const speakerTestBtn = document.getElementById('speakerTestBtn');
        const speakerTestIcon = document.getElementById('speakerTestIcon');
        const httpsIcon = document.getElementById('httpsIcon');
        const httpsStatus = document.getElementById('httpsStatus');
        const browserIcon = document.getElementById('browserIcon');
        const browserStatus = document.getElementById('browserStatus');
        
        // Test DOM
        const timer = document.getElementById('timer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const manualInput = document.getElementById('manualInput');
        const addBtn = document.getElementById('addBtn');
        const animalList = document.getElementById('animalList');
        const stats = document.getElementById('stats');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const downloadBtn = document.getElementById('downloadBtn');
        const voiceEnabled = document.getElementById('voiceEnabled');
        const voiceSpeed = document.getElementById('voiceSpeed');
        const speedValue = document.getElementById('speedValue');
        
        // ElevenLabs DOM
        const elevenLabsApiKeyInput = document.getElementById('elevenLabsApiKey');
        const testApiBtn = document.getElementById('testApiBtn');
        const apiStatus = document.getElementById('apiStatus');
        const voiceSelect = document.getElementById('voiceSelect');

        // 페이지 전환
        function showStep(stepNumber) {
            currentStep = stepNumber;
            
            // 모든 페이지 숨기기
            Object.values(pages).forEach(page => page.classList.remove('active'));
            
            // 진행 상태 업데이트
            Object.keys(steps).forEach(num => {
                const step = steps[num];
                step.classList.remove('active', 'completed');
                if (parseInt(num) < stepNumber) {
                    step.classList.add('completed');
                } else if (parseInt(num) === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // 해당 페이지 표시
            switch(stepNumber) {
                case 1:
                    pages.setup.classList.add('active');
                    break;
                case 2:
                    pages.instructions.classList.add('active');
                    break;
                case 3:
                    pages.test.classList.add('active');
                    break;
            }
        }

        // 설정 상태 확인
        function checkSetupComplete() {
            const allComplete = Object.values(setupStatus).every(status => status);
            setupNextBtn.disabled = !allComplete;
        }

        // 음성 안내 표시
        function showVoiceGuide(text) {
            voiceGuideText.textContent = text;
            voiceGuideBox.classList.add('active');
        }

        function hideVoiceGuide() {
            voiceGuideBox.classList.remove('active');
        }

        // ElevenLabs API 테스트
        async function testElevenLabsAPI() {
            const apiKey = elevenLabsApiKeyInput.value.trim();
            if (!apiKey) {
                showApiStatus('API Key를 입력해주세요', 'error');
                return;
            }

            testApiBtn.disabled = true;
            showApiStatus('연결 중...', '');

            try {
                // 음성 목록 가져오기
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: {
                        'xi-api-key': apiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    elevenLabsApiKey = apiKey;
                    elevenLabsConnected = true;
                    
                    // 음성 목록 업데이트
                    voiceSelect.innerHTML = '<option value="">기본 음성 (브라우저)</option>';
                    data.voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.voice_id;
                        option.textContent = voice.name;
                        // 한국어 음성 표시
                        if (voice.labels && voice.labels.language === 'ko') {
                            option.textContent += ' (한국어)';
                        }
                        voiceSelect.appendChild(option);
                    });
                    
                    // 한국어 음성 자동 선택
                    const koreanVoice = data.voices.find(v => 
                        v.labels && v.labels.language === 'ko'
                    ) || data.voices.find(v => 
                        v.name.toLowerCase().includes('korean') || 
                        v.name.toLowerCase().includes('ko-kr')
                    );
                    
                    if (koreanVoice) {
                        voiceSelect.value = koreanVoice.voice_id;
                        elevenLabsVoiceId = koreanVoice.voice_id;
                    } else if (data.voices.length > 0) {
                        // 한국어 음성이 없으면 첫 번째 음성 선택
                        voiceSelect.value = data.voices[0].voice_id;
                        elevenLabsVoiceId = data.voices[0].voice_id;
                    }
                    
                    voiceSelect.disabled = false;
                    showApiStatus('연결 성공!', 'connected');
                    
                    // API 키를 로컬 스토리지에 저장 (선택사항)
                    localStorage.setItem('elevenLabsApiKey', apiKey);
                } else {
                    throw new Error('API 연결 실패');
                }
            } catch (error) {
                elevenLabsConnected = false;
                showApiStatus('연결 실패: API Key를 확인해주세요', 'error');
                console.error('ElevenLabs API 오류:', error);
            } finally {
                testApiBtn.disabled = false;
            }
        }

        // API 상태 표시
        function showApiStatus(message, type) {
            apiStatus.textContent = message;
            apiStatus.className = 'api-status ' + type;
            apiStatus.style.display = 'inline-block';
            
            if (type === 'connected') {
                setTimeout(() => {
                    apiStatus.style.display = 'none';
                }, 3000);
            }
        }

        // 오디오 재생 큐 처리
        async function processAudioQueue() {
            if (isPlaying || audioQueue.length === 0) return;
            
            isPlaying = true;
            const { audioBlob, callback } = audioQueue.shift();
            
            const audio = new Audio();
            const audioUrl = URL.createObjectURL(audioBlob);
            audio.src = audioUrl;
            audio.playbackRate = 1.0; // 재생 속도 고정
            
            audio.onended = () => {
                URL.revokeObjectURL(audioUrl);
                isPlaying = false;
                if (callback) callback();
                processAudioQueue();
            };
            
            audio.onerror = () => {
                console.error('오디오 재생 오류');
                URL.revokeObjectURL(audioUrl);
                isPlaying = false;
                if (callback) callback();
                processAudioQueue();
            };
            
            try {
                await audio.play();
            } catch (error) {
                console.error('오디오 재생 실패:', error);
                // 자동 재생 정책으로 인한 실패 시 사용자 상호작용 후 재시도
                if (error.name === 'NotAllowedError') {
                    console.log('자동 재생이 차단되었습니다. 사용자 상호작용 후 재생됩니다.');
                }
                URL.revokeObjectURL(audioUrl);
                isPlaying = false;
                if (callback) callback();
                processAudioQueue();
            }
        }

        // ElevenLabs TTS
        async function elevenLabsTTS(text, callback) {
            if (!elevenLabsConnected || !elevenLabsApiKey) {
                // ElevenLabs를 사용할 수 없으면 기본 TTS 사용
                defaultTTS(text, callback);
                return;
            }

            const voiceId = voiceSelect.value || elevenLabsVoiceId;
            if (!voiceId) {
                defaultTTS(text, callback);
                return;
            }

            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xi-api-key': elevenLabsApiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.75,
                            similarity_boost: 0.75,
                            style: 0.5,
                            use_speaker_boost: true
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    audioQueue.push({ audioBlob, callback });
                    processAudioQueue();
                } else {
                    console.error('ElevenLabs TTS 오류:', response.status);
                    defaultTTS(text, callback);
                }
            } catch (error) {
                console.error('ElevenLabs TTS 실패:', error);
                defaultTTS(text, callback);
            }
        }

        // 기본 브라우저 TTS
        function defaultTTS(text, callback) {
            if (!speechSynthesis) {
                if (callback) callback();
                return;
            }

            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = parseFloat(voiceSpeed.value);
            utterance.pitch = 1;
            utterance.volume = 1;

            const voices = speechSynthesis.getVoices();
            const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
                utterance.voice = koreanVoice;
            }

            utterance.onend = () => {
                if (callback) callback();
            };
            utterance.onerror = () => {
                if (callback) callback();
            };

            speechSynthesis.speak(utterance);
        }

        // 음성 합성 (통합 함수)
        function speak(text, callback) {
            if (!voiceEnabled.checked) {
                if (callback) callback();
                return;
            }

            showVoiceGuide(text);

            if (elevenLabsConnected && elevenLabsApiKey) {
                elevenLabsTTS(text, () => {
                    hideVoiceGuide();
                    if (callback) callback();
                });
            } else {
                defaultTTS(text);
                // 기본 TTS는 utterance의 onend에서 hideVoiceGuide를 호출
                const utterance = speechSynthesis.speaking;
                if (utterance) {
                    const checkEnd = setInterval(() => {
                        if (!speechSynthesis.speaking) {
                            clearInterval(checkEnd);
                            hideVoiceGuide();
                            if (callback) callback();
                        }
                    }, 100);
                } else {
                    hideVoiceGuide();
                    if (callback) callback();
                }
            }
        }

        // 환경 설정 음성 가이드
        function setupVoiceGuide() {
            const guides = [
                "안녕하세요. 동물 범주 언어유창성검사를 시작하기 전에 환경 설정을 진행하겠습니다.",
                "먼저 마이크 권한 요청 버튼을 클릭하여 마이크 사용 권한을 허용해 주세요.",
                "권한이 허용되면 마이크 테스트 버튼을 눌러 마이크가 정상 작동하는지 확인해 주세요.",
                "다음으로 스피커 테스트 버튼을 눌러 음성이 잘 들리는지 확인해 주세요.",
                "모든 설정이 완료되면 다음 단계 버튼이 활성화됩니다."
            ];

            let index = 0;
            function speakNext() {
                if (index < guides.length) {
                    speak(guides[index], () => {
                        index++;
                        if (index < guides.length) {
                            setTimeout(speakNext, 1000);
                        }
                    });
                }
            }
            speakNext();
        }

        // 검사 안내 음성 가이드
        function instructionsVoiceGuide() {
            const guides = [
                "검사 안내를 시작하겠습니다.",
                "이 검사는 1분 동안 진행됩니다.",
                "시작 신호가 나면 생각나는 동물 이름을 최대한 많이 말씀해 주세요.",
                "포유류, 조류, 어류, 파충류, 양서류, 곤충 등 모든 종류의 동물이 가능합니다.",
                "멸종된 동물도 포함할 수 있습니다.",
                "단, 애완동물의 이름이나 가상의 동물은 제외됩니다.",
                "같은 동물을 반복하지 않도록 주의해 주세요.",
                "음성인식이 어려운 경우 키보드로 입력하실 수도 있습니다.",
                "준비가 되셨으면 다음 단계로 진행해 주세요."
            ];

            let index = 0;
            function speakNext() {
                if (index < guides.length) {
                    speak(guides[index], () => {
                        index++;
                        if (index < guides.length) {
                            setTimeout(speakNext, 800);
                        }
                    });
                }
            }
            speakNext();
        }

        // HTTPS 및 브라우저 확인
        function checkEnvironment() {
            // HTTPS 확인
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                setupStatus.https = true;
                httpsIcon.className = 'status-icon success';
                httpsIcon.textContent = '✅';
                httpsStatus.textContent = '보안 연결 확인';
            } else {
                setupStatus.https = false;
                httpsIcon.className = 'status-icon error';
                httpsIcon.textContent = '❌';
                httpsStatus.textContent = 'HTTPS 필요';
            }

            // 브라우저 확인
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                setupStatus.browser = true;
                browserIcon.className = 'status-icon success';
                browserIcon.textContent = '✅';
                browserStatus.textContent = '음성인식 지원';
            } else {
                setupStatus.browser = false;
                browserIcon.className = 'status-icon error';
                browserIcon.textContent = '❌';
                browserStatus.textContent = '미지원 브라우저';
            }

            checkSetupComplete();
        }

        // 마이크 권한 요청
        async function requestMicPermission() {
            micPermissionIcon.className = 'status-icon checking';
            micPermissionIcon.textContent = '🔄';
            
            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupStatus.micPermission = true;
                micPermissionIcon.className = 'status-icon success';
                micPermissionIcon.textContent = '✅';
                micTestBtn.disabled = false;
                initializeSpeechRecognition();
                speak("마이크 권한이 허용되었습니다. 이제 마이크 테스트를 진행해 주세요.");
            } catch (error) {
                setupStatus.micPermission = false;
                micPermissionIcon.className = 'status-icon error';
                micPermissionIcon.textContent = '❌';
                speak("마이크 권한이 거부되었습니다. 브라우저 설정에서 마이크 권한을 허용해 주세요.");
                console.error('마이크 권한 오류:', error);
            }
            
            checkSetupComplete();
        }

        // 마이크 테스트
        function testMicrophone() {
            if (!micStream) return;

            micTestIcon.className = 'status-icon checking';
            micTestIcon.textContent = '🔄';
            micVisualizer.style.display = 'flex';

            speak("마이크 테스트를 시작합니다. 아무 소리나 내어 주세요.", () => {
                // 오디오 컨텍스트 설정
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(micStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // 오디오 시각화
                const bars = micVisualizer.querySelectorAll('.audio-bar');
                let detected = false;
                
                function animate() {
                    animationId = requestAnimationFrame(animate);
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    
                    bars.forEach((bar, index) => {
                        const height = Math.min(50, (average + Math.random() * 20) * (index % 2 === 0 ? 1 : 0.8));
                        bar.style.height = `${height}px`;
                    });

                    if (average > 20 && !detected) {
                        detected = true;
                        setupStatus.micTest = true;
                        micTestIcon.className = 'status-icon success';
                        micTestIcon.textContent = '✅';
                        speak("마이크가 정상적으로 작동합니다.");
                    }
                }
                animate();

                // 5초 후 테스트 종료
                setTimeout(() => {
                    cancelAnimationFrame(animationId);
                    micVisualizer.style.display = 'none';
                    if (!setupStatus.micTest) {
                        micTestIcon.className = 'status-icon error';
                        micTestIcon.textContent = '❌';
                        speak("마이크에서 소리가 감지되지 않았습니다. 마이크 연결을 확인해 주세요.");
                    }
                    checkSetupComplete();
                }, 5000);
            });
        }

        // 스피커 테스트
        function testSpeaker() {
            speakerTestIcon.className = 'status-icon checking';
            speakerTestIcon.textContent = '🔄';
            
            const testMessage = elevenLabsConnected ? 
                "일래븐랩스 음성 테스트입니다. 이 음성이 들리시면 정상입니다." :
                "스피커 테스트입니다. 이 음성이 들리시면 정상입니다.";
            
            speak(testMessage, () => {
                setupStatus.speakerTest = true;
                speakerTestIcon.className = 'status-icon success';
                speakerTestIcon.textContent = '✅';
                checkSetupComplete();
            });
        }

        // 음성인식 초기화
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('음성인식 시작됨');
                };

                recognition.onresult = (event) => {
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            const transcript = event.results[i][0].transcript.trim();
                            console.log('인식된 텍스트:', transcript);
                            const words = transcript.split(/[\s,，、]+/).filter(word => word.length > 0);
                            words.forEach(word => {
                                if (word.length > 0) {
                                    addAnimal(word);
                                }
                            });
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error('음성인식 오류:', event.error);
                    if (event.error === 'no-speech' && isRecognizing) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (e) {}
                        }, 100);
                    }
                };

                recognition.onend = () => {
                    console.log('음성인식 종료됨');
                    if (isRecognizing && timeRemaining > 0) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                                console.log('음성인식 재시작됨');
                            } catch (e) {
                                console.error('음성인식 재시작 오류:', e);
                            }
                        }, 100);
                    }
                };
            }
        }

        // 검사 시작 음성 안내
        function startTestVoiceInstructions(callback) {
            const instructions = [
                "지금부터 동물 범주 언어유창성검사를 시작하겠습니다.",
                "이 검사는 1분 동안 진행됩니다.",
                "제가 시작이라고 말씀드리면, 생각나는 동물 이름을 가능한 한 많이 말씀해 주세요.",
                "준비되셨나요?",
                "3... 2... 1... 시작!"
            ];

            let index = 0;
            function speakNext() {
                if (index < instructions.length) {
                    speak(instructions[index], () => {
                        index++;
                        if (index < instructions.length) {
                            setTimeout(speakNext, 500);
                        } else {
                            if (callback) callback();
                        }
                    });
                }
            }

            speakNext();
        }

        // 동물 추가
        function addAnimal(animal) {
            if (!animal || animal.trim() === '') return;
            
            const trimmedAnimal = animal.trim();
            const timestamp = Date.now() - startTime;
            
            animals.push({
                name: trimmedAnimal,
                timestamp: timestamp,
                isDuplicate: uniqueAnimals.has(trimmedAnimal.toLowerCase())
            });
            
            uniqueAnimals.add(trimmedAnimal.toLowerCase());
            updateAnimalList();
        }

        // 동물 목록 업데이트
        function updateAnimalList() {
            animalList.innerHTML = '';
            animals.forEach((animal, index) => {
                const div = document.createElement('div');
                div.className = 'animal-item' + (animal.isDuplicate ? ' duplicate' : '');
                
                const rankSpan = document.createElement('span');
                rankSpan.className = 'animal-rank';
                rankSpan.textContent = index + 1;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = animal.name;
                
                const intervalSpan = document.createElement('span');
                intervalSpan.className = 'animal-interval';
                const interval = Math.floor(animal.timestamp / 15000) + 1;
                intervalSpan.textContent = `${interval}구간`;
                
                const timeSpan = document.createElement('span');
                timeSpan.style.fontSize = '12px';
                timeSpan.style.color = '#666';
                timeSpan.textContent = `(${(animal.timestamp / 1000).toFixed(1)}초)`;
                
                div.appendChild(rankSpan);
                div.appendChild(nameSpan);
                div.appendChild(intervalSpan);
                div.appendChild(timeSpan);
                
                animalList.appendChild(div);
            });
        }

        // 타이머 업데이트
        function updateTimer() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (voiceEnabled.checked && (timeRemaining === 30 || timeRemaining === 10)) {
                speak(`${timeRemaining}초 남았습니다`);
            }
        }

        // 실제 검사 시작
        function actuallyStartTest() {
            startTime = Date.now();
            timeRemaining = 60;
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            manualInput.disabled = false;
            addBtn.disabled = false;
            
            if (recognition) {
                try {
                    isRecognizing = true;
                    recognition.start();
                    recordingIndicator.classList.add('active');
                } catch (e) {
                    console.error('음성인식 시작 오류:', e);
                }
            }
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimer();
                
                if (timeRemaining <= 0) {
                    stopTest();
                }
            }, 1000);
        }

        // 검사 시작
        function startTest() {
            resetTest();
            
            if (voiceEnabled.checked) {
                startTestVoiceInstructions(() => {
                    actuallyStartTest();
                });
            } else {
                actuallyStartTest();
            }
        }

        // 검사 종료
        function stopTest() {
            endTime = Date.now();
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (recognition && isRecognizing) {
                isRecognizing = false;
                recognition.stop();
                recordingIndicator.classList.remove('active');
            }
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            manualInput.disabled = true;
            addBtn.disabled = true;
            
            if (voiceEnabled.checked) {
                const uniqueCount = uniqueAnimals.size;
                speak(`검사가 종료되었습니다. 총 ${uniqueCount}개의 서로 다른 동물을 말씀하셨습니다.`);
            }
            
            showResults();
        }

        // 결과 표시
        function showResults() {
            const totalCount = animals.length;
            const uniqueCount = uniqueAnimals.size;
            const duplicateCount = animals.filter(a => a.isDuplicate).length;
            const elapsedSeconds = Math.round((endTime - startTime) / 1000);
            
            const intervalCounts = [0, 0, 0, 0];
            const intervalUniqueCounts = [new Set(), new Set(), new Set(), new Set()];
            
            animals.forEach(animal => {
                const interval = Math.min(Math.floor(animal.timestamp / 15000), 3);
                intervalCounts[interval]++;
                if (!animal.isDuplicate) {
                    intervalUniqueCounts[interval].add(animal.name.toLowerCase());
                }
            });
            
            const intervalStats = document.getElementById('intervalStats');
            intervalStats.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const card = document.createElement('div');
                card.className = 'interval-card';
                card.innerHTML = `
                    <h4>${i + 1}구간</h4>
                    <div class="interval-count">${intervalCounts[i]}</div>
                    <div class="interval-time">${i * 15}-${(i + 1) * 15}초</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        유효: ${intervalUniqueCounts[i].size}개
                    </div>
                `;
                intervalStats.appendChild(card);
            }
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('uniqueCount').textContent = uniqueCount;
            document.getElementById('duplicateCount').textContent = duplicateCount;
            document.getElementById('elapsedTime').textContent = `${elapsedSeconds}초`;
            
            stats.style.display = 'block';
        }

        // 검사 초기화
        function resetTest() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            if (recognition && isRecognizing) {
                isRecognizing = false;
                recognition.stop();
                recordingIndicator.classList.remove('active');
            }
            
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
            
            // 오디오 큐 초기화
            audioQueue = [];
            isPlaying = false;
            
            animals = [];
            uniqueAnimals.clear();
            startTime = null;
            endTime = null;
            timeRemaining = 60;
            
            updateTimer();
            animalList.innerHTML = '';
            stats.style.display = 'none';
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            manualInput.disabled = true;
            addBtn.disabled = true;
            manualInput.value = '';
        }

        // 결과 다운로드
        function downloadResults() {
            const date = new Date().toLocaleDateString('ko-KR');
            const time = new Date().toLocaleTimeString('ko-KR');
            
            const intervalCounts = [0, 0, 0, 0];
            const intervalUniqueCounts = [new Set(), new Set(), new Set(), new Set()];
            const intervalAnimals = [[], [], [], []];
            
            animals.forEach((animal, index) => {
                const interval = Math.min(Math.floor(animal.timestamp / 15000), 3);
                intervalCounts[interval]++;
                intervalAnimals[interval].push({
                    ...animal,
                    rank: index + 1
                });
                if (!animal.isDuplicate) {
                    intervalUniqueCounts[interval].add(animal.name.toLowerCase());
                }
            });
            
            let content = `동물 범주 언어유창성검사 결과\n`;
            content += `검사 일시: ${date} ${time}\n`;
            content += `소요 시간: ${Math.round((endTime - startTime) / 1000)}초\n\n`;
            
            content += `[검사 결과 요약]\n`;
            content += `총 응답 수: ${animals.length}\n`;
            content += `유효 응답 수 (중복 제외): ${uniqueAnimals.size}\n`;
            content += `중복 응답 수: ${animals.filter(a => a.isDuplicate).length}\n\n`;
            
            content += `[구간별 분석]\n`;
            for (let i = 0; i < 4; i++) {
                content += `${i + 1}구간 (${i * 15}-${(i + 1) * 15}초): `;
                content += `총 ${intervalCounts[i]}개, 유효 ${intervalUniqueCounts[i].size}개\n`;
            }
            content += `\n`;
            
            content += `[상세 응답 목록]\n`;
            content += `순위\t동물명\t시간(초)\t구간\t중복여부\n`;
            content += `${'─'.repeat(50)}\n`;
            
            animals.forEach((animal, index) => {
                const timeStr = (animal.timestamp / 1000).toFixed(1);
                const interval = Math.min(Math.floor(animal.timestamp / 15000), 3) + 1;
                const dupStr = animal.isDuplicate ? '중복' : '-';
                content += `${index + 1}\t${animal.name}\t${timeStr}\t${interval}구간\t${dupStr}\n`;
            });
            
            content += `\n[구간별 상세 분석]\n`;
            for (let i = 0; i < 4; i++) {
                content += `\n■ ${i + 1}구간 (${i * 15}-${(i + 1) * 15}초)\n`;
                content += `응답 수: ${intervalCounts[i]}개\n`;
                content += `유효 응답: ${intervalUniqueCounts[i].size}개\n`;
                if (intervalAnimals[i].length > 0) {
                    content += `응답 목록:\n`;
                    intervalAnimals[i].forEach(animal => {
                        content += `  - ${animal.name} (순위: ${animal.rank}, ${(animal.timestamp / 1000).toFixed(1)}초)`;
                        if (animal.isDuplicate) content += ' [중복]';
                        content += '\n';
                    });
                }
            }
            
            content += `\n[유효 동물 목록 (중복 제외)]\n`;
            Array.from(uniqueAnimals).forEach((animal, index) => {
                content += `${index + 1}. ${animal}\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `언어유창성검사_${date.replace(/\./g, '')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 음성 속도 업데이트
        voiceSpeed.addEventListener('input', () => {
            speedValue.textContent = voiceSpeed.value;
        });

        // ElevenLabs 이벤트 리스너
        testApiBtn.addEventListener('click', testElevenLabsAPI);
        voiceSelect.addEventListener('change', (e) => {
            elevenLabsVoiceId = e.target.value;
        });

        // 이벤트 리스너
        setupNextBtn.addEventListener('click', () => showStep(2));
        setupVoiceGuideBtn.addEventListener('click', setupVoiceGuide);
        instructionsPrevBtn.addEventListener('click', () => showStep(1));
        instructionsNextBtn.addEventListener('click', () => showStep(3));
        instructionsVoiceGuideBtn.addEventListener('click', instructionsVoiceGuide);
        testPrevBtn.addEventListener('click', () => showStep(2));
        
        micPermissionBtn.addEventListener('click', requestMicPermission);
        micTestBtn.addEventListener('click', testMicrophone);
        speakerTestBtn.addEventListener('click', testSpeaker);
        
        startBtn.addEventListener('click', startTest);
        stopBtn.addEventListener('click', stopTest);
        resetBtn.addEventListener('click', resetTest);
        downloadBtn.addEventListener('click', downloadResults);

        addBtn.addEventListener('click', () => {
            if (manualInput.value.trim()) {
                addAnimal(manualInput.value);
                manualInput.value = '';
                manualInput.focus();
            }
        });

        manualInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && manualInput.value.trim()) {
                addAnimal(manualInput.value);
                manualInput.value = '';
            }
        });

        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            checkEnvironment();
            
            if (speechSynthesis) {
                speechSynthesis.getVoices();
                speechSynthesis.onvoiceschanged = () => {
                    voiceReady = true;
                };
            }
            
            // 저장된 ElevenLabs API 키 불러오기
            const savedApiKey = localStorage.getItem('elevenLabsApiKey');
            if (savedApiKey) {
                elevenLabsApiKeyInput.value = savedApiKey;
                testElevenLabsAPI();
            }
            
            // 환경 설정 완료 시 자동 음성 안내
            setTimeout(() => {
                if (voiceEnabled.checked) {
                    speak("동물 범주 언어유창성검사 프로그램입니다. 검사를 시작하기 전에 환경 설정을 진행해 주세요.");
                }
            }, 1000);
        });

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', () => {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            // 오디오 큐 정리
            audioQueue = [];
            isPlaying = false;
        });
    </script>
</body>
</html>