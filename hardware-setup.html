<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ë“œì›¨ì–´ ì„¤ì • - ìŒì„± ê¸°ë°˜ ê²€ì‚¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 600px;
            width: 100%;
            padding: 20px;
        }
        
        /* ê° ë‹¨ê³„ í™”ë©´ */
        .step-screen {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }
        
        .step-screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .step-description {
            font-size: 1.1rem;
            margin-bottom: 30px;
            color: #666;
            line-height: 1.8;
        }
        
        .step-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .primary-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .primary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ìƒíƒœ ì•„ì´ì½˜ */
        .status-icon {
            font-size: 3rem;
            margin: 20px 0;
        }
        
        .status-icon.pending { opacity: 0.3; }
        .status-icon.checking { 
            animation: spin 1s linear infinite;
            color: #ff9800;
        }
        .status-icon.success { color: #4caf50; }
        .status-icon.error { color: #f44336; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ì˜¤ë””ì˜¤ ì‹œê°í™” */
        .audio-visualizer {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
            margin: 30px 0;
            gap: 4px;
        }
        
        .audio-bar {
            width: 6px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 3px;
            transition: height 0.1s ease;
            min-height: 8px;
        }
        
        /* ìŒì„± ì„ íƒ */
        .voice-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }
        
        .voice-option {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .voice-option:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        
        .voice-option.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* ì†ë„ ì¡°ì ˆ ë²„íŠ¼ */
        .speed-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }
        
        .speed-option {
            padding: 15px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .speed-option:hover {
            border-color: #4caf50;
            background-color: #f1f8e9;
        }
        
        .speed-option.active {
            border-color: #4caf50;
            background-color: #4caf50;
            color: white;
        }
        
        /* Voice Guide Box */
        .voice-guide {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .voice-guide.active {
            display: flex;
        }
        
        .voice-guide-icon {
            font-size: 24px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .voice-guide-text {
            flex: 1;
            font-size: 14px;
            color: #333;
        }
        
        /* ì§„í–‰ë¥  í‘œì‹œ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .step-counter {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Voice Guide Box -->
        <div class="voice-guide" id="voiceGuideBox">
            <span class="voice-guide-icon">ğŸ”Š</span>
            <span class="voice-guide-text" id="voiceGuideText">ìŒì„± ì•ˆë‚´ ì¤‘...</span>
        </div>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div class="step-screen active" id="step0">
            <div class="step-icon">ğŸ¯</div>
            <h1 class="step-title">ê²€ì‚¬ í™˜ê²½ ì„¤ì •</h1>
            <p class="step-description">
                ìŒì„± ê¸°ë°˜ ê²€ì‚¬ë¥¼ ìœ„í•œ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
                ì¤€ë¹„ë˜ì…¨ìœ¼ë©´ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </p>
            <button class="primary-btn" onclick="startSetup()">ì‹œì‘</button>
        </div>
        
        <!-- 1ë‹¨ê³„: ë§ˆì´í¬ ê¶Œí•œ -->
        <div class="step-screen" id="step1">
            <div class="step-counter">1ë‹¨ê³„ / 6ë‹¨ê³„</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 16.7%;"></div>
            </div>
            <div class="step-icon">ğŸ¤</div>
            <h1 class="step-title">ë§ˆì´í¬ ê¶Œí•œ ì„¤ì •</h1>
            <p class="step-description">
                ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ëŠ” ì°½ì´ ëœ¹ë‹ˆë‹¤.<br>
                ì´ ì‚¬ì´íŠ¸ì—ì„œ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•´ ì£¼ì„¸ìš”.
            </p>
            <div class="status-icon checking" id="micPermissionIcon">ğŸ”„</div>
            <p id="permissionGuide" style="color: #666; font-size: 14px; margin-top: 20px;">
                ë¸Œë¼ìš°ì € ìƒë‹¨ì— ê¶Œí•œ ìš”ì²­ ì°½ì´ ë‚˜íƒ€ë‚˜ë©´ 'í—ˆìš©' ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.
            </p>
        </div>
        
        <!-- 2ë‹¨ê³„: ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ -->
        <div class="step-screen" id="step2">
            <div class="step-counter">2ë‹¨ê³„ / 6ë‹¨ê³„</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 33.3%;"></div>
            </div>
            <div class="step-icon">ğŸ”Š</div>
            <h1 class="step-title">ë§ˆì´í¬ í…ŒìŠ¤íŠ¸</h1>
            <p class="step-description">
                ì‚ ì†Œë¦¬ê°€ ë‚˜ë©´ ì•„ë¬´ ë§ì”€ì´ë‚˜ í•´ë³´ì„¸ìš”.<br>
                ë§ˆì´í¬ê°€ ì†Œë¦¬ë¥¼ ì˜ ê°ì§€í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            </p>
            <div class="status-icon checking" id="micTestIcon">ğŸ”„</div>
            <div class="audio-visualizer" id="micVisualizer">
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
            </div>
        </div>
        
        <!-- 3ë‹¨ê³„: ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸ -->
        <div class="step-screen" id="step3">
            <div class="step-counter">3ë‹¨ê³„ / 6ë‹¨ê³„</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 50%;"></div>
            </div>
            <div class="step-icon">ğŸ”Š</div>
            <h1 class="step-title">ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸</h1>
            <p class="step-description">
                ì œê°€ ë‚´ëŠ” ë¬¸ì œì— ë‹µì„ í•´ë³´ì„¸ìš”.<br>
                ìŠ¤í”¼ì»¤ê°€ ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            </p>
            <div class="status-icon checking" id="speakerTestIcon">ğŸ”„</div>
        </div>
        
        <!-- 4ë‹¨ê³„: ìŒì„± ì„ íƒ -->
        <div class="step-screen" id="step4">
            <div class="step-counter">4ë‹¨ê³„ / 6ë‹¨ê³„</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 66.7%;"></div>
            </div>
            <div class="step-icon">ğŸ­</div>
            <h1 class="step-title">ìŒì„± ì„ íƒ</h1>
            <p class="step-description">
                ì›í•˜ì‹œëŠ” ìŒì„±ì„ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
                ì„ íƒí•˜ì‹œë©´ ë¯¸ë¦¬ ë“¤ì–´ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="voice-selector">
                <div class="voice-option active" onclick="selectVoice('XrExE9yKIg1WjnnlVkGX', 'ì°¨ë¶„í•œ ì—¬ì„±', true)">
                    ì°¨ë¶„í•œ ì—¬ì„±
                </div>
                <div class="voice-option" onclick="selectVoice('IKne3meq5aSn9XLyUdCD', 'ì¹œê·¼í•œ ë‚¨ì„±', false)">
                    ì¹œê·¼í•œ ë‚¨ì„±
                </div>
            </div>
            <button class="primary-btn" onclick="nextStep()" style="display: none;">ë‹¤ìŒ ë‹¨ê³„</button>
        </div>
        
        <!-- 5ë‹¨ê³„: ì†ë„ ì„ íƒ -->
        <div class="step-screen" id="step5">
            <div class="step-counter">5ë‹¨ê³„ / 6ë‹¨ê³„</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 83.3%;"></div>
            </div>
            <div class="step-icon">âš¡</div>
            <h1 class="step-title">ë§í•˜ê¸° ì†ë„ ì¡°ì ˆ</h1>
            <p class="step-description">
                í¸í•˜ê²Œ ë“¤ìœ¼ì‹¤ ìˆ˜ ìˆëŠ” ì†ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
                ì„ íƒí•˜ì‹œë©´ ë°”ë¡œ ë“¤ì–´ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="speed-selector">
                <div class="speed-option" onclick="selectSpeed(0.8)">ì¢€ ë” ëŠë¦¬ê²Œ</div>
                <div class="speed-option active" onclick="selectSpeed(1.0)">ì§€ê¸ˆ ì •ë„</div>
                <div class="speed-option" onclick="selectSpeed(1.2)">ì¢€ ë” ë¹ ë¥´ê²Œ</div>
            </div>
            <button class="primary-btn" onclick="nextStep()">ë‹¤ìŒ ë‹¨ê³„</button>
        </div>
        
        <!-- 6ë‹¨ê³„: ì„¤ì • ì™„ë£Œ -->
        <div class="step-screen" id="step6">
            <div class="step-counter">6ë‹¨ê³„ / 6ë‹¨ê³„</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%;"></div>
            </div>
            <div class="step-icon">âœ…</div>
            <h1 class="step-title">ì„¤ì • ì™„ë£Œ</h1>
            <p class="step-description">
                ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                ì´ì œ ê²€ì‚¬ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <button class="primary-btn" onclick="proceedToTest()">ê²€ì‚¬ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentStep = 0;
        let audioContext;
        let analyser;
        let dataArray;
        let animationId;
        let micStream;
        let recognition;
        
        let setupStatus = {
            https: false,
            browser: false,
            micPermission: false,
            micTest: false,
            speakerTest: false
        };
        
        let elevenLabsConnected = false;
        let elevenLabsApiKey = 'sk_191de859c1c1dbd4601051930c5952b467ac46716aa97057';
        let elevenLabsVoiceId = 'XrExE9yKIg1WjnnlVkGX'; // ë§ˆí‹¸ë‹¤ (ì—¬ì„±) ê¸°ë³¸ê°’
        let selectedVoiceSettings = {
            stability: 0.5,
            similarity_boost: 0.75,
            style: 0,
            use_speaker_boost: true
        };
        let voiceSpeed = 1.0;
        let isFemalevoice = true; // ê¸°ë³¸ê°’ ì—¬ì„±
        
        // DOM ìš”ì†Œ
        const voiceGuideBox = document.getElementById('voiceGuideBox');
        const voiceGuideText = document.getElementById('voiceGuideText');
        
        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            checkEnvironment();
            loadSettings();
            
            // ElevenLabs API í‚¤ ìë™ ì—°ê²° ì‹œë„
            setTimeout(() => {
                connectElevenLabs();
            }, 500);
            
            // ìŒì„±ì¸ì‹ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ê¶Œí•œ ì¬ìš”ì²­ ë°©ì§€)
        });
        
        // ìŒì„± í•©ì„± í•¨ìˆ˜
        function speak(text, callback) {
            // Voice Guide Box í‘œì‹œ
            voiceGuideBox.classList.add('active');
            voiceGuideText.textContent = text;
            
            if (elevenLabsConnected && elevenLabsApiKey) {
                // ElevenLabs API ì‚¬ìš©
                const voiceSettings = {
                    ...selectedVoiceSettings,
                    speed: voiceSpeed
                };
                
                fetch(`https://api.elevenlabs.io/v1/text-to-speech/${elevenLabsVoiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': elevenLabsApiKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: voiceSettings
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const audio = new Audio(URL.createObjectURL(blob));
                    audio.onended = () => {
                        voiceGuideBox.classList.remove('active');
                        if (callback) callback();
                    };
                    audio.play();
                })
                .catch(error => {
                    console.error('ElevenLabs TTS ì˜¤ë¥˜:', error);
                    fallbackToDefaultTTS(text, callback);
                });
            } else {
                fallbackToDefaultTTS(text, callback);
            }
        }
        
        function fallbackToDefaultTTS(text, callback) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = voiceSpeed;
            
            utterance.onend = () => {
                voiceGuideBox.classList.remove('active');
                if (callback) callback();
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // í™˜ê²½ í™•ì¸
        function checkEnvironment() {
            // HTTPS í™•ì¸
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                setupStatus.https = true;
            }
            
            // ë¸Œë¼ìš°ì € í™•ì¸
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                setupStatus.browser = true;
            }
        }
        
        // ElevenLabs ì—°ê²°
        async function connectElevenLabs() {
            if (!elevenLabsApiKey || elevenLabsConnected) return;
            
            try {
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: {
                        'xi-api-key': elevenLabsApiKey
                    }
                });
                
                if (response.ok) {
                    elevenLabsConnected = true;
                    console.log('ElevenLabs ì—°ê²° ì„±ê³µ');
                }
            } catch (error) {
                console.error('ElevenLabs ì—°ê²° ì‹¤íŒ¨:', error);
                elevenLabsConnected = false;
            }
        }
        
        // ì„¤ì • ì‹œì‘
        function startSetup() {
            speak("ì•ˆë…•í•˜ì„¸ìš”. ì§€ê¸ˆë¶€í„° ê²€ì‚¬ í™˜ê²½ ì„¤ì •ì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                setTimeout(() => {
                    nextStep();
                }, 500);
            });
        }
        
        // ë‹¨ê³„ ì „í™˜
        function nextStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
            
            // ë‹¨ê³„ë³„ ìë™ ì‹¤í–‰
            setTimeout(() => {
                switch(currentStep) {
                    case 1:
                        speak("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ëŠ” ì°½ì´ ëœ¹ë‹ˆë‹¤. ì´ ì‚¬ì´íŠ¸ì—ì„œ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•´ ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.", () => {
                            setTimeout(() => {
                                requestMicPermission();
                            }, 1000);
                        });
                        break;
                    case 2:
                        startMicrophoneTest();
                        break;
                    case 3:
                        speak("ì´ì œ ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                            setTimeout(() => {
                                startSpeakerTest();
                            }, 500);
                        });
                        break;
                    case 4:
                        speak("ë§ˆì§€ë§‰ìœ¼ë¡œ ì œ ìŒì„±ì´ë‚˜ ë§í•˜ëŠ” ì†ë„ì— ëŒ€í•´ ì—¬ì­¤ë³´ê² ìŠµë‹ˆë‹¤. ë¨¼ì € ë‚¨ì„± ëª©ì†Œë¦¬ë¥¼ ì›í•˜ì‹œë©´ ì¹œê·¼í•œ ë‚¨ì„±ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ë“¤ì–´ ë³´ì‹œê³  ë‹¤ì‹œ ì—¬ì„±ì´ ë‚«ê² ë‹¤ ì‹¶ìœ¼ì‹œë©´ ì°¨ë¶„í•œ ì—¬ì„±ì„ ëˆ„ë¥´ì‹œë©´ ë˜ê² ìŠµë‹ˆë‹¤.");
                        break;
                    case 5:
                        speak("í˜¹ì‹œ ì œ ë§ ë¹ ë¥´ê¸°ê°€ ë“£ê¸°ì— í¸í•˜ì‹ ê°€ìš”? ë¹ ë¥´ê±°ë‚˜ ëŠë¦¬ë©´ ì¢€ ë” ë¹ ë¥´ê²Œ í˜¹ì€ ì¢€ ë” ëŠë¦¬ê²Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì§€ê¸ˆ ì •ë„ê°€ ê´œì°®ìœ¼ì‹œë©´ ì§€ê¸ˆ ì •ë„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.");
                        break;
                    case 6:
                        speak("ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ê²€ì‚¬ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        break;
                }
            }, 500);
        }
        
        // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
        async function requestMicPermission() {
            const icon = document.getElementById('micPermissionIcon');
            
            icon.className = 'status-icon checking';
            icon.textContent = 'ğŸ”„';
            
            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupStatus.micPermission = true;
                icon.className = 'status-icon success';
                icon.textContent = 'âœ…';
                
                // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì„ ê³„ì† í™œì„± ìƒíƒœë¡œ ìœ ì§€
                // ìŠ¤íŠ¸ë¦¼ì„ ë‹«ì§€ ì•Šì•„ ê¶Œí•œì´ ìœ ì§€ë¨
                
                speak("ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                    setTimeout(() => {
                        nextStep();
                    }, 500);
                });
            } catch (error) {
                setupStatus.micPermission = false;
                icon.className = 'status-icon error';
                icon.textContent = 'âŒ';
                
                const guideText = document.getElementById('permissionGuide');
                guideText.innerHTML = `
                    <span style="color: #f44336;">âŒ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.</span><br>
                    <span style="color: #666; font-size: 12px;">
                        ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ì˜ ğŸ”’ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬<br>
                        ë§ˆì´í¬ ê¶Œí•œì„ 'í—ˆìš©'ìœ¼ë¡œ ë³€ê²½í•œ í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.
                    </span>
                `;
                
                speak("ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•œ í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            }
            
            saveSettings();
        }
        
        // ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘
        function startMicrophoneTest() {
            if (!micStream) return;
            
            const visualizer = document.getElementById('micVisualizer');
            visualizer.style.display = 'flex';
            
            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(micStream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            // ì˜¤ë””ì˜¤ ì‹œê°í™”
            const bars = visualizer.querySelectorAll('.audio-bar');
            let detected = false;
            
            function animate() {
                animationId = requestAnimationFrame(animate);
                analyser.getByteFrequencyData(dataArray);
                
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                
                bars.forEach((bar, index) => {
                    const height = Math.min(60, (average + Math.random() * 20) * (index % 2 === 0 ? 1 : 0.8));
                    bar.style.height = `${height}px`;
                });
                
                if (average > 30 && !detected) {
                    detected = true;
                    setupStatus.micTest = true;
                    document.getElementById('micTestIcon').className = 'status-icon success';
                    document.getElementById('micTestIcon').textContent = 'âœ…';
                    
                    speak("ì†Œë¦¬ê°€ ì œê²Œë„ ì˜ ë“¤ë¦¬ë„¤ìš”. ê°ì‚¬í•©ë‹ˆë‹¤.", () => {
                        setTimeout(() => {
                            nextStep();
                        }, 500);
                    });
                }
            }
            
            // ì‚ ì†Œë¦¬ ìƒì„± í›„ í…ŒìŠ¤íŠ¸ ì‹œì‘
            speak("ì‚ ì†Œë¦¬ê°€ ë‚˜ë©´ ì•„ë¬´ ë§ì”€ì´ë‚˜ í•´ë³´ì„¸ìš”.", () => {
                setTimeout(() => {
                    // ì‚ ì†Œë¦¬ ì¬ìƒ
                    const beepContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = beepContext.createOscillator();
                    const gainNode = beepContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(beepContext.destination);
                    
                    oscillator.frequency.value = 1000;
                    gainNode.gain.value = 0.3;
                    
                    oscillator.start();
                    oscillator.stop(beepContext.currentTime + 0.5);
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                    setTimeout(() => {
                        animate();
                    }, 600);
                }, 1000);
            });
            
            // 10ì´ˆ í›„ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ
            setTimeout(() => {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (!setupStatus.micTest) {
                    document.getElementById('micTestIcon').className = 'status-icon error';
                    document.getElementById('micTestIcon').textContent = 'âŒ';
                    speak("ë§ˆì´í¬ì—ì„œ ì†Œë¦¬ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì´í¬ ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", () => {
                        // 2ì´ˆ ëŒ€ê¸° í›„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸
                        setTimeout(() => {
                            speak("ì´ì œ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê² ìŠµë‹ˆë‹¤. ì‚ ì†Œë¦¬ê°€ ë‚˜ë©´ ì•„ë¬´ ë§ì”€ì´ë‚˜ í•´ë³´ì„¸ìš”.", () => {
                                // í™”ë©´ ì´ˆê¸°í™”
                                document.getElementById('micTestIcon').className = 'status-icon checking';
                                document.getElementById('micTestIcon').textContent = 'ğŸ”„';
                                
                                // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
                                const retryButtons = document.querySelectorAll('#step2 .primary-btn');
                                retryButtons.forEach(btn => btn.remove());
                                
                                // ì¬í…ŒìŠ¤íŠ¸ ì‹œì‘
                                retryMicrophoneTest();
                            });
                        }, 2000);
                    });
                }
                saveSettings();
            }, 10000);
        }
        
        // ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸ ì‹œì‘
        function startSpeakerTest() {
            speak("ì œê°€ ë‚´ëŠ” ë¬¸ì œì— ë‹µì„ í•´ë³´ì„¸ìš”.", () => {
                setTimeout(() => {
                    speak("ë‚®ì—ëŠ” í•´ê°€ ëœ¨ì£ . ê·¸ëŸ¼ ë°¤ì—ëŠ” ë¬´ì—‡ì´ ëœ°ê¹Œìš”?", () => {
                        speak("ì‚ ì†Œë¦¬ê°€ ë‚˜ë©´ ëŒ€ë‹µí•´ ë³´ì„¸ìš”.", () => {
                            setTimeout(() => {
                                // ì‚ ì†Œë¦¬ ì¬ìƒ
                                const beepContext = new (window.AudioContext || window.webkitAudioContext)();
                                const oscillator = beepContext.createOscillator();
                                const gainNode = beepContext.createGain();
                                
                                oscillator.connect(gainNode);
                                gainNode.connect(beepContext.destination);
                                
                                oscillator.frequency.value = 1000;
                                gainNode.gain.value = 0.3;
                                
                                oscillator.start();
                                oscillator.stop(beepContext.currentTime + 0.5);
                                
                                // ì‚ ì†Œë¦¬ í›„ ëŒ€ê¸°
                                setTimeout(() => {
                                    setupStatus.speakerTest = true;
                                    document.getElementById('speakerTestIcon').className = 'status-icon success';
                                    document.getElementById('speakerTestIcon').textContent = 'âœ…';
                                    
                                    speak("ë„¤, ì˜ í•˜ì…¨ìŠµë‹ˆë‹¤. ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸ê°€ ì˜ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", () => {
                                        setTimeout(() => {
                                            nextStep();
                                        }, 100);
                                    });
                                }, 2000);
                            }, 500);
                        });
                    });
                }, 300);
            });
        }
        
        // ìŒì„± ì„ íƒ
        function selectVoice(voiceId, voiceName, isFemale) {
            elevenLabsVoiceId = voiceId;
            isFemalevoice = isFemale;
            
            document.querySelectorAll('.voice-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            speak(`${voiceName} ìŒì„±ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, () => {
                // 2ì´ˆ ëŒ€ê¸° í›„ ì§„í–‰ ì•ˆë‚´
                setTimeout(() => {
                    speak("ê·¸ëŸ¼ ì´ì œ ì´ ëª©ì†Œë¦¬ë¡œ ê²€ì‚¬ë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.", () => {
                        setTimeout(() => {
                            nextStep();
                        }, 500);
                    });
                }, 2000);
            });
            
            saveSettings();
        }
        
        // ì†ë„ ì„ íƒ
        function selectSpeed(speed) {
            // í˜„ì¬ ìŒì„±ì´ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ë³µ ì¬ìƒ ë°©ì§€
            if (voiceGuideBox.classList.contains('active')) {
                return;
            }
            
            // 'ì§€ê¸ˆ ì •ë„' ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì†ë„ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            if (speed !== voiceSpeed) {
                voiceSpeed = speed;
            }
            
            document.querySelectorAll('.speed-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            const message = speed === 0.8 ? "ì´ ì†ë„ë¡œ ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤." :
                          speed === 1.2 ? "ì´ ì†ë„ë¡œ ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤." :
                          "";  // 'ì§€ê¸ˆ ì •ë„' ì„ íƒ ì‹œ ë©˜íŠ¸ ì—†ìŒ
            
            if (message) {
                speak(message, () => {
                    setTimeout(() => {
                        speak("ì´ ì†ë„ê°€ ì ë‹¹í•˜ì‹ ê°€ìš”? ê·¸ëŸ¼ ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                    }, 500);
                });
            } else {
                // 'ì§€ê¸ˆ ì •ë„' ì„ íƒ ì‹œ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´
                speak("ì´ ì†ë„ê°€ ì ë‹¹í•˜ì‹ ê°€ìš”? ê·¸ëŸ¼ ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            }
            saveSettings();
        }
        
        // ì„¤ì • ì €ì¥
        function saveSettings() {
            const settings = {
                voiceEnabled: true,
                voiceSpeed: voiceSpeed,
                elevenLabsConnected: elevenLabsConnected,
                elevenLabsApiKey: elevenLabsApiKey,
                elevenLabsVoiceId: elevenLabsVoiceId,
                voiceSettings: selectedVoiceSettings,
                isFemalevoice: isFemalevoice,
                micTestCompleted: setupStatus.micTest,
                speakerTestCompleted: setupStatus.speakerTest,
                setupStatus: setupStatus,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('hardwareSettings', JSON.stringify(settings));
        }
        
        // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSettings() {
            const settingsStr = localStorage.getItem('hardwareSettings');
            if (settingsStr) {
                try {
                    const settings = JSON.parse(settingsStr);
                    
                    if (settings.voiceSpeed) voiceSpeed = settings.voiceSpeed;
                    if (settings.elevenLabsVoiceId) elevenLabsVoiceId = settings.elevenLabsVoiceId;
                    if (settings.isFemalevoice !== undefined) isFemalevoice = settings.isFemalevoice;
                    if (settings.voiceSettings) selectedVoiceSettings = settings.voiceSettings;
                    if (settings.elevenLabsConnected) elevenLabsConnected = settings.elevenLabsConnected;
                } catch (error) {
                    console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }
        }
        
        // ìŒì„± í™•ì¸ ì ˆì°¨ ì‹œì‘ (ì´ì œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        function startVoiceConfirmation() {
            // 1ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        }
        
        // ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¬ì‹œë„
        function retryMicrophoneTest() {
            // ê¸°ì¡´ ì„¤ì • ì´ˆê¸°í™”
            setupStatus.micTest = false;
            
            const visualizer = document.getElementById('micVisualizer');
            const bars = visualizer.querySelectorAll('.audio-bar');
            visualizer.style.display = 'flex';
            
            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„± (ì²˜ìŒ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆì„ ê²½ìš°)
            if (!audioContext || !analyser) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(micStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }
            
            const bufferLength = analyser.frequencyBinCount;
            let detected = false;
            
            // ì‚ ì†Œë¦¬ ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            setTimeout(() => {
                const beepContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = beepContext.createOscillator();
                const gainNode = beepContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(beepContext.destination);
                
                oscillator.frequency.value = 1000;
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                oscillator.stop(beepContext.currentTime + 0.5);
                
                // ìŒì„± ê°ì§€ ì• ë‹ˆë©”ì´ì…˜
                function animate() {
                    animationId = requestAnimationFrame(animate);
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    
                    bars.forEach((bar, index) => {
                        const height = Math.min(60, (average + Math.random() * 20) * (index % 2 === 0 ? 1 : 0.8));
                        bar.style.height = `${height}px`;
                    });
                    
                    if (average > 30 && !detected) {
                        detected = true;
                        setupStatus.micTest = true;
                        document.getElementById('micTestIcon').className = 'status-icon success';
                        document.getElementById('micTestIcon').textContent = 'âœ…';
                        
                        if (animationId) {
                            cancelAnimationFrame(animationId);
                        }
                        
                        speak("ì†Œë¦¬ê°€ ì œê²Œë„ ì˜ ë“¤ë¦¬ë„¤ìš”. ê°ì‚¬í•©ë‹ˆë‹¤.", () => {
                            setTimeout(() => {
                                nextStep();
                            }, 500);
                        });
                    }
                }
                
                // ì‚ ì†Œë¦¬ í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                setTimeout(() => {
                    animate();
                }, 600);
            }, 1000);
            
            // 10ì´ˆ í›„ ë˜ ì‹¤íŒ¨í•˜ë©´ ê±´ë„ˆë›°ê¸° ì˜µì…˜ ì œê³µ
            setTimeout(() => {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (!setupStatus.micTest) {
                    document.getElementById('micTestIcon').className = 'status-icon error';
                    document.getElementById('micTestIcon').textContent = 'âŒ';
                    speak("ì—¬ì „íˆ ë§ˆì´í¬ì—ì„œ ì†Œë¦¬ê°€ ê°ì§€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", () => {
                        document.getElementById('step2').innerHTML += `
                            <button class="primary-btn" onclick="startMicrophoneTest()" style="margin-top: 20px;">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</button>
                            <button class="primary-btn" onclick="skipMicTest()" style="margin-top: 10px; background: #6c757d;">ê±´ë„ˆë›°ê¸°</button>
                        `;
                    });
                }
                saveSettings();
            }, 10000);
        }
        
        // ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°
        function skipMicTest() {
            setupStatus.micTest = true; // ê±´ë„ˆë›°ì–´ë„ í†µê³¼ë¡œ ì²˜ë¦¬
            document.getElementById('micTestIcon').className = 'status-icon success';
            document.getElementById('micTestIcon').textContent = 'âœ…';
            speak("ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆë›°ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.", () => {
                setTimeout(() => {
                    nextStep();
                }, 500);
            });
            saveSettings();
        }
        
        // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰
        function proceedToTest() {
            // ìµœì¢… ì„¤ì • ì €ì¥
            saveSettings();
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë‹¤ìŒ í˜ì´ì§€ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const nextPage = urlParams.get('next') || 'animal-fluency-test-v2.html';
            
            // í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = nextPage;
        }
    </script>
</body>
</html>